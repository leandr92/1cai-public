version: '3.8'

# Stage 1: Foundation - Neo4j, Qdrant, Elasticsearch
# Extends base docker-compose.yml

services:
  # Neo4j - Graph Database for Metadata
  neo4j:
    image: neo4j:5.15-community
    container_name: 1c-ai-neo4j
    environment:
      NEO4J_AUTH: neo4j/${NEO4J_PASSWORD:-password}
      NEO4J_PLUGINS: '["apoc", "graph-data-science"]'
      NEO4J_dbms_memory_pagecache_size: 2G
      NEO4J_dbms_memory_heap_initial__size: 2G
      NEO4J_dbms_memory_heap_max__size: 4G
      NEO4J_apoc_export_file_enabled: "true"
      NEO4J_apoc_import_file_enabled: "true"
      NEO4J_apoc_import_file_use__neo4j__config: "true"
    ports:
      - "7474:7474"  # HTTP
      - "7687:7687"  # Bolt
    volumes:
      - neo4j_data:/data
      - neo4j_logs:/logs
      - neo4j_plugins:/plugins
      - ./neo4j/import:/var/lib/neo4j/import
    networks:
      - 1c-ai-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "cypher-shell -u neo4j -p ${NEO4J_PASSWORD:-password} 'RETURN 1'"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 40s

  # Qdrant - Vector Database for Semantic Search
  qdrant:
    image: qdrant/qdrant:v1.7.4
    container_name: 1c-ai-qdrant
    ports:
      - "6333:6333"  # REST API
      - "6334:6334"  # gRPC
    volumes:
      - qdrant_storage:/qdrant/storage
    environment:
      QDRANT__SERVICE__GRPC_PORT: 6334
    networks:
      - 1c-ai-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:6333/readyz || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Elasticsearch - Full-text Search
  elasticsearch:
    image: elasticsearch:8.11.3
    container_name: 1c-ai-elasticsearch
    environment:
      - discovery.type=single-node
      - "ES_JAVA_OPTS=-Xms1g -Xmx1g"
      - xpack.security.enabled=false
      - xpack.security.http.ssl.enabled=false
      - cluster.name=1c-ai-cluster
      - node.name=1c-ai-node
    ports:
      - "9200:9200"  # REST API
      - "9300:9300"  # Transport
    volumes:
      - elasticsearch_data:/usr/share/elasticsearch/data
    networks:
      - 1c-ai-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:9200/_cluster/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # Kibana - Elasticsearch UI (dev only)
  kibana:
    image: kibana:8.11.3
    container_name: 1c-ai-kibana
    environment:
      ELASTICSEARCH_HOSTS: http://elasticsearch:9200
      ELASTICSEARCH_USERNAME: elastic
      SERVER_NAME: kibana.1c-ai.local
    ports:
      - "5601:5601"
    networks:
      - 1c-ai-network
    depends_on:
      elasticsearch:
        condition: service_healthy
    profiles:
      - dev
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:5601/api/status || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # Ollama - Local LLM Server (for Qwen3-Coder)
  ollama:
    image: ollama/ollama:latest
    container_name: 1c-ai-ollama
    ports:
      - "11434:11434"
    volumes:
      - ollama_models:/root/.ollama
    networks:
      - 1c-ai-network
    restart: unless-stopped
    environment:
      - OLLAMA_KEEP_ALIVE=24h
    healthcheck:
      test: ["CMD-SHELL", "ollama list || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]

  # Telegram Bot - User Interface
  telegram-bot:
    build:
      context: .
      dockerfile: docker/Dockerfile.telegram
    container_name: 1c-ai-telegram-bot
    environment:
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      - TELEGRAM_ADMIN_IDS=${TELEGRAM_ADMIN_IDS:-}
      - TELEGRAM_PREMIUM_IDS=${TELEGRAM_PREMIUM_IDS:-}
      - TELEGRAM_RATE_LIMIT_MIN=${TELEGRAM_RATE_LIMIT_MIN:-10}
      - TELEGRAM_RATE_LIMIT_DAY=${TELEGRAM_RATE_LIMIT_DAY:-100}
      # Database connections
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - POSTGRES_DB=knowledge_base
      - POSTGRES_USER=admin
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-changeme}
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USER=neo4j
      - NEO4J_PASSWORD=${NEO4J_PASSWORD:-password}
      - QDRANT_HOST=qdrant
      - QDRANT_PORT=6333
      - OLLAMA_HOST=ollama
      - OLLAMA_PORT=11434
    networks:
      - 1c-ai-network
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
      neo4j:
        condition: service_healthy
      qdrant:
        condition: service_healthy
    profiles:
      - telegram

volumes:
  neo4j_data:
    name: 1c-ai-neo4j-data
  neo4j_logs:
    name: 1c-ai-neo4j-logs
  neo4j_plugins:
    name: 1c-ai-neo4j-plugins
  qdrant_storage:
    name: 1c-ai-qdrant-storage
  elasticsearch_data:
    name: 1c-ai-elasticsearch-data
  ollama_models:
    name: 1c-ai-ollama-models

networks:
  1c-ai-network:
    external: true




