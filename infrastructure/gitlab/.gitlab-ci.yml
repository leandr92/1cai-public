stages:
  - lint
  - test
  - security
  - build
  - deploy

variables:
  REGISTRY: "$CI_REGISTRY"
  IMAGE_NAME: "$CI_PROJECT_NAME-api"
  KUBE_CONTEXT: "kind-1cai-devops"

lint:
  image: python:3.11
  stage: lint
  script:
    - pip install -r requirements-dev.txt
    - make lint

unit_tests:
  image: python:3.11
  stage: test
  script:
    - pip install -r requirements-dev.txt
    - make test
  artifacts:
    reports:
      junit: output/test-results/**/*.xml
    expire_in: 1 week

security_scan:
  stage: security
  image: ghcr.io/trufflesecurity/trufflehog:latest
  script:
    - trufflehog git file://. --only-verified --fail
    - pip install pip-audit
    - pip-audit
    - apk add --no-cache bash helm curl unzip
    - wget -q https://github.com/open-policy-agent/conftest/releases/download/v0.46.0/conftest_0.46.0_Linux_x86_64.tar.gz -O - | tar xz -C /usr/local/bin conftest
    - pip install semgrep checkov
    - curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin
    - bash scripts/security/run_policy_checks.sh
    - bash scripts/security/run_checkov.sh

build:
  image: docker:24.0
  stage: build
  services:
    - docker:24.0-dind
  variables:
    DOCKER_TLS_CERTDIR: "/certs"
  script:
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin "$CI_REGISTRY"
    - docker build -t "$REGISTRY/$IMAGE_NAME:$CI_COMMIT_SHORT_SHA" .
    - docker push "$REGISTRY/$IMAGE_NAME:$CI_COMMIT_SHORT_SHA"
    - docker tag "$REGISTRY/$IMAGE_NAME:$CI_COMMIT_SHORT_SHA" "$REGISTRY/$IMAGE_NAME:latest"
    - docker push "$REGISTRY/$IMAGE_NAME:latest"
  only:
    - main

.deploy_template: &deploy_job
  stage: deploy
  image: bitnami/kubectl:1.29
  script:
    - mkdir -p ~/.kube
    - echo "$KUBECONFIG_CONTENT" | base64 -d > ~/.kube/config
    - helm upgrade --install 1cai infrastructure/helm/1cai-stack \
        --namespace 1cai --create-namespace \
        --set image.repository="$REGISTRY/$IMAGE_NAME" \
        --set image.tag="$CI_COMMIT_SHORT_SHA"
  environment:
    name: $ENV_NAME
    url: https://$ENV_URL
  only:
    - main

deploy_preview:
  <<: *deploy_job
  variables:
    KUBECONFIG_CONTENT: "$KIND_KUBECONFIG_B64"
    ENV_NAME: "preview"
    ENV_URL: "api.localdev"

deploy_production:
  <<: *deploy_job
  variables:
    KUBECONFIG_CONTENT: "$KUBE_PROD_CONFIG_B64"
    ENV_NAME: "production"
    ENV_URL: "api.prod.1cai.dev"
  when: manual
