pipeline {
  agent any

  environment {
    REGISTRY = "ghcr.io/1c-ai-stack"
    IMAGE_NAME = "api"
    KUBE_CONFIG = credentials('kubeconfig-1cai')
    REGISTRY_CREDENTIALS = credentials('registry-ghcr')
    VAULT_TOKEN = credentials('vault-token')
  }

  options {
    timestamps()
    ansiColor('xterm')
    disableConcurrentBuilds()
  }

  stages {
    stage('Checkout') {
      steps {
        checkout scm
      }
    }

    stage('Lint') {
      steps {
        sh 'make lint'
      }
    }

    stage('Tests') {
      steps {
        sh 'make test'
      }
      post {
        always {
          junit 'output/test-results/**/*.xml'
        }
      }
    }

    stage('Security Scan') {
      steps {
        sh 'make quality'
        sh 'bash scripts/security/run_security_scans.sh || true'
        sh 'bash scripts/security/run_policy_checks.sh'
        sh '\n          pip install --upgrade checkov\n          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sudo sh -s -- -b /usr/local/bin\n        '
        sh 'bash scripts/security/run_checkov.sh'
      }
    }

    stage('Build & Push Image') {
      steps {
        withCredentials([usernamePassword(credentialsId: 'registry-ghcr', usernameVariable: 'REG_USER', passwordVariable: 'REG_PASS')]) {
          sh '''
          docker login ${REGISTRY} -u ${REG_USER} -p ${REG_PASS}
          docker build -t ${REGISTRY}/${IMAGE_NAME}:${GIT_COMMIT} .
          docker push ${REGISTRY}/${IMAGE_NAME}:${GIT_COMMIT}
          docker tag ${REGISTRY}/${IMAGE_NAME}:${GIT_COMMIT} ${REGISTRY}/${IMAGE_NAME}:latest
          docker push ${REGISTRY}/${IMAGE_NAME}:latest
          '''
        }
      }
    }

    stage('Deploy to kind (preview)') {
      when {
        branch 'main'
      }
      steps {
        sh '''
        kind get clusters || kind create cluster --config infrastructure/kind/cluster.yaml
        helm upgrade --install 1cai infrastructure/helm/1cai-stack \
          --namespace 1cai --create-namespace \
          --set image.repository=${REGISTRY}/${IMAGE_NAME} \
          --set image.tag=${GIT_COMMIT}
        kubectl --context kind-1cai-devops get pods -n 1cai
        '''
      }
    }

    stage('Deploy to Kubernetes') {
      when {
        branch 'main'
        expression { params.DEPLOY_PROD == true }
      }
      steps {
        withCredentials([file(credentialsId: 'kubeconfig-prod', variable: 'KUBECONFIG'), string(credentialsId: 'vault-token', variable: 'VAULT_TOKEN')]) {
          sh '''
          export KUBECONFIG=$KUBECONFIG
          terraform -chdir=infrastructure/terraform init -input=false
          terraform -chdir=infrastructure/terraform apply -auto-approve \
            -var="kubeconfig_path=$KUBECONFIG" \
            -var="chart_version=0.1.0"
          '''
        }
      }
    }
  }

  post {
    failure {
      mail to: 'devops@1c-ai-stack.local',
           subject: "1C AI Stack Jenkins pipeline failed",
           body: "Build ${env.BUILD_URL} failed. Please investigate."
    }
  }
}
