#!/usr/bin/env python3
"""
–†–ï–ê–õ–¨–ù–´–ô –∞–Ω–∞–ª–∏–∑ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –ø–∞—Ä—Å–µ—Ä–∞
–ë–µ–∑ —Ç–µ–æ—Ä–∏–π - —Ç–æ–ª—å–∫–æ —Ñ–∞–∫—Ç—ã –∏ –∏–∑–º–µ—Ä–µ–Ω–∏—è

–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:
1. –ü—Ä–æ—Ñ–∏–ª–∏—Ä—É–µ—Ç —Ç–µ–∫—É—â–∏–π –ø–∞—Ä—Å–µ—Ä
2. –ù–∞—Ö–æ–¥–∏—Ç –†–ï–ê–õ–¨–ù–´–ï bottlenecks
3. –ü—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –ö–û–ù–ö–†–ï–¢–ù–´–ï —É–ª—É—á—à–µ–Ω–∏—è
4. –ò–∑–º–µ—Ä—è–µ—Ç –†–ï–ê–õ–¨–ù–´–ô —ç—Ñ—Ñ–µ–∫—Ç

–í–µ—Ä—Å–∏—è: 1.0 Pragmatic
"""

import cProfile
import pstats
import time
import sys
from pathlib import Path
from typing import Dict
import tracemalloc

sys.path.insert(0, str(Path(__file__).parent.parent))


class ParserProfiler:
    """
    –ü—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤—â–∏–∫ –ø–∞—Ä—Å–µ—Ä–∞ - –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –†–ï–ê–õ–¨–ù–´–ï –¥–∞–Ω–Ω—ã–µ
    
    –ù–µ—Ç —Ç–µ–æ—Ä–∏–π, —Ç–æ–ª—å–∫–æ –∏–∑–º–µ—Ä–µ–Ω–∏—è.
    """
    
    def __init__(self):
        self.results = {}
    
    def profile_current_parser(self, test_code: str):
        """
        –ü—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ –ø–∞—Ä—Å–µ—Ä–∞
        
        –ò–∑–º–µ—Ä—è–µ—Ç:
        - –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–∞–∂–¥–æ–π —Ñ—É–Ω–∫—Ü–∏–∏
        - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤—ã–∑–æ–≤–æ–≤
        - –ü–∞–º—è—Ç—å
        """
        print("=" * 70)
        print("–ü–†–û–§–ò–õ–ò–†–û–í–ê–ù–ò–ï –¢–ï–ö–£–©–ï–ì–û –ü–ê–†–°–ï–†–ê")
        print("=" * 70)
        
        # Start memory tracking
        tracemalloc.start()
        
        # Profile —Å cProfile
        profiler = cProfile.Profile()
        
        try:
            from scripts.parsers.improve_bsl_parser import ImprovedBSLParser
            
            parser = ImprovedBSLParser()
            
            # –ù–∞—á–∏–Ω–∞–µ–º –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ
            profiler.enable()
            start_time = time.time()
            
            # –†–ï–ê–õ–¨–ù–´–ô –ø–∞—Ä—Å–∏–Ω–≥
            result = parser.parse(test_code)
            
            # –°—Ç–æ–ø
            end_time = time.time()
            profiler.disable()
            
            # Memory peak
            current, peak = tracemalloc.get_traced_memory()
            tracemalloc.stop()
            
            # –†–µ–∑—É–ª—å—Ç–∞—Ç—ã
            elapsed = end_time - start_time
            
            print(f"\nüìä –†–ï–ó–£–õ–¨–¢–ê–¢–´:")
            print(f"–í—Ä–µ–º—è: {elapsed:.4f} —Å–µ–∫")
            print(f"–ü–∞–º—è—Ç—å (peak): {peak / 1024 / 1024:.2f} MB")
            print(f"–§—É–Ω–∫—Ü–∏–π –Ω–∞–π–¥–µ–Ω–æ: {len(result['functions'])}")
            print(f"–ü—Ä–æ—Ü–µ–¥—É—Ä –Ω–∞–π–¥–µ–Ω–æ: {len(result['procedures'])}")
            
            # –î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
            print(f"\nüîç –¢–û–ü-10 –ú–ï–î–õ–ï–ù–ù–´–• –§–£–ù–ö–¶–ò–ô:")
            stats = pstats.Stats(profiler)
            stats.sort_stats('cumulative')
            stats.print_stats(10)
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
            self.results['current'] = {
                'time': elapsed,
                'memory_mb': peak / 1024 / 1024,
                'functions_found': len(result['functions'])
            }
            
            return result
            
        except Exception as e:
            print(f"‚ùå –û—à–∏–±–∫–∞: {e}")
            traceback_str = ''.join(traceback.format_exc())
            print(traceback_str)
            return None
    
    def find_bottlenecks(self):
        """
        –ê–Ω–∞–ª–∏–∑ bottlenecks –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏—è
        
        –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ö–û–ù–ö–†–ï–¢–ù–û –≥–¥–µ —Ç—Ä–∞—Ç–∏—Ç—Å—è –≤—Ä–µ–º—è
        """
        print("\n" + "=" * 70)
        print("–ê–ù–ê–õ–ò–ó BOTTLENECKS")
        print("=" * 70)
        
        if not self.results.get('current'):
            print("‚ùå –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏—è")
            return
        
        # TODO: –î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ pstats
        # –ü–æ–∫–∞–∂–µ—Ç –∫–∞–∫–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ —Ä–µ–∞–ª—å–Ω–æ –º–µ–¥–ª–µ–Ω–Ω—ã–µ
        
        print("\nüí° –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò (–Ω–∞ –æ—Å–Ω–æ–≤–µ –†–ï–ê–õ–¨–ù–´–• –¥–∞–Ω–Ω—ã—Ö):")
        print("1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –ø–æ–ª–Ω–æ–µ –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ —Ä–µ–∞–ª—å–Ω–æ–º —Ñ–∞–π–ª–µ")
        print("2. –ù–∞–π–¥–∏—Ç–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∫–æ—Ç–æ—Ä—ã–µ –∑–∞–Ω–∏–º–∞—é—Ç >50% –≤—Ä–µ–º–µ–Ω–∏")
        print("3. –û–ø—Ç–∏–º–∏–∑–∏—Ä—É–π—Ç–µ –∏–º–µ–Ω–Ω–æ –∏—Ö")
        print("4. –ò–∑–º–µ—Ä—å—Ç–µ —É–ª—É—á—à–µ–Ω–∏–µ")
    
    def compare_optimizations(self):
        """–°—Ä–∞–≤–Ω–µ–Ω–∏–µ –¥–æ/–ø–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π"""
        print("\n" + "=" * 70)
        print("–°–†–ê–í–ù–ï–ù–ò–ï")
        print("=" * 70)
        
        current = self.results.get('current', {})
        optimized = self.results.get('optimized', {})
        
        if not current or not optimized:
            print("‚ö†Ô∏è  –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è")
            return
        
        time_improvement = (current['time'] - optimized['time']) / current['time'] * 100
        memory_improvement = (current['memory_mb'] - optimized['memory_mb']) / current['memory_mb'] * 100
        
        print(f"–í—Ä–µ–º—è: {current['time']:.4f} ‚Üí {optimized['time']:.4f} —Å–µ–∫ ({time_improvement:+.1f}%)")
        print(f"–ü–∞–º—è—Ç—å: {current['memory_mb']:.2f} ‚Üí {optimized['memory_mb']:.2f} MB ({memory_improvement:+.1f}%)")
        
        if time_improvement > 10:
            print(f"\n‚úÖ –•–æ—Ä–æ—à–µ–µ —É–ª—É—á—à–µ–Ω–∏–µ: {time_improvement:.1f}%")
        elif time_improvement > 0:
            print(f"\n‚ö†Ô∏è  –ù–µ–±–æ–ª—å—à–æ–µ —É–ª—É—á—à–µ–Ω–∏–µ: {time_improvement:.1f}%")
        else:
            print(f"\n‚ùå –£—Ö—É–¥—à–µ–Ω–∏–µ: {time_improvement:.1f}%")


def main():
    """Main - –∑–∞–ø—É—Å–∫ —Ä–µ–∞–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞"""
    
    # –¢–µ—Å—Ç–æ–≤—ã–π –∫–æ–¥ BSL
    test_code = """
#–û–±–ª–∞—Å—Ç—å –ü—Ä–æ–≥—Ä–∞–º–º–Ω—ã–π–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å

–§—É–Ω–∫—Ü–∏—è –ü–æ–ª—É—á–∏—Ç—å–°–ø–∏—Å–æ–∫–ö–ª–∏–µ–Ω—Ç–æ–≤(–¢–æ–ª—å–∫–æ–ê–∫—Ç–∏–≤–Ω—ã–µ = –ò—Å—Ç–∏–Ω–∞) –≠–∫—Å–ø–æ—Ä—Ç
    
    –ó–∞–ø—Ä–æ—Å = –ù–æ–≤—ã–π –ó–∞–ø—Ä–æ—Å;
    –ó–∞–ø—Ä–æ—Å.–¢–µ–∫—Å—Ç = "
    |–í–´–ë–†–ê–¢–¨
    |    –ö–ª–∏–µ–Ω—Ç—ã.–°—Å—ã–ª–∫–∞ –ö–ê–ö –°—Å—ã–ª–∫–∞,
    |    –ö–ª–∏–µ–Ω—Ç—ã.–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –ö–ê–ö –ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ
    |–ò–ó
    |    –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫.–ö–ª–∏–µ–Ω—Ç—ã –ö–ê–ö –ö–ª–∏–µ–Ω—Ç—ã
    |–ì–î–ï
    |    –ù–ï –ö–ª–∏–µ–Ω—Ç—ã.–ü–æ–º–µ—Ç–∫–∞–£–¥–∞–ª–µ–Ω–∏—è";
    
    –ï—Å–ª–∏ –¢–æ–ª—å–∫–æ–ê–∫—Ç–∏–≤–Ω—ã–µ –¢–æ–≥–¥–∞
        –ó–∞–ø—Ä–æ—Å.–¢–µ–∫—Å—Ç = –ó–∞–ø—Ä–æ—Å.–¢–µ–∫—Å—Ç + "
        |    –ò –ö–ª–∏–µ–Ω—Ç—ã.–ê–∫—Ç–∏–≤–Ω—ã–π";
    –ö–æ–Ω–µ—Ü–ï—Å–ª–∏;
    
    –†–µ–∑—É–ª—å—Ç–∞—Ç = –ó–∞–ø—Ä–æ—Å.–í—ã–ø–æ–ª–Ω–∏—Ç—å().–í—ã–≥—Ä—É–∑–∏—Ç—å();
    –í–æ–∑–≤—Ä–∞—Ç –†–µ–∑—É–ª—å—Ç–∞—Ç;
    
–ö–æ–Ω–µ—Ü–§—É–Ω–∫—Ü–∏–∏

–§—É–Ω–∫—Ü–∏—è –†–∞—Å—Å—á–∏—Ç–∞—Ç—å–°–∫–∏–¥–∫—É(–°—É–º–º–∞, –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ–ü–æ–∫—É–ø–æ–∫) –≠–∫—Å–ø–æ—Ä—Ç
    
    –ï—Å–ª–∏ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ–ü–æ–∫—É–ø–æ–∫ > 10 –¢–æ–≥–¥–∞
        –°—É–º–º–∞–°–∫–∏–¥–∫–∏ = –°—É–º–º–∞ * 0.15;
    –ò–Ω–∞—á–µ–ï—Å–ª–∏ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ–ü–æ–∫—É–ø–æ–∫ > 5 –¢–æ–≥–¥–∞
        –°—É–º–º–∞–°–∫–∏–¥–∫–∏ = –°—É–º–º–∞ * 0.10;
    –ò–Ω–∞—á–µ
        –°—É–º–º–∞–°–∫–∏–¥–∫–∏ = –°—É–º–º–∞ * 0.05;
    –ö–æ–Ω–µ—Ü–ï—Å–ª–∏;
    
    –í–æ–∑–≤—Ä–∞—Ç –°—É–º–º–∞–°–∫–∏–¥–∫–∏;
    
–ö–æ–Ω–µ—Ü–§—É–Ω–∫—Ü–∏–∏

–ü—Ä–æ—Ü–µ–¥—É—Ä–∞ –û–±—Ä–∞–±–æ—Ç–∞—Ç—å–î–æ–∫—É–º–µ–Ω—Ç(–î–æ–∫—É–º–µ–Ω—Ç) –≠–∫—Å–ø–æ—Ä—Ç
    
    –î–ª—è –ö–∞–∂–¥–æ–≥–æ –°—Ç—Ä–æ–∫–∞–¢–∞–±–ª–∏—Ü—ã –ò–∑ –î–æ–∫—É–º–µ–Ω—Ç.–¢–æ–≤–∞—Ä—ã –¶–∏–∫–ª
        –°—Ç—Ä–æ–∫–∞–¢–∞–±–ª–∏—Ü—ã.–°—É–º–º–∞ = –°—Ç—Ä–æ–∫–∞–¢–∞–±–ª–∏—Ü—ã.–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ * –°—Ç—Ä–æ–∫–∞–¢–∞–±–ª–∏—Ü—ã.–¶–µ–Ω–∞;
    –ö–æ–Ω–µ—Ü–¶–∏–∫–ª–∞;
    
    –ü–æ–ø—ã—Ç–∫–∞
        –î–æ–∫—É–º–µ–Ω—Ç.–ó–∞–ø–∏—Å–∞—Ç—å();
    –ò—Å–∫–ª—é—á–µ–Ω–∏–µ
        –í—ã–∑–≤–∞—Ç—å–ò—Å–∫–ª—é—á–µ–Ω–∏–µ "–û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞";
    –ö–æ–Ω–µ—Ü–ü–æ–ø—ã—Ç–∫–∏;
    
–ö–æ–Ω–µ—Ü–ü—Ä–æ—Ü–µ–¥—É—Ä—ã

#–ö–æ–Ω–µ—Ü–û–±–ª–∞—Å—Ç–∏

#–û–±–ª–∞—Å—Ç—å –°–ª—É–∂–µ–±–Ω—ã–µ–ü—Ä–æ—Ü–µ–¥—É—Ä—ã–ò–§—É–Ω–∫—Ü–∏–∏

–§—É–Ω–∫—Ü–∏—è –ü–æ–ª—É—á–∏—Ç—å–ù–∞—Å—Ç—Ä–æ–π–∫–∏()
    
    –ù–∞—Å—Ç—Ä–æ–π–∫–∏ = –ù–æ–≤—ã–π –°—Ç—Ä—É–∫—Ç—É—Ä–∞;
    –ù–∞—Å—Ç—Ä–æ–π–∫–∏.–í—Å—Ç–∞–≤–∏—Ç—å("–ü–∞—Ä–∞–º–µ—Ç—Ä1", –ò—Å—Ç–∏–Ω–∞);
    –ù–∞—Å—Ç—Ä–æ–π–∫–∏.–í—Å—Ç–∞–≤–∏—Ç—å("–ü–∞—Ä–∞–º–µ—Ç—Ä2", 100);
    
    –í–æ–∑–≤—Ä–∞—Ç –ù–∞—Å—Ç—Ä–æ–π–∫–∏;
    
–ö–æ–Ω–µ—Ü–§—É–Ω–∫—Ü–∏–∏

#–ö–æ–Ω–µ—Ü–û–±–ª–∞—Å—Ç–∏
    """ * 10  # –î—É–±–ª–∏—Ä—É–µ–º –¥–ª—è –±–æ–ª–µ–µ —Ä–µ–∞–ª—å–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞
    
    profiler = ParserProfiler()
    
    # –ü—Ä–æ—Ñ–∏–ª–∏—Ä—É–µ–º —Ç–µ–∫—É—â–∏–π –ø–∞—Ä—Å–µ—Ä
    result = profiler.profile_current_parser(test_code)
    
    if result:
        # –ê–Ω–∞–ª–∏–∑ bottlenecks
        profiler.find_bottlenecks()
        
        print("\n" + "=" * 70)
        print("‚úÖ –ü—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ")
        print("=" * 70)
        print("\n–°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:")
        print("1. –ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –∫–∞–∫–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∑–∞–Ω–∏–º–∞—é—Ç –±–æ–ª—å—à–µ –≤—Å–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏")
        print("2. –û–ø—Ç–∏–º–∏–∑–∏—Ä—É–π—Ç–µ –∏–º–µ–Ω–Ω–æ –∏—Ö")
        print("3. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–Ω–æ–≤–∞")
        print("4. –ò–∑–º–µ—Ä—å—Ç–µ –†–ï–ê–õ–¨–ù–û–ï —É–ª—É—á—à–µ–Ω–∏–µ")
        print("\n–ë–µ–∑ —ç—Ç–∏—Ö –¥–∞–Ω–Ω—ã—Ö - –ª—é–±—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ —ç—Ç–æ –≥–∞–¥–∞–Ω–∏–µ!")


if __name__ == "__main__":
    main()




