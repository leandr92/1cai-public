# üèÅ Feature Flags / Progressive Rollouts

**–û–±–Ω–æ–≤–ª–µ–Ω–æ:** 16 –Ω–æ—è–±—Ä—è 2025  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ Production (–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –∞–∫—Ç–∏–≤–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –ø–æ—ç—Ç–∞–ø–Ω–æ–≥–æ —Ä–∞—Å–∫–∞—Ç–∞ —Å–µ—Ä–≤–∏—Å–æ–≤)

---

## üéØ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

Feature Flags Service (`src/services/feature_flags.py`) –¥–∞—ë—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –≤–∫–ª—é—á–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å –¥–ª—è –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, —Ç–µ–Ω–∞–Ω—Ç–æ–≤ –∏–ª–∏ –ø—Ä–æ—Ü–µ–Ω—Ç–Ω–æ–π –¥–æ–ª–∏ —Ç—Ä–∞—Ñ–∏–∫–∞ –±–µ–∑ –¥–µ–ø–ª–æ—è –Ω–æ–≤–æ–≥–æ –∫–æ–¥–∞. –°–µ—Ä–≤–∏—Å —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ –ø–∞–º—è—Ç–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∏ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç –≤–Ω–µ—à–Ω–∏—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π.

- üîê –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –±–µ–∑–æ–ø–∞—Å–Ω—ã–π API/CLI (–º–æ–∂–Ω–æ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –≤ –∞–¥–º–∏–Ω–∫—É)
- ‚ö° –ü–æ–¥–¥–µ—Ä–∂–∫–∞ instant toggle –±–µ–∑ —Ä–µ—Å—Ç–∞—Ä—Ç–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
- üõ°Ô∏è –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤–≤–æ–¥–∞ (max_length, whitelist –∑–Ω–∞—á–µ–Ω–∏–π) –∏ structured logging
- üìä –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä–µ–∂–∏–º–æ–≤ **enabled / disabled / beta-users / percentage rollout**

---

## üß© –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```text
FastAPI endpoints ‚Üí FeatureFlagService ‚Üí (in-memory registry)
                                     ‚Üò structured_logging / audit trail
```

- –ö–ª–∞—Å—Å `FeatureFlagService` –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è –∫–∞–∫ singleton (—Å–º. `get_feature_flags()`).
- –ü—Ä–∏–º–µ—Ä—ã —Ñ–ª–∞–≥–æ–≤: `ai_response_caching`, `advanced_code_review`, `copilot_v2`, `distributed_tracing`.
- –ö–∞–∂–¥–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è (register/update/is_enabled) –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è —á–µ—Ä–µ–∑ `StructuredLogger`.

---

## üõ†Ô∏è –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

```python
from src.services.feature_flags import get_feature_flags

flags = get_feature_flags()

if flags.is_enabled("copilot_v2", user_id=current_user.id):
    return run_new_copilot()
return run_legacy_copilot()
```

### –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ñ–ª–∞–≥–∞ –≤ —Ä–∞–Ω—Ç–∞–π–º–µ

```python
flags.update_flag(
    "copilot_v2",
    state=FeatureState.PERCENTAGE,
    percentage=50,
    beta_users=["tenant-admin"]
)
```

---

## üìã Best Practices

1. **–ò–º–µ–Ω–æ–≤–∞–Ω–∏–µ:** –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ snake_case (`copilot_v2`, `ai_response_caching`).
2. **–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:** –∫–ª—é—á–∏/–∑–Ω–∞—á–µ–Ω–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É—Å–µ–∫–∞—é—Ç—Å—è –¥–æ 200 —Å–∏–º–≤–æ–ª–æ–≤.
3. **–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:** —Ö—Ä–∞–Ω–∏—Ç–µ defaults –≤ `FeatureFlagService._init_flags`, overrides ‚Äî –≤ –ë–î/–∫–æ–Ω—Ñ–∏–≥–µ (roadmap).
4. **–ê—É–¥–∏—Ç:** –≤–∫–ª—é—á–∏—Ç–µ —ç–∫—Å–ø–æ—Ä—Ç –ª–æ–≥–æ–≤ –≤ observability-—Å—Ç–µ–∫ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –≤–∫–ª—é—á–µ–Ω–∏–π/–≤—ã–∫–ª—é—á–µ–Ω–∏–π.
5. **CI:** –¥–æ–±–∞–≤—å—Ç–µ unit-—Ç–µ—Å—Ç—ã –Ω–∞ –∫—Ä–∏—Ç–∏—á–Ω—ã–µ —Ñ–ª–∞–≥–∏ (—Å–º. `tests` ‚Äî –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ).

---

## üî≠ Roadmap

- [ ] Persist storage (Redis/PostgreSQL) –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏–π –º–µ–∂–¥—É —Ä–µ—Å—Ç–∞—Ä—Ç–∞–º–∏.
- [ ] REST/Graph API –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ñ–ª–∞–≥–∞–º–∏ –∏–∑ –≤–Ω–µ—à–Ω–∏—Ö —Å–∏—Å—Ç–µ–º.
- [ ] UI-–∫–æ–º–ø–æ–Ω–µ–Ω—Ç –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏.
- [ ] –≠–∫—Å–ø–æ—Ä—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –≤ Terraform/state-as-code.

---

**–î–æ–∫—É–º–µ–Ω—Ç—ã –ø–æ —Ç–µ–º–µ:**  
- `src/services/feature_flags.py` ‚Äî –∏—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥ —Å–µ—Ä–≤–∏—Å–∞  
- `IMPROVEMENTS_PROGRESS.md` ‚Äî –∏—Å—Ç–æ—Ä–∏—è —É–ª—É—á—à–µ–Ω–∏–π Feature Flags  
- `docs/06-features/README.md` ‚Äî –∏–Ω–¥–µ–∫—Å –≤—Å–µ—Ö –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π —Å—Ç–µ–∫–∞

