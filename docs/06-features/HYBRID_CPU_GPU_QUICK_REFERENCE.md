# –ì–∏–±—Ä–∏–¥–Ω—ã–π —Ä–µ–∂–∏–º CPU+GPU - –ë—ã—Å—Ç—Ä–∞—è —Å–ø—Ä–∞–≤–∫–∞

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

```python
from src.services.embedding_service import EmbeddingService

# –í–∫–ª—é—á–∏—Ç—å –≥–∏–±—Ä–∏–¥–Ω—ã–π —Ä–µ–∂–∏–º
service = EmbeddingService(hybrid_mode=True)

# –í–µ–∫—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
embeddings = service.encode(texts)
```

## ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

```bash
# .env
EMBEDDING_HYBRID_MODE=true
EMBEDDING_CACHE_ENABLED=true
EMBEDDING_CACHE_SIZE=1000
EMBEDDING_CACHE_TTL=3600
```

## üìä –¢–æ–ø-10 –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π

### 1. –î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–∞–≥—Ä—É–∑–∫–∏ ‚úÖ
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ EMA –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –±–∞–ª–∞–Ω—Å–∏—Ä—É–π—Ç–µ –Ω–∞–≥—Ä—É–∑–∫—É –º–µ–∂–¥—É CPU/GPU
- –¶–µ–ª—å: GPU 80-95%, CPU 60-80%

### 2. –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ ‚úÖ
- LRU –∫—ç—à —Å TTL –¥–ª—è —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö —Ç–µ–∫—Å—Ç–æ–≤
- –¶–µ–ª—å: Cache hit rate > 70%
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–æ–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ (similarity > 0.95)

### 3. –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π batch splitting ‚úÖ
- –ë–æ–ª—å—à–∏–µ —Ç–µ–∫—Å—Ç—ã (>10KB) ‚Üí GPU
- –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤
- –ú–∏–Ω–∏–º—É–º 20 —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –¥–ª—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏

### 4. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –º–µ—Ç—Ä–∏–∫ ‚úÖ
- Latency p95 < 100ms
- Error rate < 0.1%
- Cache hit rate > 70%
- GPU utilization 80-95%

### 5. Graceful degradation ‚úÖ
- Fallback –Ω–∞ CPU –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö GPU
- Fallback –Ω–∞ GPU –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö CPU
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö fallback —Å–æ–±—ã—Ç–∏–π

### 6. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è batch size
- GPU: 32-128 —ç–ª–µ–º–µ–Ω—Ç–æ–≤
- CPU: 16-64 —ç–ª–µ–º–µ–Ω—Ç–æ–≤
- –ê–¥–∞–ø—Ç–∏—Ä—É–π—Ç–µ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–∞–º—è—Ç–∏

### 7. –°–º–µ—à–∞–Ω–Ω–∞—è —Ç–æ—á–Ω–æ—Å—Ç—å
- FP16 –¥–ª—è GPU (2x —É—Å–∫–æ—Ä–µ–Ω–∏–µ)
- FP32 –¥–ª—è CPU (—Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å)
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ

### 8. –ú–∏–Ω–∏–º–∏–∑–∞—Ü–∏—è –ø–µ—Ä–µ–¥–∞—á–∏ –¥–∞–Ω–Ω—ã—Ö
- –ë–∞—Ç—á–∏—Ä—É–π—Ç–µ –∑–∞–ø—Ä–æ—Å—ã
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ pinned memory
- –ö—ç—à–∏—Ä—É–π—Ç–µ –¥–∞–Ω–Ω—ã–µ –Ω–∞ GPU

### 9. Health checks
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ GPU
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥–µ–ª–µ–π
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –∫—ç—à–∞

### 10. Resource limits
- –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏
- –¢–∞–π–º–∞—É—Ç—ã –¥–ª—è –æ–ø–µ—Ä–∞—Ü–∏–π
- Rate limiting –¥–ª—è –∑–∞—â–∏—Ç—ã

## üìà –ú–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

```python
# –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
stats = service.get_device_stats()
print(f"CPU: {stats['cpu_requests']}")
print(f"GPU: {stats['gpu_requests']}")
print(f"Cache hit rate: {stats['cache_hit_rate']:.2%}")

# –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
perf = service.get_performance_stats()
print(f"CPU avg: {perf['cpu']['avg_time']:.3f}s")
print(f"GPU avg: {perf['gpu']['avg_time']:.3f}s")

# –ö—ç—à
cache = service.get_cache_stats()
print(f"Cache: {cache['size']}/{cache['max_size']}")
```

## üéØ –¶–µ–ª–µ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ (SLO)

| –ú–µ—Ç—Ä–∏–∫–∞ | –¶–µ–ª—å | –ö—Ä–∏—Ç–∏—á–Ω–æ |
|---------|------|----------|
| Latency p95 | < 100ms | > 500ms |
| Latency p99 | < 200ms | > 1000ms |
| Error rate | < 0.1% | > 1% |
| Cache hit rate | > 70% | < 50% |
| GPU utilization | 80-95% | < 50% |
| CPU utilization | 60-80% | > 90% |

## üîß Troubleshooting

### –ü—Ä–æ–±–ª–µ–º–∞: GPU –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
```python
# –ü—Ä–æ–≤–µ—Ä–∫–∞
import torch
print(torch.cuda.is_available())

# Fallback
service = EmbeddingService(hybrid_mode=False)
```

### –ü—Ä–æ–±–ª–µ–º–∞: –ù–∏–∑–∫–∏–π cache hit rate
```python
# –£–≤–µ–ª–∏—á–∏—Ç—å —Ä–∞–∑–º–µ—Ä –∫—ç—à–∞
EMBEDDING_CACHE_SIZE=5000

# –£–≤–µ–ª–∏—á–∏—Ç—å TTL
EMBEDDING_CACHE_TTL=7200
```

### –ü—Ä–æ–±–ª–µ–º–∞: –í—ã—Å–æ–∫–∞—è –ª–∞—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å
```python
# –£–≤–µ–ª–∏—á–∏—Ç—å batch size
embeddings = service.encode(texts, batch_size=64)

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ GPU
embeddings = service.encode(texts, use_device="cuda")
```

## üìö –ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

- **–û—Å–Ω–æ–≤–Ω–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ:** [`HYBRID_CPU_GPU_MODE.md`](HYBRID_CPU_GPU_MODE.md)
- **Best Practices:** [`HYBRID_CPU_GPU_BEST_PRACTICES.md`](HYBRID_CPU_GPU_BEST_PRACTICES.md)

---

**–í–µ—Ä—Å–∏—è:** 1.0  
**–û–±–Ω–æ–≤–ª–µ–Ω–æ:** 2025-01-18

