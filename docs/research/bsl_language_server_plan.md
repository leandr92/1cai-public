# План интеграции bsl-language-server и metadata.js

## Цели

- Включить полнофункциональный AST-пайплайн на базе `bsl-language-server` во все стадии анализа (парсер, датасет, рекомендации).
- Обеспечить управляемый запуск сервиса (Docker/standalone), health-check и fallback.
- Подключить `metadata.js` для генерации офлайн-документации и обогащения Developer Experience.
- Обновить документацию/Makefile, чтобы команде был доступен единый сценарий запуска.

## Текущее состояние

- **Клиент LSP уже есть** (`scripts/parsers/bsl_ast_parser.py`, `parser_integration.py`, `massive_ast_dataset_builder.py`). При отсутствии сервера падаем на regex-parser.
- **Pipeline отсутствует**: нет docker-compose сервиса, нет make-таргета для запуска LS, нет автоматического включения в orchestrator.
- **Документация ограничена**: инструкции лишь упоминают «запустите docker run …». Metadata.js никак не используется.

## План работ

### 1. Подготовка окружения *(в процессе)*

✅ Добавлен сервис `bsl-language-server` в `docker-compose.dev.yml`, make-таргеты `bsl-ls-*`, а парсер теперь читает `BSL_LANGUAGE_SERVER_URL` и честно откатывается на regex при недоступности.  
✅ Добавлен скрипт `scripts/parsers/check_bsl_language_server.py` и make-таргет `bsl-ls-check` для локальной диагностики.  
⬜ Зафиксировать аналогичную конфигурацию для других компоуз-файлов (parser/ci) при необходимости.  
⬜ Документировать требования (Java 17, образ `ghcr.io/1c-syntax/bsl-language-server`).

### 2. Интеграция в анализаторы *(в процессе)*

✅ `scripts/parsers/bsl_ast_parser.py` читает `BSL_LANGUAGE_SERVER_URL`, проверяет здоровье сервиса и автоматически откатывается на regex при недоступности.  
⬜ Обновить `scripts/analysis/tree_sitter_adapter.py` и orchestrator, чтобы при наличии LS пересчитывались AST-метрики, а tree-sitter служил вторым fallback.  
⬜ В `scripts/dataset/massive_ast_dataset_builder.py` и `IntegratedParser` логировать, использовался ли LSP/regex.

### 3. Metadata.js и офлайн-доки

3.1. Исследовать сборку `metadata.js` (Node 18). Подготовить инструкцию по запуску CLI, собрать список поддерживаемых команд.  
3.2. Создать обёртку `scripts/context/generate_metadata_docs.py`, принимающую путь к конфигурации и выгружающую статические HTML/JSON.  
3.3. Расширить Makefile: `make generate-metadata-docs` + ENV `METADATA_JS_CMD`.  
3.4. Описать интеграцию с существующим `generate_docs.py` (объединённый пакет документации).

### 4. Документация и UX

4.1. Обновить `docs/architecture/README.md` и HLD (клиент/сервер схема, зависимости).  
4.2. В `docs/research/alkoleft_inventory.md` добавить ссылку на план и статус интеграции.  
4.3. В корневом `README.md` (блок «Что нового») описать появление AST-пайплайна и офлайн-доков, указать благодарность авторам.

### 5. Тесты и наблюдаемость

5.1. Добавить smoke-тест `pytest`/`scripts/tests` для проверки `/actuator/health` + простого AST-запроса.  
5.2. Ввести prom-метрики: количество AST-запросов, ошибки, fallback rate.  
5.3. Настроить watchdog в orchestrator: если LS недоступен → автоматический fallback + предупреждение в отчетах.

### 6. Риски и fallback

- В случае недоступности LS должна сохраниться работоспособность tree-sitter/regex.
- Для Windows-настроек (без Docker) задокументировать запуск `java -jar …` с отдельным скриптом.
- Задать SLA: LS должен подниматься быстрее 10 секунд, health-check каждые 30 секунд.

## Следующие шаги

1. Создать задачи в issue tracker согласно шагам 1–6 (включая контроль зависимостей).  
2. Подготовить PoC docker-compose + health-check.  
3. После успешного включения LS – приступить к интеграции metadata.js.

> ⚠️ **Предупреждение для команды:** после включения bsl-language-server и обновления парсеров обязательно протестируйте цепочку локально (`make bsl-ls-up`, запуск анализаторов). Если возникают проблемы:
> 1. Повторите шаги по установке/конфигурации (проверка Docker, переменных окружения, портов).
> 2. Изучите логи сервиса (`make bsl-ls-logs`) и убедитесь, что health-check возвращает `{"status":"UP"}`.
> 3. Лишь после самостоятельной диагностики и фиксации симптомов обращайтесь за помощью (через issue/чат), чтобы ускорить решение.
