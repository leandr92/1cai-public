# ADR-0003: Integrate external MCP tooling (platform context, test runner)

- **Date:** 2025-11-10
- **Status:** Proposed
- **Supersedes:** None
- **Superseded by:** _n/a_

## Context

Наш MCP сервер предоставляет внутренние инструменты (поиск метаданных, семантика, генерация кода), но не использует открытые MCP-проекты сообщества:

- [`alkoleft/mcp-bsl-platform-context`](https://github.com/alkoleft/mcp-bsl-platform-context) — сервер, который возвращает платформенный контекст (справка по объектной модели 1С) в формате MCP.
- [`alkoleft/mcp-onec-test-runner`](https://github.com/alkoleft/mcp-onec-test-runner) — сервер, запускающий тесты YAxUnit/Vanessa и публикующий результаты через MCP.

Пользователи IDE (Cursor, VSCode, Claude Desktop) могут сразу получать официальную справку и запускать regression-тесты из IDE, если мы прокинем эти инструменты. В текущем виде им пришлось бы вручную поднимать отдельные MCP сервера и конфигурировать клиента.

## Decision

1. В `src/ai/mcp_server.py` добавлены MCP инструменты:
   - `bsl_platform_context`: прокси к внешнему MCP серверу платформенного контекста.
   - `bsl_test_runner`: прокси к MCP тест-раннеру.
2. В `src/config.Settings` добавлены параметры:
   - `MCP_BSL_CONTEXT_BASE_URL`, `MCP_BSL_CONTEXT_TOOL_NAME`, `MCP_BSL_CONTEXT_AUTH_TOKEN`.
   - `MCP_BSL_TEST_RUNNER_BASE_URL`, `MCP_BSL_TEST_RUNNER_TOOL_NAME`, `MCP_BSL_TEST_RUNNER_AUTH_TOKEN`.
   Значения по умолчанию позволяют конфигурации быть необязательной (инструмент сообщает, что не настроен).
3. MCP сервер проксирует вызовы через HTTP (`/mcp/tools/call`) и возвращает ответ внешнего сервера. При сбое логируется подробное сообщение и возвращается `error`.
4. Документация обновлена:
   - HLD (раздел интеграций) и README содержат описание и благодарность автору @alkoleft.
   - UML диаграмма `integration portfolio` дополнена новыми каналами.

## Consequences

- ✅ IDE-пользователи получают одну точку входа к MCP функционалу (внутренние + внешние инструменты).
- ✅ Мы можем подключать другие MCP проекты без дублирования логики внутри нашего сервера.
- ✅ Конфигурация прозрачна через переменные окружения, легко отключить по умолчанию.
- ⛏ Требуется запуск внешних MCP серверов и их сопровождение (порт, токены).
- ⛏ При недоступности внешнего сервера инструмент вернёт ошибку; необходимо мониторить.

## Notes

- Благодарим @alkoleft и сообщество bia-technologies за открытые MCP решения.
- В дальнейшем можно добавить автоматическую проверку `/mcp` на старте, чтобы заранее предупреждать о неверной конфигурации.

