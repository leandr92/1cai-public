@startuml
title ITS Scraper - Detailed Flow

actor Operator
participant "CLI / Scheduler" as CLI
participant "ITS Scraper\n(Async)" as Scraper
participant "ITS Portal" as ITS
participant "Prometheus" as Prometheus
participant "Local FS" as LocalFS
participant "S3 / MinIO" as Minio
participant "PostgreSQL" as Postgres
participant "Qdrant" as Qdrant

Operator -> CLI : make scrape-its\n(--state-file --resume)
CLI -> Scraper : start()
Scraper -> Prometheus : start_http_server / register metrics

loop Queue Producer
  Scraper -> ITS : GET list page
  Scraper -> Prometheus : its_scraper_requests_total{status="success"}++
  Scraper -> Scraper : adaptive delay update
  Scraper -> Scraper : enqueue article URLs
end

loop Article Consumer
  Scraper -> ITS : GET article page
  Scraper -> Prometheus : its_scraper_requests_total{status="success"}++
  Scraper -> LocalFS : write article.json/md/txt
  alt stream enabled
    Scraper -> Minio : put_object(article.json)
  end
  Scraper -> Postgres : upsert metadata / previous_version
  Scraper -> Qdrant : update embeddings (optional)
  Scraper -> Prometheus : its_scraper_articles_total{state="stored"}++
end

Scraper -> LocalFS : save state.json (remaining queue)
Scraper -> Prometheus : its_scraper_delay_seconds gauge
Scraper -> CLI : exit(status=0)

CLI --> Operator : summary(report)

@enduml

