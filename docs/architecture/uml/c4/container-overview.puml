@startuml container_overview
!include <C4/C4_Container>

LAYOUT_LEFT_RIGHT()
LAYOUT_WITH_LEGEND()

AddElementTag("Core","#e8f4ff","")
AddElementTag("Integration","#fff4e6","")
AddElementTag("Store","#f0f7ff","")
AddElementTag("Ops","#f6fdf3","")

Person(Developer, "1C Developers", "Use IDE and automation")
Person_Ext(Operator, "Business Stakeholders", "Consume dashboards, reports")

System_Boundary(OneCAIStack, "1C AI Stack", "Core") {
  Container(API, "Graph API", "FastAPI", "GraphQL, REST, MCP endpoints", "Core")
  Container(RestGateway, "Realtime Gateway", "Starlette, WebSocket", "Realtime streaming, MCP sessions", "Core")
  Container(Auth, "Auth and RBAC", "OAuth2, JWT", "Identity, service tokens", "Core")
  Container(AdminPortal, "Admin Portal", "React, FastAPI", "Security agent UI, audit management", "Core")

  Container_Boundary(Workers, "Worker Tier") {
    Container(Celery, "Analysis Workers", "Celery", "BSL code analysis, audits", "Core")
    Container(MLPipelines, "ML Pipelines", "Prefect, PyTorch", "Training, evaluation, embeddings", "Core")
    Container(ITSScraper, "ITS Scraper", "Async Python", "Stateful ingestion pipeline", "Core")
    Container(Orchestrator, "Task Orchestrator", "Bash, scripts", "Composite pipelines and CLI", "Core")
  }

  Container_Boundary(DataStores, "Data Stores") {
    ContainerDb(Postgres, "PostgreSQL", "Aurora / RDS", "Relational data, audit, configs", "Store")
    ContainerDb(Neo4j, "Neo4j", "Graph DB", "Code structure and dependencies", "Store")
    ContainerDb(Qdrant, "Qdrant", "Vector DB", "Embeddings for semantic search", "Store")
    ContainerDb(Redis, "Redis", "In-memory", "Cache, rate limit, queues", "Store")
    ContainerDb(Minio, "MinIO", "Object Storage", "Datasets, models, documentation dumps", "Store")
    ContainerDb(ClickHouse, "ClickHouse", "Column Store", "Observability long term metrics", "Store")
  }

  Container_Boundary(Integrations, "Integration Channels", "Integration") {
    Container(EDTPlugin, "EDT Plugin", "Java", "IDE assistant and dashboards", "Integration")
    Container(n8nNode, "n8n Node", "TypeScript", "Workflow automation", "Integration")
    Container(TelegramBot, "Telegram Bot", "Python", "Alerting and chatops", "Integration")
    Container(Marketplace, "Marketplace Extensions", "BSL", "Delivered packages and templates", "Integration")
  }

  Container_Boundary(Ops, "Operations", "Ops") {
    Container(Prometheus, "Prometheus", "Monitoring", "Metrics scrape and alert rules", "Ops")
    Container(Grafana, "Grafana", "Dashboards", "Observability and business analytics", "Ops")
    Container(Alertmanager, "Alertmanager", "Alert routing", "Ops")
    Container(GitHubActions, "CI/CD", "GitHub Actions", "Build, test, deploy, docs", "Ops")
    Container(Faro, "Tracing/Logs", "Tempo / Loki", "Distributed traces and logs", "Ops")
  }
}

Rel(Developer, API, "Graph queries, MCP requests")
Rel(Developer, EDTPlugin, "IDE commands")
Rel(Developer, n8nNode, "Trigger automations")
Rel(Operator, Grafana, "Dashboards, KPIs")

Rel(RestGateway, Redis, "PubSub channels")
Rel(API, Auth, "Authenticate requests")
Rel(API, Postgres, "Persist configs, sessions")
Rel(API, Neo4j, "Read/write dependency graph")
Rel(API, Qdrant, "Vector search")
Rel(API, Redis, "Fast cache, rate limit")
Rel(API, Celery, "Dispatch jobs", "Redis queue")
Rel(API, ITSScraper, "Trigger ingestion")
Rel(Celery, Postgres, "Read/write jobs, audit")
Rel(Celery, Neo4j, "Update graph")
Rel(Celery, Qdrant, "Sync embeddings")
Rel(Celery, Minio, "Store outputs")
Rel(MLPipelines, Minio, "Datasets, models")
Rel(MLPipelines, Qdrant, "Embeddings")
Rel(MLPipelines, Postgres, "Metadata")
Rel(ITSScraper, Minio, "Raw and processed dumps")
Rel(ITSScraper, Postgres, "Article metadata")
Rel(ITSScraper, Prometheus, "Exporter metrics")

Rel(EDTPlugin, API, "Quick analysis, call graph")
Rel(n8nNode, API, "Workflow actions")
Rel(TelegramBot, API, "Chatops, notifications")
Rel(Marketplace, API, "Package listing")
Rel(Marketplace, Minio, "Artifacts hosting")

Rel(Prometheus, API, "Scrape metrics")
Rel(Prometheus, Celery, "Scrape metrics")
Rel(Prometheus, ITSScraper, "Scrape metrics")
Rel(Prometheus, Alertmanager, "Push alerts")
Rel(Alertmanager, TelegramBot, "Escalations")
Rel(GitHubActions, API, "Deploy, test")
Rel(GitHubActions, Celery, "Deploy, test")
Rel(GitHubActions, ITSScraper, "Mock smoke tests")
Rel(Faro, API, "Traces/logs")
Rel(Faro, Celery, "Traces/logs")
Rel(Faro, GitHubActions, "Logs")

SHOW_LEGEND()
@enduml

