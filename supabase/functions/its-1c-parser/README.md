# ITS.1C Parser Edge Function

Edge Function для парсинга контента с сайта its.1c.ru с авторизованным доступом.

## Функциональность

- ✅ Авторизация через сохраненные учетные данные
- ✅ Парсинг HTML контента с использованием регулярных выражений
- ✅ Извлечение документации, примеров кода, типовых решений
- ✅ Обработка разных категорий контента
- ✅ Очистка HTML разметки
- ✅ Сохранение в таблицу `its_1c_knowledge_base`
- ✅ Валидация входа и авторизация
- ✅ CORS заголовки
- ✅ Проверка дубликатов контента

## Параметры запроса

```json
{
  "url": "https://its.1c.ru/db/v838advgdcdplab#content=1:57f3e944ee6111e4a1bc5a9e2b541742",
  "category": "documentation",
  "subcategory": "general", 
  "force_refresh": false,
  "user_id": "uuid пользователя"
}
```

## Поддерживаемые категории

- `documentation` - Документация и руководства
- `api` - API методы и интерфейсы
- `examples` - Примеры кода
- `solutions` - Типовые решения
- `general` - Общий контент

## Авторизация

Функция использует учетные данные из таблицы `encrypted_credentials` для авторизации на its.1c.ru. Убедитесь, что у пользователя есть активные учетные данные для сервиса `its_1c`.

## Структура ответа

Успешный ответ:
```json
{
  "success": true,
  "data": {
    "message": "Контент успешно спарсен и сохранен",
    "content_id": "uuid",
    "title": "Заголовок документа",
    "category": "documentation",
    "code_examples_count": 3,
    "content_length": 15420
  }
}
```

Ошибка:
```json
{
  "error": {
    "code": "PARSING_FAILED",
    "message": "Описание ошибки"
  }
}
```

## Использование

Вызовите Edge Function с POST запросом, указав URL для парсинга и user_id для авторизации:

```javascript
const response = await fetch('/functions/v1/its-1c-parser', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
  },
  body: JSON.stringify({
    url: 'URL_its.1c.ru',
    user_id: 'uuid_пользователя',
    category: 'documentation'
  })
});
```

## Детали реализации

### Парсинг контента

Функция автоматически определяет тип контента по URL и применяет соответствующие методы парсинга:

- `/api/` или `/method/` → API документация
- `/db/` или `/guide/` → Руководства и гайды
- `/code/` или `/example/` → Примеры кода
- Другие → Общий контент

### Обработка ошибок

- Валидация входных данных
- Проверка авторизации
- Обработка HTTP ошибок
- Логирование ошибок парсинга

### Производительность

- Проверка дубликатов по хешу контента
- Кэширование существующего контента
- Опциональное принудительное обновление (`force_refresh: true`)

## Требования

- Supabase проект с настроенными таблицами
- Таблица `encrypted_credentials` с учетными данными its.1c.ru
- Таблица `its_1c_knowledge_base` для хранения контента