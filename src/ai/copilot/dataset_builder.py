"""
BSL Dataset Builder
–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π builder –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –æ–±—É—á–∞—é—â–µ–≥–æ dataset –∏–∑ —Ä–∞–∑–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
"""

import asyncio
import json
from typing import List, Dict, Optional
from pathlib import Path
from datetime import datetime
from src.utils.structured_logging import StructuredLogger

logger = StructuredLogger(__name__).logger


class BSLDatasetBuilder:
    """–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π builder –¥–ª—è BSL dataset"""
    
    def __init__(self, output_dir: str = "datasets/bsl"):
        self.output_dir = Path(output_dir)
        self.output_dir.mkdir(parents=True, exist_ok=True)
        
        self.examples = []
        self.stats = {
            "total_examples": 0,
            "sources": {},
            "categories": {}
        }
    
    async def build_from_postgres(self, db_connection):
        """
        –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –ø—Ä–∏–º–µ—Ä–æ–≤ –∏–∑ PostgreSQL
        
        Queries:
        - functions —Å description –∏ code_preview
        - procedures —Å examples
        - Common patterns
        """
        try:
            # SQL –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è —Ñ—É–Ω–∫—Ü–∏–π —Å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–µ–π
            query = """
            SELECT 
                name,
                description,
                code_preview,
                module_name,
                configuration_name,
                metadata_type
            FROM functions
            WHERE 
                code_preview IS NOT NULL
                AND description IS NOT NULL
                AND LENGTH(code_preview) > 100
                AND LENGTH(code_preview) < 2000
            ORDER BY RANDOM()
            LIMIT 1000
            """
            
            # TODO: –í—ã–ø–æ–ª–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å
            # rows = await db_connection.fetch(query)
            
            # Mock –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏
            rows = []
            
            for row in rows:
                example = {
                    "instruction": f"–°–æ–∑–¥–∞–π —Ñ—É–Ω–∫—Ü–∏—é: {row['description']}",
                    "input": f"–ú–æ–¥—É–ª—å: {row['module_name']}, –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è: {row['configuration_name']}",
                    "output": row['code_preview'],
                    "metadata": {
                        "source": "postgres",
                        "configuration": row['configuration_name'],
                        "type": row['metadata_type'],
                        "module": row['module_name']
                    }
                }
                
                self.examples.append(example)
                self._update_stats("postgres", row['configuration_name'])
            
            logger.info(
                "Extracted examples from PostgreSQL",
                extra={"examples_count": len(rows)}
            )
            
        except Exception as e:
            logger.error(
                "PostgreSQL extraction error",
                extra={
                    "error": str(e),
                    "error_type": type(e).__name__
                },
                exc_info=True
            )
    
    async def build_from_github(self, repos: Optional[List[str]] = None):
        """
        –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ BSL –∫–æ–¥–∞ –∏–∑ –ø—É–±–ª–∏—á–Ω—ã—Ö GitHub —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤
        
        Popular repos:
        - 1C-Company/ssl_*
        - oscript-library/*
        - popular community libraries
        """
        
        default_repos = [
            "1C-Company/ssl_1c_bsl",
            "oscript-library/opm",
            "oscript-library/logos",
            # –î–æ–±–∞–≤–∏—Ç—å –±–æ–ª—å—à–µ –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤
        ]
        
        repos_to_scan = repos or default_repos
        
        for repo in repos_to_scan:
            try:
                await self._process_github_repo(repo)
            except Exception as e:
                logger.error(
                    "Failed to process repo",
                    extra={
                        "repo": repo,
                        "error": str(e),
                        "error_type": type(e).__name__
                    },
                    exc_info=True
                )
        
        logger.info(
            "Processed GitHub repos",
            extra={"repos_count": len(repos_to_scan)}
        )
    
    async def _process_github_repo(self, repo: str):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–¥–Ω–æ–≥–æ GitHub —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è"""
        
        # TODO: GitHub API integration
        # 1. Clone or fetch repo
        # 2. Find all .bsl/.os files
        # 3. Parse functions with comments
        # 4. Create instruction-output pairs
        
        logger.info(
            "Processing repo",
            extra={"repo": repo}
        )
    
    def add_common_patterns(self):
        """
        –î–æ–±–∞–≤–∏—Ç—å —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã BSL
        
        Categories:
        - CRUD –æ–ø–µ—Ä–∞—Ü–∏–∏
        - –†–∞–±–æ—Ç–∞ —Å —Ñ–æ—Ä–º–∞–º–∏
        - HTTP –∑–∞–ø—Ä–æ—Å—ã
        - –†–∞–±–æ—Ç–∞ —Å —Ñ–∞–π–ª–∞–º–∏
        - –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
        - –¶–∏–∫–ª—ã –∏ —É—Å–ª–æ–≤–∏—è
        """
        
        patterns = [
            {
                "category": "CRUD",
                "instruction": "–°–æ–∑–¥–∞–π —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–∞ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞ –ø–æ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏—é",
                "input": "–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫: –ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∞",
                "output": '''
–§—É–Ω–∫—Ü–∏—è –ü–æ–ª—É—á–∏—Ç—å–ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—É–ü–æ–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏—é(–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ) –≠–∫—Å–ø–æ—Ä—Ç
    
    –ó–∞–ø—Ä–æ—Å = –ù–æ–≤—ã–π –ó–∞–ø—Ä–æ—Å;
    –ó–∞–ø—Ä–æ—Å.–¢–µ–∫—Å—Ç = 
    "–í–´–ë–†–ê–¢–¨
    |    –ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∞.–°—Å—ã–ª–∫–∞ –ö–ê–ö –°—Å—ã–ª–∫–∞
    |–ò–ó
    |    –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫.–ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∞ –ö–ê–ö –ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∞
    |–ì–î–ï
    |    –ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∞.–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ = &–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ";
    
    –ó–∞–ø—Ä–æ—Å.–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å–ü–∞—Ä–∞–º–µ—Ç—Ä("–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ", –ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ);
    
    –†–µ–∑—É–ª—å—Ç–∞—Ç = –ó–∞–ø—Ä–æ—Å.–í—ã–ø–æ–ª–Ω–∏—Ç—å();
    
    –ï—Å–ª–∏ –†–µ–∑—É–ª—å—Ç–∞—Ç.–ü—É—Å—Ç–æ–π() –¢–æ–≥–¥–∞
        –í–æ–∑–≤—Ä–∞—Ç –ù–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ;
    –ò–Ω–∞—á–µ
        –í—ã–±–æ—Ä–∫–∞ = –†–µ–∑—É–ª—å—Ç–∞—Ç.–í—ã–±—Ä–∞—Ç—å();
        –í—ã–±–æ—Ä–∫–∞.–°–ª–µ–¥—É—é—â–∏–π();
        –í–æ–∑–≤—Ä–∞—Ç –í—ã–±–æ—Ä–∫–∞.–°—Å—ã–ª–∫–∞;
    –ö–æ–Ω–µ—Ü–ï—Å–ª–∏;
    
–ö–æ–Ω–µ—Ü–§—É–Ω–∫—Ü–∏–∏
'''
            },
            {
                "category": "Forms",
                "instruction": "–°–æ–∑–¥–∞–π –ø—Ä–æ—Ü–µ–¥—É—Ä—É –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è —Ñ–æ—Ä–º—ã —ç–ª–µ–º–µ–Ω—Ç–∞",
                "input": "–ü–∞—Ä–∞–º–µ—Ç—Ä—ã: –≠–ª–µ–º–µ–Ω—Ç (—Å—Å—ã–ª–∫–∞), –¢–æ–ª—å–∫–æ–ü—Ä–æ—Å–º–æ—Ç—Ä (–ë—É–ª–µ–≤–æ)",
                "output": '''
–ü—Ä–æ—Ü–µ–¥—É—Ä–∞ –û—Ç–∫—Ä—ã—Ç—å–§–æ—Ä–º—É–≠–ª–µ–º–µ–Ω—Ç–∞(–≠–ª–µ–º–µ–Ω—Ç, –¢–æ–ª—å–∫–æ–ü—Ä–æ—Å–º–æ—Ç—Ä = –õ–æ–∂—å) –≠–∫—Å–ø–æ—Ä—Ç
    
    –ï—Å–ª–∏ –ù–ï –ó–Ω–∞—á–µ–Ω–∏–µ–ó–∞–ø–æ–ª–Ω–µ–Ω–æ(–≠–ª–µ–º–µ–Ω—Ç) –¢–æ–≥–¥–∞
        –í–æ–∑–≤—Ä–∞—Ç;
    –ö–æ–Ω–µ—Ü–ï—Å–ª–∏;
    
    –ü–∞—Ä–∞–º–µ—Ç—Ä—ã–§–æ—Ä–º—ã = –ù–æ–≤—ã–π –°—Ç—Ä—É–∫—Ç—É—Ä–∞;
    –ü–∞—Ä–∞–º–µ—Ç—Ä—ã–§–æ—Ä–º—ã.–í—Å—Ç–∞–≤–∏—Ç—å("–ö–ª—é—á", –≠–ª–µ–º–µ–Ω—Ç);
    
    –ï—Å–ª–∏ –¢–æ–ª—å–∫–æ–ü—Ä–æ—Å–º–æ—Ç—Ä –¢–æ–≥–¥–∞
        –ü–∞—Ä–∞–º–µ—Ç—Ä—ã–§–æ—Ä–º—ã.–í—Å—Ç–∞–≤–∏—Ç—å("–¢–æ–ª—å–∫–æ–ü—Ä–æ—Å–º–æ—Ç—Ä", –ò—Å—Ç–∏–Ω–∞);
    –ö–æ–Ω–µ—Ü–ï—Å–ª–∏;
    
    –û—Ç–∫—Ä—ã—Ç—å–§–æ—Ä–º—É(
        "–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫." + –≠–ª–µ–º–µ–Ω—Ç.–ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ().–ò–º—è + ".–§–æ—Ä–º–∞–û–±—ä–µ–∫—Ç–∞",
        –ü–∞—Ä–∞–º–µ—Ç—Ä—ã–§–æ—Ä–º—ã
    );
    
–ö–æ–Ω–µ—Ü–ü—Ä–æ—Ü–µ–¥—É—Ä—ã
'''
            },
            {
                "category": "HTTP",
                "instruction": "–°–æ–∑–¥–∞–π —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è GET –∑–∞–ø—Ä–æ—Å–∞ –∫ REST API",
                "input": "URL, –∑–∞–≥–æ–ª–æ–≤–∫–∏, —Ç–∞–π–º–∞—É—Ç",
                "output": '''
–§—É–Ω–∫—Ü–∏—è –í—ã–ø–æ–ª–Ω–∏—Ç—åGET–ó–∞–ø—Ä–æ—Å(URL, –ó–∞–≥–æ–ª–æ–≤–∫–∏ = –ù–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ, –¢–∞–π–º–∞—É—Ç = 30) –≠–∫—Å–ø–æ—Ä—Ç
    
    HTTP–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ = –ù–æ–≤—ã–π HTTP–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ(
        URL,
        ,
        ,
        ,
        ,
        –¢–∞–π–º–∞—É—Ç
    );
    
    HTTP–ó–∞–ø—Ä–æ—Å = –ù–æ–≤—ã–π HTTP–ó–∞–ø—Ä–æ—Å();
    
    –ï—Å–ª–∏ –ó–∞–≥–æ–ª–æ–≤–∫–∏ <> –ù–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ –¢–æ–≥–¥–∞
        –î–ª—è –ö–∞–∂–¥–æ–≥–æ –ó–∞–≥–æ–ª–æ–≤–æ–∫ –ò–∑ –ó–∞–≥–æ–ª–æ–≤–∫–∏ –¶–∏–∫–ª
            HTTP–ó–∞–ø—Ä–æ—Å.–ó–∞–≥–æ–ª–æ–≤–∫–∏.–í—Å—Ç–∞–≤–∏—Ç—å(–ó–∞–≥–æ–ª–æ–≤–æ–∫.–ö–ª—é—á, –ó–∞–≥–æ–ª–æ–≤–æ–∫.–ó–Ω–∞—á–µ–Ω–∏–µ);
        –ö–æ–Ω–µ—Ü–¶–∏–∫–ª–∞;
    –ö–æ–Ω–µ—Ü–ï—Å–ª–∏;
    
    –ü–æ–ø—ã—Ç–∫–∞
        HTTP–û—Ç–≤–µ—Ç = HTTP–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.–ü–æ–ª—É—á–∏—Ç—å(HTTP–ó–∞–ø—Ä–æ—Å);
        
        –†–µ–∑—É–ª—å—Ç–∞—Ç = –ù–æ–≤—ã–π –°—Ç—Ä—É–∫—Ç—É—Ä–∞;
        –†–µ–∑—É–ª—å—Ç–∞—Ç.–í—Å—Ç–∞–≤–∏—Ç—å("–ö–æ–¥–°–æ—Å—Ç–æ—è–Ω–∏—è", HTTP–û—Ç–≤–µ—Ç.–ö–æ–¥–°–æ—Å—Ç–æ—è–Ω–∏—è);
        –†–µ–∑—É–ª—å—Ç–∞—Ç.–í—Å—Ç–∞–≤–∏—Ç—å("–¢–µ–ª–æ", HTTP–û—Ç–≤–µ—Ç.–ü–æ–ª—É—á–∏—Ç—å–¢–µ–ª–æ–ö–∞–∫–°—Ç—Ä–æ–∫—É());
        –†–µ–∑—É–ª—å—Ç–∞—Ç.–í—Å—Ç–∞–≤–∏—Ç—å("–ó–∞–≥–æ–ª–æ–≤–∫–∏", HTTP–û—Ç–≤–µ—Ç.–ó–∞–≥–æ–ª–æ–≤–∫–∏);
        
        –í–æ–∑–≤—Ä–∞—Ç –†–µ–∑—É–ª—å—Ç–∞—Ç;
        
    –ò—Å–∫–ª—é—á–µ–Ω–∏–µ
        –¢–µ–∫—Å—Ç–û—à–∏–±–∫–∏ = –û–ø–∏—Å–∞–Ω–∏–µ–û—à–∏–±–∫–∏();
        –ó–∞–ø–∏—Å—å–ñ—É—Ä–Ω–∞–ª–∞–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏(
            "HTTP.GET",
            –£—Ä–æ–≤–µ–Ω—å–ñ—É—Ä–Ω–∞–ª–∞–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏.–û—à–∏–±–∫–∞,
            ,
            ,
            –¢–µ–∫—Å—Ç–û—à–∏–±–∫–∏
        );
        
        –í—ã–∑–≤–∞—Ç—å–ò—Å–∫–ª—é—á–µ–Ω–∏–µ –¢–µ–∫—Å—Ç–û—à–∏–±–∫–∏;
    –ö–æ–Ω–µ—Ü–ü–æ–ø—ã—Ç–∫–∏;
    
–ö–æ–Ω–µ—Ü–§—É–Ω–∫—Ü–∏–∏
'''
            },
            {
                "category": "Files",
                "instruction": "–ù–∞–ø–∏—à–∏ —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è —á—Ç–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ —Ñ–∞–π–ª–∞",
                "input": "–ü—É—Ç—å –∫ —Ñ–∞–π–ª—É, –∫–æ–¥–∏—Ä–æ–≤–∫–∞",
                "output": '''
–§—É–Ω–∫—Ü–∏—è –ü—Ä–æ—á–∏—Ç–∞—Ç—å–¢–µ–∫—Å—Ç–æ–≤—ã–π–§–∞–π–ª(–ü—É—Ç—å–ö–§–∞–π–ª—É, –ö–æ–¥–∏—Ä–æ–≤–∫–∞ = "UTF-8") –≠–∫—Å–ø–æ—Ä—Ç
    
    –§–∞–π–ª–û–±—ä–µ–∫—Ç = –ù–æ–≤—ã–π –§–∞–π–ª(–ü—É—Ç—å–ö–§–∞–π–ª—É);
    
    –ï—Å–ª–∏ –ù–ï –§–∞–π–ª–û–±—ä–µ–∫—Ç.–°—É—â–µ—Å—Ç–≤—É–µ—Ç() –¢–æ–≥–¥–∞
        –í—ã–∑–≤–∞—Ç—å–ò—Å–∫–ª—é—á–µ–Ω–∏–µ "–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω: " + –ü—É—Ç—å–ö–§–∞–π–ª—É;
    –ö–æ–Ω–µ—Ü–ï—Å–ª–∏;
    
    –¢–µ–∫—Å—Ç–æ–≤—ã–π–î–æ–∫—É–º–µ–Ω—Ç = –ù–æ–≤—ã–π –¢–µ–∫—Å—Ç–æ–≤—ã–π–î–æ–∫—É–º–µ–Ω—Ç;
    
    –ü–æ–ø—ã—Ç–∫–∞
        –¢–µ–∫—Å—Ç–æ–≤—ã–π–î–æ–∫—É–º–µ–Ω—Ç.–ü—Ä–æ—á–∏—Ç–∞—Ç—å(–ü—É—Ç—å–ö–§–∞–π–ª—É, –ö–æ–¥–∏—Ä–æ–≤–∫–∞);
        –í–æ–∑–≤—Ä–∞—Ç –¢–µ–∫—Å—Ç–æ–≤—ã–π–î–æ–∫—É–º–µ–Ω—Ç.–ü–æ–ª—É—á–∏—Ç—å–¢–µ–∫—Å—Ç();
    –ò—Å–∫–ª—é—á–µ–Ω–∏–µ
        –¢–µ–∫—Å—Ç–û—à–∏–±–∫–∏ = –û–ø–∏—Å–∞–Ω–∏–µ–û—à–∏–±–∫–∏();
        –ó–∞–ø–∏—Å—å–ñ—É—Ä–Ω–∞–ª–∞–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏(
            "–ß—Ç–µ–Ω–∏–µ —Ñ–∞–π–ª–∞",
            –£—Ä–æ–≤–µ–Ω—å–ñ—É—Ä–Ω–∞–ª–∞–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏.–û—à–∏–±–∫–∞,
            ,
            ,
            "–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞: " + –ü—É—Ç—å–ö–§–∞–π–ª—É + " - " + –¢–µ–∫—Å—Ç–û—à–∏–±–∫–∏
        );
        
        –í—ã–∑–≤–∞—Ç—å–ò—Å–∫–ª—é—á–µ–Ω–∏–µ –¢–µ–∫—Å—Ç–û—à–∏–±–∫–∏;
    –ö–æ–Ω–µ—Ü–ü–æ–ø—ã—Ç–∫–∏;
    
–ö–æ–Ω–µ—Ü–§—É–Ω–∫—Ü–∏–∏
'''
            },
            {
                "category": "Error Handling",
                "instruction": "–°–æ–∑–¥–∞–π –ø—Ä–æ—Ü–µ–¥—É—Ä—É –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –æ—à–∏–±–æ–∫",
                "input": "–¢–µ–∫—Å—Ç –æ—à–∏–±–∫–∏, –∫–æ–Ω—Ç–µ–∫—Å—Ç, –∫—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å",
                "output": '''
–ü—Ä–æ—Ü–µ–¥—É—Ä–∞ –û–±—Ä–∞–±–æ—Ç–∞—Ç—å–û—à–∏–±–∫—É(–¢–µ–∫—Å—Ç–û—à–∏–±–∫–∏, –ö–æ–Ω—Ç–µ–∫—Å—Ç = "", –ö—Ä–∏—Ç–∏—á–Ω–∞—è = –õ–æ–∂—å) –≠–∫—Å–ø–æ—Ä—Ç
    
    // –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
    –°–æ–æ–±—â–µ–Ω–∏–µ–û—à–∏–±–∫–∏ = –¢–µ–∫—Å—Ç–û—à–∏–±–∫–∏;
    
    –ï—Å–ª–∏ –ó–Ω–∞—á–µ–Ω–∏–µ–ó–∞–ø–æ–ª–Ω–µ–Ω–æ(–ö–æ–Ω—Ç–µ–∫—Å—Ç) –¢–æ–≥–¥–∞
        –°–æ–æ–±—â–µ–Ω–∏–µ–û—à–∏–±–∫–∏ = –ö–æ–Ω—Ç–µ–∫—Å—Ç + ": " + –°–æ–æ–±—â–µ–Ω–∏–µ–û—à–∏–±–∫–∏;
    –ö–æ–Ω–µ—Ü–ï—Å–ª–∏;
    
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —É—Ä–æ–≤–µ–Ω—å
    –£—Ä–æ–≤–µ–Ω—å = ?(–ö—Ä–∏—Ç–∏—á–Ω–∞—è, 
        –£—Ä–æ–≤–µ–Ω—å–ñ—É—Ä–Ω–∞–ª–∞–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏.–û—à–∏–±–∫–∞,
        –£—Ä–æ–≤–µ–Ω—å–ñ—É—Ä–Ω–∞–ª–∞–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏.–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
    );
    
    // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –≤ –∂—É—Ä–Ω–∞–ª
    –ó–∞–ø–∏—Å—å–ñ—É—Ä–Ω–∞–ª–∞–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏(
        "–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫",
        –£—Ä–æ–≤–µ–Ω—å,
        ,
        ,
        –°–æ–æ–±—â–µ–Ω–∏–µ–û—à–∏–±–∫–∏
    );
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    –ï—Å–ª–∏ –ö—Ä–∏—Ç–∏—á–Ω–∞—è –¢–æ–≥–¥–∞
        –í—ã–∑–≤–∞—Ç—å–ò—Å–∫–ª—é—á–µ–Ω–∏–µ –°–æ–æ–±—â–µ–Ω–∏–µ–û—à–∏–±–∫–∏;
    –ò–Ω–∞—á–µ
        –°–æ–æ–±—â–∏—Ç—å(–°–æ–æ–±—â–µ–Ω–∏–µ–û—à–∏–±–∫–∏);
    –ö–æ–Ω–µ—Ü–ï—Å–ª–∏;
    
–ö–æ–Ω–µ—Ü–ü—Ä–æ—Ü–µ–¥—É—Ä—ã
'''
            },
            {
                "category": "Collections",
                "instruction": "–°–æ–∑–¥–∞–π —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –º–∞—Å—Å–∏–≤–∞ –ø–æ —É—Å–ª–æ–≤–∏—é",
                "input": "–ú–∞—Å—Å–∏–≤ –∑–Ω–∞—á–µ–Ω–∏–π, —Ñ—É–Ω–∫—Ü–∏—è-—Ñ–∏–ª—å—Ç—Ä",
                "output": '''
// –§–∏–ª—å—Ç—Ä—É–µ—Ç –º–∞—Å—Å–∏–≤ –ø–æ —É—Å–ª–æ–≤–∏—é
//
// –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
//   –ú–∞—Å—Å–∏–≤ - –ú–∞—Å—Å–∏–≤ - –ò—Å—Ö–æ–¥–Ω—ã–π –º–∞—Å—Å–∏–≤
//   –£—Å–ª–æ–≤–∏–µ–û—Ç–±–æ—Ä–∞ - –°—Ç—Ä–æ–∫–∞ - –£—Å–ª–æ–≤–∏–µ –≤ –≤–∏–¥–µ "–°–≤–æ–π—Å—Ç–≤–æ = –ó–Ω–∞—á–µ–Ω–∏–µ"
//
// –í–æ–∑–≤—Ä–∞—â–∞–µ–º–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ:
//   –ú–∞—Å—Å–∏–≤ - –û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–π –º–∞—Å—Å–∏–≤
//
–§—É–Ω–∫—Ü–∏—è –û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å–ú–∞—Å—Å–∏–≤(–ú–∞—Å—Å–∏–≤, –£—Å–ª–æ–≤–∏–µ–û—Ç–±–æ—Ä–∞) –≠–∫—Å–ø–æ—Ä—Ç
    
    –†–µ–∑—É–ª—å—Ç–∞—Ç = –ù–æ–≤—ã–π –ú–∞—Å—Å–∏–≤;
    
    –î–ª—è –ö–∞–∂–¥–æ–≥–æ –≠–ª–µ–º–µ–Ω—Ç –ò–∑ –ú–∞—Å—Å–∏–≤ –¶–∏–∫–ª
        –ï—Å–ª–∏ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å–£—Å–ª–æ–≤–∏–µ(–≠–ª–µ–º–µ–Ω—Ç, –£—Å–ª–æ–≤–∏–µ–û—Ç–±–æ—Ä–∞) –¢–æ–≥–¥–∞
            –†–µ–∑—É–ª—å—Ç–∞—Ç.–î–æ–±–∞–≤–∏—Ç—å(–≠–ª–µ–º–µ–Ω—Ç);
        –ö–æ–Ω–µ—Ü–ï—Å–ª–∏;
    –ö–æ–Ω–µ—Ü–¶–∏–∫–ª–∞;
    
    –í–æ–∑–≤—Ä–∞—Ç –†–µ–∑—É–ª—å—Ç–∞—Ç;
    
–ö–æ–Ω–µ—Ü–§—É–Ω–∫—Ü–∏–∏

–§—É–Ω–∫—Ü–∏—è –ü—Ä–æ–≤–µ—Ä–∏—Ç—å–£—Å–ª–æ–≤–∏–µ(–≠–ª–µ–º–µ–Ω—Ç, –£—Å–ª–æ–≤–∏–µ)
    
    // –ü—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ - –≤ production –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–æ–ª–Ω—ã–π –ø–∞—Ä—Å–µ—Ä
    –ß–∞—Å—Ç–∏ = –°—Ç—Ä–†–∞–∑–¥–µ–ª–∏—Ç—å(–£—Å–ª–æ–≤–∏–µ, "=");
    
    –ï—Å–ª–∏ –ß–∞—Å—Ç–∏.–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ() <> 2 –¢–æ–≥–¥–∞
        –í–æ–∑–≤—Ä–∞—Ç –õ–æ–∂—å;
    –ö–æ–Ω–µ—Ü–ï—Å–ª–∏;
    
    –°–≤–æ–π—Å—Ç–≤–æ = –°–æ–∫—Ä–õ–ü(–ß–∞—Å—Ç–∏[0]);
    –ó–Ω–∞—á–µ–Ω–∏–µ = –°–æ–∫—Ä–õ–ü(–ß–∞—Å—Ç–∏[1]);
    
    –ü–æ–ø—ã—Ç–∫–∞
        –ó–Ω–∞—á–µ–Ω–∏–µ–≠–ª–µ–º–µ–Ω—Ç–∞ = –≠–ª–µ–º–µ–Ω—Ç[–°–≤–æ–π—Å—Ç–≤–æ];
        –í–æ–∑–≤—Ä–∞—Ç –°—Ç—Ä–æ–∫–∞(–ó–Ω–∞—á–µ–Ω–∏–µ–≠–ª–µ–º–µ–Ω—Ç–∞) = –ó–Ω–∞—á–µ–Ω–∏–µ;
    –ò—Å–∫–ª—é—á–µ–Ω–∏–µ
        –í–æ–∑–≤—Ä–∞—Ç –õ–æ–∂—å;
    –ö–æ–Ω–µ—Ü–ü–æ–ø—ã—Ç–∫–∏;
    
–ö–æ–Ω–µ—Ü–§—É–Ω–∫—Ü–∏–∏
'''
            }
        ]
        
        for pattern in patterns:
            self.examples.append(pattern)
            self._update_stats("patterns", pattern.get("category", "other"))
        
        logger.info(
            "Added common patterns",
            extra={"patterns_count": len(patterns)}
        )
    
    def add_refactoring_examples(self):
        """
        –ü—Ä–∏–º–µ—Ä—ã —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞ –∫–æ–¥–∞
        
        –§–æ—Ä–º–∞—Ç:
        - instruction: "–û—Ç—Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏ —ç—Ç–æ—Ç –∫–æ–¥"
        - input: –ø–ª–æ—Ö–æ–π –∫–æ–¥
        - output: —É–ª—É—á—à–µ–Ω–Ω—ã–π –∫–æ–¥ + –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ
        """
        
        refactoring_examples = [
            {
                "category": "refactoring",
                "instruction": "–û—Ç—Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏ —ç—Ç–æ—Ç –∫–æ–¥: —É–±–µ—Ä–∏ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ",
                "input": '''
–§—É–Ω–∫—Ü–∏—è –ü–æ–ª—É—á–∏—Ç—å–¶–µ–Ω—É–¢–æ–≤–∞—Ä–∞1(–¢–æ–≤–∞—Ä)
    –ó–∞–ø—Ä–æ—Å = –ù–æ–≤—ã–π –ó–∞–ø—Ä–æ—Å;
    –ó–∞–ø—Ä–æ—Å.–¢–µ–∫—Å—Ç = "–í–´–ë–†–ê–¢–¨ –¶–µ–Ω–∞ –ò–ó –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫.–¢–æ–≤–∞—Ä—ã –ì–î–ï –°—Å—ã–ª–∫–∞ = &–¢–æ–≤–∞—Ä";
    –ó–∞–ø—Ä–æ—Å.–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å–ü–∞—Ä–∞–º–µ—Ç—Ä("–¢–æ–≤–∞—Ä", –¢–æ–≤–∞—Ä);
    –†–µ–∑—É–ª—å—Ç–∞—Ç = –ó–∞–ø—Ä–æ—Å.–í—ã–ø–æ–ª–Ω–∏—Ç—å();
    –ï—Å–ª–∏ –ù–ï –†–µ–∑—É–ª—å—Ç–∞—Ç.–ü—É—Å—Ç–æ–π() –¢–æ–≥–¥–∞
        –í—ã–±–æ—Ä–∫–∞ = –†–µ–∑—É–ª—å—Ç–∞—Ç.–í—ã–±—Ä–∞—Ç—å();
        –í—ã–±–æ—Ä–∫–∞.–°–ª–µ–¥—É—é—â–∏–π();
        –í–æ–∑–≤—Ä–∞—Ç –í—ã–±–æ—Ä–∫–∞.–¶–µ–Ω–∞;
    –ò–Ω–∞—á–µ
        –í–æ–∑–≤—Ä–∞—Ç 0;
    –ö–æ–Ω–µ—Ü–ï—Å–ª–∏;
–ö–æ–Ω–µ—Ü–§—É–Ω–∫—Ü–∏–∏

–§—É–Ω–∫—Ü–∏—è –ü–æ–ª—É—á–∏—Ç—å–¶–µ–Ω—É–¢–æ–≤–∞—Ä–∞2(–¢–æ–≤–∞—Ä)
    –ó–∞–ø—Ä–æ—Å = –ù–æ–≤—ã–π –ó–∞–ø—Ä–æ—Å;
    –ó–∞–ø—Ä–æ—Å.–¢–µ–∫—Å—Ç = "–í–´–ë–†–ê–¢–¨ –¶–µ–Ω–∞ –ò–ó –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫.–¢–æ–≤–∞—Ä—ã –ì–î–ï –°—Å—ã–ª–∫–∞ = &–¢–æ–≤–∞—Ä";
    –ó–∞–ø—Ä–æ—Å.–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å–ü–∞—Ä–∞–º–µ—Ç—Ä("–¢–æ–≤–∞—Ä", –¢–æ–≤–∞—Ä);
    –†–µ–∑—É–ª—å—Ç–∞—Ç = –ó–∞–ø—Ä–æ—Å.–í—ã–ø–æ–ª–Ω–∏—Ç—å();
    –ï—Å–ª–∏ –ù–ï –†–µ–∑—É–ª—å—Ç–∞—Ç.–ü—É—Å—Ç–æ–π() –¢–æ–≥–¥–∞
        –í—ã–±–æ—Ä–∫–∞ = –†–µ–∑—É–ª—å—Ç–∞—Ç.–í—ã–±—Ä–∞—Ç—å();
        –í—ã–±–æ—Ä–∫–∞.–°–ª–µ–¥—É—é—â–∏–π();
        –í–æ–∑–≤—Ä–∞—Ç –í—ã–±–æ—Ä–∫–∞.–¶–µ–Ω–∞;
    –ò–Ω–∞—á–µ
        –í–æ–∑–≤—Ä–∞—Ç 0;
    –ö–æ–Ω–µ—Ü–ï—Å–ª–∏;
–ö–æ–Ω–µ—Ü–§—É–Ω–∫—Ü–∏–∏
''',
                "output": '''
// –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥: –û–±—ä–µ–¥–∏–Ω–∏–ª –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–¥ –≤ –æ–¥–Ω—É —Ñ—É–Ω–∫—Ü–∏—é

–§—É–Ω–∫—Ü–∏—è –ü–æ–ª—É—á–∏—Ç—å–¶–µ–Ω—É–¢–æ–≤–∞—Ä–∞(–¢–æ–≤–∞—Ä) –≠–∫—Å–ø–æ—Ä—Ç
    
    –ï—Å–ª–∏ –ù–ï –ó–Ω–∞—á–µ–Ω–∏–µ–ó–∞–ø–æ–ª–Ω–µ–Ω–æ(–¢–æ–≤–∞—Ä) –¢–æ–≥–¥–∞
        –í–æ–∑–≤—Ä–∞—Ç 0;
    –ö–æ–Ω–µ—Ü–ï—Å–ª–∏;
    
    –ó–∞–ø—Ä–æ—Å = –ù–æ–≤—ã–π –ó–∞–ø—Ä–æ—Å;
    –ó–∞–ø—Ä–æ—Å.–¢–µ–∫—Å—Ç = 
    "–í–´–ë–†–ê–¢–¨
    |    –ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∞.–¶–µ–Ω–∞ –ö–ê–ö –¶–µ–Ω–∞
    |–ò–ó
    |    –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫.–ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∞ –ö–ê–ö –ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∞
    |–ì–î–ï
    |    –ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∞.–°—Å—ã–ª–∫–∞ = &–¢–æ–≤–∞—Ä";
    
    –ó–∞–ø—Ä–æ—Å.–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å–ü–∞—Ä–∞–º–µ—Ç—Ä("–¢–æ–≤–∞—Ä", –¢–æ–≤–∞—Ä);
    
    –í—ã–±–æ—Ä–∫–∞ = –ó–∞–ø—Ä–æ—Å.–í—ã–ø–æ–ª–Ω–∏—Ç—å().–í—ã–±—Ä–∞—Ç—å();
    
    –í–æ–∑–≤—Ä–∞—Ç ?(–í—ã–±–æ—Ä–∫–∞.–°–ª–µ–¥—É—é—â–∏–π(), –í—ã–±–æ—Ä–∫–∞.–¶–µ–Ω–∞, 0);
    
–ö–æ–Ω–µ—Ü–§—É–Ω–∫—Ü–∏–∏

// –ò–∑–º–µ–Ω–µ–Ω–∏—è:
// 1. –£–±—Ä–∞–Ω–æ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ - –æ–¥–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è –≤–º–µ—Å—Ç–æ –¥–≤—É—Ö
// 2. –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω–æ—Å—Ç–∏ –≤ –Ω–∞—á–∞–ª–µ
// 3. –£–ø—Ä–æ—â–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ —Å –ø–æ–º–æ—â—å—é —Ç–µ—Ä–Ω–∞—Ä–Ω–æ–≥–æ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞
// 4. –£–ª—É—á—à–µ–Ω–∞ —á–∏—Ç–∞–µ–º–æ—Å—Ç—å –∑–∞–ø—Ä–æ—Å–∞ (—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ)
'''
            },
            {
                "category": "performance",
                "instruction": "–û–ø—Ç–∏–º–∏–∑–∏—Ä—É–π —ç—Ç–æ—Ç –∫–æ–¥: –∏–∑–±–µ–≥–∞–π N+1 –∑–∞–ø—Ä–æ—Å–æ–≤",
                "input": '''
–ü—Ä–æ—Ü–µ–¥—É—Ä–∞ –ó–∞–ø–æ–ª–Ω–∏—Ç—å–¶–µ–Ω—ã–í–¢–∞–±–ª–∏—Ü–µ(–¢–∞–±–ª–∏—á–Ω–∞—è–ß–∞—Å—Ç—å)
    
    –î–ª—è –ö–∞–∂–¥–æ–≥–æ –°—Ç—Ä–æ–∫–∞ –ò–∑ –¢–∞–±–ª–∏—á–Ω–∞—è–ß–∞—Å—Ç—å –¶–∏–∫–ª
        
        –ó–∞–ø—Ä–æ—Å = –ù–æ–≤—ã–π –ó–∞–ø—Ä–æ—Å;
        –ó–∞–ø—Ä–æ—Å.–¢–µ–∫—Å—Ç = "–í–´–ë–†–ê–¢–¨ –¶–µ–Ω–∞ –ò–ó –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫.–ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∞ –ì–î–ï –°—Å—ã–ª–∫–∞ = &–°—Å—ã–ª–∫–∞";
        –ó–∞–ø—Ä–æ—Å.–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å–ü–∞—Ä–∞–º–µ—Ç—Ä("–°—Å—ã–ª–∫–∞", –°—Ç—Ä–æ–∫–∞.–ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∞);
        
        –†–µ–∑—É–ª—å—Ç–∞—Ç = –ó–∞–ø—Ä–æ—Å.–í—ã–ø–æ–ª–Ω–∏—Ç—å();
        –í—ã–±–æ—Ä–∫–∞ = –†–µ–∑—É–ª—å—Ç–∞—Ç.–í—ã–±—Ä–∞—Ç—å();
        
        –ï—Å–ª–∏ –í—ã–±–æ—Ä–∫–∞.–°–ª–µ–¥—É—é—â–∏–π() –¢–æ–≥–¥–∞
            –°—Ç—Ä–æ–∫–∞.–¶–µ–Ω–∞ = –í—ã–±–æ—Ä–∫–∞.–¶–µ–Ω–∞;
        –ö–æ–Ω–µ—Ü–ï—Å–ª–∏;
        
    –ö–æ–Ω–µ—Ü–¶–∏–∫–ª–∞;
    
–ö–æ–Ω–µ—Ü–ü—Ä–æ—Ü–µ–¥—É—Ä—ã
''',
                "output": '''
// –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: –æ–¥–∏–Ω –∑–∞–ø—Ä–æ—Å –≤–º–µ—Å—Ç–æ N –∑–∞–ø—Ä–æ—Å–æ–≤

–ü—Ä–æ—Ü–µ–¥—É—Ä–∞ –ó–∞–ø–æ–ª–Ω–∏—Ç—å–¶–µ–Ω—ã–í–¢–∞–±–ª–∏—Ü–µ(–¢–∞–±–ª–∏—á–Ω–∞—è–ß–∞—Å—Ç—å) –≠–∫—Å–ø–æ—Ä—Ç
    
    // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—ã
    –ú–∞—Å—Å–∏–≤–ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—ã = –ù–æ–≤—ã–π –ú–∞—Å—Å–∏–≤;
    
    –î–ª—è –ö–∞–∂–¥–æ–≥–æ –°—Ç—Ä–æ–∫–∞ –ò–∑ –¢–∞–±–ª–∏—á–Ω–∞—è–ß–∞—Å—Ç—å –¶–∏–∫–ª
        –ï—Å–ª–∏ –ó–Ω–∞—á–µ–Ω–∏–µ–ó–∞–ø–æ–ª–Ω–µ–Ω–æ(–°—Ç—Ä–æ–∫–∞.–ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∞) –¢–æ–≥–¥–∞
            –ú–∞—Å—Å–∏–≤–ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—ã.–î–æ–±–∞–≤–∏—Ç—å(–°—Ç—Ä–æ–∫–∞.–ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∞);
        –ö–æ–Ω–µ—Ü–ï—Å–ª–∏;
    –ö–æ–Ω–µ—Ü–¶–∏–∫–ª–∞;
    
    –ï—Å–ª–∏ –ú–∞—Å—Å–∏–≤–ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—ã.–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ() = 0 –¢–æ–≥–¥–∞
        –í–æ–∑–≤—Ä–∞—Ç;
    –ö–æ–Ω–µ—Ü–ï—Å–ª–∏;
    
    // –û–¥–∏–Ω –∑–∞–ø—Ä–æ—Å –¥–ª—è –≤—Å–µ—Ö –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä
    –ó–∞–ø—Ä–æ—Å = –ù–æ–≤—ã–π –ó–∞–ø—Ä–æ—Å;
    –ó–∞–ø—Ä–æ—Å.–¢–µ–∫—Å—Ç = 
    "–í–´–ë–†–ê–¢–¨
    |    –ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∞.–°—Å—ã–ª–∫–∞ –ö–ê–ö –ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∞,
    |    –ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∞.–¶–µ–Ω–∞ –ö–ê–ö –¶–µ–Ω–∞
    |–ò–ó
    |    –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫.–ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∞ –ö–ê–ö –ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∞
    |–ì–î–ï
    |    –ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∞.–°—Å—ã–ª–∫–∞ –í (&–°–ø–∏—Å–æ–∫–ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—ã)";
    
    –ó–∞–ø—Ä–æ—Å.–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å–ü–∞—Ä–∞–º–µ—Ç—Ä("–°–ø–∏—Å–æ–∫–ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—ã", –ú–∞—Å—Å–∏–≤–ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—ã);
    
    // –°–æ–∑–¥–∞–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞
    –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ–¶–µ–Ω = –ù–æ–≤—ã–π –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ;
    
    –í—ã–±–æ—Ä–∫–∞ = –ó–∞–ø—Ä–æ—Å.–í—ã–ø–æ–ª–Ω–∏—Ç—å().–í—ã–±—Ä–∞—Ç—å();
    –ü–æ–∫–∞ –í—ã–±–æ—Ä–∫–∞.–°–ª–µ–¥—É—é—â–∏–π() –¶–∏–∫–ª
        –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ–¶–µ–Ω.–í—Å—Ç–∞–≤–∏—Ç—å(–í—ã–±–æ—Ä–∫–∞.–ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∞, –í—ã–±–æ—Ä–∫–∞.–¶–µ–Ω–∞);
    –ö–æ–Ω–µ—Ü–¶–∏–∫–ª–∞;
    
    // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ü–µ–Ω—ã
    –î–ª—è –ö–∞–∂–¥–æ–≥–æ –°—Ç—Ä–æ–∫–∞ –ò–∑ –¢–∞–±–ª–∏—á–Ω–∞—è–ß–∞—Å—Ç—å –¶–∏–∫–ª
        –¶–µ–Ω–∞ = –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ–¶–µ–Ω.–ü–æ–ª—É—á–∏—Ç—å(–°—Ç—Ä–æ–∫–∞.–ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∞);
        –ï—Å–ª–∏ –¶–µ–Ω–∞ <> –ù–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ –¢–æ–≥–¥–∞
            –°—Ç—Ä–æ–∫–∞.–¶–µ–Ω–∞ = –¶–µ–Ω–∞;
        –ö–æ–Ω–µ—Ü–ï—Å–ª–∏;
    –ö–æ–Ω–µ—Ü–¶–∏–∫–ª–∞;
    
–ö–æ–Ω–µ—Ü–ü—Ä–æ—Ü–µ–¥—É—Ä—ã

// –£–ª—É—á—à–µ–Ω–∏—è:
// 1. –ü—Ä–æ–±–ª–µ–º–∞ N+1: –≤–º–µ—Å—Ç–æ N –∑–∞–ø—Ä–æ—Å–æ–≤ –≤—ã–ø–æ–ª–Ω—è–µ–º 1 –∑–∞–ø—Ä–æ—Å
// 2. –ò—Å–ø–æ–ª—å–∑—É–µ–º –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –¥–ª—è O(1) –ø–æ–∏—Å–∫–∞ –≤–º–µ—Å—Ç–æ O(N)
// 3. –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤
// 4. –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —É–ª—É—á—à–µ–Ω–∞ –≤ 10-100 —Ä–∞–∑
'''
            }
        ]
        
        for example in refactoring_examples:
            self.examples.append(example)
            self._update_stats("refactoring", example.get("category", "other"))
        
        logger.info(
            "Added refactoring examples",
            extra={"examples_count": len(refactoring_examples)}
        )
    
    def add_optimization_examples(self):
        """–ü—Ä–∏–º–µ—Ä—ã –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏"""
        
        optimization_examples = [
            {
                "category": "query_optimization",
                "instruction": "–û–ø—Ç–∏–º–∏–∑–∏—Ä—É–π —ç—Ç–æ—Ç –∑–∞–ø—Ä–æ—Å",
                "input": '''
–í–´–ë–†–ê–¢–¨
    –î–æ–∫—É–º–µ–Ω—Ç.–ù–æ–º–µ—Ä,
    –î–æ–∫—É–º–µ–Ω—Ç.–î–∞—Ç–∞,
    –î–æ–∫—É–º–µ–Ω—Ç.–ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç.–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ,
    –î–æ–∫—É–º–µ–Ω—Ç.–ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç.–ò–ù–ù,
    –î–æ–∫—É–º–µ–Ω—Ç.–î–æ–≥–æ–≤–æ—Ä.–ù–æ–º–µ—Ä
–ò–ó
    –î–æ–∫—É–º–µ–Ω—Ç.–†–µ–∞–ª–∏–∑–∞—Ü–∏—è–¢–æ–≤–∞—Ä–æ–≤–£—Å–ª—É–≥ –ö–ê–ö –î–æ–∫—É–º–µ–Ω—Ç
–ì–î–ï
    –î–æ–∫—É–º–µ–Ω—Ç.–ü—Ä–æ–≤–µ–¥–µ–Ω = –ò–°–¢–ò–ù–ê
''',
                "output": '''
// –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: –¥–æ–±–∞–≤–ª–µ–Ω—ã –∏–Ω–¥–µ–∫—Å—ã –∏ —É–ø—Ä–æ—â–µ–Ω—ã –æ–±—Ä–∞—â–µ–Ω–∏—è

–í–´–ë–†–ê–¢–¨
    –î–æ–∫—É–º–µ–Ω—Ç.–ù–æ–º–µ—Ä –ö–ê–ö –ù–æ–º–µ—Ä,
    –î–æ–∫—É–º–µ–Ω—Ç.–î–∞—Ç–∞ –ö–ê–ö –î–∞—Ç–∞,
    –ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç—ã–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ.–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –ö–ê–ö –ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ,
    –ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç—ã–ò–ù–ù.–ò–ù–ù –ö–ê–ö –ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–ò–ù–ù,
    –î–æ–≥–æ–≤–æ—Ä—ã–ù–æ–º–µ—Ä.–ù–æ–º–µ—Ä –ö–ê–ö –î–æ–≥–æ–≤–æ—Ä–ù–æ–º–µ—Ä
–ò–ó
    –î–æ–∫—É–º–µ–Ω—Ç.–†–µ–∞–ª–∏–∑–∞—Ü–∏—è–¢–æ–≤–∞—Ä–æ–≤–£—Å–ª—É–≥ –ö–ê–ö –î–æ–∫—É–º–µ–Ω—Ç
    
    –õ–ï–í–û–ï –°–û–ï–î–ò–ù–ï–ù–ò–ï –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫.–ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç—ã –ö–ê–ö –ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç—ã–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ
        –ü–û –î–æ–∫—É–º–µ–Ω—Ç.–ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç = –ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç—ã–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ.–°—Å—ã–ª–∫–∞
    
    –õ–ï–í–û–ï –°–û–ï–î–ò–ù–ï–ù–ò–ï –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫.–ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç—ã –ö–ê–ö –ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç—ã–ò–ù–ù
        –ü–û –î–æ–∫—É–º–µ–Ω—Ç.–ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç = –ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç—ã–ò–ù–ù.–°—Å—ã–ª–∫–∞
    
    –õ–ï–í–û–ï –°–û–ï–î–ò–ù–ï–ù–ò–ï –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫.–î–æ–≥–æ–≤–æ—Ä—ã –ö–ê–ö –î–æ–≥–æ–≤–æ—Ä—ã–ù–æ–º–µ—Ä
        –ü–û –î–æ–∫—É–º–µ–Ω—Ç.–î–æ–≥–æ–≤–æ—Ä = –î–æ–≥–æ–≤–æ—Ä—ã–ù–æ–º–µ—Ä.–°—Å—ã–ª–∫–∞
–ì–î–ï
    –î–æ–∫—É–º–µ–Ω—Ç.–ü—Ä–æ–≤–µ–¥–µ–Ω = –ò–°–¢–ò–ù–ê

// –£–ª—É—á—à–µ–Ω–∏—è:
// 1. –Ø–≤–Ω—ã–µ JOIN –≤–º–µ—Å—Ç–æ —Ç–æ—á–µ—á–Ω–æ–≥–æ –æ–±—Ä–∞—â–µ–Ω–∏—è - –±—ã—Å—Ç—Ä–µ–µ
// 2. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤ –ø–æ –°—Å—ã–ª–∫–µ
// 3. –ê–ª–∏–∞—Å—ã –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª–µ–π
// 4. –ò–∑–±–µ–≥–∞–µ–º –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –æ–±—Ä–∞—â–µ–Ω–∏–π –∫ –ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç
'''
            }
        ]
        
        for example in optimization_examples:
            self.examples.append(example)
            self._update_stats("optimization", example.get("category", "other"))
        
        logger.info(
            "Added optimization examples",
            extra={"examples_count": len(optimization_examples)}
        )
    
    def _update_stats(self, source: str, category: str):
        """–û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É"""
        self.stats["total_examples"] = len(self.examples)
        
        if source not in self.stats["sources"]:
            self.stats["sources"][source] = 0
        self.stats["sources"][source] += 1
        
        if category not in self.stats["categories"]:
            self.stats["categories"][category] = 0
        self.stats["categories"][category] += 1
    
    def save_for_finetuning(self, model_format: str = "alpaca"):
        """
        –°–æ—Ö—Ä–∞–Ω–∏—Ç—å dataset –≤ —Ñ–æ—Ä–º–∞—Ç–µ –¥–ª—è fine-tuning
        
        Formats:
        - alpaca: Alpaca instruction format (—É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π)
        - llama: Meta Llama format
        - openai: OpenAI fine-tuning format
        - huggingface: Hugging Face datasets format
        """
        
        if model_format == "alpaca":
            output_file = self.output_dir / "bsl_alpaca_train.jsonl"
            
            with open(output_file, 'w', encoding='utf-8') as f:
                for example in self.examples:
                    alpaca_format = {
                        "instruction": example.get("instruction", ""),
                        "input": example.get("input", ""),
                        "output": example.get("output", ""),
                        "system": "–¢—ã - —ç–∫—Å–ø–µ—Ä—Ç –ø–æ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ –Ω–∞ —è–∑—ã–∫–µ 1–°:–ü—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ (BSL). –ü–æ–º–æ–≥–∞–µ—à—å –ø–∏—Å–∞—Ç—å –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–π, —á–∏—Ç–∞–µ–º—ã–π –∏ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–¥."
                    }
                    
                    f.write(json.dumps(alpaca_format, ensure_ascii=False) + '\n')
            
            logger.info(
                "Alpaca format saved",
                extra={"output_file": str(output_file), "format": "alpaca"}
            )
        
        elif model_format == "openai":
            output_file = self.output_dir / "bsl_openai_train.jsonl"
            
            with open(output_file, 'w', encoding='utf-8') as f:
                for example in self.examples:
                    openai_format = {
                        "messages": [
                            {
                                "role": "system",
                                "content": "–¢—ã - —ç–∫—Å–ø–µ—Ä—Ç –ø–æ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ –Ω–∞ —è–∑—ã–∫–µ 1–°:–ü—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ (BSL)."
                            },
                            {
                                "role": "user",
                                "content": f"{example['instruction']}\n\n{example.get('input', '')}"
                            },
                            {
                                "role": "assistant",
                                "content": example["output"]
                            }
                        ]
                    }
                    
                    f.write(json.dumps(openai_format, ensure_ascii=False) + '\n')
            
            logger.info(
                "OpenAI format saved",
                extra={"output_file": str(output_file), "format": "openai"}
            )
        
        elif model_format == "huggingface":
            output_file = self.output_dir / "bsl_hf_train.jsonl"
            
            with open(output_file, 'w', encoding='utf-8') as f:
                for example in self.examples:
                    hf_format = {
                        "text": f"<|user|>\n{example['instruction']}\n{example.get('input', '')}\n<|assistant|>\n{example['output']}"
                    }
                    
                    f.write(json.dumps(hf_format, ensure_ascii=False) + '\n')
            
            logger.info(
                "HuggingFace format saved",
                extra={"output_file": str(output_file), "format": "huggingface"}
            )
        
        return str(output_file)
    
    def save_statistics(self):
        """–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É dataset"""
        
        stats_file = self.output_dir / "dataset_stats.json"
        
        with open(stats_file, 'w', encoding='utf-8') as f:
            json.dump({
                **self.stats,
                "generated_at": datetime.utcnow().isoformat(),
                "examples": len(self.examples)
            }, f, ensure_ascii=False, indent=2)
        
        logger.info(
            "Statistics saved",
            extra={"stats_file": str(stats_file)}
        )
        
        return stats_file
    
    def split_dataset(self, train_ratio: float = 0.8):
        """
        –†–∞–∑–¥–µ–ª–∏—Ç—å dataset –Ω–∞ train/val/test
        
        Args:
            train_ratio: –î–æ–ª—è train (default: 80%)
        """
        import random
        
        # Shuffle
        random.shuffle(self.examples)
        
        total = len(self.examples)
        train_size = int(total * train_ratio)
        val_size = int(total * 0.1)
        
        train_examples = self.examples[:train_size]
        val_examples = self.examples[train_size:train_size + val_size]
        test_examples = self.examples[train_size + val_size:]
        
        # Save splits
        splits = {
            "train": train_examples,
            "val": val_examples,
            "test": test_examples
        }
        
        for split_name, examples in splits.items():
            split_file = self.output_dir / f"bsl_{split_name}.jsonl"
            
            with open(split_file, 'w', encoding='utf-8') as f:
                for example in examples:
                    f.write(json.dumps(example, ensure_ascii=False) + '\n')
            
            logger.info(
                "Dataset split saved",
                extra={
                    "split_name": split_name,
                    "examples_count": len(examples),
                    "split_file": str(split_file)
                }
            )
        
        return splits


# CLI usage
async def main():
    """–û—Å–Ω–æ–≤–Ω–æ–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ dataset"""
    
    print("üöÄ Starting BSL Dataset Builder...")
    
    builder = BSLDatasetBuilder()
    
    # 1. –î–æ–±–∞–≤–ª—è–µ–º –æ–±—â–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã
    print("üìù Adding common patterns...")
    builder.add_common_patterns()
    
    # 2. –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–∏–º–µ—Ä—ã —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞
    print("üîß Adding refactoring examples...")
    builder.add_refactoring_examples()
    
    # 3. –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–∏–º–µ—Ä—ã –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
    print("‚ö° Adding optimization examples...")
    builder.add_optimization_examples()
    
    # 4. –ò–∑–≤–ª–µ–∫–∞–µ–º –∏–∑ PostgreSQL (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω)
    # print("üóÑÔ∏è Extracting from PostgreSQL...")
    # await builder.build_from_postgres(db_connection)
    
    # 5. –ò–∑–≤–ª–µ–∫–∞–µ–º –∏–∑ GitHub (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
    # print("üêô Scraping GitHub...")
    # await builder.build_from_github()
    
    print(f"\n‚úÖ Total examples: {len(builder.examples)}")
    
    # 6. –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ —Ä–∞–∑–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–∞—Ö
    print("\nüíæ Saving datasets...")
    
    builder.save_for_finetuning("alpaca")
    builder.save_for_finetuning("openai")
    builder.save_for_finetuning("huggingface")
    
    # 7. –†–∞–∑–¥–µ–ª—è–µ–º –Ω–∞ train/val/test
    print("\nüìä Splitting dataset...")
    builder.split_dataset(train_ratio=0.8)
    
    # 8. –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    print("\nüìà Saving statistics...")
    builder.save_statistics()
    
    print(f"\nüéâ Dataset –≥–æ—Ç–æ–≤! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–∞–ø–∫—É: {builder.output_dir}")
    print(f"\n–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:")
    print(f"- –í—Å–µ–≥–æ –ø—Ä–∏–º–µ—Ä–æ–≤: {builder.stats['total_examples']}")
    print(f"- –ò—Å—Ç–æ—á–Ω–∏–∫–∏: {builder.stats['sources']}")
    print(f"- –ö–∞—Ç–µ–≥–æ—Ä–∏–∏: {builder.stats['categories']}")


if __name__ == "__main__":
    asyncio.run(main())

