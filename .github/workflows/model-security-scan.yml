name: Model Security Scan

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'models/**'
      - 'scripts/download_*.py'
      - '.github/workflows/model-security-scan.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'models/**'
      - 'scripts/download_*.py'
  schedule:
    # –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –º–æ–¥–µ–ª–∏ –∫–∞–∂–¥—É—é –Ω–µ–¥–µ–ª—é (–≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ –≤ 02:00 UTC)
    - cron: '0 2 * * 0'
  workflow_dispatch:  # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫

jobs:
  scan-models:
    name: Scan AI Models for Security Issues
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install modelscan
        run: |
          echo "Installing modelscan..."
          pip install modelscan
          modelscan --version
      
      - name: Scan local models
        id: scan_local
        run: |
          echo "Scanning local model files..."
          
          # –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –æ—Ç—á–µ—Ç–æ–≤
          mkdir -p security-reports
          
          # –°–∫–∞–Ω–∏—Ä—É–µ–º –≤—Å–µ –º–æ–¥–µ–ª–∏ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ models/
          if [ -d "models" ]; then
            echo "Found models directory"
            
            # –°–∫–∞–Ω–∏—Ä—É–µ–º –∫–∞–∂–¥—É—é –º–æ–¥–µ–ª—å
            find models -type f \( -name "*.pt" -o -name "*.pth" -o -name "*.bin" -o -name "*.safetensors" \) | while IFS= read -r model_file; do
              echo "Scanning: $model_file"
              
              # –ó–∞–ø—É—Å–∫–∞–µ–º modelscan
              modelscan -p "$model_file" -o security-reports/$(basename "$model_file").json || {
                echo "‚ö†Ô∏è SECURITY ISSUE DETECTED in $model_file"
                exit 1
              }
              
              echo "‚úì $model_file is safe"
            done
          else
            echo "No models directory found - skipping local scan"
          fi
      
      - name: Scan HuggingFace downloaded models
        id: scan_hf
        run: |
          echo "Scanning HuggingFace cache..."
          
          # HuggingFace –∫–µ—à –æ–±—ã—á–Ω–æ –≤ ~/.cache/huggingface
          HF_CACHE="$HOME/.cache/huggingface/hub"
          
          if [ -d "$HF_CACHE" ]; then
            echo "Found HuggingFace cache: $HF_CACHE"
            
            # –°–∫–∞–Ω–∏—Ä—É–µ–º –º–æ–¥–µ–ª–∏ –∏–∑ –∫–µ—à–∞
            find "$HF_CACHE" -type f \( -name "*.safetensors" -o -name "*.bin" \) | head -n 10 | while IFS= read -r model_file; do
              echo "Scanning cached model: $model_file"
              
              modelscan -p "$model_file" || {
                echo "‚ö†Ô∏è SECURITY ISSUE in cached model: $model_file"
                # –ù–µ –ø—Ä–µ—Ä—ã–≤–∞–µ–º workflow –¥–ª—è –∫–µ—à–∞ (–º–æ–∂–µ—Ç –±—ã—Ç—å —Å—Ç–∞—Ä–∞—è –º–æ–¥–µ–ª—å)
              }
            done
          else
            echo "No HuggingFace cache found"
          fi
      
      - name: Generate security report
        if: always()
        run: |
          echo "Generating security report..."
          
          cat > security-reports/SUMMARY.md << 'EOF'
          # Model Security Scan Report
          
          **Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          **Workflow:** ${{ github.workflow }}
          **Run ID:** ${{ github.run_id }}
          
          ## Scan Results
          
          ### Local Models
          EOF
          
          if [ -d "models" ]; then
            echo "‚úÖ Scanned $(find models -type f \( -name "*.pt" -o -name "*.bin" -o -name "*.safetensors" \) | wc -l) local model files" >> security-reports/SUMMARY.md
          else
            echo "‚ö†Ô∏è No local models found" >> security-reports/SUMMARY.md
          fi
          
          echo "" >> security-reports/SUMMARY.md
          echo "### HuggingFace Cache" >> security-reports/SUMMARY.md
          
          HF_CACHE="$HOME/.cache/huggingface/hub"
          if [ -d "$HF_CACHE" ]; then
            echo "‚úÖ Scanned HuggingFace cache" >> security-reports/SUMMARY.md
          else
            echo "‚ö†Ô∏è No HuggingFace cache found" >> security-reports/SUMMARY.md
          fi
          
          echo "" >> security-reports/SUMMARY.md
          echo "## Recommendations" >> security-reports/SUMMARY.md
          echo "" >> security-reports/SUMMARY.md
          echo "- ‚úÖ Only download models from verified sources" >> security-reports/SUMMARY.md
          echo "- ‚úÖ Check model checksums before use" >> security-reports/SUMMARY.md
          echo "- ‚úÖ Run models in isolated Docker containers" >> security-reports/SUMMARY.md
          echo "- ‚úÖ Monitor outbound network connections from models" >> security-reports/SUMMARY.md
          
          cat security-reports/SUMMARY.md
      
      - name: Upload security reports
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: model-security-reports
          path: security-reports/
          retention-days: 30
      
      - name: Create issue on security failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'üö® Model Security Scan Failed',
              body: `
              ## Security Issue Detected
              
              The automated model security scan has detected potential security issues.
              
              **Workflow:** ${context.workflow}
              **Run ID:** ${context.runId}
              **Branch:** ${context.ref}
              
              ### Action Required
              
              1. Review the security report in the workflow artifacts
              2. Identify and remove malicious models
              3. Update model download sources if needed
              4. Re-run the security scan
              
              ### Resources
              
              - [Model Security Best Practices](https://huggingface.co/docs/hub/security)
              - [ModeScan Documentation](https://github.com/protectai/modelscan)
              
              **This issue was created automatically by the CI/CD pipeline.**
              `,
              labels: ['security', 'ci/cd', 'critical']
            });
            
            console.log(`Created issue #${issue.data.number}`);

  verify-model-sources:
    name: Verify Model Download Sources
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Check model download scripts
        run: |
          echo "Checking model download sources..."
          
          # –°–ø–∏—Å–æ–∫ –¥–æ–≤–µ—Ä–µ–Ω–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
          TRUSTED_SOURCES=(
            "huggingface.co"
            "deepseek-ai"
            "Qwen"
            "sentence-transformers"
            "openai"
          )
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–∫—Ä–∏–ø—Ç—ã –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥–µ–ª–µ–π
          if ls scripts/download_*.py 1> /dev/null 2>&1; then
            for script in scripts/download_*.py; do
              echo "Checking $script..."
              
              # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –¥–æ–≤–µ—Ä–µ–Ω–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
              trusted=false
              for source in "${TRUSTED_SOURCES[@]}"; do
                if grep -q "$source" "$script"; then
                  echo "‚úì $script uses trusted source: $source"
                  trusted=true
                  break
                fi
              done
              
              if [ "$trusted" = false ]; then
                echo "‚ö†Ô∏è WARNING: $script may use untrusted sources"
                echo "Please review manually"
              fi
            done
          fi
      
      - name: Verify requirements.txt models
        run: |
          echo "Checking requirements.txt for model packages..."
          
          if [ -f "requirements.txt" ]; then
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å—Ç–∞–Ω–æ–≤–∫—É –º–æ–¥–µ–ª–µ–π —á–µ—Ä–µ–∑ pip
            if grep -E "(deepseek|transformers|chandra)" requirements.txt; then
              echo "‚úì Found AI model dependencies in requirements.txt"
              
              # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –≤–µ—Ä—Å–∏–∏ (–¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏)
              if grep -E "(deepseek|transformers|chandra).*==.*" requirements.txt; then
                echo "‚úì Model packages have pinned versions (secure)"
              else
                echo "‚ö†Ô∏è WARNING: Some model packages don't have pinned versions"
                echo "Recommendation: Pin versions for security"
              fi
            fi
          fi

  test-model-isolation:
    name: Test Model Isolation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Verify Docker isolation
        run: |
          echo "Checking Docker configuration for model isolation..."
          
          if [ -f "docker-compose.yml" ]; then
            echo "‚úì Found docker-compose.yml"
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º network isolation
            if grep -q "network_mode" docker-compose.yml; then
              echo "‚úì Network mode configured"
            else
              echo "‚ö†Ô∏è Consider adding network isolation for AI services"
            fi
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º resource limits
            if grep -q "mem_limit\|cpus" docker-compose.yml; then
              echo "‚úì Resource limits configured"
            else
              echo "‚ö†Ô∏è Consider adding resource limits for AI services"
            fi
          fi
      
      - name: Check monitoring setup
        run: |
          echo "Checking monitoring for AI model activity..."
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ Prometheus/Grafana
          if [ -f "docker-compose.monitoring.yml" ] || grep -q "prometheus\|grafana" docker-compose.yml; then
            echo "‚úì Monitoring infrastructure found"
          else
            echo "‚ö†Ô∏è Consider adding monitoring for model behavior"
          fi






