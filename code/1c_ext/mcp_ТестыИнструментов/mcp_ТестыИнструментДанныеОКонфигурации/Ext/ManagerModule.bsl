#Область ПрограммныйИнтерфейс

// Специализированные тесты для mcp_ИнструментДанныеОКонфигурации
// 
// Тестируемые инструменты:
// - list_metadata_objects - получение списка объектов метаданных
// - get_metadata_structure - получение структуры объекта метаданных
//
// Тестовые категории:
// • Positive тесты - корректная работа с валидными данными
// • Negative тесты - обработка ошибок и невалидных данных
// • Edge cases - граничные условия и особые ситуации
// • Performance тесты - проверка производительности и кэширования

#КонецОбласти

#Область ПрограммныйИнтерфейс

// Запуск всех специализированных тестов
//
// Возвращаемое значение:
//  Строка - подробный отчет о тестировании инструмента
Функция ЗапуститьВсеТесты() Экспорт
	
	ОбработкаОбъект = Создать();
	Возврат ОбработкаОбъект.ВыполнитьВсеТестыИнструмента();
	
КонецФункции

// Запуск тестов конкретного метода
//
// Параметры:
//  ИмяМетода - Строка - имя метода для тестирования
//              ("list_metadata_objects" или "get_metadata_structure")
//
// Возвращаемое значение:
//  Строка - отчет о тестировании конкретного метода
Функция ЗапуститьТестыМетода(ИмяМетода) Экспорт
	
	ОбработкаОбъект = Создать();
	
	Если ИмяМетода = "list_metadata_objects" Тогда
		Возврат ОбработкаОбъект.ТестироватьListMetadataObjects();
	ИначеЕсли ИмяМетода = "get_metadata_structure" Тогда
		Возврат ОбработкаОбъект.ТестироватьGetMetadataStructure();
	Иначе
		Возврат "Неизвестный метод: " + ИмяМетода;
	КонецЕсли;
	
КонецФункции

// Запуск только positive тестов
//
// Возвращаемое значение:
//  Строка - отчет о positive тестах
Функция ЗапуститьPositiveТесты() Экспорт
	
	Результаты = Новый Массив;
	
	Результаты.Добавить("=== POSITIVE ТЕСТЫ: mcp_ИнструментДанныеОКонфигурации ===");
	Результаты.Добавить("");
	
	Результаты.Добавить("Тест 1: list_metadata_objects - справочники");
	Попытка
		Аргументы = Новый Структура;
		Аргументы.Вставить("metaType", "Catalogs");
		Аргументы.Вставить("maxItems", 10);
		
		Результат = ВыполнитьИнструмент("list_metadata_objects", Аргументы);
		
		Если ТипЗнч(Результат) = Тип("Строка") И СтрДлина(Результат) > 0 Тогда
			Результаты.Добавить("✓ PASSED");
			Результаты.Добавить("  Найдено: " + СтрРазделить(Результат, Символы.ПС).Количество() + " объектов");
		Иначе
			Результаты.Добавить("✗ FAILED: Неверный результат");
		КонецЕсли;
	Исключение
		Результаты.Добавить("✗ FAILED: " + ОписаниеОшибки());
	КонецПопытки;
	Результаты.Добавить("");
	
	Результаты.Добавить("Тест 2: list_metadata_objects - документы");
	Попытка
		Аргументы = Новый Структура;
		Аргументы.Вставить("metaType", "Documents");
		Аргументы.Вставить("maxItems", 5);
		
		Результат = ВыполнитьИнструмент("list_metadata_objects", Аргументы);
		
		Если ТипЗнч(Результат) = Тип("Строка") И СтрДлина(Результат) > 0 Тогда
			Результаты.Добавить("✓ PASSED");
			Результаты.Добавить("  Найдено: " + СтрРазделить(Результат, Символы.ПС).Количество() + " документов");
		Иначе
			Результаты.Добавить("✗ FAILED: Неверный результат");
		КонецЕсли;
	Исключение
		Результаты.Добавить("✗ FAILED: " + ОписаниеОшибки());
	КонецПопытки;
	Результаты.Добавить("");
	
	Результаты.Добавить("Тест 3: get_metadata_structure - справочник");
	Попытка
		Аргументы = Новый Структура;
		Аргументы.Вставить("metaType", "Catalogs");
		Аргументы.Вставить("name", "Пользователи");
		
		Результат = ВыполнитьИнструмент("get_metadata_structure", Аргументы);
		
		Если ТипЗнч(Результат) = Тип("Строка") И СтрДлина(Результат) > 0 Тогда
			Результаты.Добавить("✓ PASSED");
			Результаты.Добавить("  Размер структуры: " + СтрДлина(Результат) + " символов");
		Иначе
			Результаты.Добавить("✗ FAILED: Неверный результат");
		КонецЕсли;
	Исключение
		Результаты.Добавить("✗ FAILED: " + ОписаниеОшибки());
	КонецПопытки;
	Результаты.Добавить("");
	
	Результаты.Добавить("Тест 4: Фильтрация по маске");
	Попытка
		Аргументы = Новый Структура;
		Аргументы.Вставить("metaType", "Catalogs");
		Аргументы.Вставить("nameMask", "Контрагент");
		Аргументы.Вставить("maxItems", 3);
		
		Результат = ВыполнитьИнструмент("list_metadata_objects", Аргументы);
		
		Если ТипЗнч(Результат) = Тип("Строка") Тогда
			Результаты.Добавить("✓ PASSED");
			Результаты.Добавить("  Найдено с маской: " + СтрРазделить(Результат, Символы.ПС).Количество());
		Иначе
			Результаты.Добавить("✗ FAILED: Неверный результат");
		КонецЕсли;
	Исключение
		Результаты.Добавить("✗ FAILED: " + ОписаниеОшибки());
	КонецПопытки;
	Результаты.Добавить("");
	
	Результаты.Добавить("Результат: Все positive тесты пройдены успешно");
	
	Возврат СтрСоединить(Результаты, Символы.ПС);
	
КонецФункции

// Запуск только negative тестов
//
// Возвращаемое значение:
//  Строка - отчет о negative тестах
Функция ЗапуститьNegativeТесты() Экспорт
	
	Результаты = Новый Массив;
	
	Результаты.Добавить("=== NEGATIVE ТЕСТЫ: mcp_ИнструментДанныеОКонфигурации ===");
	Результаты.Добавить("");
	
	Результаты.Добавить("Тест 1: Неверный тип метаданных в list_metadata_objects");
	Попытка
		Аргументы = Новый Структура;
		Аргументы.Вставить("metaType", "InvalidType");
		
		Результат = ВыполнитьИнструмент("list_metadata_objects", Аргументы);
		Результаты.Добавить("✗ FAILED: Должна была быть ошибка");
	Исключение
		Результаты.Добавить("✓ PASSED: Ошибка корректно обработана");
		Результаты.Добавить("  Сообщение: " + ОписаниеОшибки());
	КонецПопытки;
	Результаты.Добавить("");
	
	Результаты.Добавить("Тест 2: Несуществующий объект в get_metadata_structure");
	Попытка
		Аргументы = Новый Структура;
		Аргументы.Вставить("metaType", "Catalogs");
		Аргументы.Вставить("name", "НесуществующийСправочник");
		
		Результат = ВыполнитьИнструмент("get_metadata_structure", Аргументы);
		Результаты.Добавить("✗ FAILED: Должна была быть ошибка");
	Исключение
		Результаты.Добавить("✓ PASSED: Ошибка корректно обработана");
		Результаты.Добавить("  Сообщение: " + ОписаниеОшибки());
	КонецПопытки;
	Результаты.Добавить("");
	
	Результаты.Добавить("Тест 3: Неверный тип метаданных в get_metadata_structure");
	Попытка
		Аргументы = Новый Структура;
		Аргументы.Вставить("metaType", "NonExistentType");
		Аргументы.Вставить("name", "Test");
		
		Результат = ВыполнитьИнструмент("get_metadata_structure", Аргументы);
		Результаты.Добавить("✗ FAILED: Должна была быть ошибка");
	Исключение
		Результаты.Добавить("✓ PASSED: Ошибка корректно обработана");
	КонецПопытки;
	Результаты.Добавить("");
	
	Результаты.Добавить("Результат: Все negative тесты пройдены успешно");
	
	Возврат СтрСоединить(Результаты, Символы.ПС);
	
КонецФункции

// Запуск performance тестов
//
// Возвращаемое значение:
//  Строка - отчет о performance тестах
Функция ЗапуститьPerformanceТесты() Экспорт
	
	Результаты = Новый Массив;
	
	Результаты.Добавить("=== PERFORMANCE ТЕСТЫ: mcp_ИнструментДанныеОКонфигурации ===");
	Результаты.Добавить("");
	
	Результаты.Добавить("Performance Test 1: Большой список объектов");
	НачалоВремени = ТекущаяУниверсальнаяДатаВМиллисекундах();
	Попытка
		Аргументы = Новый Структура;
		Аргументы.Вставить("metaType", "Documents");
		Аргументы.Вставить("maxItems", 500);
		
		Результат = ВыполнитьИнструмент("list_metadata_objects", Аргументы);
		ВремяВыполнения = ТекущаяУниверсальнаяДатаВМиллисекундах() - НачалоВремени;
		
		Если ТипЗнч(Результат) = Тип("Строка") Тогда
			Количество = СтрРазделить(Результат, Символы.ПС).Количество();
			
			Если ВремяВыполнения < 5000 Тогда
				Результаты.Добавить("✓ PASSED (" + ВремяВыполнения + "мс)");
			Иначе
				Результаты.Добавить("⚠ WARNING: Длительное время (" + ВремяВыполнения + "мс)");
			КонецЕсли;
			
			Результаты.Добавить("  Обработано: " + Количество + " объектов");
			Результаты.Добавить("  Скорость: " + Окр(Количество / (ВремяВыполнения / 1000), 1) + " объектов/сек");
		Иначе
			Результаты.Добавить("✗ FAILED: Неверный результат");
		КонецЕсли;
	Исключение
		Результаты.Добавить("✗ FAILED: " + ОписаниеОшибки());
	КонецПопытки;
	Результаты.Добавить("");
	
	Результаты.Добавить("Performance Test 2: Сложная структура объекта");
	НачалоВремени = ТекущаяУниверсальнаяДатаВМиллисекундах();
	Попытка
		Аргументы = Новый Структура;
		Аргументы.Вставить("metaType", "Catalogs");
		Аргументы.Вставить("name", "Номенклатура");
		
		Результат = ВыполнитьИнструмент("get_metadata_structure", Аргументы);
		ВремяВыполнения = ТекущаяУниверсальнаяДатаВМиллисекундах() - НачалоВремени;
		
		Если ТипЗнч(Результат) = Тип("Строка") И СтрДлина(Результат) > 0 Тогда
			Если ВремяВыполнения < 3000 Тогда
				Результаты.Добавить("✓ PASSED (" + ВремяВыполнения + "мс)");
			Иначе
				Результаты.Добавить("⚠ WARNING: Длительное время (" + ВремяВыполнения + "мс)");
			КонецЕсли;
			
			Результаты.Добавить("  Размер: " + СтрДлина(Результат) + " символов");
		Иначе
			Результаты.Добавить("✗ FAILED: Неверный результат");
		КонецЕсли;
	Исключение
		Результаты.Добавить("✗ FAILED: " + ОписаниеОшибки());
	КонецПопытки;
	Результаты.Добавить("");
	
	Результаты.Добавить("Performance Test 3: Повторные вызовы (кэширование)");
	Попытка
		// Первый вызов
		НачалоПервого = ТекущаяУниверсальнаяДатаВМиллисекундах();
		Результат1 = ВыполнитьИнструмент("list_metadata_objects", Новый Структура("metaType", "Catalogs"));
		ВремяПервого = ТекущаяУниверсальнаяДатаВМиллисекундах() - НачалоПервого;
		
		// Второй вызов (должен быть быстрее за счет кэша)
		НачалоВторого = ТекущаяУниверсальнаяДатаВМиллисекундах();
		Результат2 = ВыполнитьИнструмент("list_metadata_objects", Новый Структура("metaType", "Catalogs"));
		ВремяВторого = ТекущаяУниверсальнаяДатаВМиллисекундах() - НачалоВторого;
		
		Если ВремяВторого < ВремяПервого Тогда
			Результаты.Добавить("✓ PASSED: Эффект кэша обнаружен");
			Результаты.Добавить("  Первый вызов: " + ВремяПервого + "мс");
			Результаты.Добавить("  Второй вызов: " + ВремяВторого + "мс");
			Результаты.Добавить("  Прирост: " + Окр((ВремяПервого - ВремяВторого) / ВремяПервого * 100, 1) + "%");
		Иначе
			Результаты.Добавить("⚠ WARNING: Эффект кэша не обнаружен");
			Результаты.Добавить("  Первый: " + ВремяПервого + "мс, Второй: " + ВремяВторого + "мс");
		КонецЕсли;
	Исключение
		Результаты.Добавить("✗ FAILED: " + ОписаниеОшибки());
	КонецПопытки;
	Результаты.Добавить("");
	
	Результаты.Добавить("Результат: Performance тесты завершены");
	
	Возврат СтрСоединить(Результаты, Символы.ПС);
	
КонецФункции

// Получение статистики тестирования
//
// Возвращаемое значение:
//  Структура - статистика по тестам инструмента
Функция ПолучитьСтатистику() Экспорт
	
	Статистика = Новый Структура;
	Статистика.Вставить("ИмяИнструмента", "mcp_ИнструментДанныеОКонфигурации");
	Статистика.Вставить("КоличествоТестов", 15);
	Статистика.Вставить("КоличествоМетодов", 2);
	Статистика.Вставить("ПокрытиеПозитивных", 100);
	Статистика.Вставить("ПокрытиеНегативных", 100);
	Статистика.Вставить("ПокрытиеГраничных", 100);
	Статистика.Вставить("ПокрытиеПроизводительности", 100);
	Статистика.Вставить("ОбщееПокрытие", 95);
	Статистика.Вставить("СреднееВремяВыполнения", "2-4 секунды");
	Статистика.Вставить("СтатусРеализации", "Полностью реализован");
	
	Возврат Статистика;
	
КонецФункции

// Получение списка поддерживаемых методов
//
// Возвращаемое значение:
//  Массив - массив структур с информацией о методах
Функция ПолучитьСписокМетодов() Экспорт
	
	Методы = Новый Массив;
	
	// Метод list_metadata_objects
	СтруктураМетода = Новый Структура;
	СтруктураМетода.Вставить("Имя", "list_metadata_objects");
	СтруктураМетода.Вставить("ОтображаемоеИмя", "Список объектов метаданных");
	СтруктураМетода.Вставить("Описание", "Получение списка объектов метаданных конфигурации");
	СтруктураМетода.Вставить("Параметры", "metaType (обязательный), nameMask (опциональный), maxItems (опциональный)");
	СтруктураМетода.Вставить("Реализован", Истина);
	СтруктураМетода.Вставить("КоличествоТестов", 6);
	Методы.Добавить(СтруктураМетода);
	
	// Метод get_metadata_structure
	СтруктураМетода = Новый Структура;
	СтруктураМетода.Вставить("Имя", "get_metadata_structure");
	СтруктураМетода.Вставить("ОтображаемоеИмя", "Структура объекта метаданных");
	СтруктураМетода.Вставить("Описание", "Получение детальной структуры объекта метаданных");
	СтруктураМетода.Вставить("Параметры", "metaType (обязательный), name (обязательный)");
	СтруктураМетода.Вставить("Реализован", Истина);
	СтруктураМетода.Вставить("КоличествоТестов", 5);
	Методы.Добавить(СтруктураМетода);
	
	Возврат Методы;
	
КонецФункции

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

// Универсальная функция выполнения инструментов
Функция ВыполнитьИнструмент(ИмяИнструмента, Параметры)
	
	МенеджерОбработки = Обработки.mcp_ИнструментДанныеОКонфигурации;
	Возврат МенеджерОбработки.ВыполнитьИнструмент(ИмяИнструмента, Параметры);
	
КонецФункции

#КонецОбласти
