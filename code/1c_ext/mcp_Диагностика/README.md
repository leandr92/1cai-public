# Модуль Расширенной Диагностики и Трассировки для 1С

## Описание

Модуль `mcp_Диагностика` предоставляет комплексную систему для диагностики, трассировки и мониторинга производительности в 1С. Модуль позволяет отслеживать выполнение операций, анализировать ошибки, измерять производительность и получать рекомендации по оптимизации.

## Основные Возможности

### 1. Трассировка Стека Вызовов
- **Функция**: `ПолучитьСтекВызовов()`
- Получение детальной трассировки с указанием модулей, процедур и номеров строк
- Форматирование в читаемый вид для разработчиков
- Сохранение контекста операции (параметры, переменные)

### 2. Контекст Операции
- **Функция**: `СоздатьКонтекстОперации()`
- Структура с полями:
  - `ИдентификаторОперации` - уникальный идентификатор
  - `Пользователь` - текущий пользователь
  - `ВремяНачала/ВремяОкончания` - временные метки
  - `ПараметрыВхода/Результат` - входные и выходные данные
  - `СостояниеСистемы` - нагрузка, память, количество сеансов
  - `КомпонентыСистемы` - версии модулей и конфигурации

### 3. Дедупликация Ошибок
- **Функция**: `ВычислитьХешОшибки()`
- Алгоритм вычисления хэша по стеку и контексту
- Группировка похожих ошибок
- Подсчет частоты возникновения
- Автоматическое подавление дубликатов

### 4. Метрики Производительности
- Измерение времени выполнения операций
- Мониторинг использования памяти
- Подсчет количества операций в секунду
- Анализ узких мест производительности

### 5. Интеграция с Логированием
- Обогащение логов диагностической информацией
- Структурированный вывод stack trace
- Связь с correlation_id для трассировки
- Автоматическая сборка контекста

### 6. Инструменты для Разработчиков
- **Функция**: `ПолучитьОтчетПоПроизводительности()` - отчет по производительности
- **Функция**: `ПолучитьАнализЧастыхОшибок()` - анализ частых ошибок
- **Функция**: `ПолучитьРекомендацииПоОптимизации()` - рекомендации по оптимизации
- Отладка в режиме консоли

## Использование

### Базовый пример использования

```bsl
// Создание контекста операции
Контекст = mcp_Диагностика.СоздатьКонтекстОперации("ВыполнениеОтчета", 
    Новый Структура("Отчет, Период", "Продажи", "2025"));

Попытка
    // Выполнение основной логики
    Результат = ВыполнитьОтчет("Продажи", "2025");
    
    // Завершение с успешным результатом
    mcp_Диагностика.ЗавершитьКонтекстОперации(Контекст, Результат);
    
Исключение
    // Завершение с ошибкой
    mcp_Диагностика.ЗавершитьКонтекстОперации(Контекст, , Истина, ОписаниеОшибки());
КонецПопытки;
```

### Получение стека вызовов

```bsl
Стек = mcp_Диагностика.ПолучитьСтекВызовов();

Для Каждого Элемент Из Стека.Элементы Цикл
    Сообщить(Элемент.Модуль + "." + Элемент.Процедура + " (строка " + Элемент.НомерСтроки + ")");
КонецЦикла;
```

### Анализ производительности

```bsl
// Получение отчета по производительности за последний час
Отчет = mcp_Диагностика.ПолучитьОтчетПоПроизводительности(60);

Для Каждого КлючЗначение Из Отчет.СтатистикаОпераций Цикл
    Статистика = КлючЗначение.Значение;
    Сообщить("Операция: " + КлючЗначение.Ключ);
    Сообщить("Среднее время: " + Статистика.СреднееВремя + " сек");
    Сообщить("Количество вызовов: " + Статистика.КоличествоВызовов);
КонецЦикла;
```

### Анализ частых ошибок

```bsl
АнализОшибок = mcp_Диагностика.ПолучитьАнализЧастыхОшибок();

Для Каждого ЧастаяОшибка Из АнализОшибок.ЧастыеОшибки Цикл
    Сообщить("Хеш ошибки: " + ЧастаяОшибка.ХешОшибки);
    Сообщить("Количество вхождений: " + ЧастаяОшибка.КоличествоВхождений);
    Сообщить("Частота в час: " + ЧастаяОшибка.ЧастотаВЧас);
КонецЦикла;
```

### Получение рекомендаций по оптимизации

```bsl
Рекомендации = mcp_Диагностика.ПолучитьРекомендацииПоОптимизации();

Для Каждого Рекомендация Из Рекомендации Цикл
    Сообщить("Тип: " + Рекомендация.Тип);
    Сообщить("Приоритет: " + Рекомендация.Приоритет);
    Сообщить("Описание: " + Рекомендация.Описание);
КонецЦикла;
```

## Структура Данных

### КонтекстОперации
```bsl
Структура = {
    "ИдентификаторОперации": "Строка",
    "Пользователь": "Строка", 
    "ВремяНачала": "Дата",
    "ВремяОкончания": "Дата",
    "ПараметрыВхода": "Структура",
    "Результат": "Произвольный",
    "СостояниеОшибки": "Булево",
    "СообщениеОбОшибке": "Строка",
    "СтекВызовов": "Структура",
    "ВремяВыполнения": "Число",
    "ХешОшибки": "Строка",
    "СостояниеСистемы": "Структура",
    "КомпонентыСистемы": "Структура"
}
```

### ЭлементСтека
```bsl
Структура = {
    "Модуль": "Строка",
    "Процедура": "Строка", 
    "НомерСтроки": "Число",
    "СтрокаКода": "Строка",
    "ПолныйПуть": "Строка",
    "Уровень": "Число"
}
```

## Глобальные Переменные

Модуль использует глобальные переменные для хранения данных:
- `ГлобальныеПеременные.МетрикиПроизводительности` - массив метрик
- `ГлобальныеПеременные.СчетчикиОшибок` - соответствие счетчиков ошибок

## Ограничения

- Массив метрик ограничен последними 1000 записями
- Детализированный стек подавляется для часто повторяющихся ошибок (более 10 раз)
- Доступ к тексту модулей может быть ограничен правами пользователя

## Интеграция

Модуль интегрируется с другими компонентами системы:
- **mcp_Логирование** - для структурированного вывода
- **mcp_СообщенияОбОшибках** - для обработки исключений
- **mcp_Тестирование** - для мониторинга тестов

## Производительность

- Минимальное влияние на производительность при нормальных условиях
- Автоматическая оптимизация при частых ошибках
- Ограничение размера хранимых данных

## Примеры Сценариев

### 1. Мониторинг критической операции
```bsl
Контекст = mcp_Диагностика.СоздатьКонтекстОперации("КритическаяОперация", Параметры);
Попытка
    Результат = ВыполнитьКритическуюОперацию();
    mcp_Диагностика.ЗавершитьКонтекстОперации(Контекст, Результат);
Исключение
    mcp_Диагностика.ЗавершитьКонтекстОперации(Контекст, , Истина, ОписаниеОшибки());
КонецПопытки;
```

### 2. Анализ производительности в конце дня
```bsl
// Получаем рекомендации за рабочий день
Рекомендации = mcp_Диагностика.ПолучитьРекомендацииПоОптимизации();

// Фильтруем критические рекомендации
Для Каждого Рекомендация Из Рекомендации Цикл
    Если Рекомендация.Приоритет = "Критический" Тогда
        // Отправляем уведомление администратору
        ОтправитьУведомление(Рекомендация);
    КонецЕсли;
КонецЦикла;
```

### 3. Дедупликация ошибок
```bsl
// При возникновении ошибки автоматически создается хеш
Контекст = mcp_Диагностика.СоздатьКонтекстОперации("ТестоваяОперация");
mcp_Диагностика.ЗавершитьКонтекстОперации(Контекст, , Истина, "Тестовая ошибка");

// Повторная та же ошибка будет иметь тот же хеш
Контекст2 = mcp_Диагностика.СоздатьКонтекстОперации("ТестоваяОперация");
mcp_Диагностика.ЗавершитьКонтекстОперации(Контекст2, , Истина, "Тестовая ошибка");

// При анализе частых ошибок обе будут сгруппированы по хешу
```


Модуль разработан как часть системы mcp (Модульные Компоненты для Производительности) для 1С.

## Лицензия

Внутреннее использование в рамках проекта.