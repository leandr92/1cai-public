# Примеры использования модуля кэширования mcp_Кэширование

## Базовые операции с кэшем

```1c
// ========================================
// УСТАНОВКА И ПОЛУЧЕНИЕ ДАННЫХ
// ========================================

// Установка простых данных
ДанныеПользователя = Новый Структура;
ДанныеПользователя.Вставить("Имя", "Иванов И.И.");
ДанныеПользователя.Вставить("Роль", "Администратор");
ДанныеПользователя.Вставить("ДатаВхода", ТекущаяДата());

ИдентификаторЗапроса = "req_" + Строка(Новый УникальныйИдентификатор);
Результат = mcp_Кэширование.УстановитьВКэш(
    "пользователь_123", 
    ДанныеПользователя, 
    3600, // TTL 1 час
    ИдентификаторЗапроса,
    "пользовательские_данные"
);

// Получение данных из кэша
КэшированныеДанные = mcp_Кэширование.ПолучитьИзКэша("пользователь_123", ИдентификаторЗапроса);

Если КэшированныеДанные <> Неопределено Тогда
    Сообщить("Данные получены из кэша: " + КэшированныеДанные.Имя);
Иначе
    Сообщить("Данные отсутствуют в кэше или истекли");
КонецЕсли;

// ========================================
// РАБОТА С МЕТАДАННЫМИ КОНФИГУРАЦИИ
// ========================================

// Получение кэша метаданных конфигурации (TTL = 1 час)
Метаданные = mcp_Кэширование.ПолучитьКэшМетаданныхКонфигурации(ИдентификаторЗапроса);

Если Метаданные.Количество() > 0 Тогда
    Сообщить("Количество инструментов в кэше: " + Метаданные.Количество());
КонецЕсли;

// ========================================
// ETag И ВАЛИДАЦИЯ КЭША
// ========================================

// Создание ETag для валидации
Контент = Новый Структура;
Контент.Вставить("Версия", "1.0");
Контент.Вставить("Данные", "Important data content");

ETag = mcp_Кэширование.СоздатьETag(Контент, ИдентификаторЗапроса);
Сообщить("Создан ETag: " + ETag);

// Проверка валидности ETag
Валиден = mcp_Кэширование.ПроверитьETag(Контент, ETag, ИдентификаторЗапроса);
Сообщить("ETag валиден: " + ?(Валиден, "Да", "Нет"));

// ========================================
// УДАЛЕНИЕ И ОЧИСТКА
// ========================================

// Удаление конкретного ключа
УспешноУдалено = mcp_Кэширование.УдалитьИзКэша("пользователь_123", ИдентификаторЗапроса);

// Частичная очистка по префиксу
УдаленоЗаписей = mcp_Кэширование.ОчиститьКэш("пользователь_", ИдентификаторЗапроса);
Сообщить("Удалено записей с префиксом 'пользователь_': " + УдаленоЗаписей);

// Полная очистка кэша
УдаленоВсего = mcp_Кэширование.ОчиститьКэш("", ИдентификаторЗапроса);
Сообщить("Удалено всего записей: " + УдаленоВсего);

// ========================================
// ИНВАЛИДАЦИЯ ПО СОБЫТИЯМ
// ========================================

// Обновление конфигурации - очищаем кэш метаданных
mcp_Кэширование.ИнвалидироватьКэшПоСобытию("обновление_конфигурации", , ИдентификаторЗапроса);

// Обновление данных - очищаем кэш по типам
ДанныеСобытия = Новый Структура;
ДанныеСобытия.Вставить("ТипыОбъектов", Новый Массив);
ДанныеСобытия.ТипыОбъектов.Добавить("Справочники");
ДанныеСобытия.ТипыОбъектов.Добавить("Документы");

mcp_Кэширование.ИнвалидироватьКэшПоСобытию("обновление_данных", ДанныеСобытия, ИдентификаторЗапроса);

// Регламентная очистка истекшего кэша
mcp_Кэширование.ИнвалидироватьКэшПоСобытию("регламентная_очистка", , ИдентификаторЗапроса);

// ========================================
// СТАТИСТИКА И МОНИТОРИНГ
// ========================================

// Получение статистики кэша
Статистика = mcp_Кэширование.ПолучитьСтатистикуКэша(ИдентификаторЗапроса);

Сообщить("Статистика кэша:");
Сообщить("- Всего записей: " + Статистика.КоличествоЗаписей);
Сообщить("- Активные записи: " + Статистика.АктивныеЗаписи);
Сообщить("- Истекшие записи: " + Статистика.ИстекшиеЗаписи);
Сообщить("- Время получения: " + Статистика.ВремяПолучения);

// ========================================
// ОБРАБОТКА ОШИБОК
// ========================================

// Пример с корректной обработкой ошибок
Попытка
    // Устанавливаем большие данные в кэш
    БольшиеДанные = Новый Массив;
    Для Индекс = 1 По 1000 Цикл
        БольшиеДанные.Добавить("Элемент_" + Индекс);
    КонецЦикла;
    
    Результат = mcp_Кэширование.УстановитьВКэш(
        "большие_данные", 
        БольшиеДанные, 
        1800, // 30 минут
        ИдентификаторЗапроса,
        "массив_данных"
    );
    
    Если Не Результат Тогда
        Сообщить("Не удалось сохранить данные в кэш");
    КонецЕсли;
    
Исключение
    // Ошибки уже логируются внутри модуля
    Сообщить("Произошла ошибка при работе с кэшем");
КонецПопытки;
```

## Продвинутые сценарии использования

### Кэширование результатов запросов к базе данных

```1c
// Функция с кэшированием результатов запроса
Функция ПолучитьДанныеОтчетаСТехПоддержкой(ДатаНачала, ДатаОкончания, ИдентификаторЗапроса)
    
    КлючКэша = "отчет_техподдержки_" + Формат(ДатаНачала, "ДФ=yyyyMMdd") + "_" + Формат(ДатаОкончания, "ДФ=yyyyMMdd");
    
    // Проверяем кэш
    КэшированныйРезультат = mcp_Кэширование.ПолучитьИзКэша(КлючКэша, ИдентификаторЗапроса);
    
    Если КэшированныйРезультат <> Неопределено Тогда
        ЗаписатьЛог("INFO", "Отчет получен из кэша", ИдентификаторЗапроса, КлючКэша, "");
        Возврат КэшированныйРезультат;
    КонецЕсли;
    
    // Выполняем запрос (дорогостоящая операция)
    Запрос = Новый Запрос;
    Запрос.Текст = "
    |ВЫБРАТЬ
    |    Количество(*) КАК КоличествоЗаявок,
    |    СУММА(ВремяРешения) КАК ОбщееВремя
    |ИЗ
    |    РегистрСведений.ЗаявкиТехПоддержки
    |ГДЕ
    |    ДатаСоздания МЕЖДУ &ДатаНачала И &ДатаОкончания
    |    И Статус = &Закрыта
    |";
    
    Запрос.УстановитьПараметр("ДатаНачала", ДатаНачала);
    Запрос.УстановитьПараметр("ДатаОкончания", ДатаОкончания);
    Запрос.УстановитьПараметр("Закрыта", Перечисления.СтатусыЗаявок.Закрыта);
    
    РезультатЗапроса = Запрос.Выполнить();
    Выборка = РезультатЗапроса.Выбрать();
    
    Если Выборка.Следующий() Тогда
        ДанныеОтчета = Новый Структура;
        ДанныеОтчета.Вставить("КоличествоЗаявок", Выборка.КоличествоЗаявок);
        ДанныеОтчета.Вставить("СреднееВремя", ?(Выборка.КоличествоЗаявок > 0, Выборка.ОбщееВремя / Выборка.КоличествоЗаявок, 0));
        ДанныеОтчета.Вставить("ДатаФормирования", ТекущаяДата());
        
        // Сохраняем в кэш на 30 минут
        mcp_Кэширование.УстановитьВКэш(
            КлючКэша, 
            ДанныеОтчета, 
            1800, // 30 минут
            ИдентификаторЗапроса,
            "отчеты"
        );
        
        ЗаписатьЛог("INFO", "Отчет сформирован и сохранен в кэш", ИдентификаторЗапроса, КлючКэша, "");
        Возврат ДанныеОтчета;
    КонецЕсли;
    
    Возврат Неопределено;
    
КонецФункции
```

### Многоуровневое кэширование с различными TTL

```1c
// Настройка кэширования для разных типов данных
Процедура НастроитьМногоуровневоеКэширование()
    
    ИдентификаторЗапроса = "setup_" + Строка(Новый УникальныйИдентификатор);
    
    // Справочники - долгий кэш (24 часа)
    ДанныеСправочника = ПолучитьДанныеСправочника();
    mcp_Кэширование.УстановитьВКэш(
        "справочник_валют", 
        ДанныеСправочника, 
        86400, // 24 часа
        ИдентификаторЗапроса,
        "справочники"
    );
    
    // Настройки пользователей - средний кэш (1 час)
    НастройкиПользователей = ПолучитьНастройкиПользователей();
    mcp_Кэширование.УстановитьВКэш(
        "настройки_пользователей", 
        НастройкиПользователей, 
        3600, // 1 час
        ИдентификаторЗапроса,
        "настройки"
    );
    
    // Временные данные - короткий кэш (5 минут)
    ВременныеДанные = ПолучитьВременныеДанные();
    mcp_Кэширование.УстановитьВКэш(
        "временные_данные", 
        ВременныеДанные, 
        300, // 5 минут
        ИдентификаторЗапроса,
        "временные"
    );
    
    // Кэш сессии - до закрытия сеанса
    ДанныеСессии = ПолучитьДанныеСессии();
    mcp_Кэширование.УстановитьВКэш(
        "сессия_" + Строка(ТекущийСеансИнформационнойБазы), 
        ДанныеСессии, 
        0, // Без ограничения по времени (будет очищен при завершении сеанса)
        ИдентификаторЗапроса,
        "сессия"
    );
    
КонецПроцедуры
```

### Интеграция с системой мониторинга

```1c
// Отправка метрик кэша в систему мониторинга
Процедура ОтправитьМетрикиКэшаВМониторинг()
    
    ИдентификаторЗапроса = "metrics_" + Строка(Новый УникальныйИдентификатор);
    
    // Получаем статистику
    Статистика = mcp_Кэширование.ПолучитьСтатистикуКэша(ИдентификаторЗапроса);
    
    // Формируем метрики для отправки
    Метрики = Новый Структура;
    Метрики.Вставить("cache_entries_count", Статистика.КоличествоЗаписей);
    Метрики.Вставить("cache_active_entries", Статистика.АктивныеЗаписи);
    Метрики.Вставить("cache_expired_entries", Статистика.ИстекшиеЗаписи);
    Метрики.Вставить("cache_hit_ratio", 
        ?(Статистика.КоличествоЗаписей > 0, 
          (Статистика.АктивныеЗаписи / Статистика.КоличествоЗаписей) * 100, 
          0));
    Метрики.Вставить("timestamp", ТекущаяУниверсальнаяДатаВМиллисекундах());
    
    // Отправляем в систему мониторинга (пример)
    ОтправитьВСистемуМониторинга(Метрики, "1c_cache_metrics");
    
КонецПроцедуры
```

### Обработка событий системы

```1c
// Подписка на события для автоматической инвалидации кэша
Процедура ОбработкаСобытияОбновленияКонфигурации() Экспорт
    
    ИдентификаторЗапроса = "event_" + Строка(Новый УникальныйИдентификатор);
    
    // Очищаем все кэши, связанные с конфигурацией
    mcp_Кэширование.ИнвалидироватьКэшПоСобытию("обновление_конфигурации", , ИдентификаторЗапроса);
    
    // Логируем событие
    ЗаписатьЛог("INFO", "Выполнена инвалидация кэша после обновления конфигурации", ИдентификаторЗапроса, "", "");
    
КонецПроцедуры

Процедура ОбработкаСобытияОбновленияДанных(ТипыОбновленныхОбъектов) Экспорт
    
    ИдентификаторЗапроса = "event_" + Строка(Новый УникальныйИдентификатор);
    
    ДанныеСобытия = Новый Структура;
    ДанныеСобытия.Вставить("ТипыОбъектов", ТипыОбновленныхОбъектов);
    
    mcp_Кэширование.ИнвалидироватьКэшПоСобытию("обновление_данных", ДанныеСобытия, ИдентификаторЗапроса);
    
КонецПроцедуры
```

Эти примеры демонстрируют различные сценарии эффективного использования модуля кэширования в реальных проектах 1С.
