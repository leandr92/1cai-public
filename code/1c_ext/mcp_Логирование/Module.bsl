#Область СлужебныйПрограммныйИнтерфейс

// Модуль структурированного JSON логирования для 1С:Предприятие
// Версия: 1.0
// Дата: 2025-10-29
// 
// Описание: Модуль обеспечивает структурированное JSON логирование в соответствии
// со стандартами обработки ошибок 1С:Предприятие и индустриальными практиками
// структурированного логирования

// =============================================================================
// ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ
// =============================================================================

// Содержит информацию о текущей операции для корреляции логов
ТекущаяОперация = Неопределено;

// Массив паттернов для маскирования PII данных
МаскироватьПоля = Новый Массив;
МаскироватьПоля.Добавить("password");
МаскироватьПоля.Добавить("passwd");
МаскироватьПоля.Добавить("token");
МаскироватьПоля.Добавить("auth");
МаскироватьПоля.Добавить("secret");
МаскироватьПоля.Добавить("key");
МаскироватьПоля.Добавить("credit_card");
МаскироватьПоля.Добавить("card_number");
МаскироватьПоля.Добавить("ssn");
МаскироватьПоля.Добавить("email");

// =============================================================================
// ОСНОВНЫЕ ФУНКЦИИ ЛОГИРОВАНИЯ
// =============================================================================

// Записывает информационное сообщение в структурированном JSON формате
// 
// Параметры:
//   Сообщение - Строка - Текст сообщения для логирования
//   Контекст - Структура - Дополнительные данные контекста (необязательно)
//   ВремяНачала - Дата - Время начала операции для расчета duration_ms (необязательно)
Процедура ЛогироватьИнформацию(Сообщение, Контекст = Неопределено, ВремяНачала = Неопределено) Экспорт
	
	ЗаписатьСтруктурированныйЛог("INFO", Сообщение, Контекст, ВремяНачала);
	
КонецПроцедуры

// Записывает предупреждение в структурированном JSON формате
// 
// Параметры:
//   Сообщение - Строка - Текст предупреждения
//   Контекст - Структура - Дополнительные данные контекста (необязательно)
//   ВремяНачала - Дата - Время начала операции для расчета duration_ms (необязательно)
Процедура ЛогироватьПредупреждение(Сообщение, Контекст = Неопределено, ВремяНачала = Неопределено) Экспорт
	
	ЗаписатьСтруктурированныйЛог("WARN", Сообщение, Контекст, ВремяНачала);
	
КонецПроцедуры

// Записывает ошибку в структурированном JSON формате
// 
// Параметры:
//   Сообщение - Строка - Текст ошибки
//   ИнфОшибки - ИнформацияОбОшибке - Информация об ошибке (необязательно)
//   Контекст - Структура - Дополнительные данные контекста (необязательно)
//   ВремяНачала - Дата - Время начала операции для расчета duration_ms (необязательно)
Процедура ЛогироватьОшибку(Сообщение, ИнфОшибки = Неопределено, Контекст = Неопределено, ВремяНачала = Неопределено) Экспорт
	
	ЗаписатьСтруктурированныйЛог("ERROR", Сообщение, Контекст, ВремяНачала, ИнфОшибки);
	
КонецПроцедуры

// Записывает критическую ошибку в структурированном JSON формате
// 
// Параметры:
//   Сообщение - Строка - Текст критической ошибки
//   ИнфОшибки - ИнформацияОбОшибке - Информация об ошибке (необязательно)
//   Контекст - Структура - Дополнительные данные контекста (необязательно)
//   ВремяНачала - Дата - Время начала операции для расчета duration_ms (необязательно)
Процедура ЛогироватьКритическуюОшибку(Сообщение, ИнфОшибки = Неопределено, Контекст = Неопределено, ВремяНачала = Неопределено) Экспорт
	
	ЗаписатьСтруктурированныйЛог("FATAL", Сообщение, Контекст, ВремяНачала, ИнфОшибки);
	
КонецПроцедуры

// =============================================================================
// СЛУЖЕБНЫЕ ФУНКЦИИ
// =============================================================================

// Основная функция записи структурированного лога
Процедура ЗаписатьСтруктурированныйЛог(Уровень, Сообщение, Контекст = Неопределено, ВремяНачала = Неопределено, ИнфОшибки = Неопределено)
	
	Попытка
		
		// Формируем базовую структуру лога
		СтруктураЛога = СформироватьСтруктуруЛога();
		
		// Заполняем обязательные поля
		СтруктураЛога.level = Уровень;
		СтруктураЛога.message = Сообщение;
		СтруктураЛога.timestamp = ПолучитьТекущуюМеткуВремени();
		
		// Получаем данные пользователя (анонимизированно)
		СтруктураЛога.user_id = ПолучитьИдентификаторПользователя();
		
		// Получаем корреляционные идентификаторы
		КорреляционныеИД = ПолучитьКорреляционныеИдентификаторы();
		СтруктураЛога.request_id = КорреляционныеИД.request_id;
		СтруктураЛога.correlation_id = КорреляционныеИД.correlation_id;
		
		// Рассчитываем длительность операции
		Если ВремяНачала <> Неопределено Тогда
			СтруктураЛога.duration_ms = РассчитатьДлительностьОперации(ВремяНачала);
		КонецЕсли;
		
		// Добавляем информацию об ошибке, если передана
		Если ИнфОшибки <> Неопределено Тогда
			ЗаполнитьИнформациюОбОшибке(СтруктураЛога, ИнфОшибки);
		КонецЕсли;
		
		// Добавляем контекстные данные
		Если Контекст <> Неопределено Тогда
			СтруктураЛога.context = МаскироватьКонфиденциальныеДанные(Контекст);
		КонецЕсли;
		
		// Формируем JSON строку
		JSONСтрока = ПреобразоватьСтруктуруВJSON(СтруктураЛога);
		
		// Записываем в журнал регистрации 1С
		ЗаписатьВЖурналРегистрации(Уровень, JSONСтрока, Сообщение);
		
		// Выводим в консоль разработчика для отладки
		ВывестиВКонсольРазработчика(Уровень, JSONСтрока);
		
	Исключение
		// В случае ошибки логирования пишем в стандартный журнал
		ЗаписьЖурналаРегистрации("Ошибка структурированного логирования: " + ОписаниеОшибки(), 
		                         УровеньРегистрацииРежима.Ошибка);
	КонецПопытки;
	
КонецПроцедуры

// =============================================================================
// СОЗДАНИЕ СТРУКТУРЫ ЛОГА
// =============================================================================

// Формирует базовую структуру JSON лога согласно стандартам
// 
// Возвращаемое значение:
//   Структура - базовая структура лога с предустановленными полями
Функция СформироватьСтруктуруЛога() Экспорт
	
	СтруктураЛога = Новый Структура;
	
	// Обязательные поля согласно стандарту
	СтруктураЛога.Вставить("timestamp", "");        // ISO 8601
	СтруктураЛога.Вставить("level", "");            // INFO/WARN/ERROR/FATAL
	СтруктураЛога.Вставить("message", "");          // Текст сообщения
	СтруктураЛога.Вставить("request_id", "");       // Уникальный ID запроса
	СтруктураЛога.Вставить("correlation_id", "");   // ID корреляции
	
	// Дополнительные поля
	СтруктураЛога.Вставить("user_id", "");          // Анонимизированный ID пользователя
	СтруктураЛога.Вставить("error_code", "");       // Код ошибки (если есть)
	СтруктураЛога.Вставить("http_method", "");      // HTTP метод (для интеграций)
	СтруктураЛога.Вставить("target_service", "");   // Целевой сервис
	СтруктураЛога.Вставить("duration_ms", 0);       // Длительность в миллисекундах
	СтруктураЛога.Вставить("severity", "");         // Уровень серьезности
	СтруктураЛога.Вставить("stacktrace", "");       // Краткий стек вызовов
	СтруктураЛога.Вставить("context", Новый Структура); // Дополнительные данные
	
	// Поля специфичные для 1С
	СтруктураЛога.Вставить("infobase", ПолучитьИмяИнформационнойБазы());
	СтруктураЛога.Вставить("server_name", ПолучитьИмяСервера1С());
	СтруктураЛога.Вставить("process_id", ПолучитьИДПроцесса());
	
	Возврат СтруктураЛога;
	
КонецФункции

// =============================================================================
// РАБОТА С КОРРЕЛЯЦИОННЫМИ ИДЕНТИФИКАТОРАМИ
// =============================================================================

// Генерирует уникальный идентификатор запроса
// 
// Возвращаемое значение:
//   Строка - UUID идентификатор
Функция СгенерироватьИдентификаторЗапроса() Экспорт
	
	Возврат Строка(Новый UUID);
	
КонецФункции

// Генерирует корреляционный идентификатор для трассировки
// 
// Возвращаемое значение:
//   Строка - Корреляционный идентификатор
Функция СгенерироватьКорреляционныйИдентификатор() Экспорт
	
	ТекущееВремя = ТекущаяДатаСеанса();
	СлучайноеЧисло = Формат(ТекущаяДатаСеанса() % 1000000, "ЧГ=0");
	
	КорреляционныйИД = "trace_" + СтрЗаменить(Строка(ТекущееВремя), ".", "_") + "_" + СлучайноеЧисло;
	
	Возврат КорреляционныйИД;
	
КонецФункции

// Получает или создает корреляционные идентификаторы для текущей операции
// 
// Возвращаемое значение:
//   Структура - содержит request_id и correlation_id
Функция ПолучитьКорреляционныеИдентификаторы() Экспорт
	
	Результат = Новый Структура;
	
	// Проверяем наличие текущей операции
	Если ТекущаяОперация = Неопределено Тогда
		Результат.request_id = СгенерироватьИдентификаторЗапроса();
		Результат.correlation_id = СгенерироватьКорреляционныйИдентификатор();
		
		ТекущаяОперация = Новый Структура;
		ТекущаяОперация.Вставить("request_id", Результат.request_id);
		ТекущаяОперация.Вставить("correlation_id", Результат.correlation_id);
		ТекущаяОперация.Вставить("start_time", ТекущаяДатаСеанса());
	Иначе
		Результат.request_id = ТекущаяОперация.request_id;
		Результат.correlation_id = ТекущаяОперация.correlation_id;
	КонецЕсли;
	
	Возврат Результат;
	
КонецФункции

// Начинает новую операцию с генерацией корреляционных ID
// 
// Параметры:
//   КонтекстОперации - Структура - Контекст новой операции (необязательно)
// 
// Возвращаемое значение:
//   Структура - Идентификаторы новой операции
Функция НачатьНовуюОперацию(КонтекстОперации = Неопределено) Экспорт
	
	ТекущаяОперация = Новый Структура;
	ТекущаяОперация.Вставить("request_id", СгенерироватьИдентификаторЗапроса());
	ТекущаяОперация.Вставить("correlation_id", СгенерироватьКорреляционныйИдентификатор());
	ТекущаяОперация.Вставить("start_time", ТекущаяДатаСеанса());
	
	Если КонтекстОперации <> Неопределено Тогда
		ТекущаяОперация.Вставить("context", КонтекстОперации);
	КонецЕсли;
	
	Возврат Новый Структура("request_id,correlation_id", 
	                       ТекущаяОперация.request_id, 
	                       ТекущаяОперация.correlation_id);
	
КонецФункции

// =============================================================================
// РАБОТА С УРОВНЯМИ ЛОГИРОВАНИЯ
// =============================================================================

// Проверяет корректность уровня логирования
// 
// Параметры:
//   Уровень - Строка - Проверяемый уровень
// 
// Возвращаемое значение:
//   Булево - Истина если уровень корректный
Функция ЭтоДопустимыйУровеньЛогирования(Уровень) Экспорт
	
	ДопустимыеУровни = Новый Массив;
	ДопустимыеУровни.Добавить("INFO");
	ДопустимыеУровни.Добавить("WARN");
	ДопустимыеУровни.Добавить("ERROR");
	ДопустимыеУровни.Добавить("FATAL");
	
	Возврат ДопустимыеУровни.Найти(Уровень) <> Неопределено;
	
КонецФункции

// Получает приоритет уровня логирования
// 
// Параметры:
//   Уровень - Строка - Уровень логирования
// 
// Возвращаемое значение:
//   Число - Приоритет уровня (1-INFO, 2-WARN, 3-ERROR, 4-FATAL)
Функция ПолучитьПриоритетУровня(Уровень) Экспорт
	
	Приоритеты = Новый Соответствие;
	Приоритеты.Вставить("INFO", 1);
	Приоритеты.Вставить("WARN", 2);
	Приоритеты.Вставить("ERROR", 3);
	Приоритеты.Вставить("FATAL", 4);
	
	Возврат Приоритеты[Уровень];
	
КонецФункции

// =============================================================================
// МАСКИРОВАНИЕ PII И КОНФИДЕНЦИАЛЬНЫХ ДАННЫХ
// =============================================================================

// Маскирует конфиденциальные данные в структуре
// 
// Параметры:
//   Данные - Структура - Данные для маскирования
// 
// Возвращаемое значение:
//   Структура - Данные с замаскированными конфиденциальными полями
Функция МаскироватьКонфиденциальныеДанные(Данные) Экспорт
	
	Если ТипЗнч(Данные) <> Тип("Структура") И ТипЗнч(Данные) <> Тип("Соответствие") Тогда
		Возврат Данные;
	КонецЕсли;
	
	Результат = Новый Структура;
	
	Для Каждого КлючЗначение Из Данные Цикл
		Ключ = КлючЗначение.Ключ;
		Значение = КлючЗначение.Значение;
		
		// Проверяем, нужно ли маскировать поле
		Если ТребуетсяМаскированиеПоля(Ключ) Тогда
			Результат.Вставить(Ключ, "*****");
		Иначе
			// Рекурсивно обрабатываем вложенные структуры
			Если ТипЗнч(Значение) = Тип("Структура") Или ТипЗнч(Значение) = Тип("Соответствие") Тогда
				Результат.Вставить(Ключ, МаскироватьКонфиденциальныеДанные(Значение));
			Иначе
				Результат.Вставить(Ключ, Значение);
			КонецЕсли;
		КонецЕсли;
	КонецЦикла;
	
	Возврат Результат;
	
КонецФункции

// Проверяет, требуется ли маскирование поля
// 
// Параметры:
//   ИмяПоля - Строка - Имя проверяемого поля
// 
// Возвращаемое значение:
//   Булево - Истина если поле нужно маскировать
Функция ТребуетсяМаскированиеПоля(ИмяПоля) Экспорт
	
	ИмяПоляВРег = ВРег(ИмяПоля);
	
	Для Каждого Паттерн Из МаскироватьПоля Цикл
		Если СтрНайти(ИмяПоляВРег, ВРег(Паттерн)) > 0 Тогда
			Возврат Истина;
		КонецЕсли;
	КонецЦикла;
	
	Возврат Ложь;
	
КонецФункции

// Анонимизирует идентификатор пользователя
// 
// Параметры:
//   ПользовательИД - Строка - Исходный идентификатор пользователя (необязательно)
// 
// Возвращаемое значение:
//   Строка - Анонимизированный идентификатор пользователя
Функция АнонимизироватьИдентификаторПользователя(ПользовательИД = "") Экспорт
	
	ТекущийПользователь = ПараметрыСеанса.ТекущийПользователь;
	
	Если ЗначениеЗаполнено(ПользовательИД) Тогда
		// Анонимизируем переданный ID
		Хеш = ПолучитьХешСтроки(ПользовательИД);
		Возврат "USER_" + Лев(Хеш, 8);
	Иначе
		// Анонимизируем текущего пользователя
		Если ЗначениеЗаполнено(ТекущийПользователь) Тогда
			Хеш = ПолучитьХешСтроки(Строка(ТекущийПользователь.УникальныйИдентификатор));
			Возврат "USER_" + Лев(Хеш, 8);
		Иначе
			Возврат "USER_ANON";
		КонецЕсли;
	КонецЕсли;
	
КонецФункции

// =============================================================================
// ПОЛУЧЕНИЕ СИСТЕМНОЙ ИНФОРМАЦИИ
// =============================================================================

// Получает анонимизированный идентификатор текущего пользователя
// 
// Возвращаемое значение:
//   Строка - Анонимизированный ID пользователя
Функция ПолучитьИдентификаторПользователя() Экспорт
	
	Возврат АнонимизироватьИдентификаторПользователя();
	
КонецФункции

// Получает текущую метку времени в формате ISO 8601
// 
// Возвращаемое значение:
//   Строка - Метка времени в формате ISO 8601
Функция ПолучитьТекущуюМеткуВремени() Экспорт
	
	ТекущаяДата = ТекущаяДатаСеанса();
	Смещение = СмещениеЛетнегоВремени();
	
	Год = Год(ТекущаяДата);
	Месяц = Формат(Месяц(ТекущаяДата), "ЧЦ=2; ЧВН=");
	День = Формат(День(ТекущаяДата), "ЧЦ=2; ЧВН=");
	Час = Формат(Час(ТекущаяДата), "ЧЦ=2; ЧВН=");
	Минута = Формат(Минута(ТекущаяДата), "ЧЦ=2; ЧВН=");
	Секунда = Формат(Секунда(ТекущаяДата), "ЧЦ=2; ЧВН=");
	
	Если Смещение >= 0 Тогда
		ЗнакСмещения = "+";
	Иначе
		ЗнакСмещения = "-";
	КонецЕсли;
	
	ЧасыСмещения = Формат(Цел(МодульЧисла(Смещение) / 3600), "ЧЦ=2; ЧВН=");
	МинутыСмещения = Формат(Цел(МодульЧисла(Смещение) % 3600 / 60), "ЧЦ=2; ЧВН=");
	
	МеткаВремени = СтрШаблон("%1-%2-%3T%4:%5:%6%7%8:%9", 
	                        Год, Месяц, День, Час, Минута, Секунда, 
	                        ЗнакСмещения, ЧасыСмещения, МинутыСмещения);
	
	Возврат МеткаВремени;
	
КонецФункции

// Рассчитывает длительность операции в миллисекундах
// 
// Параметры:
//   ВремяНачала - Дата - Время начала операции
// 
// Возвращаемое значение:
//   Число - Длительность в миллисекундах
Функция РассчитатьДлительностьОперации(ВремяНачала) Экспорт
	
	Если ВремяНачала = Неопределено Тогда
		Возврат 0;
	КонецЕсли;
	
	ТекущееВремя = ТекущаяДатаСеанса();
	Разница = ТекущееВремя - ВремяНачала;
	
	Возврат Цел(Разница * 1000); // Переводим в миллисекунды
	
КонецФункции

// Получает краткий стек вызовов для ошибки
// 
// Параметры:
//   ИнфОшибки - ИнформацияОбОшибке - Информация об ошибке
// 
// Возвращаемое значение:
//   Строка - Краткий стек вызовов
Функция ПолучитьКраткийСтекВызовов(ИнфОшибки) Экспорт
	
	Если ИнфОшибки = Неопределено Тогда
		Возврат "";
	КонецЕсли;
	
	ПодробноеПредставление = ОбработкаОшибок.ПодробноеПредставлениеОшибки(ИнфОшибки);
	
	// Извлекаем только первые 3 строки стека для краткости
	СтрокиСтека = СтрРазделить(ПодробноеПредставление, Символы.ПС);
	
	Если СтрокиСтека.Количество() <= 3 Тогда
		Возврат ПодробноеПредставление;
	Иначе
		КраткийСтек = "";
		Для Сч = 0 По 2 Цикл
			КраткийСтек = КраткийСтек + СтрокиСтека[Сч] + Символы.ПС;
		КонецЦикла;
		Возврат КраткийСтек;
	КонецЕсли;
	
КонецФункции

// =============================================================================
// ЗАПОЛНЕНИЕ ИНФОРМАЦИИ ОБ ОШИБКЕ
// =============================================================================

// Заполняет информацию об ошибке в структуру лога
// 
// Параметры:
//   СтруктураЛога - Структура - Структура лога для заполнения
//   ИнфОшибки - ИнформацияОбОшибке - Информация об ошибке
Процедура ЗаполнитьИнформациюОбОшибке(СтруктураЛога, ИнфОшибки)
	
	Если ИнфОшибки = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	// Заполняем технические детали ошибки
	СтруктураЛога.stacktrace = ПолучитьКраткийСтекВызовов(ИнфОшибки);
	
	// Определяем код ошибки на основе типа исключения
	СтруктураЛога.error_code = ОпределитьКодОшибки(ИнфОшибки);
	
	// Определяем серьезность ошибки
	СтруктураЛога.severity = ОпределитьСерьезностьОшибки(СтруктураЛога.level, ИнфОшибки);
	
	// Добавляем контекст ошибки в context
	Если СтруктураЛога.context = Неопределено Тогда
		СтруктураЛога.context = Новый Структура;
	КонецЕсли;
	
	СтруктураЛога.context.Вставить("error_details", Новый Структура);
	СтруктураЛога.context.error_details.Вставить("error_source", ПолучитьИсточникОшибки(ИнфОшибки));
	СтруктураЛога.context.error_details.Вставить("is_recoverable", ОпределитьВосстановимостьОшибки(ИнфОшибки));
	
КонецПроцедуры

// Определяет код ошибки на основе типа исключения
// 
// Параметры:
//   ИнфОшибки - ИнформацияОбОшибке - Информация об ошибке
// 
// Возвращаемое значение:
//   Строка - Код ошибки
Функция ОпределитьКодОшибки(ИнфОшибки) Экспорт
	
	Описание = ОбработкаОшибок.ПодробноеПредставлениеОшибки(ИнфОшибки);
	
	// Анализируем текст ошибки и определяем код
	Если СтрНайти(Описание, "по причине") > 0 Тогда
		Возврат "E_PLATFORM";
	ИначеЕсли СтрНайти(Описание, "файл") > 0 Тогда
		Возврат "E_FILE_OPERATION";
	ИначеЕсли СтрНайти(Описание, "соединение") > 0 Тогда
		Возврат "E_CONNECTION";
	ИначеЕсли СтрНайти(Описание, "база данных") > 0 Тогда
		Возврат "E_DATABASE";
	Иначе
		Возврат "E_APPLICATION";
	КонецЕсли;
	
КонецФункции

// Определяет серьезность ошибки
// 
// Параметры:
//   Уровень - Строка - Уровень логирования
//   ИнфОшибки - ИнформацияОбОшибке - Информация об ошибке
// 
// Возвращаемое значение:
//   Строка - Уровень серьезности
Функция ОпределитьСерьезностьОшибки(Уровень, ИнфОшибки) Экспорт
	
	Если Уровень = "FATAL" Тогда
		Возврат "CRITICAL";
	ИначеЕсли Уровень = "ERROR" Тогда
		Если ОпределитьВосстановимостьОшибки(ИнфОшибки) Тогда
			Возврат "HIGH";
		Иначе
			Возврат "MEDIUM";
		КонецЕсли;
	ИначеЕсли Уровень = "WARN" Тогда
		Возврат "LOW";
	Иначе
		Возврат "INFO";
	КонецЕсли;
	
КонецФункции

// Определяет, является ли ошибка восстановимой
// 
// Параметры:
//   ИнфОшибки - ИнформацияОбОшибке - Информация об ошибке
// 
// Возвращаемое значение:
//   Булево - Истина если ошибка восстановима
Функция ОпределитьВосстановимостьОшибки(ИнфОшибки) Экспорт
	
	Описание = ОбработкаОшибок.ПодробноеПредставлениеОшибки(ИнфОшибки);
	
	// Проверяем признаки восстановимых ошибок
	ВосстановимыеПризнаки = Новый Массив;
	ВосстановимыеПризнаки.Добавить("временная недоступность");
	ВосстановимыеПризнаки.Добавить("соединение отклонено");
	ВосстановимыеПризнаки.Добавить("таймаут");
	ВосстановимыеПризнаки.Добавить("превышен интервал ожидания");
	
	Для Каждого Признак Из ВосстановимыеПризнаки Цикл
		Если СтрНайти(ВРег(Описание), ВРег(Признак)) > 0 Тогда
			Возврат Истина;
		КонецЕсли;
	КонецЦикла;
	
	Возврат Ложь;
	
КонецФункции

// Получает источник ошибки
// 
// Параметры:
//   ИнфОшибки - ИнформацияОбОшибке - Информация об ошибке
// 
// Возвращаемое значение:
//   Строка - Источник ошибки
Функция ПолучитьИсточникОшибки(ИнфОшибки) Экспорт
	
	Если ИнфОшибки.Источник = "" Тогда
		Возврат "1C_PLATFORM";
	Иначе
		Возврат ИнфОшибки.Источник;
	КонецЕсли;
	
КонецФункции

// =============================================================================
// ПРЕОБРАЗОВАНИЕ В JSON
// =============================================================================

// Преобразует структуру в JSON строку
// 
// Параметры:
//   Данные - Структура - Структура для преобразования
// 
// Возвращаемое значение:
//   Строка - JSON представление структуры
Функция ПреобразоватьСтруктуруВJSON(Данные) Экспорт
	
	ЗаписьJSON = Новый ЗаписьJSON;
	ЗаписьJSON.УстановитьСтроку();
	
	Попытка
		ЗаписатьJSON(ЗаписьJSON, Данные);
		Возврат ЗаписьJSON.Закрыть();
	Исключение
		Возврат "{""error"": ""Не удалось сформировать JSON: " + ОписаниеОшибки() + """, ""original_data"": """ + Строка(Данные) + """}";
	КонецПопытки;
	
КонецФункции

// =============================================================================
// РАБОТА С ЖУРНАЛОМ РЕГИСТРАЦИИ 1С
// =============================================================================

// Записывает лог в журнал регистрации 1С
// 
// Параметры:
//   Уровень - Строка - Уровень логирования
//   JSONСтрока - Строка - JSON представление лога
//   Сообщение - Строка - Оригинальное сообщение
Процедура ЗаписатьВЖурналРегистрации(Уровень, JSONСтрока, Сообщение)
	
	Попытка
		// Определяем уровень записи в журнал
		УровеньЗаписи = ПолучитьУровеньЗаписиВЖурнал(Уровень);
		
		// Формируем текст для записи в журнал
		ТекстЗаписи = СтрШаблон("[%1] %2 %3", Уровень, Сообщение, JSONСтрока);
		
		// Записываем в журнал регистрации
		ЗаписьЖурналаРегистрации(ТекстЗаписи, УровеньЗаписи);
		
	Исключение
		// Игнорируем ошибки записи в журнал, чтобы не нарушить основной поток
	КонецПопытки;
	
КонецПроцедуры

// Получает уровень записи для журнала регистрации 1С
// 
// Параметры:
//   УровеньЛогирования - Строка - Уровень логирования
// 
// Возвращаемое значение:
//   УровеньРегистрацииРежима - Уровень записи в журнал
Функция ПолучитьУровеньЗаписиВЖурнал(УровеньЛогирования) Экспорт
	
	СоответствиеУровней = Новый Соответствие;
	СоответствиеУровней.Вставить("INFO", УровеньРегистрацииРежима.Информация);
	СоответствиеУровней.Вставить("WARN", УровеньРегистрацииРежима.Предупреждение);
	СоответствиеУровней.Вставить("ERROR", УровеньРегистрацииРежима.Ошибка);
	СоответствиеУровней.Вставить("FATAL", УровеньРегистрацииРежима.Ошибка);
	
	Возврат СоответствиеУровней[УровеньЛогирования];
	
КонецФункции

// Выводит лог в консоль разработчика (для отладки)
// 
// Параметры:
//   Уровень - Строка - Уровень логирования
//   JSONСтрока - Строка - JSON представление лога
Процедура ВывестиВКонсольРазработчика(Уровень, JSONСтрока)
	
	#Если Клиент Тогда
		Если НЕ ЭтаФорма.РежимОтображенияОшибки = РежимОтображенияОшибки.Отключен Тогда
			Сообщить(СтрШаблон("[%1] %2", Уровень, JSONСтрока));
		КонецЕсли;
	#КонецЕсли
	
КонецПроцедуры

// =============================================================================
// ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ
// =============================================================================

// Получает хеш строки для анонимизации
// 
// Параметры:
//   Строка - Строка - Строка для хеширования
// 
// Возвращаемое значение:
//   Строка - Хеш строки
Функция ПолучитьХешСтроки(Строка) Экспорт
	
	ХешированиеДанных = Новый ХешированиеДанных(ХешФункция.MD5);
	ХешированиеДанные.Добавить(Строка);
	
	Возврат ХешированиеДанных.ХешСумма;
	
КонецФункции

// Получает имя информационной базы
// 
// Возвращаемое значение:
//   Строка - Имя информационной базы
Функция ПолучитьИмяИнформационнойБазы() Экспорт
	
	Возврат Строка(Константы.ЗаголовокСистемы.Получить());
	
КонецФункции

// Получает имя сервера 1С
// 
// Возвращаемое значение:
//   Строка - Имя сервера 1С
Функция ПолучитьИмяСервера1С() Экспорт
	
	Возврат ИмяСервера1СПредприятия;
	
КонецФункции

// Получает идентификатор процесса
// 
// Возвращаемое значение:
//   Строка - Идентификатор процесса
Функция ПолучитьИДПроцесса() Экспорт
	
	Возврат Строка(РабочийПроцесс);
	
КонецФункции

// Проверяет, включено ли логирование для указанного уровня
// 
// Параметры:
//   Уровень - Строка - Проверяемый уровень
// 
// Возвращаемое значение:
//   Булево - Истина если логирование включено
Функция ВключеноЛогированиеУровня(Уровень) Экспорт
	
	// В реальной реализации здесь может быть проверка настроек логирования
	// Например, чтение из констант или регистров сведений
	Возврат Истина; // По умолчанию все уровни включены
	
КонецФункции

// =============================================================================
// КОНСТРУКТОРЫ ДЛЯ УДОБСТВА ИСПОЛЬЗОВАНИЯ
// =============================================================================

// Создает структуру контекста для логирования
// 
// Параметры:
//   Операция - Строка - Название операции (необязательно)
//   Объект - Строка - Объект конфигурации (необязательно)
//   ДополнительныеПараметры - Структура - Дополнительные параметры (необязательно)
// 
// Возвращаемое значение:
//   Структура - Контекст для логирования
Функция СоздатьКонтекстЛогирования(Операция = "", Объект = "", ДополнительныеПараметры = Неопределено) Экспорт
	
	Контекст = Новый Структура;
	
	Если ЗначениеЗаполнено(Операция) Тогда
		Контекст.Вставить("operation", Операция);
	КонецЕсли;
	
	Если ЗначениеЗаполнено(Объект) Тогда
		Контекст.Вставить("object", Объект);
	КонецЕсли;
	
	Контекст.Вставить("timestamp", ПолучитьТекущуюМеткуВремени());
	Контекст.Вставить("session_id", ПолучитьИДПроцесса());
	
	Если ДополнительныеПараметры <> Неопределено Тогда
		Для Каждого КлючЗначение Из ДополнительныеПараметры Цикл
			Контекст.Вставить(КлючЗначение.Ключ, КлючЗначение.Значение);
		КонецЦикла;
	КонецЕсли;
	
	Возврат Контекст;
	
КонецФункции

// Записывает лог с расширенной информацией об интеграции
// 
// Параметры:
//   Уровень - Строка - Уровень логирования
//   Сообщение - Строка - Текст сообщения
//   HTTPМетод - Строка - HTTP метод (необязательно)
//   ЦелевойСервис - Строка - Название целевого сервиса (необязательно)
//   URL - Строка - URL запроса (необязательно)
//   СтатусКод - Число - HTTP статус код (необязательно)
//   Контекст - Структура - Дополнительные данные (необязательно)
Процедура ЛогироватьИнтеграцию(Уровень, Сообщение, HTTPМетод = "", ЦелевойСервис = "", URL = "", СтатусКод = 0, Контекст = Неопределено) Экспорт
	
	Если Контекст = Неопределено Тогда
		Контекст = Новый Структура;
	КонецЕсли;
	
	// Добавляем информацию об интеграции в контекст
	Контекст.Вставить("integration", Новый Структура);
	Контекст.integration.Вставить("http_method", HTTPМетод);
	Контекст.integration.Вставить("target_service", ЦелевойСервис);
	Контекст.integration.Вставить("url", URL);
	
	Если СтатусКод > 0 Тогда
		Контекст.integration.Вставить("status_code", СтатусКод);
		Контекст.integration.Вставить("is_success", СтатусКод >= 200 И СтатусКод < 300);
	КонецЕсли;
	
	// Вызываем соответствующую функцию логирования
	Если Уровень = "INFO" Тогда
		ЛогироватьИнформацию(Сообщение, Контекст);
	ИначеЕсли Уровень = "WARN" Тогда
		ЛогироватьПредупреждение(Сообщение, Контекст);
	ИначеЕсли Уровень = "ERROR" Тогда
		ЛогироватьОшибку(Сообщение, Неопределено, Контекст);
	ИначеЕсли Уровень = "FATAL" Тогда
		ЛогироватьКритическуюОшибку(Сообщение, Неопределено, Контекст);
	КонецЕсли;
	
КонецПроцедуры

// =============================================================================
// ИНИЦИАЛИЗАЦИЯ МОДУЛЯ
// =============================================================================

// Инициализирует модуль логирования
Процедура ИнициализироватьЛогирование() Экспорт
	
	// Инициализируем текущую операцию
	ТекущаяОперация = Новый Структура;
	ТекущаяОперация.Вставить("request_id", СгенерироватьИдентификаторЗапроса());
	ТекущаяОперация.Вставить("correlation_id", СгенерироватьКорреляционныйИдентификатор());
	ТекущаяОперация.Вставить("start_time", ТекущаяДатаСеанса());
	
КонецПроцедуры

// Завершает текущую операцию и записывает итоговый лог
Процедура ЗавершитьОперацию() Экспорт
	
	Если ТекущаяОперация <> Неопределено Тогда
		Длительность = РассчитатьДлительностьОперации(ТекущаяОперация.start_time);
		
		Контекст = Новый Структура;
		Контекст.Вставить("operation_duration_ms", Длительность);
		Контекст.Вставить("final_operation", Истина);
		
		ЛогироватьИнформацию("Операция завершена успешно", Контекст, ТекущаяОперация.start_time);
		
		// Сбрасываем текущую операцию
		ТекущаяОперация = Неопределено;
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

// Служебная процедура для логирования начала операции
Процедура ЗаписатьЛогНачалаОперации(ОписаниеОперации, Контекст = Неопределено)
	
	ЛогироватьИнформацию("Начало операции: " + ОписаниеОперации, Контекст);
	
КонецПроцедуры

// Служебная процедура для логирования окончания операции
Процедура ЗаписатьЛогОкончанияОперации(ОписаниеОперации, Успешно = Истина, ВремяНачала = Неопределено)
	
	Если Успешно Тогда
		ЛогироватьИнформацию("Завершение операции: " + ОписаниеОперации, Неопределено, ВремяНачала);
	Иначе
		ЛогироватьОшибку("Ошибка операции: " + ОписаниеОперации, Неопределено, Неопределено, ВремяНачала);
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

// Инициализируем модуль при загрузке
ИнициализироватьЛогирование();
