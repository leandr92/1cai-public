#Область ПримерыИспользованияМодуляЛогирования

// =============================================================================
// ПРИМЕРЫ ИСПОЛЬЗОВАНИЯ МОДУЛЯ СТРУКТУРИРОВАННОГО JSON ЛОГИРОВАНИЯ
// =============================================================================

#Если Клиент Тогда

// Пример 1: Простое логирование информационного сообщения
Процедура Пример1_ПростоеИнформационноеСообщение()
	
	// Создаем контекст операции
	Контекст = СоздатьКонтекстЛогирования("СозданиеДокумента", "Документ.ЗаказПокупателя");
	Контекст.Вставить("document_number", "ЗП-00001");
	Контекст.Вставить("customer_name", "ООО 'Пример'");
	
	// Логируем информационное сообщение
	ЛогироватьИнформацию("Создан новый документ заказа", Контекст);
	
КонецПроцедуры

// Пример 2: Логирование с временными метками
Процедура Пример2_ЛогированиеСВременнымиМетками()
	
	ВремяНачала = ТекущаяДатаСеанса();
	
	Попытка
		// Выполняем длительную операцию
		ВыполнитьДлительнуюОперацию();
		
		ЛогироватьИнформацию("Операция выполнена успешно", Неопределено, ВремяНачала);
		
	Исключение
		ИнфОшибки = ИнформацияОбОшибке();
		ЛогироватьОшибку("Ошибка при выполнении длительной операции", ИнфОшибки, Неопределено, ВремяНачала);
		
		// Перевыбрасываем исключение
		ВызватьИсключение;
	КонецПопытки;
	
КонецПроцедуры

// Пример 3: Логирование веб-сервиса
Процедура Пример3_ЛогированиеВебСервиса()
	
	Попытка
		// Создаем WSПрокси
		WSПрокси = Новый WSПрокси("http://service.example.com", "Service", "ServiceSoap");
		
		// Подготавливаем данные для запроса
		Запрос = Новый Структура;
		Запрос.Вставить("operation", "GetData");
		Запрос.Вставить("user_id", "USER-12345");
		Запрос.Вставить("api_key", "secret_key_123"); // Будет замаскирован
		
		Контекст = СоздатьКонтекстЛогирования("ВебСервис", "ExternalService");
		Контекст.Вставить("request_data", Запрос);
		
		ЛогироватьИнформацию("Начало вызова веб-сервиса", Контекст);
		
		ВремяНачала = ТекущаяДатаСеанса();
		
		// Выполняем запрос
		Ответ = WSПрокси.GetData(Запрос.operation, Запрос.user_id);
		
		// Логируем успешный ответ
		КонтекстОтвета = Новый Структура;
		КонтекстОтвета.Вставить("response_data", Ответ);
		КонтекстОтвета.Вставить("duration_ms", РассчитатьДлительностьОперации(ВремяНачала));
		
		ЛогироватьИнформацию("Успешный ответ от веб-сервиса", КонтекстОтвета, ВремяНачала);
		
	Исключение
		ИнфОшибки = ИнформацияОбОшибке();
		
		// Логируем ошибку интеграции
		ЛогироватьИнтеграцию("ERROR", 
		                    "Ошибка вызова веб-сервиса", 
		                    "POST", 
		                    "ExternalService", 
		                    "http://service.example.com", 
		                    0, // Статус код неизвестен
		                    Новый Структура("error_details,original_request", 
		                                  ОбработкаОшибок.ПодробноеПредставлениеОшибки(ИнфОшибки), 
		                                  Запрос));
		
		ВызватьИсключение;
	КонецПопытки;
	
КонецПроцедуры

// Пример 4: Логирование обработки файлов
Процедура Пример4_ЛогированиеОбработкиФайлов()
	
	ИмяФайла = "data_import.xlsx";
	ПолныйПутьКФайлу = "C:\Temp\" + ИмяФайла;
	
	Попытка
		// Создаем контекст для работы с файлами
		Контекст = СоздатьКонтекстЛогирования("ОбработкаФайла", "ОбработчикИмпорта");
		Контекст.Вставить("file_name", ИмяФайла);
		Контекст.Вставить("file_path", ПолныйПутьКФайлу);
		Контекст.Вставить("file_size", 1024000); // размер в байтах
		
		ЛогироватьИнформацию("Начата обработка файла", Контекст);
		
		// Проверяем существование файла
		Файл = Новый Файл(ПолныйПутьКФайлу);
		Если НЕ Файл.Существует() Тогда
			ЛогироватьПредупреждение("Файл не найден: " + ПолныйПутьКФайлу, Контекст);
			Возврат;
		КонецЕсли;
		
		// Обрабатываем файл
		ОбработатьФайлДанных(Файл, Контекст);
		
		ЛогироватьИнформацию("Файл успешно обработан", Контекст);
		
	Исключение
		ИнфОшибки = ИнформацияОбОшибке();
		
		// Обогащаем контекст информацией об ошибке
		КонтекстОшибки = Новый Структура("file_name,file_path,error_info", 
		                               ИмяФайла, 
		                               ПолныйПутьКФайлу, 
		                               ОбработкаОшибок.ПодробноеПредставлениеОшибки(ИнфОшибки));
		
		ЛогироватьОшибку("Ошибка при обработке файла " + ИмяФайла, ИнфОшибки, КонтекстОшибки);
		
		ВызватьИсключение;
	КонецПопытки;
	
КонецПроцедуры

// Пример 5: Логирование бизнес-процессов
Процедура Пример5_ЛогированиеБизнесПроцессов()
	
	// Начинаем новую бизнес-операцию
	ИдентификаторыОперации = НачатьНовуюОперацию(СоздатьКонтекстЛогирования("ЗаказНаПродажу", "БизнесПроцесс"));
	
	Попытка
		ЛогироватьИнформацию("Начат бизнес-процесс обработки заказа", Неопределено);
		
		// Этап 1: Проверка данных клиента
		Контекст1 = Новый Структура;
		Контекст1.Вставить("stage", "ПроверкаКлиента");
		Контекст1.Вставить("customer_id", "CUST-001");
		ЛогироватьИнформацию("Начат этап: Проверка данных клиента", Контекст1);
		
		ПроверитьДанныеКлиента();
		
		ЛогироватьИнформацию("Этап завершен: Проверка данных клиента", Контекст1);
		
		// Этап 2: Резервирование товара
		Контекст2 = Новый Структура;
		Контекст2.Вставить("stage", "РезервированиеТовара");
		Контекст2.Вставить("items_count", 5);
		ЛогироватьИнформацию("Начат этап: Резервирование товара", Контекст2);
		
		ЗарезервироватьТовар();
		
		ЛогироватьИнформацию("Этап завершен: Резервирование товара", Контекст2);
		
		// Этап 3: Создание документов
		Контекст3 = Новый Структура;
		Контекст3.Вставить("stage", "СозданиеДокументов");
		Контекст3.Вставить("documents_count", 2);
		ЛогироватьИнформацию("Начат этап: Создание документов", Контекст3);
		
		СоздатьДокументыПродажи();
		
		ЛогироватьИнформацию("Этап завершен: Создание документов", Контекст3);
		
		ЛогироватьИнформацию("Бизнес-процесс успешно завершен", Неопределено);
		
		// Завершаем операцию
		ЗавершитьОперацию();
		
	Исключение
		ИнфОшибки = ИнформацияОбОшибке();
		
		ЛогироватьКритическуюОшибку("Критическая ошибка в бизнес-процессе", ИнфОшибки, Новый Структура("operation_id", ИдентификаторыОперации.request_id));
		
		ВызватьИсключение;
	КонецПопытки;
	
КонецПроцедуры

// Пример 6: Логирование с маскированием PII данных
Процедура Пример6_ЛогированиеСМаскированием()
	
	// Создаем данные с конфиденциальной информацией
	КонфиденциальныеДанные = Новый Структура;
	КонфиденциальныеДанные.Вставить("user_name", "Иванов Иван Иванович");
	КонфиденциальныеДанные.Вставить("email", "ivanov@example.com");
	КонфиденциальныеДанные.Вставить("password", "secret123");
	КонфиденциальныеДанные.Вставить("credit_card", "1234-5678-9012-3456");
	КонфиденциальныеДанные.Вставить("api_token", "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...");
	КонфиденциальныеДанные.Вставить("ssn", "123-45-6789");
	КонфиденциальныеДанные.Вставить("safe_data", "Эти данные безопасны");
	
	Контекст = СоздатьКонтекстЛогирования("ОбработкаPII", "Безопасность");
	Контекст.Вставить("user_data", КонфиденциальныеДанные);
	
	ЛогироватьИнформацию("Обработка персональных данных", Контекст);
	
КонецПроцедуры

// Пример 7: Логирование фоновых заданий
Процедура Пример7_ЛогированиеФоновыхЗаданий()
	
	ПараметрыЗадания = Новый Структура;
	ПараметрыЗадания.Вставить("job_name", "ОбновлениеКлассификатора");
	ПараметрыЗадания.Вставить("schedule_time", ТекущаяДатаСеанса());
	ПараметрыЗадания.Вставить("parameters", Новый Массив);
	
	Контекст = СоздатьКонтекстЛогирования("ФоновоеЗадание", "Планировщик");
	Контекст.Вставить("job_parameters", ПараметрыЗадания);
	
	ЛогироватьИнформацию("Запущено фоновое задание", Контекст);
	
	ВремяНачала = ТекущаяДатаСеанса();
	
	Попытка
		// Выполняем фоновое задание
		ВыполнитьОбновлениеКлассификатора();
		
		Длительность = РассчитатьДлительностьОперации(ВремяНачала);
		
		КонтекстЗавершения = Новый Структура;
		КонтекстЗавершения.Вставить("duration_ms", Длительность);
		КонтекстЗавершения.Вставить("status", "SUCCESS");
		
		ЛогироватьИнформацию("Фоновое задание выполнено успешно", КонтекстЗавершения, ВремяНачала);
		
	Исключение
		ИнфОшибки = ИнформацияОбОшибке();
		
		КонтекстОшибки = Новый Структура;
		КонтекстОшибки.Вставить("job_name", "ОбновлениеКлассификатора");
		КонтекстОшибки.Вставить("error_stage", "Выполнение");
		КонтекстОшибки.Вставить("is_retryable", ОпределитьВосстановимостьОшибки(ИнфОшибки));
		
		ЛогироватьОшибку("Ошибка при выполнении фонового задания", ИнфОшибки, КонтекстОшибки, ВремяНачала);
		
		ВызватьИсключение;
	КонецПопытки;
	
КонецПроцедуры

// Пример 8: Логирование с корреляционными ID
Процедура Пример8_ЛогированиеСКорреляционнымиID()
	
	// Начинаем операцию с генерацией корреляционных ID
	ОперацияID = НачатьНовуюОперацию(СоздатьКонтекстЛогирования("ОбработкаЗапроса", "API"));
	
	ЛогироватьИнформацию("Начата обработка запроса", Новый Структура("operation_id", ОперацияID.request_id));
	
	Попытка
		// Имитируем многоэтапную обработку
		
		// Этап 1: Валидация
		ЛогироватьИнформацию("Начат этап: Валидация входных данных", Неопределено);
		ВалидироватьВходныеДанные();
		ЛогироватьИнформацию("Этап завершен: Валидация входных данных", Неопределено);
		
		// Этап 2: Бизнес-логика
		ЛогироватьИнформацию("Начат этап: Обработка бизнес-логики", Неопределено);
		ОбработатьБизнесЛогику();
		ЛогироватьИнформацию("Этап завершен: Обработка бизнес-логики", Неопределено);
		
		// Этап 3: Сохранение
		ЛогироватьИнформацию("Начат этап: Сохранение результатов", Неопределено);
		СохранитьРезультаты();
		ЛогироватьИнформацию("Этап завершен: Сохранение результатов", Неопределено);
		
		ЛогироватьИнформацию("Запрос обработан успешно", Неопределено);
		
		ЗавершитьОперацию();
		
	Исключение
		ИнфОшибки = ИнформацияОбОшибке();
		
		// Логируем ошибку с привязкой к операции
		КонтекстОшибки = Новый Структура;
		КонтекстОшибки.Вставить("operation_id", ОперацияID.request_id);
		КонтекстОшибки.Вставить("correlation_id", ОперацияID.correlation_id);
		КонтекстОшибки.Вставить("failed_stage", ОпределитьЭтапОшибки(ИнфОшибки));
		
		ЛогироватьКритическуюОшибку("Критическая ошибка при обработке запроса", ИнфОшибки, КонтекстОшибки);
		
		ВызватьИсключение;
	КонецПопытки;
	
КонецПроцедуры

// Вспомогательные процедуры для примеров

Процедура ВыполнитьДлительнуюОперации()
	
	// Имитация длительной операции
	Для Сч = 1 По 1000000 Цикл
		// Выполняем работу...
	КонецЦикла;
	
КонецПроцедуры

Процедура ОбработатьФайлДанных(Файл, Контекст)
	
	// Имитация обработки файла
	ЛогироватьИнформацию("Начато чтение файла: " + Файл.Имя, Контекст);
	
	// Имитация работы с файлом
	Текст = "";
	ТекстовыйФайл = Новый ТекстовыйДокумент();
	ТекстовыйФайл.Прочитать(Файл.ПолноеИмя);
	Текст = ТекстовыйФайл.ПолучитьТекст();
	
	ЛогироватьИнформацию("Завершено чтение файла, строк: " + СтрДлина(Текст), Контекст);
	
КонецПроцедуры

Процедура ПроверитьДанныеКлиента()
	
	// Имитация проверки данных клиента
	ЛогироватьИнформацию("Проверка данных клиента выполнена", Новый Структура("customer_valid", Истина));
	
КонецПроцедуры

Процедура ЗарезервироватьТовар()
	
	// Имитация резервирования товара
	ЛогироватьИнформацию("Товар зарезервирован", Новый Структура("reservation_id", "RES-12345"));
	
КонецПроцедуры

Процедура СоздатьДокументыПродажи()
	
	// Имитация создания документов
	ЛогироватьИнформацию("Документы продажи созданы", Новый Структура("documents", "Заказ, РасходнаяНакладная"));
	
КонецПроцедуры

Процедура ВыполнитьОбновлениеКлассификатора()
	
	// Имитация обновления классификатора
	ЛогироватьИнформацию("Начато обновление классификатора", Неопределено);
	
	// Выполняем работу...
	Для Сч = 1 По 100000 Цикл
		// Работаем...
	КонецЦикла;
	
	ЛогироватьИнформацию("Обновление классификатора завершено", Неопределено);
	
КонецПроцедуры

Процедура ВалидироватьВходныеДанные()
	
	// Имитация валидации
	ЛогироватьИнформацию("Входные данные валидны", Неопределено);
	
КонецПроцедуры

Процедура ОбработатьБизнесЛогику()
	
	// Имитация бизнес-логики
	ЛогироватьИнформацию("Бизнес-логика обработана", Неопределено);
	
КонецПроцедуры

Процедура СохранитьРезультаты()
	
	// Имитация сохранения
	ЛогироватьИнформацию("Результаты сохранены", Неопределено);
	
КонецПроцедуры

Функция ОпределитьЭтапОшибки(ИнфОшибки)
	
	Описание = ОбработкаОшибок.ПодробноеПредставлениеОшибки(ИнфОшибки);
	
	Если СтрНайти(Описание, "Валидация") > 0 Тогда
		Возврат "Валидация";
	ИначеЕсли СтрНайти(Описание, "Бизнес") > 0 Тогда
		Возврат "Бизнес-логика";
	ИначеЕсли СтрНайти(Описание, "Сохранение") > 0 Тогда
		Возврат "Сохранение";
	Иначе
		Возврат "Неизвестно";
	КонецЕсли;
	
КонецФункции

#КонецЕсли

#КонецОбласти
