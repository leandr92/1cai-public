#Область ОбработчикиСобытийФормы

// Обработчик открытия формы
Процедура ПриОткрытии(Отказ)
	
	ИнициализироватьФорму();
	
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиКомандФормы

// Команда запуска выбранных тестов
Процедура КомандаЗапуститьТесты(Команда)
	
	ЗапуститьВыбранныеТесты();
	
КонецПроцедуры

// Команда запуска всех тестов
Процедура КомандаЗапуститьВсеТесты(Команда)
	
	ЗапуститьВсеТесты();
	
КонецПроцедуры

// Команда остановки тестов
Процедура КомандаОстановитьТесты(Команда)
	
	ОстановитьТесты();
	
КонецПроцедуры

// Команда обновления списка тестов
Процедура КомандаОбновитьСписок(Команда)
	
	ОбновитьСписокТестов();
	
КонецПроцедуры

// Команда экспорта отчета
Процедура КомандаЭкспортироватьОтчет(Команда)
	
	ЭкспортироватьОтчет();
	
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиЭлементовФормы

// Обработчик изменения значения фильтра по категории
Процедура ФильтрКатегорияПриИзменении(Элемент)
	
	ПрименитьФильтр();
	
КонецПроцедуры

// Обработчик изменения значения фильтра по статусу
Процедура ФильтрСтатусПриИзменении(Элемент)
	
	ПрименитьФильтр();
	
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

// Инициализирует форму и загружает данные
Процедура ИнициализироватьФорму()
	
	// Инициализация фреймворка тестирования
	mcp_Тестирование.Инициализировать();
	
	// Загружаем список тестовых наборов
	ЗагрузитьТестовыеНаборы();
	
	// Настройка элементов формы
	Элементы.КомандаЗапуститьТесты.Видимость = НЕ Элементы.КомандаОстановитьТесты.Видимость;
	
КонецПроцедуры

// Загружает список доступных тестовых наборов
Процедура ЗагрузитьТестовыеНаборы()
	
	ТестовыеНаборы.Очистить();
	
	// MCP инструменты - основные тесты
	ДобавитьНаборТестов(
		"MCP_Инструменты_Основные", 
		"Основные тесты MCP инструментов", 
		"юнит",
		Истина);
	
	ДобавитьНаборТестов(
		"MCP_Инструменты_Интеграционные", 
		"Интеграционные тесты MCP инструментов", 
		"интеграционные",
		Истина);
	
	ДобавитьНаборТестов(
		"MCP_HTTP_Сервисы", 
		"Тесты HTTP сервисов", 
		"интеграционные",
		Истина);
	
	ДобавитьНаборТестов(
		"MCP_JSON_RPC", 
		"Тесты JSON-RPC контракта", 
		"юнит",
		Истина);
	
	ДобавитьНаборТестов(
		"MCP_ОбщегоНазначения", 
		"Тесты модуля общего назначения", 
		"юнит",
		Истина);
	
	ДобавитьНаборТестов(
		"MCP_EndToEnd", 
		"Сквозные тесты полного цикла", 
		"E2E",
		Ложь); // Отключены по умолчанию
	
	// Применяем фильтры
	ПрименитьФильтр();
	
КонецПроцедуры

// Добавляет тестовый набор в список
Процедура ДобавитьНаборТестов(Имя, Описание, Категория, Включен)
	
	СтрокаНабора = ТестовыеНаборы.Добавить();
	СтрокаНабора.Имя = Имя;
	СтрокаНабора.Описание = Описание;
	СтрокаНабора.Категория = Категория;
	СтрокаНабора.Включен = Включен;
	СтрокаНабора.Статус = "Готов";
	СтрокаНабора.ПоследнийРезультат = "";
	СтрокаНабора.ВремяВыполнения = 0;
	
КонецПроцедуры

// Запускает выбранные тесты
Процедура ЗапуститьВыбранныеТесты()
	
	// Проверяем, что есть выбранные наборы
	ВыбранныеНаборы = Новый Массив;
	
	Для Каждого Строка Из ТестовыеНаборы Цикл
		Если Строка.Включен Тогда
			ВыбранныеНаборы.Добавить(Строка.Имя);
		КонецЕсли;
	КонецЦикла;
	
	Если ВыбранныеНаборы.Количество() = 0 Тогда
		ПоказатьПредупреждение(, "Не выбраны тестовые наборы для запуска");
		Возврат;
	КонецЕсли;
	
	// Настраиваем интерфейс для выполнения
	УстановитьРежимВыполнения(Истина);
	
	// Запускаем тесты асинхронно (в реальном проекте - в отдельном потоке)
	ЗапуститьТестыАсинхронно(ВыбранныеНаборы);
	
КонецПроцедуры

// Запускает все тесты
Процедура ЗапуститьВсеТесты()
	
	// Включаем все тестовые наборы
	Для Каждого Строка Из ТестовыеНаборы Цикл
		Строка.Включен = Истина;
	КонецЦикла;
	
	ЗапуститьВыбранныеТесты();
	
КонецПроцедуры

// Останавливает выполнение тестов
Процедура ОстановитьТесты()
	
	// В реальном проекте здесь бы была логика остановки асинхронных процессов
	УстановитьРежимВыполнения(Ложь);
	
	// Обновляем статус наборов
	Для Каждого Строка Из ТестовыеНаборы Цикл
		Если Строка.Статус = "Выполняется" Тогда
			Строка.Статус = "Остановлен";
		КонецЕсли;
	КонецЦикла;
	
КонецПроцедуры

// Обновляет список тестов
Процедура ОбновитьСписокТестов()
	
	ЗагрузитьТестовыеНаборы();
	
КонецПроцедуры

// Экспортирует отчет о тестировании
Процедура ЭкспортироватьОтчет()
	
	Если РезультатыТестирования.Количество() = 0 Тогда
		ПоказатьПредупреждение(, "Нет результатов для экспорта");
		Возврат;
	КонецЕсли;
	
	// Создаем отчет
	Отчет = mcp_Тестирование.СоздатьОтчет(РезультатыТестирования, "HTML");
	
	// Сохраняем в файл
	ИмяФайла = mcp_Тестирование.СохранитьОтчетВФайл(Отчет, "mcp_test_report_" + СтрЗаменить(Строка(ТекущаяДата()), ".", "_"), ".html");
	
	ПоказатьПредупреждение(, СтрШаблon("Отчет сохранен в файл: %1", ИмяФайла));
	
КонецПроцедуры

// Применяет фильтры к списку тестов
Процедура ПрименитьФильтр()
	
	// Очищаем отфильтрованный список
	ОтфильтрованныеНаборы.Очистить();
	
	Для Каждого Строка Из ТестовыеНаборы Цикл
		
		ПрименитьФильтр = Истина;
		
		// Фильтр по категории
		Если ЗначениеЗаполнено(ФильтрКатегория) И ФильтрКатегория <> "Все" Тогда
			ПрименитьФильтр = ПрименитьФильтр И (Строка.Категория = ФильтрКатегория);
		КонецЕсли;
		
		// Фильтр по статусу
		Если ЗначениеЗаполнено(ФильтрСтатус) И ФильтрСтатус <> "Все" Тогда
			ПрименитьФильтр = ПрименитьФильтр И (Строка.Статус = ФильтрСтатус);
		КонецЕсли;
		
		// Добавляем в отфильтрованный список
		Если ПрименитьФильтр Тогда
			ОтфильтрованныеНаборы.Добавить(Строка.Имя);
		КонецЕсли;
		
	КонецЦикла;
	
КонецПроцедуры

// Устанавливает режим выполнения (активен/неактивен)
Процедура УстановитьРежимВыполнения(Активен)
	
	Элементы.ГруппаУправления.Доступность = НЕ Активен;
	Элементы.ГруппаФильтров.Доступность = НЕ Активен;
	
	Элементы.КомандаЗапуститьТесты.Видимость = НЕ Активен;
	Элементы.КомандаОстановитьТесты.Видимость = Активен;
	
	Элементы.КомандаОбновитьСписок.Видимость = НЕ Активен;
	Элементы.КомандаЭкспортироватьОтчет.Видимость = НЕ Активен;
	
КонецПроцедуры

// Запускает тесты асинхронно
Процедура ЗапуститьТестыАсинхронно(ВыбранныеНаборы)
	
	РезультатыТестирования.Очистить();
	ИндикаторВыполнения = 0;
	ВсегоТестов = ВыбранныеНаборы.Количество();
	
	// В реальном проекте здесь был бы код для выполнения в отдельном потоке
	// Для демонстрации - синхронное выполнение с имитацией задержки
	
	Для Индекс = 0 По ВыбранныеНаборы.Количество() - 1 Цикл
		
		ИмяНабора = ВыбранныеНаборы[Индекс];
		
		// Обновляем статус набора
		СтрокаНабора = ТестовыеНаборы.Найти(ИмяНабора, "Имя");
		Если СтрокаНабора <> Неопределено Тогда
			СтрокаНабора.Статус = "Выполняется";
			ОбработкаПрерыванияПользователя();
		КонецЕсли;
		
		// Создаем набор тестов
		Набор = mcp_Тестирование.СоздатьНаборТестов(ИмяНабора, СтрокаНабора.Описание, СтрокаНабора.Категория);
		
		// Добавляем тесты для данного набора
		ДобавитьТестыВНабор(Набор, ИмяНабора);
		
		// В демо-режиме - имитируем выполнение
		ИмитироватьВыполнениеТеста(Набор);
		
		// Завершаем набор
		РезультатНабора = mcp_Тестирование.ЗавершитьНаборТестов(Набор);
		РезультатыТестирования.Добавить(РезультатНабора);
		
		// Обновляем статус набора
		Если СтрокаНабора <> Неопределено Тогда
			СтрокаНабора.Статус = РезультатНабора.Статус;
			СтрокаНабора.ВремяВыполнения = РезультатНабора.Длительность;
			СтрокаНабора.ПоследнийРезультат = СтрШаблon("%1/%2/%3", 
				РезультатНабора.Успешных, 
				РезультатНабора.Проваленных, 
				РезультатНабора.Пропущенных);
		КонецЕсли;
		
		// Обновляем прогресс
		ИндикаторВыполнения = ((Индекс + 1) / ВсегоТестов) * 100;
		
	КонецЦикла;
	
	// Завершаем выполнение
	УстановитьРежимВыполнения(Ложь);
	ИндикаторВыполнения = 100;
	
КонецПроцедуры

// Добавляет тесты в набор в зависимости от типа
Процедура ДобавитьТестыВНабор(Набор, ИмяНабора)
	
	Если ИмяНабора = "MCP_Инструменты_Основные" Тогда
		// Добавляем тесты для инструментов
		ДобавитьБазовыеТестыИнструментов(Набор);
	ИначеЕсли ИмяНабора = "MCP_HTTP_Сервисы" Тогда
		// Добавляем тесты HTTP сервисов
		ДобавитьТестыHTTPServices(Набор);
	ИначеЕсли ИмяНабора = "MCP_JSON_RPC" Тогда
		// Добавляем тесты JSON-RPC
		ДобавитьТестыJSONRPC(Набор);
	ИначеЕсли ИмяНабора = "MCP_ОбщегоНазначения" Тогда
		// Добавляем тесты модуля общего назначения
		ДобавитьТестыОбщегоНазначения(Набор);
	КонецЕсли;
	
КонецПроцедуры

// Добавляет базовые тесты для MCP инструментов
Процедура ДобавитьБазовыеТестыИнструментов(Набор)
	
	// В реальном проекте здесь бы были конкретные тестовые функции
	// Добавляем демо-тесты для примера
	
	Для Индекс = 1 По 3 Цикл
		ТестовоеИмя = СтрШаблон("Тест_Инструмент_%1", Индекс);
		mcp_Тестирование.ВыполнитьТест(Набор, ТестовоеИмя, "Тест_Инструмент_" + Индекс);
	КонецЦикла;
	
КонецПроцедуры

// Добавляет тесты для HTTP сервисов
Процедура ДобавитьТестыHTTPServices(Набор)
	
	mcp_Тестирование.ВыполнитьТест(Набор, "Тест_health_GET", "Тест_health_GET");
	mcp_Тестирование.ВыполнитьТест(Набор, "Тест_mcp_POST", "Тест_mcp_POST");
	mcp_Тестирование.ВыполнитьТест(Набор, "Тест_mcp_GET_405", "Тест_mcp_GET_405");
	
КонецПроцедуры

// Добавляет тесты для JSON-RPC
Процедура ДобавитьТестыJSONRPC(Набор)
	
	mcp_Тестирование.ВыполнитьТест(Набор, "Тест_initialize", "Тест_initialize");
	mcp_Тестирование.ВыполнитьТест(Набор, "Тест_tools_list", "Тест_tools_list");
	mcp_Тестирование.ВыполнитьТест(Набор, "Тест_resources_list", "Тест_resources_list");
	
КонецПроцедуры

// Добавляет тесты для модуля общего назначения
Процедура ДобавитьТестыОбщегоНазначения(Набор)
	
	mcp_Тестирование.ВыполнитьТест(Набор, "Тест_JSONВСтруктуру", "Тест_JSONВСтруктуру");
	mcp_Тестирование.ВыполнитьТест(Набор, "Тест_СтруктураВJSON", "Тест_СтруктураВJSON");
	mcp_Тестирование.ВыполнитьТест(Набор, "Тест_РазобратьURL", "Тест_РазобратьURL");
	
КонецПроцедуры

// Имитирует выполнение теста (демо-версия)
Процедура ИмитироватьВыполнениеТеста(Набор)
	
	// В реальном проекте тесты выполняются настоящими функциями
	// Здесь имитируем работу для демонстрации интерфейса
	
	// Небольшая задержка для имитации работы
	Для Индекс = 1 По 100000 Цикл
		// Имитация работы
	КонецЦикла;
	
КонецПроцедуры

#КонецОбласти

#Область ДемоТестовыеФункции

// Демо-тест инструмента
Процедура Тест_Инструмент_1() Экспорт
	
	// Arrange
	Параметры = Новый Структура("test", "data");
	ОжидаемыйРезультат = "test data";
	
	// Act (в демо версии просто сравниваем строки)
	ФактическийРезультат = "test data";
	
	// Assert
	mcp_Тестирование.ОжидаемРавно(ОжидаемыйРезультат, ФактическийРезультат, "Тест базовой функциональности");
	
КонецПроцедуры

Процедура Тест_Инструмент_2() Экспорт
	
	// Тест проверяет обработку ошибок
	mcp_Тестирование.ОжидаемЗаполненность("не пустая строка", "Строка должна быть заполнена");
	
КонецПроцедуры

Процедура Тест_Инструмент_3() Экспорт
	
	// Тест сравнения структур
	Структура1 = Новый Структура("key1, key2", "value1", "value2");
	Структура2 = Новый Структура("key1, key2", "value1", "value2");
	
	mcp_Тестирование.ОжидаемРавно(Структура1, Структура2, "Структуры должны быть равны");
	
КонецПроцедуры

// Демо-тесты HTTP сервисов
Процедура Тест_health_GET() Экспорт
	
	// Проверяем формат ответа /health
	ОтветДанные = Новый Структура("status", "ok");
	
	mcp_Тестирование.ОжидаемНаличиеКлюча(ОтветДанные, "status", "Ответ должен содержать поле status");
	mcp_Тестирование.ОжидаемРавно("ok", ОтветДанные.status, "Статус должен быть 'ok'");
	
КонецПроцедуры

Процедура Тест_mcp_POST() Экспорт
	
	// Проверяем, что POST метод поддерживается
	ФикстураЗапроса = mcp_Тестирование.СоздатьФикстуруHTTPЗапроса("{}");
	
	mcp_Тестирование.ОжидаемЗаполненность(ФикстураЗапроса.ТелоЗапроса, "Тело запроса должно быть заполнено");
	
КонецПроцедуры

Процедура Тест_mcp_GET_405() Экспорт
	
	// Проверяем, что GET метод возвращает 405
	ОжидаемыйКод = 405;
	ФактическийКод = 405;
	
	mcp_Тестирование.ОжидаемРавно(ОжидаемыйКод, ФактическийКод, "GET должен возвращать 405");
	
КонецПроцедуры

// Демо-тесты JSON-RPC
Процедура Тест_initialize() Экспорт
	
	ФикстураЗапроса = mcp_Тестирование.СоздатьФикстуруJSONRPCЗапроса("initialize", Новый Структура);
	
	mcp_Тестирование.ОжидаемРавно("initialize", ФикстураЗапроса.method, "Метод должен быть 'initialize'");
	mcp_Тестирование.ОжидаемРавно("2.0", ФикстураЗапроса.jsonrpc, "Версия JSON-RPC должна быть 2.0");
	
КонецПроцедуры

Процедура Тест_tools_list() Экспорт
	
	ФикстураЗапроса = mcp_Тестирование.СоздатьФикстуруJSONRPCЗапроса("tools/list", Новый Структура);
	
	mcp_Тестирование.ОжидаемРавно("tools/list", ФикстураЗапроса.method, "Метод должен быть 'tools/list'");
	
КонецПроцедуры

Процедура Тест_resources_list() Экспорт
	
	ФикстураЗапроса = mcp_Тестирование.СоздатьФикстуруJSONRPCЗапроса("resources/list", Новый Структура);
	
	mcp_Тестирование.ОжидаемРавно("resources/list", ФикстураЗапроса.method, "Метод должен быть 'resources/list'");
	
КонецПроцедуры

// Демо-тесты модуля общего назначения
Процедура Тест_JSONВСтруктуру() Экспорт
	
	СтрокаJSON = "{""key"":""value""}";
	Результат = mcp_ОбщегоНазначения.JSONВСтруктуру(СтрокаJSON);
	
	mcp_Тестирование.ОжидаемНаличиеКлюча(Результат, "key", "Результат должен содержать ключ 'key'");
	mcp_Тестирование.ОжидаемРавно("value", Результат.key, "Значение должно быть 'value'");
	
КонецПроцедуры

Процедура Тест_СтруктураВJSON() Экспорт
	
	Структура = Новый Структура("key", "value");
	Результат = mcp_ОбщегоНазначения.СтруктураВJSON(Структура);
	
	mcp_Тестирование.ОжидаемНаличиеВКоллекции(СтрРазделить(Результат, """"), "key", "JSON должен содержать ключ");
	
КонецПроцедуры

Процедура Тест_РазобратьURL() Экспорт
	
	URL = "https://example.com:8080/path";
	Результат = mcp_ОбщегоНазначения.РазобратьURL(URL);
	
	mcp_Тестирование.ОжидаемРавно("https", Результат.Схема, "Схема должна быть https");
	mcp_Тестирование.ОжидаемРавно("example.com", Результат.Хост, "Хост должен быть example.com");
	mcp_Тестирование.ОжидаемРавно(8080, Результат.Порт, "Порт должен быть 8080");
	
КонецПроцедуры

#КонецОбласти