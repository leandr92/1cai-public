#Область СлужебныйПрограммныйИнтерфейс

// Основной модуль фреймворка тестирования MCP
// Соответствует стандартам xUnitFor1C и современным практикам тестирования 1С

// Репозиторий проекта: 
// https://github.com/vladimir-kharin/1c_mcp
// 
// Часть проекта 1c_mcp: Фреймворк тестирования
// Харин Владимир (С) 2025. https://vharin.ru

#Область Инициализация

// Инициализирует тестовый фреймворк MCP
// 
// Возвращаемое значение:
//  Булево - Истина, если инициализация прошла успешно
Функция Инициализировать() Экспорт
	
	// Создаем таблицу результатов тестов
	СоздатьТаблицуРезультатов();
	
	// Регистрируем в журнале событие
	ЗаписатьВЖурнал("MCP_TESTS", "Инициализация тестового фреймворка", 1);
	
	Возврат Истина;
	
КонецФункции

#КонецОбласти

#Область ТестовыеНаборы

// Создает новый тестовый набор
//
// Параметры:
//  ИмяНабора - Строка - имя тестового набора
//  Описание - Строка - описание набора тестов
//  Категория - Строка - категория тестов (юнит, интеграционные, E2E)
//
// Возвращаемое значение:
//  Структура - описание тестового набора
Функция СоздатьНаборТестов(ИмяНабора, Описание = "", Категория = "юнит") Экспорт
	
	НаборТестов = Новый Структура;
	НаборТестов.Вставить("Имя", ИмяНабора);
	НаборТестов.Вставить("Описание", Описание);
	НаборТестов.Вставить("Категория", Категория);
	НаборТестов.Вставить("Тесты", Новый Массив);
	НаборТестов.Вставить("ВремяНачала", ТекущаяДатаСеанса());
	НаборТестов.Вставить("Статус", "Выполняется");
	
	Возврат НаборТестов;
	
КонецФункции

// Завершает тестовый набор и сохраняет результаты
//
// Параметры:
//  НаборТестов - Структура - описание тестового набора
//
// Возвращаемое значение:
//  Структура - результаты выполнения набора
Функция ЗавершитьНаборТестов(НаборТестов) Экспорт
	
	НаборТестов.Вставить("ВремяОкончания", ТекущаяДатаСеанса());
	НаборТестов.Вставить("Длительность", НаборТестов.ВремяОкончания - НаборТестов.ВремяНачала);
	
	// Подсчет статистики
	ОбщееКоличество = НаборТестов.Тесты.Количество();
	Успешных = 0;
	Проваленных = 0;
	Пропущенных = 0;
	
	Для Каждого Тест Из НаборТестов.Тесты Цикл
		Если Тест.Статус = "Пройден" Тогда
			Успешных = Успешных + 1;
		ИначеЕсли Тест.Статус = "Провален" Тогда
			Проваленных = Проваленных + 1;
		Иначе
			Пропущенных = Пропущенных + 1;
		КонецЕсли;
	КонецЦикла;
	
	НаборТестов.Вставить("ОбщееКоличество", ОбщееКоличество);
	НаборТестов.Вставить("Успешных", Успешных);
	НаборТестов.Вставить("Проваленных", Проваленных);
	НаборТестов.Вставить("Пропущенных", Пропущенных);
	
	// Определяем общий статус
	Если Проваленных > 0 Тогда
		НаборТестов.Статус = "Провален";
	ИначеЕсли Успешных > 0 Тогда
		НаборТестов.Статус = "Успешен";
	Иначе
		НаборТестов.Статус = "Пуст";
	КонецЕсли;
	
	ЗаписатьВЖурнал("MCP_TESTS", 
		СтрШаблон("Завершен набор '%1': %2/%3/%4", 
			ИмяНабора, Успешных, Проваленных, Пропущенных), 1);
	
	Возврат НаборТестов;
	
КонецФункции

#КонецОбласти

#Область ВыполнениеТестов

// Выполняет тест с setup и teardown
//
// Параметры:
//  НаборТестов - Структура - тестовый набор
//  ИмяТеста - Строка - имя теста
//  ТестоваяФункция - Строка - имя функции для выполнения теста
//  ДанныеФикстуры - Произвольный - данные фикстуры (опционально)
Процедура ВыполнитьТест(НаборТестов, ИмяТеста, ТестоваяФункция, ДанныеФикстуры = Неопределено) Экспорт
	
	РезультатТеста = Новый Структура;
	РезультатТеста.Вставить("Имя", ИмяТеста);
	РезультатТеста.Вставить("Статус", "Пройден");
	РезультатТеста.Вставить("ВремяНачала", ТекущаяДатаСеанса());
	РезультатТеста.Вставить("ВремяОкончания", "");
	РезультатТеста.Вставить("Длительность", 0);
	РезультатТеста.Вставить("ОписаниеОшибки", "");
	РезультатТеста.Вставить("Сообщения", Новый Массив);
	РезультатТеста.Вставить("Фикстуры", ДанныеФикстуры);
	
	Попытка
		
		// Выполняем setup
		Если ЕстьМетодSetup(ТестоваяФункция) Тогда
			ВыполнитьМетод("Setup_" + ТестоваяФункция, ДанныеФикстуры);
		КонецЕсли;
		
		// Выполняем основной тест
		ВыполнитьМетод(ТестоваяФункция, ДанныеФикстуры);
		
		// Выполняем teardown
		Если ЕстьМетодTeardown(ТестоваяФункция) Тогда
			ВыполнитьМетод("Teardown_" + ТестоваяФункция, ДанныеФикстуры);
		КонецЕсли;
		
	Исключение
		
		ИнформацияОбОшибке = ИнформацияОбОшибке();
		РезультатТеста.Статус = "Провален";
		РезультатТеста.ОписаниеОшибки = ПодробноеПредставлениеОшибки(ИнформацияОбОшибке);
		
		ЗаписатьВЖурнал("MCP_TESTS", 
			СтрШаблон("Тест '%1' провален: %2", ИмяТеста, РезультатТеста.ОписаниеОшибки), 3);
		
	КонецПопытки;
	
	РезультатТеста.ВремяОкончания = ТекущаяДатаСеанса();
	РезультатТеста.Длительность = РезультатТеста.ВремяОкончания - РезультатТеста.ВремяНачала;
	
	// Добавляем в набор
	НаборТестов.Тесты.Добавить(РезультатТеста);
	
КонецПроцедуры

#КонецОбласти

#Область Assertions

// Проверяет, что два значения равны
//
// Параметры:
//  Ожидаемое - Произвольный - ожидаемое значение
//  Фактическое - Произвольный - фактическое значение
//  Сообщение - Строка - сообщение при несоответствии
Процедура ОжидаемРавно(Ожидаемое, Фактическое, Сообщение = "") Экспорт
	
	Если НЕ СравнитьЗначения(Ожидаемое, Фактическое) Тогда
		
		ТекстОшибки = СтрШаблон("Ожидалось: %1, получено: %2%3", 
			Строка(Ожидаемое), 
			Строка(Фактическое), 
			?(ЗначениеЗаполнено(Сообщение), Символы.ПС + Сообщение, ""));
		
		ВызватьИсключение ТекстОшибки;
		
	КонецЕсли;
	
КонецПроцедуры

// Проверяет, что два значения НЕ равны
//
// Параметры:
//  НеОжидаемое - Произвольный - значение, которое не должно быть получено
//  Фактическое - Произвольный - фактическое значение
//  Сообщение - Строка - сообщение при несоответствии
Процедура ОжидаемНеРавно(НеОжидаемое, Фактическое, Сообщение = "") Экспорт
	
	Если СравнитьЗначения(НеОжидаемое, Фактическое) Тогда
		
		ТекстОшибки = СтрШаблон("Не ожидалось значение: %1%2", 
			Строка(Фактическое), 
			?(ЗначениеЗаполнено(Сообщение), Символы.ПС + Сообщение, ""));
		
		ВызватьИсключение ТекстОшибки;
		
	КонецЕсли;
	
КонецПроцедуры

// Проверяет, что значение Истина
//
// Параметры:
//  Условие - Булево - проверяемое условие
//  Сообщение - Строка - сообщение при несоответствии
Процедура ОжидаемИстину(Условие, Сообщение = "Условие должно быть истинным") Экспорт
	
	Если НЕ Условие Тогда
		ВызватьИсключение Сообщение;
	КонецЕсли;
	
КонецПроцедуры

// Проверяет, что значение Ложь
//
// Параметры:
//  Условие - Булево - проверяемое условие
//  Сообщение - Строка - сообщение при несоответствии
Процедура ОжидаемЛожь(Условие, Сообщение = "Условие должно быть ложным") Экспорт
	
	Если Условие Тогда
		ВызватьИсключение Сообщение;
	КонецЕсли;
	
КонецПроцедуры

// Проверяет, что значение неопределено
//
// Параметры:
//  Значение - Произвольный - проверяемое значение
//  Сообщение - Строка - сообщение при несоответствии
Процедура ОжидаемНеопределено(Значение, Сообщение = "Значение должно быть неопределено") Экспорт
	
	Если Значение <> Неопределено Тогда
		ТекстОшибки = СтрШаблон("%1 (фактически: %2)", Сообщение, Строка(Значение));
		ВызватьИсключение ТекстОшибки;
	КонецЕсли;
	
КонецПроцедуры

// Проверяет, что значение заполнено
//
// Параметры:
//  Значение - Произвольный - проверяемое значение
//  Сообщение - Строка - сообщение при несоответствии
Процедура ОжидаемЗаполненность(Значение, Сообщение = "Значение должно быть заполнено") Экспорт
	
	Если НЕ ЗначениеЗаполнено(Значение) Тогда
		ТекстОшибки = СтрШаблон("%1 (фактически: %2)", Сообщение, Строка(Значение));
		ВызватьИсключение ТекстОшибки;
	КонецЕсли;
	
КонецПроцедуры

// Проверяет, что коллекция содержит элемент
//
// Параметры:
//  Коллекция - Массив - проверяемая коллекция
//  Элемент - Произвольный - искомый элемент
//  Сообщение - Строка - сообщение при несоответствии
Процедура ОжидаемНаличиеВКоллекции(Коллекция, Элемент, Сообщение = "") Экспорт
	
	Если ТипЗнч(Коллекция) <> Тип("Массив") Тогда
		ВызватьИсключение "Проверяемая коллекция должна быть массивом";
	КонецЕсли;
	
	Найден = Ложь;
	Для Каждого ЭлементКоллекции Из Коллекция Цикл
		Если СравнитьЗначения(Элемент, ЭлементКоллекции) Тогда
			Найден = Истина;
			Прервать;
		КонецЕсли;
	КонецЦикла;
	
	Если НЕ Найден Тогда
		ТекстОшибки = СтрШаблон("Элемент '%1' не найден в коллекции%2", 
			Строка(Элемент), 
			?(ЗначениеЗаполнено(Сообщение), Символы.ПС + Сообщение, ""));
		ВызватьИсключение ТекстОшибки;
	КонецЕсли;
	
КонецПроцедуры

// Проверяет, что в структуре есть ключ
//
// Параметры:
//  СтруктураДанных - Структура - проверяемая структура
//  Ключ - Строка - искомый ключ
//  Сообщение - Строка - сообщение при несоответствии
Процедура ОжидаемНаличиеКлюча(СтруктураДанных, Ключ, Сообщение = "") Экспорт
	
	Если ТипЗнч(СтруктураДанных) <> Тип("Структура") Тогда
		ВызватьИсключение "Проверяемые данные должны быть структурой";
	КонецЕсли;
	
	Если НЕ СтруктураДанных.Свойство(Ключ) Тогда
		ТекстОшибки = СтрШаблон("Ключ '%1' не найден в структуре%2", 
			Ключ, 
			?(ЗначениеЗаполнено(Сообщение), Символы.ПС + Сообщение, ""));
		ВызватьИсключение ТекстОшибки;
	КонецЕсли;
	
КонецПроцедуры

// Проверяет, что в JSON-RPC ответе есть ошибка
//
// Параметры:
//  Ответ - Структура - ответ сервера
//  КодОшибки - Число - ожидаемый код ошибки (опционально)
//  Сообщение - Строка - сообщение при несоответствии
Процедура ОжидаемJSONRPCОшибку(Ответ, КодОшибки = Неопределено, Сообщение = "") Экспорт
	
	Если ТипЗнч(Ответ) <> Тип("Структура") Тогда
		ВызватьИсключение "Ответ должен быть структурой";
	КонецЕсли;
	
	// Проверяем наличие поля error
	Если НЕ Ответ.Свойство("error") Тогда
		ТекстОшибки = "В ответе отсутствует поле 'error'" + 
			?(ЗначениеЗаполнено(Сообщение), Символы.ПС + Сообщение, "");
		ВызватьИсключение ТекстОшибки;
	КонецЕсли;
	
	// Проверяем код ошибки, если указан
	Если КодОшибки <> Неопределено Тогда
		Ошибка = Ответ.error;
		Если НЕ Ошибка.Свойство("code") ИЛИ Ошибка.code <> КодОшибки Тогда
			ТекстОшибки = СтрШаблон("Ожидался код ошибки %1, получен: %2%3", 
				КодОшибки, 
				?(Ошибка.Свойство("code"), Ошибка.code, "не указан"), 
				?(ЗначениеЗаполнено(Сообщение), Символы.ПС + Сообщение, ""));
			ВызватьИсключение ТекстОшибки;
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры

// Проверяет, что JSON-RPC ответ успешный
//
// Параметры:
//  Ответ - Структура - ответ сервера
//  Сообщение - Строка - сообщение при несоответствии
Процедура ОжидаемJSONRPCУспех(Ответ, Сообщение = "") Экспорт
	
	Если ТипЗнч(Ответ) <> Тип("Структура") Тогда
		ВызватьИсключение "Ответ должен быть структурой";
	КонецЕсли;
	
	// Проверяем отсутствие поля error
	Если Ответ.Свойство("error") Тогда
		ТекстОшибки = "Ответ не должен содержать ошибки" + 
			?(ЗначениеЗаполнено(Сообщение), Символы.ПС + Сообщение, "") +
			Символы.ПС + "Полученная ошибка: " + Строка(Ответ.error);
		ВызватьИсключение ТекстОшибки;
	КонецЕсли;
	
	// Проверяем наличие поля result
	Если НЕ Ответ.Свойство("result") Тогда
		ТекстОшибки = "В успешном ответе должно быть поле 'result'" + 
			?(ЗначениеЗаполнено(Сообщение), Символы.ПС + Сообщение, "");
		ВызватьИсключение ТекстОшибки;
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

#Область Фикстуры

// Создает фикстуру для JSON-RPC запроса
//
// Параметры:
//  Метод - Строка - имя метода
//  Параметры - Структура - параметры запроса
//  Идентификатор - Число - идентификатор запроса (опционально)
//
// Возвращаемое значение:
//  Структура - JSON-RPC запрос
Функция СоздатьФикстуруJSONRPCЗапроса(Метод, Параметры, Идентификатор = 1) Экспорт
	
	Фикстура = Новый Структура;
	Фикстура.Вставить("jsonrpc", "2.0");
	Фикстура.Вставить("id", Идентификатор);
	Фикстура.Вставить("method", Метод);
	Фикстура.Вставить("params", Параметры);
	
	Возврат Фикстура;
	
КонецФункции

// Создает фикстуру для инструмента MCP
//
// Параметры:
//  ИмяИнструмента - Строка - имя инструмента
//  Аргументы - Структура - аргументы для инструмента
//
// Возвращаемое значение:
//  Структура - фикстура для вызова инструмента
Функция СоздатьФикстуруИнструмента(ИмяИнструмента, Аргументы) Экспорт
	
	Фикстура = Новый Структура;
	Фикстура.Вставить("name", ИмяИнструмента);
	Фикстура.Вставить("arguments", Аргументы);
	
	Возврат Фикстура;
	
КонецФункции

// Создает фикстуру для HTTP запроса
//
// Параметры:
//  ТелоЗапроса - Строка - JSON строка тела запроса
//  Заголовки - Структура - заголовки запроса (опционально)
//
// Возвращаемое значение:
//  Структура - имитация HTTP запроса
Функция СоздатьФикстуруHTTPЗапроса(ТелоЗапроса, Заголовки = Неопределено) Экспорт
	
	Фикстура = Новый Структура;
	Фикстура.Вставить("ТелоЗапроса", ТелоЗапроса);
	
	Если Заголовки <> Неопределено Тогда
		Фикстура.Вставить("Заголовки", Заголовки);
	Иначе
		Фикстура.Вставить("Заголовки", Новый Структура);
	КонецЕсли;
	
	Возврат Фикстура;
	
КонецФункции

#КонецОбласти

#Область УтилитыСравнения

// Сравнивает две структуры по содержимому
//
// Параметры:
//  Структура1 - Структура - первая структура
//  Структура2 - Структура - вторая структура
//  ИгнорироватьПорядок - Булево - игнорировать порядок ключей (по умолчанию Ложь)
//
// Возвращаемое значение:
//  Булево - Истина, если структуры равны
Функция СравнитьСтруктуры(Структура1, Структура2, ИгнорироватьПорядок = Ложь) Экспорт
	
	Если ТипЗнч(Структура1) <> Тип("Структура") 
		ИЛИ ТипЗнч(Структура2) <> Тип("Структура") Тогда
		Возврат Ложь;
	КонецЕсли;
	
	// Сравниваем количество ключей
	Если Структура1.Количество() <> Структура2.Количество() Тогда
		Возврат Ложь;
	КонецЕсли;
	
	// Сравниваем каждый ключ и значение
	Для Каждого КлючЗначение Из Структура1 Цикл
		
		Если НЕ Структура2.Свойство(КлючЗначение.Ключ) Тогда
			Возврат Ложь;
		КонецЕсли;
		
		// Рекурсивно сравниваем значения
		Если НЕ СравнитьЗначения(КлючЗначение.Значение, Структура2[КлючЗначение.Ключ]) Тогда
			Возврат Ложь;
		КонецЕсли;
		
	КонецЦикла;
	
	Возврат Истина;
	
КонецФункции

// Сравнивает два значения произвольного типа
//
// Параметры:
//  Значение1 - Произвольный - первое значение
//  Значение2 - Произвольный - второе значение
//
// Возвращаемое значение:
//  Булево - Истина, если значения равны
Функция СравнитьЗначения(Значение1, Значение2) Экспорт
	
	// Простые типы
	Если Значение1 = Значение2 Тогда
		Возврат Истина;
	КонецЕсли;
	
	// Специальная обработка для Неопределено и Null
	Если (Значение1 = Неопределено ИЛИ Значение1 = Null) 
		И (Значение2 = Неопределено ИЛИ Значение2 = Null) Тогда
		Возврат Истина;
	КонецЕсли;
	
	// Структуры
	Если ТипЗнч(Значение1) = Тип("Структура") Тогда
		Возврат СравнитьСтруктуры(Значение1, Значение2);
	КонецЕсли;
	
	// Массивы
	Если ТипЗнч(Значение1) = Тип("Массив") Тогда
		Возврат СравнитьМассивы(Значение1, Значение2);
	КонецЕсли;
	
	// Соответствия
	Если ТипЗнч(Значение1) = Тип("Соответствие") Тогда
		Возврат СравнитьСоответствия(Значение1, Значение2);
	КонецЕсли;
	
	// Для строк - дополнительная проверка на пустые строки
	Если ТипЗнч(Значение1) = Тип("Строка") И ТипЗнч(Значение2) = Тип("Строка") Тогда
		Возврат СокрЛП(Значение1) = СокрЛП(Значение2);
	КонецЕсли;
	
	Возврат Ложь;
	
КонецФункции

#КонецОбласти

#Область Отчетность

// Создает отчет о результатах тестирования
//
// Параметры:
//  НаборыТестов - Массив - массив результатов тестовых наборов
//  Формат - Строка - формат отчета ("XML", "JSON", "HTML", "Простой")
//
// Возвращаемое значение:
//  Строка - отчет в указанном формате
Функция СоздатьОтчет(НаборыТестов, Формат = "Простой") Экспорт
	
	Если Формат = "XML" Тогда
		Возврат СоздатьОтчетXML(НаборыТестов);
	ИначеЕсли Формат = "JSON" Тогда
		Возврат СоздатьОтчетJSON(НаборыТестов);
	ИначеЕсли Формат = "HTML" Тогда
		Возврат СоздатьОтчетHTML(НаборыТестов);
	Иначе
		Возврат СоздатьОтчетПростой(НаборыТестов);
	КонецЕсли;
	
КонецФункции

// Сохраняет отчет в файл
//
// Параметры:
//  Отчет - Строка - содержимое отчета
//  ИмяФайла - Строка - имя файла для сохранения
//  Расширение - Строка - расширение файла (опционально)
//
// Возвращаемое значение:
//  Строка - полный путь к сохраненному файлу
Функция СохранитьОтчетВФайл(Отчет, ИмяФайла, Расширение = "") Экспорт
	
	Если НЕ ЗначениеЗаполнено(Расширение) Тогда
		Расширение = ".txt";
	КонецЕсли;
	
	ПолноеИмяФайла = КаталогВременныхФайлов() + ИмяФайла + Расширение;
	
	ЗаписьТекста = Новый ЗаписьТекста(ПолноеИмяФайла, КодировкаТекста.UTF8);
	ЗаписьТекста.Записать(Отчет);
	ЗаписьТекста.Закрыть();
	
	ЗаписатьВЖурнал("MCP_TESTS", СтрШаблон("Отчет сохранен в файл: %1", ПолноеИмяФайла), 1);
	
	Возврат ПолноеИмяФайла;
	
КонецФункции

#КонецОбласти

#Класс

#Область СлужебныеПроцедурыИФункции

// Создает таблицу для хранения результатов тестов
Процедура СоздатьТаблицуРезультатов()
	
	// Инициализация структуры для хранения результатов
	// В реальной реализации это может быть регистр сведений или справочник
	
КонецПроцедуры

// Проверяет наличие метода setup для теста
Функция ЕстьМетодSetup(ИмяТеста)
	
	Попытка
		ВыполнитьМетод("Setup_" + ИмяТеста, Неопределено, Истина);
		Возврат Истина;
	Исключение
		Возврат Ложь;
	КонецПопытки;
	
КонецФункции

// Проверяет наличие метода teardown для теста
Функция ЕстьМетодTeardown(ИмяТеста)
	
	Попытка
		ВыполнитьМетод("Teardown_" + ИмяТеста, Неопределено, Истина);
		Возврат Истина;
	Исключение
		Возврат Ложь;
	КонецПопытки;
	
КонецФункции

// Выполняет метод по имени (используется для тестовых функций)
Процедура ВыполнитьМетод(ИмяМетода, ДанныеФикстуры, ПроверкаНаличия = Ложь)
	
	Если ПроверкаНаличия Тогда
		// Просто проверяем существование метода
		Выполнить(ИмяМетода + "()");
	Иначе
		// Выполняем метод с данными фикстуры
		Выполнить(ИмяМетода + "(ДанныеФикстуры)");
	КонецЕсли;
	
КонецПроцедуры

// Сравнивает два массива
Функция СравнитьМассивы(Массив1, Массив2)
	
	Если ТипЗнч(Массив1) <> Тип("Массив") ИЛИ ТипЗнч(Массив2) <> Тип("Массив") Тогда
		Возврат Ложь;
	КонецЕсли;
	
	Если Массив1.Количество() <> Массив2.Количество() Тогда
		Возврат Ложь;
	КонецЕсли;
	
	Для Индекс = 0 По Массив1.Количество() - 1 Цикл
		Если НЕ СравнитьЗначения(Массив1[Индекс], Массив2[Индекс]) Тогда
			Возврат Ложь;
		КонецЕсли;
	КонецЦикла;
	
	Возврат Истина;
	
КонецФункции

// Сравнивает два соответствия
Функция СравнитьСоответствия(Соответствие1, Соответствие2)
	
	Если ТипЗнч(Соответствие1) <> Тип("Соответствие") 
		ИЛИ ТипЗнч(Соответствие2) <> Тип("Соответствие") Тогда
		Возврат Ложь;
	КонецЕсли;
	
	Если Соответствие1.Количество() <> Соответствие2.Количество() Тогда
		Возврат Ложь;
	КонецЕсли;
	
	Для Каждого КлючЗначение Из Соответствие1 Цикл
		
		Если НЕ Соответствие2.Получить(КлючЗначение.Ключ) <> Неопределено Тогда
			Возврат Ложь;
		КонецЕсли;
		
		// Рекурсивно сравниваем значения
		Если НЕ СравнитьЗначения(КлючЗначение.Значение, Соответствие2[КлючЗначение.Ключ]) Тогда
			Возврат Ложь;
		КонецЕсли;
		
	КонецЦикла;
	
	Возврат Истина;
	
КонецФункции

// Создает простой текстовый отчет
Функция СоздатьОтчетПростой(НаборыТестов)
	
	Отчет = "";
	Отчет = Отчет + "=== ОТЧЕТ О ТЕСТИРОВАНИИ MCP ===" + Символы.ПС;
	Отчет = Отчет + "Дата: " + ТекущаяДатаСеанса() + Символы.ПС;
	Отчет = Отчет + "Количество наборов: " + НаборыТестов.Количество() + Символы.ПС;
	Отчет = Отчет + Символы.ПС;
	
	ОбщееУспешных = 0;
	ОбщееПроваленных = 0;
	ОбщееПропущенных = 0;
	ОбщаяДлительность = 0;
	
	Для Каждого Набор Из НаборыТестов Цикл
		
		Отчет = Отчет + "Набор: " + Набор.Имя + Символы.ПС;
		Отчет = Отчет + "Статус: " + Набор.Статус + Символы.ПС;
		Отчет = Отчет + "Длительность: " + Набор.Длительность + " сек" + Символы.ПС;
		Отчет = Отчет + "Тестов: " + Набор.ОбщееКоличество + 
			" (успешных: " + Набор.Успешных + 
			", проваленных: " + Набор.Проваленных + 
			", пропущенных: " + Набор.Пропущенных + ")" + Символы.ПС;
		
		ОбщееУспешных = ОбщееУспешных + Набор.Успешных;
		ОбщееПроваленных = ОбщееПроваленных + Набор.Проваленных;
		ОбщееПропущенных = ОбщееПропущенных + Набор.Пропущенных;
		ОбщаяДлительность = ОбщаяДлительность + Набор.Длительность;
		
		// Детали проваленных тестов
		Если Набор.Проваленных > 0 Тогда
			Отчет = Отчет + "Проваленные тесты:" + Символы.ПС;
			Для Каждого Тест Из Набор.Тесты Цикл
				Если Тест.Статус = "Провален" Тогда
					Отчет = Отчет + "  - " + Тест.Имя + Символы.ПС;
					Отчет = Отчет + "    Ошибка: " + Тест.ОписаниеОшибки + Символы.ПС;
				КонецЕсли;
			КонецЦикла;
		КонецЕсли;
		
		Отчет = Отчет + Символы.ПС;
		
	КонецЦикла;
	
	// Итоговая статистика
	Отчет = Отчет + "=== ИТОГОВАЯ СТАТИСТИКА ===" + Символы.ПС;
	Отчет = Отчет + "Общее количество тестов: " + (ОбщееУспешных + ОбщееПроваленных + ОбщееПропущенных) + Символы.ПС;
	Отчет = Отчет + "Успешных: " + ОбщееУспешных + Символы.ПС;
	Отчет = Отчет + "Проваленных: " + ОбщееПроваленных + Символы.ПС;
	Отчет = Отчет + "Пропущенных: " + ОбщееПропущенных + Символы.ПС;
	Отчет = Отчет + "Общая длительность: " + ОбщаяДлительность + " сек" + Символы.ПС;
	
	Если ОбщееПроваленных = 0 Тогда
		Отчет = Отчет + Символы.ПС + "ВСЕ ТЕСТЫ ПРОЙДЕНЫ УСПЕШНО!" + Символы.ПС;
	Иначе
		Отчет = Отчет + Символы.ПС + "ОБНАРУЖЕНЫ ПРОВАЛЕННЫЕ ТЕСТЫ!" + Символы.ПС;
	КонецЕсли;
	
	Возврат Отчет;
	
КонецФункции

// Создает XML отчет
Функция СоздатьОтчетXML(НаборыТестов)
	
	XMLОтчет = "";
	XMLОтчет = XMLОтчет + "<?xml version=""1.0"" encoding=""UTF-8""?>" + Символы.ПС;
	XMLОтчет = XMLОтчет + "<testsuites>" + Символы.ПС;
	
	Для Каждого Набор Из НаборыТестов Цикл
		
		XMLОтчет = XMLОтчет + СтрШаблон("  <testsuite name=""%1"" tests=""%2"" failures=""%3"" errors=""0"" time=""%4"">", 
			XMLСтрока(Набор.Имя), 
			Набор.ОбщееКоличество, 
			Набор.Проваленных, 
			Набор.Длительность) + Символы.ПС;
		
		Для Каждого Тест Из Набор.Тесты Цикл
			
			Статус = ?(Тест.Статус = "Пройден", "passed", "failed");
			ВремяТеста = Тест.Длительность;
			
			XMLОтчет = XMLОтчет + СтрШаблон("    <testcase name=""%1"" classname=""%2.%3"" time=""%4"">", 
				XMLСтрока(Тест.Имя), 
				XMLСтрока("MCP"), 
				XMLСтрока(Набор.Имя), 
				ВремяТеста) + Символы.ПС;
			
			Если Тест.Статус = "Провален" Тогда
				XMLОтчет = XMLОтчет + СтрШаблон("      <failure message=""%1"">%2</failure>", 
					XMLСтрока("Тест провален"), 
					XMLСтрока(Тест.ОписаниеОшибки)) + Символы.ПС;
			КонецЕсли;
			
			XMLОтчет = XMLОтчет + "    </testcase>" + Символы.ПС;
			
		КонецЦикла;
		
		XMLОтчет = XMLОтчет + "  </testsuite>" + Символы.ПС;
		
	КонецЦикла;
	
	XMLОтчет = XMLОтчет + "</testsuites>";
	
	Возврат XMLОтчет;
	
КонецФункции

// Создает JSON отчет
Функция СоздатьОтчетJSON(НаборыТестов)
	
	Отчет = Новый Структура;
	Отчет.Вставить("timestamp", ТекущаяДатаСеанса());
	Отчет.Вставить("testSuites", Новый Массив);
	
	Для Каждого Набор Из НаборыТестов Цикл
		
		НаборJSON = Новый Структура;
		НаборJSON.Вставить("name", Набор.Имя);
		НаборJSON.Вставить("status", Набор.Статус);
		НаборJSON.Вставить("duration", Набор.Длительность);
		НаборJSON.Вставить("tests", Новый Массив);
		
		Для Каждого Тест Из Набор.Тесты Цикл
			
			ТестJSON = Новый Структура;
			ТестJSON.Вставить("name", Тест.Имя);
			ТестJSON.Вставить("status", Тест.Статус);
			ТестJSON.Вставить("duration", Тест.Длительность);
			ТестJSON.Вставить("error", Тест.ОписаниеОшибки);
			
			НаборJSON.tests.Добавить(ТестJSON);
			
		КонецЦикла;
		
		Отчет.testSuites.Добавить(НаборJSON);
		
	КонецЦикла;
	
	Возврат mcp_ОбщегоНазначения.СтруктураВJSON(Отчет);
	
КонецФункции

// Создает HTML отчет
Функция СоздатьОтчетHTML(НаборыТестов)
	
	HTML = "";
	HTML = HTML + "<!DOCTYPE html>" + Символы.ПС;
	HTML = HTML + "<html><head>" + Символы.ПС;
	HTML = HTML + "<meta charset=""UTF-8"">" + Символы.ПС;
	HTML = HTML + "<title>Отчет о тестировании MCP</title>" + Символы.ПС;
	HTML = HTML + "<style>" + Символы.ПС;
	HTML = HTML + "body { font-family: Arial, sans-serif; margin: 20px; }" + Символы.ПС;
	HTML = HTML + ".summary { background: #f0f0f0; padding: 10px; margin-bottom: 20px; }" + Символы.ПС;
	HTML = HTML + ".test-suite { margin: 20px 0; border: 1px solid #ccc; }" + Символы.ПС;
	HTML = HTML + ".test-suite-header { background: #e0e0e0; padding: 10px; font-weight: bold; }" + Символы.ПС;
	HTML = HTML + ".test-case { margin: 10px; padding: 5px; }" + Символы.ПС;
	HTML = HTML + ".passed { color: green; }" + Символы.ПС;
	HTML = HTML + ".failed { color: red; }" + Символы.ПС;
	HTML = HTML + "</style></head><body>" + Символы.ПС;
	
	HTML = HTML + "<h1>Отчет о тестировании MCP</h1>" + Символы.ПС;
	HTML = HTML + СтрШаблон("<div class=""summary""><strong>Дата:</strong> %1<BR>", ТекущаяДатаСеанса());
	HTML = HTML + СтрШаблон("<strong>Количество наборов:</strong> %1</div>", НаборыТестов.Количество()) + Символы.ПС;
	
	Для Каждого Набор Из НаборыТестов Цикл
		
		HTML = HTML + СтрШаблон("<div class=""test-suite""><div class=""test-suite-header"">Набор: %1 (статус: %2)</div>", 
			Набор.Имя, Набор.Статус) + Символы.ПС;
		HTML = HTML + СтрШаблон("<div>Тестов: %1, Успешных: %2, Проваленных: %3, Длительность: %4 сек</div>", 
			Набор.ОбщееКоличество, Набор.Успешных, Набор.Проваленных, Набор.Длительность) + Символы.ПС;
		
		Для Каждого Тест Из Набор.Тесты Цикл
			
			КлассCSS = ?(Тест.Статус = "Пройден", "passed", "failed");
			HTML = HTML + СтрШаблон("<div class=""test-case %1"">• %2 (%3 сек)", 
				КлассCSS, Тест.Имя, Тест.Длительность);
			
			Если Тест.Статус = "Провален" Тогда
				HTML = HTML + СтрШаблон("<br><em>Ошибка:</em> %1", Тест.ОписаниеОшибки);
			КонецЕсли;
			
			HTML = HTML + "</div>" + Символы.ПС;
			
		КонецЦикла;
		
		HTML = HTML + "</div>" + Символы.ПС;
		
	КонецЦикла;
	
	HTML = HTML + "</body></html>";
	
	Возврат HTML;
	
КонецФункции

// Записывает сообщение в журнал регистрации 1С
Процедура ЗаписатьВЖурнал(ИмяСобытия, Сообщение, Уровень = 1)
	
	Попытка
		ЗаписьЖурналаРегистрации(
			СтрШаблон("MCP.Тестирование.%1", ИмяСобытия), 
			?(Уровень = 1, УровеньЖурналаРегистрации.Информация,
			?(Уровень = 2, УровеньЖурналаРегистрации.Предупреждение,
			УровеньЖурналаРегистрации.Ошибка)),
			, 
			, 
			Сообщение);
	Исключение
		// Игнорируем ошибки записи в журнал
	КонецПопытки;
	
КонецПроцедуры

#КонецОбласти

#КонецОбласти