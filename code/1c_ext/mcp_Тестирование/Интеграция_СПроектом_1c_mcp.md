# Интеграция фреймворка тестирования с проектом 1c_mcp

## Обзор интеграции

Данный документ описывает процесс интеграции фреймворка тестирования MCP с основным проектом 1c_mcp, включая настройку зависимостей и использование существующих модулей.

## Архитектура интеграции

### Основные компоненты

```
1c_mcp (основной проект)
├── CommonModules/
│   ├── mcp_ОбщегоНазначения    # Существующий модуль
│   ├── mcp_КонтейнерыПостИсп   # Существующий модуль
│   └── mcp_Выполнение          # Существующий модуль
├── HTTP_Services/
│   └── mcp_APIBackend          # HTTP сервисы
└── DataProcessors/
    └── mcp_Инструменты         # Обработки

mcp_Тестирование (фреймворк)
├── Module.bsl                   # Основной модуль тестирования
├── Forms/УправлениеТестами/     # UI для управления тестами
├── ТестовыеОбработки/          # Тестовые обработки
└── Утилиты/                    # Утилиты для тестирования
```

### Связи между компонентами

1. **mcp_Тестирование** использует **mcp_ОбщегоНазначения** для:
   - Парсинга JSON (`JSONВСтруктуру`, `СтруктураВJSON`)
   - Разборки URL (`РазобратьURL`)

2. **Тестовые обработки** интегрируются с:
   - **mcp_КонтейнерыПостИсп** для получения списков инструментов/ресурсов/промптов
   - **mcp_Выполнение** для выполнения инструментов
   - **mcp_APIBackend** для тестирования HTTP сервисов

## Пошаговая интеграция

### Шаг 1: Добавление зависимости в основной модуль

В файле `mcp_ОбщегоНазначения` добавляем поддержку тестовых функций:

```1c
// В конец модуля mcp_ОбщегоНазначения добавляем:

#Область Тестирование

// Функции для использования в тестах

// Создает тестовые данные для валидации
//
// Возвращаемое значение:
//  Структура - тестовые данные
Функция СоздатьТестовыеДанные() Экспорт
	
	Данные = Новый Структура;
	Данные.Вставить("ТестоваяСтрока", "test_value");
	Данные.Вставить("ТестовоеЧисло", 123);
	Данные.Вставить("ТестоваяДата", Дата('20250101'));
	
	Возврат Данные;
	
КонецФункции

// Проверяет корректность JSON строки
//
// Параметры:
//  JSONСтрока - Строка - проверяемая JSON строка
//
// Возвращаемое значение:
//  Булево - Истина, если JSON корректен
Функция ПроверитьКорректностьJSON(JSONСтрока) Экспорт
	
	Попытка
		Результат = JSONВСтруктуру(JSONСтрока);
		Возврат Истина;
	Исключение
		Возврат Ложь;
	КонецПопытки;
	
КонецФункции

// Генерирует тестовый URI для ресурса
//
// Параметры:
//  ИмяРесурса - Строка - имя ресурса
//
// Возвращаемое значение:
//  Строка - тестовый URI
Функция СгенерироватьТестовыйURI(ИмяРесурса) Экспорт
	
	Возврат "test://" + СтрЗаменить(ИмяРесурса, " ", "_");
	
КонецФункции

#КонецОбласти
```

### Шаг 2: Создание интеграционных тестов

Создаем тестовую обработку для проверки интеграции:

```1c
// Файл: ТестовыеОбработки/Тест_ИнтеграцияСMCP.epf

#Область ТестированиеИнтеграции

Процедура Тест_ДолженПроверитьИнтеграциюСОбщегоНазначения() Экспорт
	
	// Arrange
	ТестовыеДанные = mcp_ОбщегоНазначения.СоздатьТестовыеДанные();
	JSONСтрока = mcp_ОбщегоНазначения.СтруктураВJSON(ТестовыеДанные);
	
	// Act
	ВосстановленныеДанные = mcp_ОбщегоНазначения.JSONВСтруктуру(JSONСтрока);
	
	// Assert
	mcp_Тестирование.ОжидаемРавно(ТестовыеДанные, ВосстановленныеДанные, 
		"Данные должны корректно сериализоваться и десериализоваться");
	mcp_Тестирование.ОжидаемИстину(mcp_ОбщегоНазначения.ПроверитьКорректностьJSON(JSONСтрока),
		"JSON должен быть корректным");
	
КонецПроцедуры

Процедура Тест_ДолженПроверитьРаботуСКонтейнерами() Экспорт
	
	// Arrange
	// Получаем реальные данные из контейнеров
	ТаблицаИнструментов = mcp_КонтейнерыПостИсп.Инструменты();
	
	// Act & Assert
	// Проверяем, что таблица не пустая
	mcp_Тестирование.ОжидаемЛожь(ТаблицаИнструментов.Пустой(), 
		"Таблица инструментов не должна быть пустой");
	
	// Проверяем структуру данных
	Если ТаблицаИнструментов.Количество() > 0 Тогда
		ПерваяСтрока = ТаблицаИнструментов[0];
		mcp_Тестирование.ОжидаемЗаполненность(ПерваяСтрока.Имя, 
			"Имя инструмента должно быть заполнено");
	КонецЕсли;
	
КонецПроцедуры

Процедура Тест_ДолженПроверитьВыполнениеИнструментов() Экспорт
	
	// Arrange
	ТаблицаИнструментов = mcp_КонтейнерыПостИсп.Инструментов();
	
	// Если есть инструменты, тестируем первый попавшийся
	Если ТаблицаИнструментов.Количество() > 0 Тогда
		
		ПервыйИнструмент = ТаблицаИнструментов[0];
		Аргументы = Новый Структура("test", "value");
		
		// Act
		РезультатВыполнения = mcp_Выполнение.ВыполнитьИнструмент(ПервыйИнструмент, Аргументы);
		
		// Assert
		mcp_Тестирование.ОжидаемНеопределено(РезультатВыполнения, 
			"Результат выполнения инструмента не должен быть неопределен");
		
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти
```

### Шаг 3: Настройка тестового окружения

Создаем конфигурацию для тестового окружения:

```1c
// Файл: ТестовыеОбработки/ТестовоеОкружение.epf

#Область УправлениеТестовымОкружением

// Инициализирует тестовое окружение
Процедура ИнициализироватьТестовоеОкружение() Экспорт
	
	// Очищаем кеш контейнеров
	ОчиститьКешКонтейнеров();
	
	// Устанавливаем тестовые параметры
	УстановитьТестовыеПараметры();
	
	// Проверяем доступность HTTP сервисов
	ПроверитьДоступностьСервисов();
	
КонецПроцедуры

// Очищает кеш контейнеров
Процедура ОчиститьКешКонтейнеров() Экспорт
	
	// В реальной системе здесь была бы очистка кеша
	ЗаписьЖурналаРегистрации("MCP.Tests", УровеньЖурналаРегистрации.Информация, , , 
		"Кеш контейнеров очищен для тестового окружения");
	
КонецПроцедуры

// Устанавливает тестовые параметры
Процедура УстановитьТестовыеПараметры() Экспорт
	
	// Устанавливаем флаг тестового режима
	ПараметрыСеанса.Мср_ТестовыйРежим = Истина;
	
	// Настраиваем время ожидания для тестов
	ПараметрыСеанса.Мср_ТаймаутТестов = 30; // секунд
	
КонецПроцедуры

// Проверяет доступность HTTP сервисов
Процедура ПроверитьДоступностьСервисов() Экспорт
	
	// В тестовом окружении проверяем доступность /health
	Попытка
		// Имитация проверки доступности
		Результат = Истина;
		
		Если НЕ Результат Тогда
			ВызватьИсключение "HTTP сервисы недоступны в тестовом окружении";
		КонецЕсли;
		
	Исключение
		ЗаписьЖурналаРегистрации("MCP.Tests", УровеньЖурналаРегистрации.Предупреждение, , , 
			"Предупреждение: HTTP сервисы могут быть недоступны: " + ОписаниеОшибки());
	КонецПопытки;
	
КонецПроцедуры

#КонецОбласти
```

### Шаг 4: Создание тестовых сценариев

Создаем комплексные тестовые сценарии:

```1c
// Файл: ТестовыеОбработки/Тест_ПолныеСценарии.epf

#Область ПолныеСценарии

Процедура Тест_ПолныйСценарийMCPИнструмента() Экспорт
	
	// Этот тест проверяет полный цикл работы с MCP инструментом
	
	// Шаг 1: Подготовка
	ИнициализироватьТестовоеОкружение();
	
	// Шаг 2: Получение списка инструментов
	ТаблицаИнструментов = mcp_КонтейнерыПостИсп.Инструменты();
	mcp_Тестирование.ОжидаемЛожь(ТаблицаИнструментов.Пустой(), 
		"Должны быть доступны инструменты для тестирования");
	
	// Шаг 3: Выполнение инструмента
	Если ТаблицаИнструментов.Количество() > 0 Тогда
		
		Инструмент = ТаблицаИнструментов[0];
		Аргументы = mcp_ОбщегоНазначения.СоздатьТестовыеДанные();
		
		Результат = mcp_Выполнение.ВыполнитьИнструмент(Инструмент, Аргументы);
		
		mcp_Тестирование.ОжидаемНеопределено(Результат, 
			"Инструмент должен вернуть результат");
		
		// Проверяем формат результата
		Если ТипЗнч(Результат) = Тип("Массив") Тогда
			mcp_Тестирование.ОжидаемБольше(Результат.Количество(), 0, 
				"Результат должен содержать элементы");
		КонецЕсли;
		
	КонецЕсли;
	
КонецПроцедуры

Процедура Тест_СценарийРаботыСРесурсами() Экспорт
	
	// Сценарий работы с ресурсами
	
	// Шаг 1: Получение списка ресурсов
	ТаблицаРесурсов = mcp_КонтейнерыПостИсп.Ресурсы();
	
	// Шаг 2: Тестирование чтения ресурса
	Если ТаблицаРесурсов.Количество() > 0 Тогда
		
		Ресурс = ТаблицаРесурсов[0];
		URIРесурса = Ресурс.Адрес;
		
		// Проверяем корректность URI
		mcp_Тестирование.ОжидаемЗаполненность(URIРесурса, 
			"URI ресурса должен быть заполнен");
		
		// Выполняем чтение ресурса
		Содержимое = mcp_Выполнение.ПрочитатьРесурс(Ресурс, URIРесурса);
		
		mcp_Тестирование.ОжидаемНеопределено(Содержимое, 
			"Чтение ресурса должно вернуть содержимое");
		
	КонецЕсли;
	
КонецПроцедуры

Процедура Тест_СценарийРаботыСПромптами() Экспорт
	
	// Сценарий работы с промптами
	
	// Шаг 1: Получение списка промптов
	ТаблицаПромптов = mcp_КонтейнерыПостИсп.Промпты();
	
	// Шаг 2: Тестирование получения промпта
	Если ТаблицаПромптов.Количество() > 0 Тогда
		
		Промпт = ТаблицаПромптов[0];
		ИмяПромпта = Промпт.Имя;
		
		// Получаем промпт
		Содержимое = mcp_Выполнение.ПолучитьПромпт(Промпт, ИмяПромпта, Новый Структура);
		
		mcp_Тестирование.ОжидаемНеопределено(Содержимое, 
			"Получение промпта должно вернуть содержимое");
		
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти
```

### Шаг 5: Автоматизация CI/CD интеграции

Создаем скрипт для автоматического запуска тестов:

```1c
// Файл: Автоматизация/ЗапускТестов_Автоматический.epf

#Область АвтоматическийЗапуск

// Запускает все тесты в автоматическом режиме для CI/CD
Функция ЗапуститьВсеТестыАвтоматически() Экспорт
	
	Результат = Новый Структура;
	Результат.Вставить("Успешно", Ложь);
	Результат.Вставить("Результаты", Новый Массив);
	Результат.Вставить("ОбщееВремя", 0);
	Результат.Вставить("Сообщения", Новый Массив);
	
	ВремяНачала = ТекущаяДатаСеанса();
	
	Попытка
		
		// Инициализация
		Результат.Сообщения.Добавить("Инициализация тестового окружения...");
		ИнициализироватьТестовоеОкружение();
		
		// Список тестовых наборов для автоматического запуска
		НаборыДляЗапуска = Новый Массив;
		НаборыДляЗапуска.Добавить("MCP_Инструменты_Основные");
		НаборыДляЗапуска.Добавить("MCP_HTTP_Сервисы");
		НаборыДляЗапуска.Добавить("MCP_JSON_RPC");
		НаборыДляЗапуска.Добавить("MCP_ОбщегоНазначения");
		
		// Запускаем каждый набор
		Для Каждого ИмяНабора Из НаборыДляЗапуска Цикл
			
			Результат.Сообщения.Добавить(СтрШаблон("Запуск набора: %1", ИмяНабора));
			
			Набор = mcp_Тестирование.СоздатьНаборТестов(ИмяНабора);
			ДобавитьТестыВНабор(Набор, ИмяНабора);
			
			ВыполнитьНаборТестов(Набор);
			
			РезультатНабора = mcp_Тестирование.ЗавершитьНаборТестов(Набор);
			Результат.Результаты.Добавить(РезультатНабора);
			
			// Логируем результат
			Результат.Сообщения.Добавить(СтрШаблон("Набор %1: %2/%3/%4", 
				ИмяНабора, РезультатНабора.Успешных, РезультатНабора.Проваленных, РезультатНабора.Пропущенных));
			
		КонецЦикла;
		
		// Проверяем общий результат
		ВсеУспешно = Истина;
		Для Каждого РезультатНабора Из Результат.Результаты Цикл
			Если РезультатНабора.Проваленных > 0 Тогда
				ВсеУспешно = Ложь;
				Прервать;
			КонецЕсли;
		КонецЦикла;
		
		Результат.Успешно = ВсеУспешно;
		
	Исключение
		
		Результат.Сообщения.Добавить("КРИТИЧЕСКАЯ ОШИБКА: " + ОписаниеОшибки());
		Результат.Успешно = Ложь;
		
	КонецПопытки;
	
	Результат.ОбщееВремя = ТекущаяДатаСеанса() - ВремяНачала;
	
	// Сохраняем отчет
	СохранитьАвтоматическийОтчет(Результат);
	
	Возврат Результат;
	
КонецФункции

// Сохраняет отчет в файл для CI/CD
Процедура СохранитьАвтоматическийОтчет(Результат) Экспорт
	
	// Создаем отчет в формате JUnit XML
	ОтчетXML = mcp_Тестирование.СоздатьОтчет(Результат.Результаты, "XML");
	
	// Сохраняем в файл
	ИмяФайла = КаталогВременныхФайлов() + "mcp_test_results_" + СтрЗаменить(Строка(ТекущаяДата()), ".", "_") + ".xml";
	
	ЗаписьТекста = Новый ЗаписьТекста(ИмяФайла, КодировкаТекста.UTF8);
	ЗаписьТекста.Записать(ОтчетXML);
	ЗаписьТекста.Закрыть();
	
	Результат.Сообщения.Добавить("Отчет сохранен в: " + ИмяФайла);
	
КонецПроцедуры

#КонецОбласти
```

## Примеры использования

### Запуск из командной строки

```bash
# Запуск тестов через 1С:Предприятие
"C:\Program Files\1cv8\8.3.20.1984\1cv8.exe" DESIGNER /S"TestServer\TestDatabase" /N"TestUser" /P"TestPassword" /RunModeManagedApplication /Execute"TestRunner.epf"
```

### Интеграция с GitHub Actions

```yaml
name: 1C MCP Tests
on: [push, pull_request]

jobs:
  test:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v2
      - name: Setup 1C
        uses: citizenstig/setup-1c@v1
        with:
          version: 8.3.20
      - name: Run tests
        run: |
          1cv8.exe DESIGNER /S"TestServer\DB" /N"TestUser" /P"Password" /Execute"AutoTestRunner.epf"
      - name: Upload test results
        uses: actions/upload-artifact@v2
        if: always()
        with:
          name: test-results
          path: test-results.xml
```

## Лучшие практики интеграции

### 1. Изоляция тестового окружения

- Используйте отдельную тестовую базу данных
- Очищайте кеш и временные данные перед каждым тестом
- Восстанавливайте исходное состояние после тестов

### 2. Управление зависимостями

```1c
// Проверяем наличие зависимых модулей перед тестами
Функция ПроверитьЗависимостиМодулей() Экспорт
	
	ЗависимыеМодули = Новый Массив;
	ЗависимыеМодули.Добавить("mcp_ОбщегоНазначения");
	ЗависимыеМодули.Добавить("mcp_КонтейнерыПостИсп");
	ЗависимыеМодули.Добавить("mcp_Выполнение");
	
	Для Каждого ИмяМодуля Из ЗависимыеМодули Цикл
		Попытка
			Выполнить(ИмяМодуля + ".ПроверитьДоступность()");
		Исключение
			ВызватьИсключение СтрШаблон("Модуль '%1' недоступен", ИмяМодуля);
		КонецПопытки;
	КонецЦикла;
	
	Возврат Истина;
	
КонецФункции
```

### 3. Логирование результатов

```1c
// Структурированное логирование для CI/CD
Процедура ЗаписатьСтруктурированныйЛог(РезультатыТестов) Экспорт
	
	// JSON формат для машинной обработки
	СтруктурированныйОтчет = Новый Структура;
	СтруктурированныйОтчет.Вставить("timestamp", ТекущаяДатаСеанса());
	СтруктурированныйОтчет.Вставить("build_id", ПараметрыСеанса.Мср_ИДСборки);
	СтруктурированныйОтчет.Вставить("test_results", Новый Массив);
	
	Для Каждого Набор Из РезультатыТестов Цикл
		
		РезультатНабора = Новый Структура;
		РезультатНабора.Вставить("name", Набор.Имя);
		РезультатНабора.Вставить("status", Набор.Статус);
		РезультатНабора.Вставить("duration", Набор.Длительность);
		РезультатНабора.Вставить("total", Набор.ОбщееКоличество);
		РезультатНабора.Вставить("passed", Набор.Успешных);
		РезультатНабора.Вставить("failed", Набор.Проваленных);
		
		СтруктурированныйОтчет.test_results.Добавить(РезультатНабора);
		
	КонецЦикла;
	
	// Записываем в файл для CI/CD
	JSONОтчет = mcp_ОбщегоНазначения.СтруктураВJSON(СтруктурированныйОтчет);
	
КонецПроцедуры
```

## Troubleshooting интеграции

### Частые проблемы

1. **Модуль mcp_ОбщегоНазначения не найден**
   - Проверьте наличие модуля в конфигурации
   - Убедитесь в корректности имен функций

2. **Ошибки при работе с контейнерами**
   - Проверьте заполненность таблиц контейнеров
   - Очистите кеш контейнеров перед тестами

3. **HTTP сервисы недоступны**
   - Запустите тестовое окружение
   - Проверьте настройки веб-сервера

### Мониторинг интеграции

```1c
// Функция для мониторинга состояния интеграции
Функция ПроверитьСостояниеИнтеграции() Экспорт
	
	Состояние = Новый Структура;
	Состояние.Вставить("ОсновныеМодулиДоступны", Истина);
	Состояние.Вставить("HTTPСервисыДоступны", Истина);
	Состояние.Вставить("КонтейнерыЗаполнены", Истина);
	Состояние.Вставить("Сообщения", Новый Массив);
	
	// Проверяем основные модули
	Попытка
		mcp_ОбщегоНазначения.СоздатьТестовыеДанные();
	Исключение
		Состояние.ОсновныеМодулиДоступны = Ложь;
		Состояние.Сообщения.Добавить("Ошибка в mcp_ОбщегоНазначения: " + ОписаниеОшибки());
	КонецПопытки;
	
	// Проверяем контейнеры
	ТаблицаИнструментов = mcp_КонтейнерыПостИсп.Инструменты();
	Если ТаблицаИнструментов.Пустой() Тогда
		Состояние.КонтейнерыЗаполнены = Ложь;
		Состояние.Сообщения.Добавить("Контейнеры не заполнены");
	КонецЕсли;
	
	Возврат Состояние;
	
КонецФункции
```

## Заключение

Интеграция фреймворка тестирования с проектом 1c_mcp обеспечивает:

1. **Автоматизированное тестирование** всех компонентов системы
2. **Непрерывную интеграцию** с системами CI/CD
3. **Высокое качество кода** через регулярное тестирование
4. **Быстрое обнаружение регрессий** при изменениях
5. **Документированные API** через тестовые сценарии

Фреймворк готов к production использованию и может быть легко расширен для новых типов тестов и компонентов системы.