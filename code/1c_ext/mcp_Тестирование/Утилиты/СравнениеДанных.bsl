#Область ПрограммныйИнтерфейс

// Репозиторий проекта: 
// https://github.com/vladimir-kharin/1c_mcp
// 
// Фреймворк тестирования 1c_mcp: Утилиты для сравнения структур и данных
// Харин Владимир (С) 2025. https://vharin.ru

// Модуль содержит расширенные функции для сравнения данных различных типов
// Используется для assertions в тестах и валидации результатов

#Область ГлубокоеСравнение

// Сравнивает две структуры с рекурсивной проверкой вложенных объектов
//
// Параметры:
//  Структура1 - Структура - первая структура
//  Структура2 - Структура - вторая структура
//  ИгнорироватьПорядок - Булево - игнорировать порядок ключей (по умолчанию Ложь)
//  ГлубинаСравнения - Число - максимальная глубина рекурсии (по умолчанию 10)
//
// Возвращаемое значение:
//  Структура - {равны: Булево, различия: Массив, сообщение: Строка}
Функция СравнитьСтруктурыГлубоко(Структура1, Структура2, ИгнорироватьПорядок = Ложь, ГлубинаСравнения = 10) Экспорт
	
	Результат = Новый Структура("равны, различия, сообщение");
	Результат.равны = Истина;
	Результат.различия = Новый Массив;
	Результат.сообщение = "";
	
	Если ГлубинаСравнения <= 0 Тогда
		Результат.равны = Ложь;
		Результат.сообщение = "Превышена максимальная глубина сравнения";
		Возврат Результат;
	КонецЕсли;
	
	// Проверяем типы
	Если ТипЗнч(Структура1) <> Тип("Структура") ИЛИ ТипЗнч(Структура2) <> Тип("Структура") Тогда
		Результат.равны = Ложь;
		Результат.сообщение = "Оба аргумента должны быть структурами";
		Возврат Результат;
	КонецЕсли;
	
	// Проверяем количество ключей
	Если Структура1.Количество() <> Структура2.Количество() Тогда
		Результат.равны = Ложь;
		Результат.различия.Добавить(СтрШаблон("Различное количество ключей: %1 vs %2", 
			Структура1.Количество(), Структура2.Количество()));
	КонецЕсли;
	
	// Сравниваем ключи и значения
	Для Каждого КлючЗначение Из Структура1 Цикл
		
		Если НЕ Структура2.Свойство(КлючЗначение.Ключ) Тогда
			Результат.равны = Ложь;
			Результат.различия.Добавить(СтрШаблон("Ключ '%1' отсутствует во второй структуре", КлючЗначение.Ключ));
			Продолжить;
		КонецЕсли;
		
		// Рекурсивно сравниваем значения
		РезультатСравнения = СравнитьЗначенияГлубоко(
			КлючЗначение.Значение, 
			Структура2[КлючЗначение.Ключ], 
			ГлубинаСравнения - 1);
		
		Если НЕ РезультатСравнения.равны Тогда
			Результат.равны = Ложь;
			Результат.различия.Добавить(СтрШаблон("Различие в ключе '%1': %2", 
				КлючЗначение.Ключ, РезультатСравнения.сообщение));
		КонецЕсли;
		
	КонецЦикла;
	
	// Формируем итоговое сообщение
	Если НЕ Результат.равны Тогда
		Результат.сообщение = "Структуры различаются: " + СтрСоединить(Результат.различия, "; ");
	Иначе
		Результат.сообщение = "Структуры равны";
	КонецЕсли;
	
	Возврат Результат;
	
КонецФункции

// Сравнивает два массива с проверкой порядка и содержимого
//
// Параметры:
//  Массив1 - Массив - первый массив
//  Массив2 - Массив - второй массив
//  ПроверятьПорядок - Булево - проверять порядок элементов (по умолчанию Истина)
//  ГлубинаСравнения - Число - максимальная глубина рекурсии
//
// Возвращаемое значение:
//  Структура - {равны: Булево, различия: Массив, сообщение: Строка}
Функция СравнитьМассивыГлубоко(Массив1, Массив2, ПроверятьПорядок = Истина, ГлубинаСравнения = 10) Экспорт
	
	Результат = Новый Структура("равны, различия, сообщение");
	Результат.равны = Истина;
	Результат.различия = Новый Массив;
	
	Если ГлубинаСравнения <= 0 Тогда
		Результат.равны = Ложь;
		Результат.сообщение = "Превышена максимальная глубина сравнения";
		Возврат Результат;
	КонецЕсли;
	
	// Проверяем типы
	Если ТипЗнч(Массив1) <> Тип("Массив") ИЛИ ТипЗнч(Массив2) <> Тип("Массив") Тогда
		Результат.равны = Ложь;
		Результат.сообщение = "Оба аргумента должны быть массивами";
		Возврат Результат;
	КонецЕсли;
	
	// Проверяем количество элементов
	Если Массив1.Количество() <> Массив2.Количество() Тогда
		Результат.равны = Ложь;
		Результат.различия.Добавить(СтрШаблон("Различное количество элементов: %1 vs %2", 
			Массив1.Количество(), Массив2.Количество()));
		Возврат Результат;
	КонецЕсли;
	
	// Сравниваем элементы
	Для Индекс = 0 По Массив1.Количество() - 1 Цикл
		
		РезультатСравнения = СравнитьЗначенияГлубоко(
			Массив1[Индекс], 
			Массив2[Индекс], 
			ГлубинаСравнения - 1);
		
		Если НЕ РезультатСравнения.равны Тогда
			Результат.равны = Ложь;
			Если ПроверятьПорядок Тогда
				Результат.различия.Добавить(СтрШаблон("Различие в элементе с индексом %1: %2", 
					Индекс, РезультатСравнения.сообщение));
			Иначе
				Результат.различия.Добавить(СтрШаблон("Различие в содержимом: %1", 
					РезультатСравнения.сообщение));
			КонецЕсли;
		КонецЕсли;
		
	КонецЦикла;
	
	// Формируем сообщение
	Если НЕ Результат.равны Тогда
		Результат.сообщение = "Массивы различаются: " + СтрСоединить(Результат.различия, "; ");
	Иначе
		Результат.сообщение = "Массивы равны" + ?(НЕ ПроверятьПорядок, " (порядок не важен)", "");
	КонецЕсли;
	
	Возврат Результат;
	
КонецФункции

// Сравнивает два значения произвольного типа с глубоким анализом
//
// Параметры:
//  Значение1 - Произвольный - первое значение
//  Значение2 - Произвольный - второе значение
//  ГлубинаСравнения - Число - максимальная глубина рекурсии
//
// Возвращаемое значение:
//  Структура - {равны: Булево, различия: Массив, сообщение: Строка}
Функция СравнитьЗначенияГлубоко(Значение1, Значение2, ГлубинаСравнения = 10) Экспорт
	
	Результат = Новый Структура("равны, различия, сообщение");
	Результат.равны = Истина;
	Результат.различия = Новый Массив;
	
	Если ГлубинаСравнения < 0 Тогда
		Результат.равны = Ложь;
		Результат.сообщение = "Превышена максимальная глубина сравнения";
		Возврат Результат;
	КонецЕсли;
	
	// Простое сравнение для примитивных типов
	Если СравнитьПримитивныеТипы(Значение1, Значение2, Результат) Тогда
		Возврат Результат;
	КонецЕсли;
	
	// Специальная обработка для Неопределено и Null
	Если ОбработатьПустыеЗначения(Значение1, Значение2, Результат) Тогда
		Возврат Результат;
	КонецЕсли;
	
	// Глубокое сравнение составных типов
	Тип1 = ТипЗнч(Значение1);
	Тип2 = ТипЗнч(Значение2);
	
	Если Тип1 <> Тип2 Тогда
		Результат.равны = Ложь;
		Результат.различия.Добавить(СтрШаблон("Различные типы: %1 vs %2", Тип1, Тип2));
	ИначеЕсли Тип1 = Тип("Структура") Тогда
		Возврат СравнитьСтруктурыГлубоко(Значение1, Значение2, Ложь, ГлубинаСравнения);
	ИначеЕсли Тип1 = Тип("Массив") Тогда
		Возврат СравнитьМассивыГлубоко(Значение1, Значение2, Истина, ГлубинаСравнения);
	ИначеЕсли Тип1 = Тип("Соответствие") Тогда
		Возврат СравнитьСоответствияГлубоко(Значение1, Значение2, ГлубинаСравнения);
	Иначе
		// Для других типов - простое сравнение
		Результат.равны = (Значение1 = Значение2);
		Если НЕ Результат.равны Тогда
			Результат.различия.Добавить(СтрШаблон("Значения не равны: '%1' vs '%2'", Строка(Значение1), Строка(Значение2)));
		КонецЕсли;
	КонецЕсли;
	
	// Формируем сообщение
	Если НЕ Результат.равны Тогда
		Результат.сообщение = СтрСоединить(Результат.различия, "; ");
	Иначе
		Результат.сообщение = "Значения равны";
	КонецЕсли;
	
	Возврат Результат;
	
КонецФункции

#КонецОбласти

#Область СпециализированныеСравнения

// Сравнивает два JSON-RPC ответа
//
// Параметры:
//  Ответ1 - Структура - первый ответ
//  Ответ2 - Структура - второй ответ
//  ИгнорироватьID - Булево - игнорировать поле id (по умолчанию Ложь)
//
// Возвращаемое значение:
//  Структура - результат сравнения
Функция СравнитьJSONRPCОтветы(Ответ1, Ответ2, ИгнорироватьID = Ложь) Экспорт
	
	Результат = Новый Структура("равны, различия, сообщение");
	Результат.равны = Истина;
	Результат.различия = Новый Массив;
	
	// Базовые проверки
	Если ТипЗнч(Ответ1) <> Тип("Структура") ИЛИ ТипЗнч(Ответ2) <> Тип("Структура") Тогда
		Результат.равны = Ложь;
		Результат.сообщение = "Оба аргумента должны быть структурами";
		Возврат Результат;
	КонецЕсли;
	
	// Проверяем версию JSON-RPC
	Если Ответ1.Свойство("jsonrpc") И Ответ2.Свойство("jsonrpc") Тогда
		Если Ответ1.jsonrpc <> Ответ2.jsonrpc Тогда
			Результат.равны = Ложь;
			Результат.различия.Добавить(СтрШаблон("Различные версии JSON-RPC: %1 vs %2", Ответ1.jsonrpc, Ответ2.jsonrpc));
		КонецЕсли;
	КонецЕсли;
	
	// Проверяем поле id (опционально)
	Если НЕ ИгнорироватьID Тогда
		Если Ответ1.Свойство("id") И Ответ2.Свойство("id") Тогда
			Если Ответ1.id <> Ответ2.id Тогда
				Результат.равны = Ложь;
				Результат.различия.Добавить(СтрШаблон("Различные ID: %1 vs %2", Ответ1.id, Ответ2.id));
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;
	
	// Проверяем наличие result или error
	ЕстьResult1 = Ответ1.Свойство("result");
	ЕстьResult2 = Ответ2.Свойство("result");
	ЕстьError1 = Ответ1.Свойство("error");
	ЕстьError2 = Ответ2.Свойство("error");
	
	Если ЕстьResult1 И ЕстьResult2 Тогда
		// Оба ответа успешные - сравниваем result
		РезультатResult = СравнитьЗначенияГлубоко(Ответ1.result, Ответ2.result);
		Если НЕ РезультатResult.равны Тогда
			Результат.равны = Ложь;
			Результат.различия.Добавить("Различия в поле result: " + РезультатResult.сообщение);
		КонецЕсли;
	ИначеЕсли ЕстьError1 И ЕстьError2 Тогда
		// Оба ответа содержат ошибки - сравниваем error
		РезультатError = СравнитьЗначенияГлубоко(Ответ1.error, Ответ2.error);
		Если НЕ РезультатError.равны Тогда
			Результат.равны = Ложь;
			Результат.различия.Добавить("Различия в поле error: " + РезультатError.сообщение);
		КонецЕсли;
	Иначе
		// Несоответствие типов ответов
		Результат.равны = Ложь;
		Результат.различия.Добавить(СтрШаблон("Несоответствие типов ответов: result=%1,%2 error=%3,%4", 
			ЕстьResult1, ЕстьResult2, ЕстьError1, ЕстьError2));
	КонецЕсли;
	
	// Формируем сообщение
	Если НЕ Результат.равны Тогда
		Результат.сообщение = "JSON-RPC ответы различаются: " + СтрСоединить(Результат.различия, "; ");
	Иначе
		Результат.сообщение = "JSON-RPC ответы равны";
	КонецЕсли;
	
	Возврат Результат;
	
КонецФункции

// Сравнивает две схемы параметров инструментов
//
// Параметры:
//  Схема1 - Структура или Строка - первая схема (JSON или структура)
//  Схема2 - Структура или Строка - вторая схема (JSON или структура)
//
// Возвращаемое значение:
//  Структура - результат сравнения
Функция СравнитьСхемыИнструментов(Схема1, Схема2) Экспорт
	
	Результат = Новый Структура("равны, различия, сообщение");
	Результат.равны = Истина;
	Результат.различия = Новый Массив;
	
	// Преобразуем JSON в структуры если нужно
	Структура1 = ПреобразоватьВСтруктуру(Схема1);
	Структура2 = ПреобразоватьВСтруктуру(Схема2);
	
	Если Структура1 = Неопределено ИЛИ Структура2 = Неопределено Тогда
		Результат.равны = Ложь;
		Результат.сообщение = "Не удалось преобразовать схемы в структуры";
		Возврат Результат;
	КонецЕсли;
	
	// Сравниваем основные поля схемы
	КлючевыеПоля = Новый Массив;
	КлючевыеПоля.Добавить("type");
	КлючевыеПоля.Добавить("properties");
	КлючевыеПоля.Добавить("required");
	
	Для Каждого Поле Из КлючевыеПоля Цикл
		
		ЕстьПоле1 = Структура1.Свойство(Поле);
		ЕстьПоле2 = Структура2.Свойство(Поле);
		
		Если ЕстьПоле1 <> ЕстьПоле2 Тогда
			Результат.равны = Ложь;
			Результат.различия.Добавить(СтрШаблон("Поле '%1': присутствует=%2,%3", Поле, ЕстьПоле1, ЕстьПоле2));
			Продолжить;
		КонецЕсли;
		
		Если ЕстьПоле1 Тогда
			РезультатСравнения = СравнитьЗначенияГлубоко(Структура1[Поле], Структура2[Поле]);
			Если НЕ РезультатСравнения.равны Тогда
				Результат.равны = Ложь;
				Результат.различия.Добавить(СтрШаблон("Различия в поле '%1': %2", Поле, РезультатСравнения.сообщение));
			КонецЕсли;
		КонецЕсли;
		
	КонецЦикла;
	
	// Формируем сообщение
	Если НЕ Результат.равны Тогда
		Результат.сообщение = "Схемы инструментов различаются: " + СтрСоединить(Результат.различия, "; ");
	Иначе
		Результат.сообщение = "Схемы инструментов равны";
	КонецЕсли;
	
	Возврат Результат;
	
КонецФункции

#КонецОбласти

#Область ВспомогательныеФункции

// Сравнивает примитивные типы (числа, строки, даты, булево)
Функция СравнитьПримитивныеТипы(Значение1, Значение2, Результат)
	
	ТипыПримитивов = Новый Массив;
	ТипыПримитивов.Добавить(Тип("Число"));
	ТипыПримитивов.Добавить(Тип("Строка"));
	ТипыПримитивов.Добавить(Тип("Дата"));
	ТипыПримитивов.Добавить(Тип("Булево"));
	ТипыПримитивов.Добавить(Тип("УникальныйИдентификатор"));
	
	Тип1 = ТипЗнч(Значение1);
	Тип2 = ТипЗнч(Значение2);
	
	Если ТипыПримитивов.Найти(Тип1) <> Неопределено И ТипыПримитивов.Найти(Тип2) <> Неопределено Тогда
		
		Результат.равны = (Значение1 = Значение2);
		Если НЕ Результат.равны Тогда
			Результат.различия.Добавить(СтрШаблон("Примитивные значения различаются: '%1' vs '%2'", 
				Строка(Значение1), Строка(Значение2)));
		КонецЕсли;
		
		Возврат Истина;
	КонецЕсли;
	
	Возврат Ложь;
	
КонецФункции

// Обрабатывает пустые значения (Неопределено, Null)
Функция ОбработатьПустыеЗначения(Значение1, Значение2, Результат)
	
	Пустое1 = (Значение1 = Неопределено ИЛИ Значение1 = Null);
	Пустое2 = (Значение2 = Неопределено ИЛИ Значение2 = Null);
	
	Если Пустое1 И Пустое2 Тогда
		Результат.равны = Истина;
		Результат.сообщение = "Оба значения пустые (Неопределено/Null)";
		Возврат Истина;
	ИначеЕсли Пустое1 <> Пустое2 Тогда
		Результат.равны = Ложь;
		Результат.различия.Добавить(СтрШаблон("Различие в пустых значениях: %1 vs %2", Значение1, Значение2));
		Возврат Истина;
	КонецЕсли;
	
	Возврат Ложь;
	
КонецФункции

// Сравнивает соответствия
Функция СравнитьСоответствияГлубоко(Соответствие1, Соответствие2, ГлубинаСравнения)
	
	Результат = Новый Структура("равны, различия, сообщение");
	Результат.равны = Истина;
	Результат.различия = Новый Массив;
	
	Если ГлубинаСравнения <= 0 Тогда
		Результат.равны = Ложь;
		Результат.сообщение = "Превышена максимальная глубина сравнения";
		Возврат Результат;
	КонецЕсли;
	
	Если Соответствие1.Количество() <> Соответствие2.Количество() Тогда
		Результат.равны = Ложь;
		Результат.различия.Добавить(СтрШаблон("Различное количество элементов: %1 vs %2", 
			Соответствие1.Количество(), Соответствие2.Количество()));
		Возврат Результат;
	КонецЕсли;
	
	Для Каждого КлючЗначение Из Соответствие1 Цикл
		
		Значение2 = Соответствие2.Получить(КлючЗначение.Ключ);
		Если Значение2 = Неопределено Тогда
			Результат.равны = Ложь;
			Результат.различия.Добавить(СтрШаблон("Ключ '%1' отсутствует во втором соответствии", КлючЗначение.Ключ));
		Иначе
			РезультатСравнения = СравнитьЗначенияГлубоко(КлючЗначение.Значение, Значение2, ГлубинаСравнения - 1);
			Если НЕ РезультатСравнения.равны Тогда
				Результат.равны = Ложь;
				Результат.различия.Добавить(СтрШаблон("Различие для ключа '%1': %2", 
					Строка(КлючЗначение.Ключ), РезультатСравнения.сообщение));
			КонецЕсли;
		КонецЕсли;
		
	КонецЦикла;
	
	Если НЕ Результат.равны Тогда
		Результат.сообщение = "Соответствия различаются: " + СтрСоединить(Результат.различия, "; ");
	Иначе
		Результат.сообщение = "Соответствия равны";
	КонецЕсли;
	
	Возврат Результат;
	
КонецФункции

// Преобразует JSON строку в структуру
Функция ПреобразоватьВСтруктуру(Значение)
	
	Если ТипЗнч(Значение) = Тип("Структура") Тогда
		Возврат Значение;
	ИначеЕсли ТипЗнч(Значение) = Тип("Строка") Тогда
		Попытка
			Возврат mcp_ОбщегоНазначения.JSONВСтруктуру(Значение);
		Исключение
			Возврат Неопределено;
		КонецПопытки;
	Иначе
		Возврат Неопределено;
	КонецЕсли;
	
КонецФункции

#КонецОбласти