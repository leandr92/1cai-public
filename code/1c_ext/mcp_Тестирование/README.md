# MCP Testing Framework для 1С:Предприятие

## Обзор

Фреймворк тестирования для проекта 1c_mcp, построенный на основе стандартов xUnitFor1C и современных практик тестирования в 1С. Предоставляет комплексное решение для юнит-, интеграционного и E2E тестирования MCP компонентов.

## Архитектура фреймворка

```
mcp_Тестирование/
├── Module.bsl                          # Основной модуль фреймворка
├── Forms/
│   └── УправлениеТестами/
│       └── Form.bsl                    # UI для управления тестами
├── ТестовыеОбработки/
│   ├── Тест_MCPИнструмента_Базовый.epf # Базовые тесты инструментов
│   ├── Тест_HTTP_Services.epf          # Тесты HTTP сервисов и JSON-RPC
│   └── Тест_E2E_ПолныйЦикл.epf         # E2E тесты полного цикла
└── Утилиты/
    ├── СравнениеДанных.bsl             # Утилиты для сравнения данных
    └── ГенераторОтчетов.bsl            # Генератор отчетов
```

## Возможности

### 1. Основной модуль (mcp_Тестирование)

- **Управление тестовыми наборами**: Создание, выполнение и завершение наборов тестов
- **Setup/Teardown**: Поддержка методов подготовки и очистки окружения
- **Assertions**: Богатый набор проверок (равенство, наличие, JSON-RPC проверки)
- **Фикстуры**: Готовые фикстуры для JSON-RPC, HTTP запросов и инструментов
- **Интеграция с журналом регистрации**: Автоматическое логирование тестов

### 2. Assertions

```1c
// Базовые проверки
mcp_Тестирование.ОжидаемРавно(Ожидаемое, Фактическое, "Сообщение");
mcp_Тестирование.ОжидаемИстину(Условие);
mcp_Тестирование.ОжидаемЗаполненность(Значение);

// Специализированные проверки
mcp_Тестирование.ОжидаемJSONRPCУспех(Ответ);
mcp_Тестирование.ОжидаемJSONRPCОшибку(Ответ, КодОшибки);
mcp_Тестирование.ОжидаемНаличиеКлюча(Структура, Ключ);
mcp_Тестирование.ОжидаемНаличиеВКоллекции(Массив, Элемент);
```

### 3. Фикстуры

```1c
// JSON-RPC запрос
ФикстураЗапроса = mcp_Тестирование.СоздатьФикстуруJSONRPCЗапроса("tools/list", Параметры);

// Инструмент MCP
ФикстураИнструмента = mcp_Тестирование.СоздатьФикстуруИнструмента("tool_name", Аргументы);

// HTTP запрос
ФикстураHTTP = mcp_Тестирование.СоздатьФикстуруHTTPЗапроса(JSONСтрока, Заголовки);
```

### 4. Тестовые категории

#### Юнит-тесты
- Тестирование отдельных функций и методов
- Проверка бизнес-логики MCP инструментов
- Валидация входных параметров

#### Интеграционные тесты
- Тестирование HTTP сервисов
- Проверка JSON-RPC контрактов
- Валидация взаимодействия компонентов

#### E2E тесты
- Сквозные сценарии полного цикла
- Проверка производительности
- Тестирование стабильности

## Использование

### Создание тестового набора

```1c
// Создаем набор тестов
НаборТестов = mcp_Тестирование.СоздатьНаборТестов(
    "Тест_MCP_Инструмента", 
    "Описание набора тестов", 
    "юнит");

// Добавляем тесты
mcp_Тестирование.ВыполнитьТест(
    НаборТестов, 
    "ИмяТеста", 
    "ИмяТестовойФункции");

// Завершаем набор
Результат = mcp_Тестирование.ЗавершитьНаборТестов(НаборТестов);
```

### Создание тестовой функции

```1c
Процедура Тест_ДолженПроверитьФункцию() Экспорт
    
    // Arrange - подготовка
    ВходныеДанные = Новый Структура("param", "value");
    ОжидаемыйРезультат = "expected";
    
    // Act - выполнение
    ФактическийРезультат = ВыполнитьФункцию(ВходныеДанные);
    
    // Assert - проверка
    mcp_Тестирование.ОжидаемРавно(ОжидаемыйРезультат, ФактическийРезультат);
    
КонецПроцедуры
```

### Setup и Teardown

```1c
// Setup - подготовка окружения
Процедура Setup_Тест_ДолженПроверитьФункцию()
    // Инициализация тестовых данных
КонецПроцедуры

// Teardown - очистка после теста
Процедура Teardown_Тест_ДолженПроверитьФункцию()
    // Очистка ресурсов
КонецПроцедуры
```

## Форматы отчетов

### Поддерживаемые форматы

1. **HTML** - Интерактивный отчет с фильтрацией
2. **XML (JUnit)** - Для интеграции с CI/CD
3. **JSON** - Машинно-читаемый формат
4. **Markdown** - Для документации
5. **CSV** - Для анализа в Excel
6. **Простой текст** - Для быстрого просмотра

### Генерация отчетов

```1c
// Создание отчета
Отчет = mcp_Тестирование.СоздатьОтчет(РезультатыТестов, "HTML");

// Сохранение в файл
ИмяФайла = mcp_Тестирование.СохранитьОтчетВФайл(Отчет, "test_report", ".html");
```

## Интерфейс управления тестами

### Функциональность

- **Запуск выбранных тестов**: Выборочный запуск тестовых наборов
- **Запуск всех тестов**: Полное тестирование
- **Остановка тестов**: Прерывание выполнения
- **Фильтрация**: По категории и статусу
- **Экспорт отчетов**: В различных форматах

### Использование

1. Откройте обработку `УправлениеТестами`
2. Выберите необходимые тестовые наборы
3. Настройте фильтры при необходимости
4. Запустите тесты
5. Просмотрите результаты в отчете

## Утилиты сравнения данных

### Глубокое сравнение структур

```1c
// Сравнение структур с рекурсией
Результат = СравнениеДанных.СравнитьСтруктурыГлубоко(Структура1, Структура2);

Если НЕ Результат.равны Тогда
    Сообщить("Различия: " + Результат.сообщение);
КонецЕсли;
```

### Сравнение массивов

```1c
// Сравнение массивов с проверкой порядка
Результат = СравнениеДанных.СравнитьМассивыГлубоко(Массив1, Массив2, Истина);

// Сравнение без учета порядка
Результат = СравнениеДанных.СравнитьМассивыГлубоко(Массив1, Массив2, Ложь);
```

### Специализированные сравнения

```1c
// Сравнение JSON-RPC ответов
Результат = СравнениеДанных.СравнитьJSONRPCОтветы(Ответ1, Ответ2);

// Сравнение схем инструментов
Результат = СравнениеДанных.СравнитьСхемыИнструментов(Схема1, Схема2);
```

## Лучшие практики

### 1. Именование тестов

```1c
// Хорошо: Описывает проверяемое поведение
Тест_ДолженВерифицироватьВыполнениеИнструментаПриКорректныхПараметрах()

// Плохо: Не описывает суть
Тест_Проверка1()
```

### 2. Структура теста (AAA)

```1c
Процедура Тест_ДолженРассчитатьНДС() Экспорт
    
    // Arrange - подготовка данных
    Сумма = 1000;
    СтавкаНДС = 20;
    ОжидаемаяСуммаНДС = 200;
    
    // Act - выполнение действия
    ФактическаяСуммаНДС = РассчитатьНДС(Сумма, СтавкаНДС);
    
    // Assert - проверка результата
    mcp_Тестирование.ОжидаемРавно(ОжидаемаяСуммаНДС, ФактическаяСуммаНДС);
    
КонецПроцедуры
```

### 3. Изоляция тестов

- Каждый тест независим
- Используйте фикстуры для подготовки данных
- Очищайте ресурсы в Teardown

### 4. Тестовые данные

```1c
// Используйте детерминированные данные
Функция СоздатьТестовыеДанные()
    Данные = Новый Структура;
    Данные.Вставить("Имя", "ТестовыйКлиент");
    Данные.Вставить("Код", "TEST001");
    Возврат Данные;
КонецФункции
```

## Интеграция с CI/CD

### JUnit XML отчет

```xml
<?xml version="1.0" encoding="UTF-8"?>
<testsuites>
  <testsuite name="MCP_Tests" tests="10" failures="1" errors="0" time="15">
    <testcase name="TestInitialize" classname="MCP.Tests" time="2">
      <failure message="Test failed">Error details</failure>
    </testcase>
  </testsuite>
</testsuites>
```

### GitHub Actions пример

```yaml
- name: Run 1C MCP Tests
  run: |
    1cv8 run tests/xunit/ -out test-results.xml
    
- name: Publish Test Results
  uses: dorny/test-reporter@v1
  if: success() || failure()
  with:
    name: 1C MCP Test Results
    path: test-results.xml
    reporter: java-junit
```

## Метрики и аналитика

### Основные метрики

- **Покрытие кода**: Процент покрытых строк/функций
- **Flakiness rate**: Доля нестабильных тестов
- **Время выполнения**: Среднее и p95 время
- **Количество дефектов**: Найденные проблемы по этапам

### Отчетность

```1c
// Получение статистики
Статистика = ПодсчитатьОбщуюСтатистику(РезультатыТестов);

// Создание детального отчета
Отчет = ГенераторОтчетов.СоздатьИнтерактивныйHTMLОтчет(РезультатыТестов);
```

## Troubleshooting

### Частые проблемы

1. **Тесты не выполняются**
   - Проверьте права доступа к обработкам
   - Убедитесь в корректности имен функций

2. **Ошибки сравнения данных**
   - Проверьте типы сравниваемых значений
   - Используйте глубокое сравнение для сложных структур

3. **Медленное выполнение тестов**
   - Оптимизируйте тестовые данные
   - Используйте моки для внешних зависимостей

### Логирование

```1c
// Включение подробного логирования
ЗаписьЖурналаРегистрации(
    "MCP.Tests.ИмяТеста", 
    УровеньЖурналаРегистрации.Отладка, 
    , 
    , 
    "Детальная информация о тесте");
```

## Расширение фреймворка

### Добавление новых assertions

```1c
// В модуле mcp_Тестирование
Процедура ОжидаемСпециальнуюПроверку(Значение, Сообщение = "") Экспорт
    Если НЕ СпециальнаяЛогикаПроверки(Значение) Тогда
        ВызватьИсключение Сообщение;
    КонецЕсли;
КонецПроцедуры
```

### Создание специализированных тестовых обработок

```1c
// Создайте новую обработку на основе базового шаблона
// Реализуйте функции:
// - ТЦИнициализировать()
// - ТЦВыполнить()
// - ТЦУдалитьДанные()
```

## Поддержка и развитие

### Текущая версия: 1.0.0

### Планы развития

- [ ] Поддержка параллельного выполнения тестов
- [ ] Интеграция с Mock объектами
- [ ] Расширенные метрики производительности
- [ ] Автоматическая генерация тестовых данных
- [ ] Интеграция с системами мониторинга

### Контрибьюция

При разработке новых тестов:
1. Следуйте стандартам именования
2. Добавляйте документацию к функциям
3. Тестируйте на разных версиях платформы
4. Проверяйте совместимость с существующими тестами

## Заключение

Фреймворк тестирования MCP предоставляет современное решение для обеспечения качества в проекте 1c_mcp. Он следует лучшим практикам тестирования 1С и обеспечивает надежную основу для автоматизированного тестирования на всех уровнях: от юнит-тестов до сквозных E2E сценариев.

---

**Разработчик**: Харин Владимир  
**Проект**: [1c_mcp](https://github.com/vladimir-kharin/1c_mcp)  
**Лицензия**: MIT  
**Документация обновлена**: 2025-10-29