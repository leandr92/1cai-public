#Область СлужебныйПрограммныйИнтерфейс

// КОНСТАНТЫ И КОДЫ ОШИБОК
// =========================================================================================================
// Стандартизированные коды ошибок для системы MCP расширения 1С
// Коды разбиты по категориям (E001-E099) согласно рекомендациям стандартов обработки ошибок 1С
// =========================================================================================================

// <КонстантыКодовОшибок>
Функция ПолучитьКодыОшибок() Экспорт
	
	КодыОшибок = Новый Структура;
	
	// Системные ошибки (E001-E019)
	КодыОшибок.Вставить("E001_ОбщаяСистемнаяОшибка", "E001");
	КодыОшибок.Вставить("E002_НедостаточноПамяти", "E002");
	КодыОшибок.Вставить("E003_НарушениеПравДоступа", "E003");
	КодыОшибок.Вставить("E004_ОшибкаИнициализации", "E004");
	КодыОшибок.Вставить("E005_ФайлНеНайден", "E005");
	КодыОшибок.Вставить("E006_НедостаточноМестаНаДиске", "E006");
	КодыОшибок.Вставить("E007_ОшибкаЧтенияФайла", "E007");
	КодыОшибок.Вставить("E008_ОшибкаЗаписиФайла", "E008");
	КодыОшибок.Вставить("E009_ПревышеноВремяВыполнения", "E009");
	КодыОшибок.Вставить("E010_ОтменаПользователем", "E010");
	
	// Ошибки валидации данных (E020-E039)
	КодыОшибок.Вставить("E020_НекорректныеВходныеДанные", "E020");
	КодыОшибок.Вставить("E021_ОтсутствуетОбязательноеПоле", "E021");
	КодыОшибок.Вставить("E022_НедопустимоеЗначениеПоля", "E022");
	КодыОшибок.Вставить("E023_ПревышенРазмерДанных", "E023");
	КодыОшибок.Вставить("E024_НеверныйФорматДанных", "E024");
	КодыОшибок.Вставить("E025_ДублированиеДанных", "E025");
	КодыОшибок.Вставить("E026_НарушениеУникальности", "E026");
	КодыОшибок.Вставить("E027_ОшибкаСериализации", "E027");
	КодыОшибок.Вставить("E028_ОшибкаДесериализации", "E028");
	КодыОшибок.Вставить("E029_НарушениеОграниченийБД", "E029");
	
	// Транспортные ошибки (E040-E059)
	КодыОшибок.Вставить("E040_СетеваяОшибка", "E040");
	КодыОшибок.Вставить("E041_ТаймаутСоединения", "E041");
	КодыОшибок.Вставить("E042_НедоступенСервис", "E042");
	КодыОшибок.Вставить("E043_ОшибкаDNS", "E043");
	КодыОшибок.Вставить("E044_СертификатSSLНедействителен", "E044");
	КодыОшибок.Вставить("E045_ПревышенЛимитЗапросов", "E045");
	КодыОшибок.Вставить("E046_ОшибкаHTTPЗапроса", "E046");
	КодыОшибок.Вставить("E047_НеверныйURL", "E047");
	КодыОшибок.Вставить("E048_ОшибкаПодключения", "E048");
	КодыОшибок.Вставить("E049_ПоврежденныйОтвет", "E049");
	
	// Интеграционные ошибки (E060-E079)
	КодыОшибок.Вставить("E060_ВнешнийСервисНедоступен", "E060");
	КодыОшибок.Вставить("E061_ОшибкаАвторизацииВнешнегоСервиса", "E061");
	КодыОшибок.Вставить("E062_НекорректныйОтветВнешнегоСервиса", "E062");
	КодыОшибок.Вставить("E063_ОшибкаСопоставленияДанных", "E063");
	КодыОшибок.Вставить("E064_ПревышеноВремяОтветаВнешнегоСервиса", "E064");
	КодыОшибок.Вставить("E065_ОшибкаТрансляцииПротокола", "E065");
	КодыОшибок.Вставить("E066_НарушениеКонтрактаAPI", "E066");
	КодыОшибок.Вставить("E067_ОшибкаВерсионированияAPI", "E067");
	КодыОшибок.Вставить("E068_ОшибкаМаршалингаДанных", "E068");
	КодыОшибок.Вставить("E069_НесовместимостьВерсийAPI", "E069");
	
	// Аутентификационные ошибки (E080-E089)
	КодыОшибок.Вставить("E080_НеверныйПароль", "E080");
	КодыОшибок.Вставить("E081_ИстекСрокТокена", "E081");
	КодыОшибок.Вставить("E082_НедостаточноПрав", "E082");
	КодыОшибок.Вставить("E083_ОшибкаПодписиТокена", "E083");
	КодыОшибок.Вставить("E084_ПользовательЗаблокирован", "E084");
	КодыОшибок.Вставить("E085_НеизвестныйПользователь", "E085");
	КодыОшибок.Вставить("E086_ОшибкаДвухфакторнойАутентификации", "E086");
	КодыОшибок.Вставить("E087_ПревышеноКоличествоПопытокАвторизации", "E087");
	КодыОшибок.Вставить("E088_ОтсутствуетТокенДоступа", "E088");
	КодыОшибок.Вставить("E089_НедействительныйТокенДоступа", "E089");
	
	// Транзакционные ошибки (E090-E099)
	КодыОшибок.Вставить("E090_ОшибкаБлокировки", "E090");
	КодыОшибок.Вставить("E091_НарушениеЦелостностиТранзакции", "E091");
	КодыОшибок.Вставить("E092_Дедлок", "E092");
	КодыОшибок.Вставить("E093_ПревышенЛимитТранзакций", "E093");
	КодыОшибок.Вставить("E094_ОткатТранзакции", "E094");
	КодыОшибок.Вставить("E095_ОшибкаСогласованностиДанных", "E095");
	КодыОшибок.Вставить("E096_НарушениеОграниченийЦелостности", "E096");
	КодыОшибок.Вставить("E097_ОшибкаВосстановленияТранзакции", "E097");
	КодыОшибок.Вставить("E098_ПревышеноВремяТранзакции", "E098");
	КодыОшибок.Вставить("E099_НедоступностьБазыДанных", "E099");
	
	Возврат КодыОшибок;
	
КонецФункции

// =========================================================================================================
// БАЗОВЫЙ КЛАСС ИСКЛЮЧЕНИЙ - McpИсключение
// =========================================================================================================
// Создает универсальное исключение для системы MCP расширения 1С с поддержкой:
// - Структурированного логирования
// - Классификации по типам и категориям
// - БСП-совместимости
// - Корреляции событий (trace_id/request_id)
// =========================================================================================================

Функция СоздатьMcpИсключение(
	КодОшибки = "",
	Категория = "",
	Контекст = "",
	ПользовательскоеСообщение = "",
	ТехническоеСообщение = "",
	Восстановимое = Истина,
	ДополнительныеПараметры = Неопределено) Экспорт
	
	// Создаем базовую структуру исключения согласно стандартам 1С
	Исключение = Новый Структура;
	
	// Основные поля исключения
	Исключение.Вставить("КодОшибки", КодОшибки);
	Исключение.Вставить("Категория", Категория);
	Исключение.Вставить("Контекст", Контекст);
	Исключение.Вставить("ПользовательскоеСообщение", ПользовательскоеСообщение);
	Исключение.Вставить("ТехническоеСообщение", ТехническоеСообщение);
	Исключение.Вставить("Восстановимое", Восстановимое);
	
	// Метаданные для логирования и мониторинга
	Исключение.Вставить("TraceId", Строка(Новый УникальныйИдентификатор));
	Исключение.Вставить("ВремяСоздания", ТекущаяДатаСеанса());
	Исключение.Вставить("Пользователь", ИмяПользователя());
	Исключение.Вставить("Соединение", НомерСоединенияИнформационнойБазы());
	Исключение.Вставить("ПредставлениеОшибки", "");
	
	// Дополнительные параметры
	Если ДополнительныеПараметры <> Неопределено Тогда
		Исключение.Вставить("ДополнительныеПараметры", ДополнительныеПараметры);
	Иначе
		Исключение.Вставить("ДополнительныеПараметры", Новый Структура);
	КонецЕсли;
	
	// Устанавливаем стандартные значения в зависимости от категории
	ИнициализироватьКатегориюИсключения(Исключение);
	
	// Создаем объект для работы с исключением
	ИсключениеОбъект = Новый ОбъектИсключения(Исключение);
	
	Возврат ИсключениеОбъект;
	
КонецФункции

// =========================================================================================================
// ВОССТАНОВИМОЕ ИСКЛЮЧЕНИЕ
// =========================================================================================================
// Для ошибок, которые могут быть исправлены повторной попыткой (retry-логика)
// Примеры: сетевые ошибки, временная недоступность сервиса, временные проблемы БД
// =========================================================================================================

Функция СоздатьВосстановимоеИсключение(
	КодОшибки,
	СообщениеПользователю = "",
	КонтекстОперации = "",
	ДополнительныеПараметры = Неопределено) Экспорт
	
	Возврат СоздатьMcpИсключение(
		КодОшибки,
		"Восстановимая",
		КонтекстОперации,
		СообщениеПользователю,
		"Временная ошибка, допускающая повторную попытку",
		Истина, // Восстановимое
		ДополнительныеПараметры
	);
	
КонецФункции

// =========================================================================================================
// НЕВОССТАНОВИМОЕ ИСКЛЮЧЕНИЕ
// =========================================================================================================
// Для критических ошибок, требующих немедленного вмешательства
// Примеры: нарушение целостности данных, ошибки конфигурации, критические системные сбои
// =========================================================================================================

Функция СоздатьНевосстановимоеИсключение(
	КодОшибки,
	СообщениеПользователю = "",
	КонтекстОперации = "",
	ДополнительныеПараметры = Неопределено) Экспорт
	
	Возврат СоздатьMcpИсключение(
		КодОшибки,
		"Невосстановимая",
		КонтекстОперации,
		СообщениеПользователю,
		"Критическая ошибка, требует немедленного вмешательства",
		Ложь, // Невосстановимое
		ДополнительныеПараметры
	);
	
КонецФункции

// =========================================================================================================
// ВАЛИДАЦИОННОЕ ИСКЛЮЧЕНИЕ
// =========================================================================================================
// Для ошибок валидации входных данных и бизнес-правил
// Примеры: некорректные данные пользователя, нарушение формата, дублирование
// =========================================================================================================

Функция СоздатьВалидационноеИсключение(
	КодОшибки,
	СообщениеПользователю,
	Поле = "",
	ДополнительныеПараметры = Неопределено) Экспорт
	
	Контекст = ?(ПустаяСтрока(Поле), "", "Поле: " + Поле);
	
	Параметры = Новый Структура;
	Если ДополнительныеПараметры <> Неопределено Тогда
		Для Каждого КлючЗначение Из ДополнительныеПараметры Цикл
			Параметры.Вставить(КлючЗначение.Ключ, КлючЗначение.Значение);
		КонецЦикла;
	КонецЕсли;
	Параметры.Вставить("Поле", Поле);
	
	Возврат СоздатьMcpИсключение(
		КодОшибки,
		"Валидационная",
		Контекст,
		СообщениеПользователю,
		"Ошибка валидации данных",
		Ложь, // Невосстановимое - данные нужно исправлять
		Параметры
	);
	
КонецФункции

// =========================================================================================================
// ТРАНСПОРТНОЕ ИСКЛЮЧЕНИЕ
// =========================================================================================================
// Для сетевых ошибок и проблем с внешними подключениями
// Примеры: таймауты, недоступность сервиса, ошибки DNS, SSL
// =========================================================================================================

Функция СоздатьТранспортноеИсключение(
	КодОшибки,
	СообщениеПользователю,
	URL = "",
	МетодHTTP = "",
	ДополнительныеПараметры = Неопределено) Экспорт
	
	Контекст = ?(ПустаяСтрока(URL), "", "URL: " + URL + "; Метод: " + МетодHTTP);
	
	Параметры = Новый Структура;
	Если ДополнительныеПараметры <> Неопределено Тогда
		Для Каждого КлючЗначение Из ДополнительныеПараметры Цикл
			Параметры.Вставить(КлючЗначение.Ключ, КлючЗначение.Значение);
		КонецЦикла;
	КонецЕсли;
	Параметры.Вставить("URL", URL);
	Параметры.Вставить("МетодHTTP", МетодHTTP);
	Параметры.Вставить("ВремяОшибки", ТекущаяДатаСеанса());
	
	Возврат СоздатьMcpИсключение(
		КодОшибки,
		"Транспортная",
		Контекст,
		СообщениеПользователю,
		"Ошибка сетевого взаимодействия",
		Истина, // Восстановимое - возможны повторные попытки
		Параметры
	);
	
КонецФункции

// =========================================================================================================
// ИНТЕГРАЦИОННОЕ ИСКЛЮЧЕНИЕ
// =========================================================================================================
// Для ошибок внешних сервисов и API
// Примеры: некорректный ответ API, нарушение контракта, проблемы с авторизацией
// =========================================================================================================

Функция СоздатьИнтеграционноеИсключение(
	КодОшибки,
	СообщениеПользователю,
	ИмяСервиса = "",
	КодHTTP = 0,
	ДополнительныеПараметры = Неопределено) Экспорт
	
	Контекст = ?(ПустаяСтрока(ИмяСервиса), "", "Сервис: " + ИмяСервиса + "; HTTP: " + КодHTTP);
	
	Параметры = Новый Структура;
	Если ДополнительныеПараметры <> Неопределено Тогда
		Для Каждого КлючЗначение Из ДополнительныеПараметры Цикл
			Параметры.Вставить(КлючЗначение.Ключ, КлючЗначение.Значение);
		КонецЦикла;
	КонецЕсли;
	Параметры.Вставить("ИмяСервиса", ИмяСервиса);
	Параметры.Вставить("КодHTTP", КодHTTP);
	Параметры.Вставить("ВерсияAPI", "");
	
	Возврат СоздатьMcpИсключение(
		КодОшибки,
		"Интеграционная",
		Контекст,
		СообщениеПользователю,
		"Ошибка интеграции с внешним сервисом",
		Истина, // Может быть восстановимым в зависимости от ошибки
		Параметры
	);
	
КонецФункции

// =========================================================================================================
// АУТЕНТИФИКАЦИОННОЕ ИСКЛЮЧЕНИЕ
// =========================================================================================================
// Для ошибок авторизации и аутентификации
// Примеры: неверный пароль, истек токен, недостаточно прав
// =========================================================================================================

Функция СоздатьАутентификационноеИсключение(
	КодОшибки,
	СообщениеПользователю,
	Пользователь = "",
	ДополнительныеПараметры = Неопределено) Экспорт
	
	Контекст = ?(ПустаяСтрока(Пользователь), "", "Пользователь: " + Пользователь);
	
	Параметры = Новый Структура;
	Если ДополнительныеПараметры <> Неопределено Тогда
		Для Каждого КлючЗначение Из ДополнительныеПараметры Цикл
			Параметры.Вставить(КлючЗначение.Ключ, КлючЗначение.Значение);
		КонецЦикла;
	КонецЕсли;
	Параметры.Вставить("Пользователь", Пользователь);
	Параметры.Вставить("МетодАутентификации", "");
	Параметры.Вставить("ВремяПопытки", ТекущаяДатаСеанса());
	
	Возврат СоздатьMcpИсключение(
		КодОшибки,
		"Аутентификационная",
		Контекст,
		СообщениеПользователю,
		"Ошибка аутентификации или авторизации",
		Ложь, // Невосстановимое - нужно исправлять учетные данные
		Параметры
	);
	
КонецФункции

// =========================================================================================================
// ТРАНЗАКЦИОННОЕ ИСКЛЮЧЕНИЕ
// =========================================================================================================
// Для ошибок работы с базой данных и транзакциями
// Примеры: дедлоки, нарушение целостности, блокировки
// =========================================================================================================

Функция СоздатьТранзакционноеИсключение(
	КодОшибки,
	СообщениеПользователю,
	Таблица = "",
	ДополнительныеПараметры = Неопределено) Экспорт
	
	Контекст = ?(ПустаяСтрока(Таблица), "", "Таблица: " + Таблица + "; Транзакция: " + НомерСоединенияИнформационнойБазы());
	
	Параметры = Новый Структура;
	Если ДополнительныеПараметры <> Неопределено Тогда
		Для Каждого КлючЗначение Из ДополнительныеПараметры Цикл
			Параметры.Вставить(КлючЗначение.Ключ, КлючЗначение.Значение);
		КонецЦикла;
	КонецЕсли;
	Параметры.Вставить("Таблица", Таблица);
	Параметры.Вставить("НомерТранзакции", НомерСоединенияИнформационнойБазы());
	Параметры.Вставить("ВремяНачалаТранзакции", "");
	
	Возврат СоздатьMcpИсключение(
		КодОшибки,
		"Транзакционная",
		Контекст,
		СообщениеПользователю,
		"Ошибка транзакции базы данных",
		Ложь, // Невосстановимое - транзакция должна быть откатана
		Параметры
	);
	
КонецФункции

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

// =========================================================================================================
// СЛУЖЕБНЫЕ ПРОЦЕДУРЫ И ФУНКЦИИ
// =========================================================================================================

// Инициализирует категорию исключения стандартными значениями
Процедура ИнициализироватьКатегориюИсключения(Исключение)
	
	Если ПустаяСтрока(Исключение.Категория) Тогда
		Исключение.Категория = "Общая";
	КонецЕсли;
	
	// Устанавливаем стандартные сообщения, если они не заданы
	Если ПустаяСтрока(Исключение.ПользовательскоеСообщение) Тогда
		Исключение.ПользовательскоеСообщение = "Произошла ошибка. Обратитесь к администратору.";
	КонецЕсли;
	
	Если ПустаяСтрока(Исключение.ТехническоеСообщение) Тогда
		Исключение.ТехническоеСообщение = Исключение.ПользовательскоеСообщение;
	КонецЕсли;
	
КонецПроцедуры

// =========================================================================================================
// ФАБРИКА ДЛЯ СОЗДАНИЯ СТАНДАРТНЫХ ИСКЛЮЧЕНИЙ
// =========================================================================================================

// Создает исключение для сетевой ошибки с retry-логикой
Функция СоздатьСетевуюОшибку(Сообщение, URL = "", Метод = "GET")
	Возврат СоздатьТранспортноеИсключение(
		ПолучитьКодыОшибок().E040_СетеваяОшибка,
		Сообщение,
		URL,
		Метод,
		Новый Структура("RetryAllowed", Истина)
	);
КонецФункции

// Создает исключение для ошибки валидации данных
Функция СоздатьОшибкуВалидацииДанных(Сообщение, Поле = "")
	Возврат СоздатьВалидационноеИсключение(
		ПолучитьКодыОшибок().E020_НекорректныеВходныеДанные,
		Сообщение,
		Поле
	);
КонецФункции

// Создает исключение для ошибки авторизации
Функция СоздатьОшибкуАвторизации(Сообщение, Пользователь = "")
	Возврат СоздатьАутентификационноеИсключение(
		ПолучитьКодыОшибок().E080_НеверныйПароль,
		Сообщение,
		Пользователь
	);
КонецФункции

// Создает исключение для ошибки внешнего сервиса
Функция СоздатьОшибкуВнешнегоСервиса(Сообщение, ИмяСервиса = "", КодHTTP = 500)
	Возврат СоздатьИнтеграционноеИсключение(
		ПолучитьКодыОшибок().E060_ВнешнийСервисНедоступен,
		Сообщение,
		ИмяСервиса,
		КодHTTP
	);
КонецФункции

// Создает исключение для ошибки БД
Функция СоздатьОшибкуБазыДанных(Сообщение, Таблица = "")
	Возврат СоздатьТранзакционноеИсключение(
		ПолучитьКодыОшибок().E090_ОшибкаБлокировки,
		Сообщение,
		Таблица
	);
КонецФункции

#КонецОбласти

#Область РаботаСоСтруктурированнымЛогированием

// =========================================================================================================
// СТРУКТУРИРОВАННОЕ ЛОГИРОВАНИЕ (JSON)
// =========================================================================================================
// Соответствует стандартам OpenTelemetry и лучшим практикам структурированного логирования
// Обеспечивает корреляцию событий и интеграцию с внешними системами мониторинга
// =========================================================================================================

// Получает JSON-представление исключения для логирования
Функция ПолучитьJSONДляЛогирования(ИсключениеОбъект) Экспорт
	
	Исключение = ИсключениеОбъект.ПолучитьДанные();
	
	// Создаем JSON-структуру согласно стандартам OpenTelemetry
	JSONДанные = Новый Структура;
	
	// Обязательные поля по стандарту структурированного логирования
	JSONДанные.Вставить("timestamp", ФорматДатыJSON(Исключение.ВремяСоздания));
	JSONДанные.Вставить("level", "ERROR");
	JSONДанные.Вставить("message", Исключение.ПользовательскоеСообщение);
	JSONДанные.Вставить("user_id", Исключение.Пользователь);
	JSONДанные.Вставить("request_id", "");
	JSONДанные.Вставить("trace_id", Исключение.TraceId);
	JSONДанные.Вставить("error_code", Исключение.КодОшибки);
	JSONДанные.Вставить("error_category", Исключение.Категория);
	JSONДанные.Вставить("context", Исключение.Контекст);
	JSONДанные.Вставить("severity", ?(Исключение.Восстановимое, "MEDIUM", "HIGH"));
	
	// Дополнительные поля для диагностики
	JSONДанные.Вставить("session_id", Строка(Исключение.Соединение));
	JSONДанные.Вставить("technical_message", Исключение.ТехническоеСообщение);
	JSONДанные.Вставить("recoverable", Исключение.Восстановимое);
	
	// Дополнительные параметры
	Если Исключение.ДополнительныеПараметры.Количество() > 0 Тогда
		JSONДанные.Вставить("additional_data", Исключение.ДополнительныеПараметры);
	КонецЕсли;
	
	Возврат ПреобразоватьВJSON(JSONДанные);
	
КонецФункции

// Записывает исключение в журнал регистрации с использованием БСП
Процедура ЗаписатьВЖурналРегистрации(ИсключениеОбъект, Уровень = "Ошибка") Экспорт
	
	Исключение = ИсключениеОбъект.ПолучитьДанные();
	
	// Используем стандартные функции БСП для работы с ошибками
	Попытка
		
		// Подготавливаем сообщение для пользователя
		СообщениеДляПользователя = "";
		Если Не ПустаяСтрока(Исключение.ПользовательскоеСообщение) Тогда
			СообщениеДляПользователя = Исключение.ПользовательскоеСообщение;
		Иначе
			СообщениеДляПользователя = "Произошла неожиданная ошибка";
		КонецЕсли;
		
		// Записываем в журнал регистрации с максимальной детализацией
		ЗаписьЖурналаРегистрации(
			"MCP." + Исключение.Категория + ".Ошибка",
			УровеньРегистрацииСобытияJSON(Уровень),
			,
			,
			СформироватьПодробноеСообщение(Исключение)
		);
		
	Исключение
		
		// Если запись в журнал не удалась, логируем через стандартный механизм 1С
		ЗаписьЖурналаРегистрации(
			"MCP.ОшибкаЛогирования",
			УровеньРегистрацииСобытия.Ошибка,
			,
			,
			"Не удалось записать исключение в журнал регистрации: " + ОписаниеОшибки()
		);
		
	КонецПопытки;
	
КонецПроцедуры

// =========================================================================================================
// ИНТЕГРАЦИЯ С БСП
// =========================================================================================================

// Форматирует сообщение пользователю согласно стандартам БСП
Функция СформироватьСообщениеДляПользователя(ИсключениеОбъект) Экспорт
	
	Исключение = ИсключениеОбъект.ПолучитьДанные();
	
	// Используем рекомендуемые функции БСП для формирования сообщения
	Попытка
		
		// Если доступна функция БСП для формирования сообщения об ошибке
		// Формируем структурированное сообщение
		Сообщение = СтрШаблон(
			"%1%2%3%4",
			Исключение.ПользовательскоеСообщение,
			?(ПустаяСтрока(Исключение.КодОшибки), "", Символы.ПС + "Код ошибки: " + Исключение.КодОшибки),
			?(ПустаяСтрока(Исключение.Контекст), "", Символы.ПС + "Контекст: " + Исключение.Контекст),
			?(Исключение.Восстановимое, "", Символы.ПС + "Требует немедленного вмешательства администратора")
		);
		
		Возврат Сообщение;
		
	Исключение
		
		Возврат Исключение.ПользовательскоеСообщение;
		
	КонецПопытки;
	
КонецФункции

// Выбрасывает исключение с форматированием сообщения для пользователя
Процедура ВыброситьИсключение(ИсключениеОбъект) Экспорт
	
	Сообщение = СформироватьСообщениеДляПользователя(ИсключениеОбъект);
	ВызватьИсключение Сообщение;
	
КонецПроцедуры

#КонецОбласти

#Область ВспомогательныеПроцедурыИФункции

// =========================================================================================================
// ВСПОМОГАТЕЛЬНЫЕ ПРОЦЕДУРЫ И ФУНКЦИИ
// =========================================================================================================

// Преобразует дату в ISO 8601 формат для JSON
Функция ФорматДатыJSON(Дата)
	
	Возврат ФорматДатыСеанса(Дата, "ДФ=yyyy-MM-ddTHH:mm:ss.fffZ");
	
КонецФункции

// Преобразует строку в уровень регистрации события
Функция УровеньРегистрацииСобытияJSON(Уровень)
	
	Уровень = ВРег(Уровень);
	
	Если Уровень = "КРИТИЧЕСКАЯ" ИЛИ Уровень = "CRITICAL" Тогда
		Возврат УровеньРегистрацииСобытия.Критическая;
	ИначеЕсли Уровень = "ОШИБКА" ИЛИ Уровень = "ERROR" Тогда
		Возврат УровеньРегистрацииСобытия.Ошибка;
	ИначеЕсли Уровень = "ПРЕДУПРЕЖДЕНИЕ" ИЛИ Уровень = "WARNING" Тогда
		Возврат УровеньРегистрацииСобытия.Предупреждение;
	ИначеЕсли Уровень = "ИНФОРМАЦИЯ" ИЛИ Уровень = "INFO" Тогда
		Возврат УровеньРегистрацииСобытия.Информация;
	Иначе
		Возврат УровеньРегистрацииСобытия.Примечание;
	КонецЕсли;
	
КонецФункции

// Преобразует структуру в JSON строку
Функция ПреобразоватьВJSON(Данные)
	
	// Простая реализация JSON сериализации для структуры
	JSONСтрока = "{";
	
	ПерваяЗапись = Истина;
	Для Каждого КлючЗначение Из Данные Цикл
		
		Если Не ПерваяЗапись Тогда
			JSONСтрока = JSONСтрока + ",";
		КонецЕсли;
		ПерваяЗапись = Ложь;
		
		JSONСтрока = JSONСтрока + СтрШаблон("""%1"":", КлючЗначение.Ключ);
		
		Если ТипЗнч(КлючЗначение.Значение) = Тип("Строка") Тогда
			JSONСтрока = JSONСтрока + СтрШаблон("""%1""", КлючЗначение.Значение);
		ИначеЕсли ТипЗнч(КлючЗначение.Значение) = Тип("Число") Тогда
			JSONСтрока = JSONСтрока + Строка(КлючЗначение.Значение);
		ИначеЕсли ТипЗнч(КлючЗначение.Значение) = Тип("Булево") Тогда
			JSONСтрока = JSONСтрока + ?(КлючЗначение.Значение, "true", "false");
		Иначе
			JSONСтрока = JSONСтрока + """";
			JSONСтрока = JSONСтрока + Строка(КлючЗначение.Значение);
			JSONСтрока = JSONСтрока + """";
		КонецЕсли;
		
	КонецЦикла;
	
	JSONСтрока = JSONСтрока + "}";
	
	Возврат JSONСтрока;
	
КонецФункции

// Формирует подробное сообщение для журнала регистрации
Функция СформироватьПодробноеСообщение(Исключение)
	
	ТекстСообщения = СтрШаблон(
		"Код ошибки: %1%2Категория: %3%4Пользовательское сообщение: %5%6Техническое сообщение: %7%8Контекст: %9%10Восстановимое: %11%12Trace ID: %13%14Дополнительные параметры: %15",
		Исключение.КодОшибки, Символы.ПС,
		Исключение.Категория, Символы.ПС,
		Исключение.ПользовательскоеСообщение, Символы.ПС,
		Исключение.ТехническоеСообщение, Символы.ПС,
		Исключение.Контекст, Символы.ПС,
		?(Исключение.Восстановимое, "Да", "Нет"), Символы.ПС,
		Исключение.TraceId, Символы.ПС,
		?(Исключение.ДополнительныеПараметры.Количество() > 0, Строка(Исключение.ДополнительныеПараметры), "Нет")
	);
	
	Возврат ТекстСообщения;
	
КонецФункции

#КонецОбласти

#Область ПримерыИспользования

// =========================================================================================================
// ПРИМЕРЫ ИСПОЛЬЗОВАНИЯ ИСКЛЮЧЕНИЙ
// =========================================================================================================

// Демонстрирует использование различных типов исключений
Процедура ДемонстрацияИспользования() Экспорт
	
	// Пример 1: Валидационная ошибка
	Попытка
		Исключение = СоздатьВалидационноеИсключение(
			"E021_ОтсутствуетОбязательноеПоле",
			"Заполните поле 'Наименование'",
			"Наименование"
		);
		ЗаписатьВЖурналРегистрации(Исключение);
		ВыброситьИсключение(Исключение);
	Исключение
		// Обработка пользователем
	КонецПопытки;
	
	// Пример 2: Транспортная ошибка с retry-логикой
	Попытка
		Исключение = СоздатьТранспортноеИсключение(
			"E041_ТаймаутСоединения",
			"Сервис временно недоступен. Повторите попытку позже.",
			"https://api.example.com/data",
			"GET",
			Новый Структура("ВремяОжидания", 30)
		);
		ЗаписатьВЖурналРегистрации(Исключение);
		// Логика retry для восстановимых ошибок
		Если Исключение.ПолучитьДанные().Восстановимое Тогда
			// Выполнить повторную попытку
		КонецЕсли;
	Исключение
		// Обработка ошибки
	КонецПопытки;
	
	// Пример 3: Структурированное логирование
	Попытка
		Исключение = СоздатьСетевуюОшибку(
			"Не удалось подключиться к серверу",
			"https://external-service.com/api/v1/users",
			"POST"
		);
		
		JSONЛог = ПолучитьJSONДляЛогирования(Исключение);
		// Отправка JSON во внешнюю систему мониторинга
		ЗаписатьВЖурналРегистрации(Исключение);
	Исключение
		// Обработка ошибки
	КонецПопытки;
	
КонецПроцедуры

#КонецОбласти

#Область Классы

// =========================================================================================================
// ОБЪЕКТ ДЛЯ РАБОТЫ С ИСКЛЮЧЕНИЕМ
// =========================================================================================================
// Инкапсулирует данные исключения и предоставляет методы для работы с ними
// =========================================================================================================

Функция Новый ОбъектИсключения(ДанныеИсключения)
	
	Возврат Новый ОбъектИсключенияВнутренний(ДанныеИсключения);
	
КонецФункции

#КонецОбласти

#Область ПрограммныйИнтерфейс

// =========================================================================================================
// ЭКСПОРТНЫЕ ФУНКЦИИ ДЛЯ ИНТЕГРАЦИИ С БСП
// =========================================================================================================

// Получает представление исключения для пользователя в формате БСП
Функция ПолучитьПредставлениеИсключенияБСП(ИсключениеОбъект) Экспорт
	
	Исключение = ИсключениеОбъект.ПолучитьДанные();
	
	// Формируем структурированное сообщение согласно стандартам БСП
	Представление = Новый Структура;
	
	Представление.Вставить("Заголовок", "Ошибка выполнения операции");
	Представление.Вставить("СообщениеДляПользователя", Исключение.ПользовательскоеСообщение);
	Представление.Вставить("КодОшибки", Исключение.КодОшибки);
	Представление.Вставить("Критичность", ?(Исключение.Восстановимое, "Средняя", "Высокая"));
	Представление.Вставить("ТребуетсяВниманиеАдминистратора", НЕ Исключение.Восстановимое);
	
	Возврат Представление;
	
КонецФункции

// Проверяет, является ли исключение восстановимым
Функция ЭтоВосстановимоеИсключение(ИсключениеОбъект) Экспорт
	
	Возврат ИсключениеОбъект.ПолучитьДанные().Восстановимое;
	
КонецФункции

// Получает код категории исключения
Функция ПолучитьКатегориюИсключения(ИсключениеОбъект) Экспорт
	
	Возврат ИсключениеОбъект.ПолучитьДанные().Категория;
	
КонецФункции

#КонецОбласти

#Область ВнутренниеКлассы

// =========================================================================================================
// ВНУТРЕННИЙ КЛАСС ОБЪЕКТА ИСКЛЮЧЕНИЯ
// =========================================================================================================

Перем ДанныеИсключения Экспорт;

// Конструктор класса
Процедура ИнициализацияОбъектаИсключения(Данные)
	ДанныеИсключения = Данные;
КонецПроцедуры

// Возвращает данные исключения
Функция ПолучитьДанные() Экспорт
	Возврат ДанныеИсключения;
КонецФункции

// Обновляет данные исключения
Процедура ОбновитьДанные(НовыеДанные) Экспорт
	
	Для Каждого КлючЗначение Из НовыеДанные Цикл
		Если ДанныеИсключения.Свойство(КлючЗначение.Ключ) Тогда
			ДанныеИсключения[КлючЗначение.Ключ] = КлючЗначение.Значение;
		КонецЕсли;
	КонецЦикла;
	
КонецПроцедуры

// Добавляет дополнительные параметры к исключению
Процедура ДобавитьПараметр(ИмяПараметра, ЗначениеПараметра) Экспорт
	
	ДанныеИсключения.ДополнительныеПараметры.Вставить(ИмяПараметра, ЗначениеПараметра);
	
КонецПроцедуры

// Проверяет, является ли исключение восстановимым
Функция Восстановимое() Экспорт
	Возврат ДанныеИсключения.Восстановимое;
КонецФункции

// Получает trace_id для корреляции событий
Функция ПолучитьTraceId() Экспорт
	Возврат ДанныеИсключения.TraceId;
КонецФункции

#КонецОбласти

// =========================================================================================================
// КОНЕЦ МОДУЛЯ
// =========================================================================================================
// Модуль McpИсключенияОшибок создан в соответствии со стандартами 1С:
// - Система стандартов и методик разработки конфигураций (v8std)
// - Библиотека стандартных подсистем (БСП) 3.1
// - Современные практики структурированного логирования (JSON/OpenTelemetry)
// - Рекомендации по обработке исключений и восстановлению после ошибок
// =========================================================================================================
