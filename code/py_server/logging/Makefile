# Makefile –¥–ª—è —Å–∏—Å—Ç–µ–º—ã —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è

.PHONY: help install test lint format clean run-demo check-deps validate

# –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
PYTHON := python3
PIP := pip3
VENV_DIR := venv
REQUIREMENTS := requirements.txt
EXAMPLES_FILE := examples.py

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ü–≤–µ—Ç–Ω–æ–≥–æ –≤—ã–≤–æ–¥–∞
YELLOW := \033[1;33m
GREEN := \033[1;32m
RED := \033[1;31m
BLUE := \033[1;34m
RESET := \033[0m

help: ## –ü–æ–∫–∞–∑–∞—Ç—å —Å–ø—Ä–∞–≤–∫—É
	@echo "$(BLUE)–°–∏—Å—Ç–µ–º–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è - –î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:$(RESET)"
	@echo ""
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "$(YELLOW)%-20s$(RESET) %s\n", $$1, $$2}'
	@echo ""

install: ## –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
	@echo "$(GREEN)üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π...$(RESET)"
	$(PIP) install --upgrade pip
	$(PIP) install -r $(REQUIREMENTS)
	@echo "$(GREEN)‚úÖ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã$(RESET)"

install-dev: ## –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
	@echo "$(GREEN)üõ†Ô∏è  –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏...$(RESET)"
	$(PIP) install -r $(REQUIREMENTS)
	$(PIP) install pytest pytest-asyncio pytest-cov black flake8 mypy
	@echo "$(GREEN)‚úÖ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã$(RESET)"

test: ## –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤
	@echo "$(GREEN)üß™ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤...$(RESET)"
	$(PYTHON) -m pytest tests.py -v --cov=. --cov-report=term-missing
	@echo "$(GREEN)‚úÖ –¢–µ—Å—Ç—ã –∑–∞–≤–µ—Ä—à–µ–Ω—ã$(RESET)"

test-quick: ## –ë—ã—Å—Ç—Ä—ã–µ —Ç–µ—Å—Ç—ã –±–µ–∑ –ø–æ–∫—Ä—ã—Ç–∏—è
	@echo "$(GREEN)‚ö° –ë—ã—Å—Ç—Ä—ã–µ —Ç–µ—Å—Ç—ã...$(RESET)"
	$(PYTHON) -m pytest tests.py -v -x
	@echo "$(GREEN)‚úÖ –ë—ã—Å—Ç—Ä—ã–µ —Ç–µ—Å—Ç—ã –∑–∞–≤–µ—Ä—à–µ–Ω—ã$(RESET)"

lint: ## –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞ –ª–∏–Ω—Ç–µ—Ä–æ–º
	@echo "$(GREEN)üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞ –ª–∏–Ω—Ç–µ—Ä–æ–º...$(RESET)"
	flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
	@echo "$(GREEN)‚úÖ –õ–∏–Ω—Ç–∏–Ω–≥ –∑–∞–≤–µ—Ä—à–µ–Ω$(RESET)"

format: ## –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞
	@echo "$(GREEN)üìù –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞...$(RESET)"
	black . --line-length=100
	@echo "$(GREEN)‚úÖ –ö–æ–¥ –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω$(RESET)"

type-check: ## –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–æ–≤
	@echo "$(GREEN)üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–æ–≤...$(RESET)"
	mypy . --ignore-missing-imports
	@echo "$(GREEN)‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–æ–≤ –∑–∞–≤–µ—Ä—à–µ–Ω–∞$(RESET)"

validate: lint type-check test-quick ## –ü–æ–ª–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –∫–æ–¥–∞
	@echo "$(GREEN)‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞$(RESET)"

run-demo: ## –ó–∞–ø—É—Å–∫ –¥–µ–º–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
	@echo "$(GREEN)üöÄ –ó–∞–ø—É—Å–∫ –¥–µ–º–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è...$(RESET)"
	@echo "$(BLUE)–û—Ç–∫—Ä–æ–π—Ç–µ –±—Ä–∞—É–∑–µ—Ä: http://localhost:8000$(RESET)"
	$(PYTHON) $(EXAMPLES_FILE)

run-demo-background: ## –ó–∞–ø—É—Å–∫ –¥–µ–º–æ –≤ —Ñ–æ–Ω–µ
	@echo "$(GREEN)üöÄ –ó–∞–ø—É—Å–∫ –¥–µ–º–æ –≤ —Ñ–æ–Ω–µ...$(RESET)"
	nohup $(PYTHON) $(EXAMPLES_FILE) > demo.log 2>&1 &
	@echo "$(GREEN)‚úÖ –î–µ–º–æ –∑–∞–ø—É—â–µ–Ω–æ –≤ —Ñ–æ–Ω–µ (PID: $(shell pgrep -f $(EXAMPLES_FILE)))$(RESET)"

stop-demo: ## –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –¥–µ–º–æ
	@echo "$(GREEN)üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –¥–µ–º–æ...$(RESET)"
	-@pkill -f "$(EXAMPLES_FILE)" || true
	@echo "$(GREEN)‚úÖ –î–µ–º–æ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ$(RESET)"

create-venv: ## –°–æ–∑–¥–∞–Ω–∏–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è
	@echo "$(GREEN)üîß –°–æ–∑–¥–∞–Ω–∏–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è...$(RESET)"
	$(PYTHON) -m venv $(VENV_DIR)
	@echo "$(GREEN)‚úÖ –í–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ$(RESET)"

activate-venv: ## –ê–∫—Ç–∏–≤–∞—Ü–∏—è –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è
	@echo "$(GREEN)‚ö° –ê–∫—Ç–∏–≤–∞—Ü–∏—è –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è...$(RESET)"
	@echo "$(BLUE)–í—ã–ø–æ–ª–Ω–∏—Ç–µ: source $(VENV_DIR)/bin/activate$(RESET)"

check-deps: ## –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
	@echo "$(GREEN)üìã –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π...$(RESET)"
	@echo "–û—Å–Ω–æ–≤–Ω—ã–µ –ø–∞–∫–µ—Ç—ã:"
	@$(PYTHON) -c "import structlog; print('structlog:', structlog.__version__)"
	@$(PYTHON) -c "try: import aiohttp; print('aiohttp:', aiohttp.__version__); except: print('aiohttp: –ù–ï –£–°–¢–ê–ù–û–í–õ–ï–ù')"
	@$(PYTHON) -c "try: import requests; print('requests:', requests.__version__); except: print('requests: –ù–ï –£–°–¢–ê–ù–û–í–õ–ï–ù')"
	@$(PYTHON) -c "try: import colorama; print('colorama:', colorama.__version__); except: print('colorama: –ù–ï –£–°–¢–ê–ù–û–í–õ–ï–ù')"
	@echo "$(GREEN)‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞$(RESET)"

clean: ## –û—á–∏—Å—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
	@echo "$(GREEN)üßπ –û—á–∏—Å—Ç–∫–∞ —Ñ–∞–π–ª–æ–≤...$(RESET)"
	find . -type f -name "*.pyc" -delete
	find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
	find . -type d -name ".pytest_cache" -exec rm -rf {} + 2>/dev/null || true
	find . -type f -name ".coverage" -delete
	find . -type d -name "htmlcov" -exec rm -rf {} + 2>/dev/null || true
	rm -f demo.log
	rm -rf $(VENV_DIR)
	@echo "$(GREEN)‚úÖ –û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞$(RESET)"

show-config: ## –ü–æ–∫–∞–∑–∞—Ç—å —Ç–µ–∫—É—â—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
	@echo "$(BLUE)–¢–µ–∫—É—â–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è:$(RESET)"
	@echo "SERVICE_NAME: ${SERVICE_NAME:-py_server}"
	@echo "LOG_LEVEL: ${LOG_LEVEL:-INFO}"
	@echo "JSON_OUTPUT: ${JSON_OUTPUT:-true}"
	@echo "CONSOLE_COLOR: ${CONSOLE_COLOR:-true}"
	@echo "ENABLE_METRICS: ${ENABLE_METRICS:-true}"
	@echo "ENABLE_APM: ${ENABLE_APM:-false}"
	@echo "MASK_EMAIL: ${MASK_EMAIL:-true}"
	@echo "MASK_PHONE: ${MASK_PHONE:-true}"

demo-urls: ## –ü–æ–∫–∞–∑–∞—Ç—å URL'—ã –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
	@echo "$(BLUE)–î–æ—Å—Ç—É–ø–Ω—ã–µ endpoint'—ã –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:$(RESET)"
	@echo "http://localhost:8000/"
	@echo "http://localhost:8000/demo/basic"
	@echo "http://localhost:8000/demo/http"
	@echo "http://localhost:8000/demo/business"
	@echo "http://localhost:8000/demo/performance"
	@echo "http://localhost:8000/demo/error"
	@echo "http://localhost:8000/demo/sanitization"

stress-test: ## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
	@echo "$(GREEN)‚ö° –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏...$(RESET)"
	@echo "–ì–µ–Ω–µ—Ä–∞—Ü–∏—è 10000 —Å–æ–æ–±—â–µ–Ω–∏–π –ª–æ–≥–æ–≤..."
	$(PYTHON) -c "
import time
from . import setup_logging, get_logger

setup_logging()
logger = get_logger('stress_test')

start_time = time.time()
for i in range(10000):
    logger.info('Stress test message', iteration=i, timestamp=time.time())
end_time = time.time()

duration = end_time - start_time
msgs_per_sec = 10000 / duration
print(f'‚úÖ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è 10000 –ª–æ–≥–æ–≤ –∑–∞ {duration:.2f}—Å ({msgs_per_sec:.0f} —Å–æ–æ–±—â–µ–Ω–∏–π/—Å–µ–∫)')
"

benchmark-sanitization: ## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ —Å–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏–∏
	@echo "$(GREEN)üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ —Å–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏–∏...$(RESET)"
	$(PYTHON) -c "
import time
from .sanitizers import DataSanitizer, sanitize_user_data

data = {
    'email': 'user@example.com',
    'phone': '+7 (900) 123-45-67',
    'password': 'secret123',
    'credit_card': '4532 1234 5678 9012'
}

sanitizer = DataSanitizer()

# –¢–µ—Å—Ç —Å–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏–∏ —Å–ª–æ–≤–∞—Ä–µ–π
start_time = time.time()
for i in range(1000):
    sanitized = sanitizer.sanitize_dict(data, {})
end_time = time.time()

duration = end_time - start_time
ops_per_sec = 1000 / duration
print(f'‚úÖ –°–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏—è 1000 —Å–ª–æ–≤–∞—Ä–µ–π –∑–∞ {duration:.2f}—Å ({ops_per_sec:.0f} –æ–ø–µ—Ä–∞—Ü–∏–π/—Å–µ–∫)')

# –¢–µ—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö
start_time = time.time()
for i in range(1000):
    sanitized = sanitize_user_data(data, 'salt')
end_time = time.time()

duration = end_time - start_time
ops_per_sec = 1000 / duration
print(f'‚úÖ –°–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö: {ops_per_sec:.0f} –æ–ø–µ—Ä–∞—Ü–∏–π/—Å–µ–∫')
"

docker-build: ## –°–æ–∑–¥–∞–Ω–∏–µ Docker –æ–±—Ä–∞–∑–∞
	@echo "$(GREEN)üê≥ –°–æ–∑–¥–∞–Ω–∏–µ Docker –æ–±—Ä–∞–∑–∞...$(RESET)"
	docker build -t logging-system-demo -f ../../Dockerfile . 2>/dev/null || echo "Dockerfile –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º"
	@echo "$(GREEN)‚úÖ Docker –æ–±—Ä–∞–∑ —Å–æ–∑–¥–∞–Ω$(RESET)"

deploy-check: ## –ü—Ä–æ–≤–µ—Ä–∫–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –∫ –¥–µ–ø–ª–æ—é
	@echo "$(GREEN)üöÄ –ü—Ä–æ–≤–µ—Ä–∫–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –∫ –¥–µ–ø–ª–æ—é...$(RESET)"
	@echo "1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
	@$(PYTHON) -c "import structlog; print('‚úÖ structlog')" 2>/dev/null || (echo "‚ùå structlog" && exit 1)
	@$(PYTHON) -c "import json; print('‚úÖ json')" 2>/dev/null || (echo "‚ùå json" && exit 1)
	@$(PYTHON) -c "import uuid; print('‚úÖ uuid')" 2>/dev/null || (echo "‚ùå uuid" && exit 1)
	@echo "2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –º–æ–¥—É–ª–µ–π..."
	@test -f __init__.py && echo "‚úÖ __init__.py" || (echo "‚ùå __init__.py" && exit 1)
	@test -f config.py && echo "‚úÖ config.py" || (echo "‚ùå config.py" && exit 1)
	@test -f formatter.py && echo "‚úÖ formatter.py" || (echo "‚ùå formatter.py" && exit 1)
	@test -f sanitizers.py && echo "‚úÖ sanitizers.py" || (echo "‚ùå sanitizers.py" && exit 1)
	@test -f middleware.py && echo "‚úÖ middleware.py" || (echo "‚ùå middleware.py" && exit 1)
	@test -f handlers.py && echo "‚úÖ handlers.py" || (echo "‚ùå handlers.py" && exit 1)
	@test -f tests.py && echo "‚úÖ tests.py" || (echo "‚ùå tests.py" && exit 1)
	@echo "3. –ó–∞–ø—É—Å–∫ –±—ã—Å—Ç—Ä—ã—Ö —Ç–µ—Å—Ç–æ–≤..."
	@$(PYTHON) -m pytest tests.py::TestLoggingConfig::test_default_config_values -v > /dev/null 2>&1 && echo "‚úÖ –¢–µ—Å—Ç—ã –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏" || echo "‚ùå –¢–µ—Å—Ç—ã –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏"
	@echo "4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏–º–µ—Ä–∞..."
	@test -f examples.py && echo "‚úÖ examples.py" || (echo "‚ùå examples.py" && exit 1)
	@echo "$(GREEN)‚úÖ –°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ –¥–µ–ø–ª–æ—é!$(RESET)"

# –¶–µ–ª–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
all: install-dev test format validate ## –ü–æ–ª–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞

info: ## –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–∏—Å—Ç–µ–º–µ
	@echo "$(BLUE)üìä –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–∏—Å—Ç–µ–º–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è:$(RESET)"
	@echo "–í–µ—Ä—Å–∏—è: 1.0.0"
	@echo "–ú–æ–¥—É–ª–∏: $(shell ls *.py | wc -l) —Ñ–∞–π–ª–æ–≤"
	@echo "–°—Ç—Ä–æ–∫–∏ –∫–æ–¥–∞: $(shell cat *.py | wc -l) —Å—Ç—Ä–æ–∫"
	@echo "–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏: $(shell wc -l < requirements.txt) –ø–∞–∫–µ—Ç–æ–≤"
	@echo "–ü–æ–∫—Ä—ã—Ç–∏–µ —Ç–µ—Å—Ç–∞–º–∏: $(shell grep -c 'def test' tests.py 2>/dev/null || echo '0') —Ç–µ—Å—Ç–æ–≤—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π"

# –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –¥–ª—è make –≤ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö —Ü–µ–ª—è—Ö
-.SILENT: help info clean
-.IGNORE: validate lint type-check