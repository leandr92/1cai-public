# Архитектура MCP-расширения для 1С

## Обзор архитектуры

MCP-сервер в 1С реализован как расширение с модульной архитектурой на основе контейнеров:

```
Python MCP Proxy ←→ HTTP-сервис mcp_APIBackend ←→ Обработки-контейнеры
```

**Ключевые принципы:**
- Универсальный HTTP-сервис (не требует изменений при добавлении инструментов)
- Обработки-контейнеры реализуют стандартный программный интерфейс 
- Автоматическое обнаружение контейнеров через подсистемы
- JSON-схемы параметров для типизации

## HTTP-сервис `mcp_APIBackend`

**Файл:** `HTTPServices/mcp_APIBackend/Ext/Module.bsl`

Реализует JSON-RPC API с двумя endpoints:
- `GET /mcp/health` - проверка состояния
- `POST /mcp/rpc` - универсальный JSON-RPC обработчик

**Поддерживаемые методы:**
- `tools/list`, `tools/call` - инструменты
- `resources/list`, `resources/read` - ресурсы  
- `prompts/list`, `prompts/get` - промпты

## Общие модули

### `mcp_Метаданные` - Схемы и таблицы

**Назначение:** Создание таблиц описаний и JSON-схем

**Ключевые функции:**
```bsl
// Создание таблиц
ТаблицаИнструментов() // Колонки: ИмяОбработкиКонтейнера, Имя, Описание, СхемаПараметров
ТаблицаРесурсов()     // Колонки: ИмяОбработкиКонтейнера, Адрес, Имя, Описание  
ТаблицаПромптов()     // Колонки: ИмяОбработкиКонтейнера, Имя, Описание, Параметры

// Добавление элементов в таблицы
ДобавитьИнструмент(Таблица, Имя, Описание, СхемаПараметров)
ДобавитьРесурс(Таблица, Адрес, Имя, Описание)
ДобавитьПромпт(Таблица, Имя, Описание, Параметры)

// Заполнение из контейнеров (через подсистемы)
ЗаполнитьТаблицуИнструментов(ТаблицаИнструментов)
ЗаполнитьТаблицуРесурсов(ТаблицаРесурсов)
ЗаполнитьТаблицуПромптов(ТаблицаПромптов)

// Создание JSON-схем параметров
ПараметрИнструмента(Имя, Тип, Описание, ЗначениеПоУмолчанию, Обязательный, СписокДопустимыхЗначений)
ПараметрИнструментаМассив(Имя, ТипЭлементаМассива, Описание, Обязательный, СписокДопустимыхЗначенийЭлемента)
СхемаПараметровИнструмента(МассивОписанийПараметров) // Возвращает JSON

// Для промптов
ПараметрПромпта(Имя, Описание, Обязательный)
ПараметрыПромпта(МассивОписанийПараметров)
```

### `mcp_Выполнение` - Выполнение операций

**Назначение:** Вызов методов контейнеров

**Ключевые функции:**
```bsl
ВыполнитьИнструмент(СтрокаТаблицыИнструментов, Параметры)
ПрочитатьРесурс(СтрокаТаблицыРесурсов, Адрес)  
ПолучитьПромпт(СтрокаТаблицыПромптов, Имя, Параметры)
```

### `mcp_КонтейнерыПовтИсп` - Кеширование

**Назначение:** Кешированное получение таблиц

**Ключевые функции:**
```bsl
Инструменты() // ТаблицаЗначений
Ресурсы()     // ТаблицаЗначений  
Промпты()     // ТаблицаЗначений
```

### `mcp_ОбщегоНазначения` - Утилиты

**Назначение:** JSON, HTTP утилиты

**Ключевые функции:**
```bsl
JSONВСтруктуру(СтрокаJSON)   // Парсинг JSON в структуру
СтруктураВJSON(Объект)       // Сериализация в JSON
РазобратьURL(URL)            // Парсинг URL
```

## Обработки-контейнеры

### Программный интерфейс для инструментов

**Обязательные методы менеджера обработки:**

```bsl
// Добавление описаний инструментов в таблицу
Процедура ДобавитьИнструменты(Инструменты) Экспорт
	// Создать параметры через mcp_Метаданные.ПараметрИнструмента()
	// Создать схему через mcp_Метаданные.СхемаПараметровИнструмента()
	// Добавить через mcp_Метаданные.ДобавитьИнструмент()
КонецПроцедуры

// Выполнение инструмента по имени
Функция ВыполнитьИнструмент(ИмяИнструмента, Аргументы) Экспорт
	// Проверить ИмяИнструмента и вызвать соответствующую функцию
	// Аргументы - Структура с параметрами
	// Возврат: строка, массив структур с type/text, или структура с type/text
КонецФункции
```

### Программный интерфейс для ресурсов

**Опциональные методы менеджера обработки:**

```bsl
// Добавление описаний ресурсов
Процедура ДобавитьРесурсы(Ресурсы) Экспорт
	// Добавить через mcp_Метаданные.ДобавитьРесурс(Ресурсы, Адрес, Имя, Описание)
КонецПроцедуры

// Чтение ресурса по адресу
Функция ПрочитатьРесурс(Адрес) Экспорт
	// Адрес - строка (URI)
	// Возврат: строка, массив структур с type/text/mimeType, или структура
КонецФункции
```

### Программный интерфейс для промптов

**Опциональные методы менеджера обработки:**

```bsl
// Добавление описаний промптов
Процедура ДобавитьПромпты(Промпты) Экспорт
	// Создать параметры через mcp_Метаданные.ПараметрПромпта()
	// Создать описание через mcp_Метаданные.ПараметрыПромпта()
	// Добавить через mcp_Метаданные.ДобавитьПромпт()
КонецПроцедуры

// Получение промпта
Функция ПолучитьПромпт(ИмяПромпта, Параметры) Экспорт
	// Параметры - Структура
	// Возврат: структура с полями description, messages или массив сообщений
КонецФункции
```

## Подсистемы

**Главная подсистема:** `mcp_MCPСервер`

**Подсистемы для группировки контейнеров:**
- `mcp_КонтейнерыИнструментов` - обработки с инструментами
- `mcp_КонтейнерыРесурсов` - обработки с ресурсами  
- `mcp_КонтейнерыПромптов` - обработки с промптами

**Принцип работы:** модуль `mcp_Метаданные` автоматически обходит состав подсистем и вызывает методы всех включенных обработок.

## Создание нового инструмента

1. **Создать обработку** с префиксом `mcp_ИнструментИмя`
2. **Включить в подсистему** `mcp_КонтейнерыИнструментов`
3. **Реализовать методы:**
   ```bsl
   Процедура ДобавитьИнструменты(Инструменты) Экспорт
   Функция ВыполнитьИнструмент(ИмяИнструмента, Аргументы) Экспорт
   ```
4. **Никаких изменений** в HTTP-сервисе или других модулях не требуется

## Пример реализации инструмента

```bsl
Процедура ДобавитьИнструменты(Инструменты) Экспорт
	МассивПараметров = Новый Массив;
	
	// Добавляем параметры
	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"text", "string", "Текст для обработки", , Истина));
	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"maxLength", "number", "Максимальная длина", 100));
	
	// Создаем схему
	СхемаПараметров = mcp_Метаданные.СхемаПараметровИнструмента(МассивПараметров);
	
	// Добавляем инструмент
	mcp_Метаданные.ДобавитьИнструмент(
		Инструменты, "process_text", "Обработка текста", СхемаПараметров);
КонецПроцедуры

Функция ВыполнитьИнструмент(ИмяИнструмента, Аргументы) Экспорт
	Если ИмяИнструмента = "process_text" Тогда
		Текст = Аргументы.text;
		МаксДлина = ?(Аргументы.Свойство("maxLength"), Аргументы.maxLength, 100);
		
		// Логика обработки
		Результат = Лев(Текст, МаксДлина);
		Возврат Результат;
	КонецЕсли;
	
	ВызватьИсключение "Неизвестный инструмент: " + ИмяИнструмента;
КонецФункции
```

## Отступы и стиль кода

- **Стандартный отступ:** одна табуляция
- **Именование:** префикс `mcp_` для всех объектов расширения
- **Экспортные методы:** обязательно с `Экспорт`
- **Обработка ошибок:** через `ВызватьИсключение` 