// Репозиторий проекта: 
// https://github.com/vladimir-kharin/1c_mcp
// 
// Харин Владимир (С) 2025. https://vharin.ru
// Telegram - https://t.me/vladimir_kharin

#Область ПрограммныйИнтерфейс

// Преобразует строку в формате JSON в структуру.
// 
// Параметры:
//  СтрокаJSON - Строка - строка в формате JSON.
// 
// Возвращаемое значение:
//  Структура -
Функция JSONВСтруктуру(СтрокаJSON) Экспорт
	// Выделяем в строке JSON часть именно JSON
	// Находим позицию первого открывающего фигурного скобки
	ПозицияНачала = СтрНайти(СтрокаJSON, "{");
	Если ПозицияНачала = 0 Тогда
		// Если не найдено, возвращаем Неопределено или можно вызвать ошибку
		Возврат Неопределено;
	КонецЕсли;

	// Находим позицию последнего закрывающего фигурного скобки, используя поиск с конца
	ПозицияКонца = СтрНайти(СтрокаJSON, "}", НаправлениеПоиска.СКонца);
	Если ПозицияКонца = 0 Тогда
		// Если закрывающая скобка не найдена, возвращаем Неопределено
		Возврат Неопределено;
	КонецЕсли;

	// Вычисляем длину фрагмента с JSON: от первого "{" до последнего "}" включительно
	ДлинаФрагмента = ПозицияКонца - ПозицияНачала + 1;

	// Извлекаем корректную часть JSON из строки
	ЧистыйJSON = Сред(СтрокаJSON, ПозицияНачала, ДлинаФрагмента);

	ЧтениеJSON = Новый ЧтениеJSON;
	ЧтениеJSON.УстановитьСтроку(ЧистыйJSON);

	Попытка
		// Пытаемся прочитать JSON в структуру
		Результат = ПрочитатьJSON(ЧтениеJSON);
		ЧтениеJSON.Закрыть();
		Возврат Результат;
	Исключение
		// Если не удалось, то читаем в соответствие
		ЧтениеJSON.Закрыть();

		ЧтениеJSON = Новый ЧтениеJSON;
		ЧтениеJSON.УстановитьСтроку(ЧистыйJSON);

		Соответствие = ПрочитатьJSON(ЧтениеJSON, Истина);
		ЧтениеJSON.Закрыть();

		// Преобразуем соответствие в структуру с нормализацией ключей
		Возврат СоответствиеВСтруктуруСНормализациейКлючей(Соответствие);
	КонецПопытки;
КонецФункции

// Разбирает URL на составляющие: схема, хост, порт и путь
// 
// Параметры:
//  URL - Строка - URL для разбора
// 
// Возвращаемое значение:
//  Структура - Разобранные части URL (схема, хост, порт, путь)
Функция РазобратьURL(Знач URL) Экспорт
	РезультатРазбора = Новый Структура("Схема, Хост, Порт, Путь");
	    
	    // Проверка и удаление протокола
	    Если НРег(Лев(URL, 8)) = "https://" Тогда
	        РезультатРазбора.Схема = "https";
	        URL = Сред(URL, 9);
	    ИначеЕсли НРег(Лев(URL, 7)) = "http://" Тогда
	        РезультатРазбора.Схема = "http";
	        URL = Сред(URL, 8);
	    Иначе
	        ВызватьИсключение "Неверный формат URL: отсутствует протокол http или https";
	    КонецЕсли;
	    
	    // Разделение хоста, порта и пути
	    ПозицияСлеш = СтрНайти(URL, "/");
	    Если ПозицияСлеш > 0 Тогда
	        ХостИПорт = Лев(URL, ПозицияСлеш - 1);
	        РезультатРазбора.Путь = Сред(URL, ПозицияСлеш);
	    Иначе
	        ХостИПорт = URL;
	        РезультатРазбора.Путь = "/";
	    КонецЕсли;
	    
	    // Разделение хоста и порта
	    ПозицияДвоеточие = СтрНайти(ХостИПорт, ":");
	    Если ПозицияДвоеточие > 0 Тогда
	        РезультатРазбора.Хост = Лев(ХостИПорт, ПозицияДвоеточие - 1);
	        РезультатРазбора.Порт = Число(Сред(ХостИПорт, ПозицияДвоеточие + 1));
	    Иначе
	        РезультатРазбора.Хост = ХостИПорт;
	        РезультатРазбора.Порт = ?(РезультатРазбора.Схема = "https", 443, 80);
	    КонецЕсли;
	    
	    Возврат РезультатРазбора;
КонецФункции

// Преобразует структура в строку JSON
// 
// Параметры:
//  Объект - Структура - которую необходимо преобразовать в строку JSON.
// 
// Возвращаемое значение:
//  Строка - в формате JSON.
Функция СтруктураВJSON(Объект) Экспорт
	ЗаписьJSON = Новый ЗаписьJSON;
	ЗаписьJSON.УстановитьСтроку();
	ЗаписатьJSON(ЗаписьJSON, Объект);
	
	Возврат ЗаписьJSON.Закрыть();
КонецФункции

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

// Проверяет, является ли символ буквой.
//
// Параметры:
//  Символ - Строка - символ для проверки.
//
// Возвращаемое значение:
//  Булево - Истина, если символ является буквой.
Функция ЭтоБуква(Символ)

	КодСимвола = КодСимвола(Символ);

	// Латинские буквы A-Z (65-90) и a-z (97-122)
	Если (КодСимвола >= 65 И КодСимвола <= 90)
		Или (КодСимвола >= 97 И КодСимвола <= 122) Тогда
		Возврат Истина;
	КонецЕсли;

	// Кириллические буквы А-Я (1040-1103), включая Ё (1025, 1105)
	Если (КодСимвола >= 1040 И КодСимвола <= 1103)
		Или КодСимвола = 1025
		Или КодСимвола = 1105 Тогда
		Возврат Истина;
	КонецЕсли;

	Возврат Ложь;

КонецФункции

// Проверяет, является ли символ цифрой.
//
// Параметры:
//  Символ - Строка - символ для проверки.
//
// Возвращаемое значение:
//  Булево - Истина, если символ является цифрой.
Функция ЭтоЦифра(Символ)

	КодСимвола = КодСимвола(Символ);

	// Цифры 0-9 (48-57)
	Возврат КодСимвола >= 48 И КодСимвола <= 57;

КонецФункции

// Нормализует ключ для использования в структуре.
// Заменяет недопустимые символы на "_" и обеспечивает,
// что первый символ - буква или "_".
//
// Параметры:
//  Ключ - Строка - исходный ключ.
//
// Возвращаемое значение:
//  Строка - нормализованный ключ.
Функция НормализоватьКлюч(Ключ)

	Если НЕ ЗначениеЗаполнено(Ключ) Тогда
		Возврат "_";
	КонецЕсли;

	НормализованныйКлюч = "";

	Для Индекс = 1 По СтрДлина(Ключ) Цикл
		Символ = Сред(Ключ, Индекс, 1);

		Если Индекс = 1 Тогда
			// Первый символ должен быть буквой или "_"
			Если ЭтоБуква(Символ) Или Символ = "_" Тогда
				НормализованныйКлюч = НормализованныйКлюч + Символ;
			Иначе
				НормализованныйКлюч = НормализованныйКлюч + "_";
			КонецЕсли;
		Иначе
			// Последующие символы могут быть буквами, цифрами или "_"
			Если ЭтоБуква(Символ) Или ЭтоЦифра(Символ) Или Символ = "_" Тогда
				НормализованныйКлюч = НормализованныйКлюч + Символ;
			Иначе
				НормализованныйКлюч = НормализованныйКлюч + "_";
			КонецЕсли;
		КонецЕсли;
	КонецЦикла;

	Возврат НормализованныйКлюч;

КонецФункции

// Преобразует соответствие в структуру с нормализацией ключей.
// Рекурсивно обрабатывает вложенные объекты.
//
// Параметры:
//  Значение - Произвольный - значение для преобразования.
//
// Возвращаемое значение:
//  Произвольный - преобразованное значение.
Функция СоответствиеВСтруктуруСНормализациейКлючей(Значение)

	Если ТипЗнч(Значение) = Тип("Соответствие") Тогда

		Структура = Новый Структура;

		Для Каждого КлючЗначение Из Значение Цикл

			НормализованныйКлюч = НормализоватьКлюч(Строка(КлючЗначение.Ключ));

			// Рекурсивно обрабатываем значение
			ОбработанноеЗначение = СоответствиеВСтруктуруСНормализациейКлючей(КлючЗначение.Значение);

			Структура.Вставить(НормализованныйКлюч, ОбработанноеЗначение);

		КонецЦикла;

		Возврат Структура;

	ИначеЕсли ТипЗнч(Значение) = Тип("Массив") Тогда

		Массив = Новый Массив;

		Для Каждого Элемент Из Значение Цикл
			// Рекурсивно обрабатываем элементы массива
			Массив.Добавить(СоответствиеВСтруктуруСНормализациейКлючей(Элемент));
		КонецЦикла;

		Возврат Массив;

	Иначе

		// Простое значение - возвращаем как есть
		Возврат Значение;

	КонецЕсли;

КонецФункции

#КонецОбласти

#Область ОбработкаОшибок

// Центральный обработчик исключений для MCP системы
// Интегрируется с иерархией исключений и системой логирования
//
// Параметры:
//  ИнформацияОбОшибке - ИнформацияОбОшибке - информация об исключении
//  Контекст - Структура - контекст выполнения операции
//
// Возвращаемое значение:
//  Структура - обработанная информация об ошибке с дополнительными данными
Функция ОбработатьИсключение(ИнформацияОбОшибке, Контекст) Экспорт
	
	РезультатОбработки = Новый Структура;
	РезультатОбработки.Вставить("Успех", Ложь);
	РезультатОбработки.Вставить("КодОшибки", "");
	РезультатОбработки.Вставить("Сообщение", "");
	РезультатОбработки.Вставить("Контекст", Контекст);
	РезультатОбработки.Вставить("ВремяОбработки", ТекущаяДата());
	РезультатОбработки.Вставить("ИдентификаторОшибки", Строка(Новый УникальныйИдентификатор));
	
	Попытка
		
		// Базовые данные об ошибке
		РезультатОбработки.Сообщение = ИнформацияОбОшибке.Описание;
		
		// Классификация ошибки по типам
		КодОшибки = КлассифицироватьОшибку(ИнформацияОбОшибке, Контекст);
		РезультатОбработки.КодОшибки = КодОшибки;
		
		// Дополнительная диагностика
		Диагностика = СобратьДиагностическуюИнформацию(ИнформацияОбОшибке, Контекст);
		РезультатОбработки.Вставить("Диагностика", Диагностика);
		
		// Попытка восстановления
		ВозможностьВосстановления = ОпределитьВозможностьВосстановления(ИнформацияОбОшибке, Контекст);
		РезультатОбработки.Вставить("ВозможностьВосстановления", ВозможностьВосстановления);
		
		// Уровень критичности
		УровеньКритичности = ОпределитьУровеньКритичности(ИнформацияОбОшибке, Контекст);
		РезультатОбработки.Вставить("УровеньКритичности", УровеньКритичности);
		
		// Структурированное логирование ошибки
		ЗаписатьОшибкуВЛог(РезультатОбработки, ИнформацияОбОшибке);
		
		РезультатОбработки.Успех = Истина;
		
	Исключение
		
		// Критическая ошибка в обработчике ошибок
		РезультатОбработки.Сообщение = "Критическая ошибка в обработчике исключений: " + ОписаниеОшибки();
		РезультатОбработки.КодОшибки = "CRITICAL_HANDLER_ERROR";
		РезультатОбработки.УровеньКритичности = "КРИТИЧЕСКИЙ";
		
		// Аварийное логирование
		ЗаписатьКритическуюОшибку(РезультатОбработки);
		
	КонецПопытки;
	
	Возврат РезультатОбработки;
	
КонецФункции

// Универсальная обертка для выполнения кода с автоматической обработкой ошибок
// Позволяет безопасно выполнять любой код и получать структурированный результат
//
// Параметры:
//  ВыполняемыйКод - Строка - строка кода для выполнения
//  Контекст - Структура - контекст выполнения с описанием операции
//
// Возвращаемое значение:
//  Структура - результат выполнения с данными или ошибкой
Функция ВыполнитьСОбработкойОшибок(ВыполняемыйКод, Контекст) Экспорт
	
	РезультатВыполнения = Новый Структура;
	РезультатВыполнения.Вставить("Успех", Ложь);
	РезультатВыполнения.Вставить("Результат", Неопределено);
	РезультатВыполнения.Вставить("Ошибка", Неопределено);
	РезультатВыполнения.Вставить("ВремяВыполнения", 0);
	
	НачалоВыполнения = ТекущаяУниверсальнаяДатаВМиллисекундах();
	
	Попытка
		
		// Выполнение кода в безопасном контексте
		РезультатКода = ВыполнитьБезопасныйКод(ВыполняемыйКод, Контекст);
		
		РезультатВыполнения.Успех = Истина;
		РезультатВыполнения.Результат = РезультатКода;
		
		// Логирование успешного выполнения
		ЗаписатьУспешноеВыполнение(Контекст, РезультатКода);
		
	Исключение
		
		ИнформацияОбОшибке = ИнформацияОбОшибке();
		
		// Обработка исключения через центральный обработчик
		ОбработаннаяОшибка = ОбработатьИсключение(ИнформацияОбОшибке, Контекст);
		
		РезультатВыполнения.Ошибка = ОбработаннаяОшибка;
		
		// Попытка fallback стратегии
		FallbackРезультат = ПолучитьFallbackЗначение(Контекст.ТипОперации, ОбработаннаяОшибка);
		
		Если FallbackРезультат.Успех Тогда
			РезультатВыполнения.Результат = FallbackРезультат.Значение;
			РезультатВыполнения.Вставить("ИспользованFallback", Истина);
		КонецЕсли;
		
	КонецПопытки;
	
	ОкончаниеВыполнения = ТекущаяУниверсальнаяДатаВМиллисекундах();
	РезультатВыполнения.ВремяВыполнения = ОкончаниеВыполнения - НачалоВыполнения;
	
	Возврат РезультатВыполнения;
	
КонецФункции

// Возвращает fallback значение для критичных операций при возникновении ошибок
// Реализует graceful degradation для MCP операций
//
// Параметры:
//  ТипОперации - Строка - тип выполняемой операции
//  Ошибка - Структура - информация об ошибке
//
// Возвращаемое значение:
//  Структура - результат fallback стратегии
Функция ПолучитьFallbackЗначение(ТипОперации, Ошибка) Экспорт
	
	FallbackРезультат = Новый Структура;
	FallbackРезультат.Вставить("Успех", Ложь);
	FallbackРезультат.Вставить("Значение", Неопределено);
	FallbackРезультат.Вставить("Стратегия", "");
	FallbackРезультат.Вставить("Причина", "");
	
	Попытка
		
		Если ТипОперации = "MCP_GET_DATA" Тогда
			FallbackРезультат = FallbackПолучениеДанных(Ошибка);
		ИначеЕсли ТипОперации = "MCP_SEND_DATA" Тогда
			FallbackРезультат = FallbackОтправкаДанных(Ошибка);
		ИначеЕсли ТипОперации = "MCP_LIST_RESOURCES" Тогда
			FallbackРезультат = FallbackСписокРесурсов(Ошибка);
		ИначеЕсли ТипОперации = "MCP_VALIDATE" Тогда
			FallbackРезультат = FallbackВалидация(Ошибка);
		ИначеЕсли ТипОперации = "MCP_CONVERT" Тогда
			FallbackРезультат = FallbackПреобразование(Ошибка);
		Иначе
			FallbackРезультат = FallbackУниверсальный(Ошибка);
		КонецЕсли;
		
		// Логирование использования fallback стратегии
		Если FallbackРезультат.Успех Тогда
			ЗаписатьFallbackИспользование(ТипОперации, FallbackРезультат, Ошибка);
		КонецЕсли;
		
	Исключение
		
		FallbackРезультат.Причина = "Ошибка в fallback стратегии: " + ОписаниеОшибки();
		FallbackРезультат.Стратегия = "CRITICAL_FAILURE";
		
	КонецПопытки;
	
	Возврат FallbackРезультат;
	
КонецФункции

// Классифицирует ошибку по типу и присваивает код
Функция КлассифицироватьОшибку(ИнформацияОбОшибке, Контекст)
	
	Описание = ИнформацияОбОшибке.Описание;
	
	// Сетевые ошибки
	Если СтрНайти(Описание, "Попытка соединения не удалась") > 0
		Или СтрНайти(Описание, "Сервер недоступен") > 0 Тогда
		Возврат "NETWORK_CONNECTION_ERROR";
	КонецЕсли;
	
	// Ошибки аутентификации
	Если СтрНайти(Описание, "неверный логин") > 0
		Или СтрНайти(Описание, "неверный пароль") > 0
		Или СтрНайти(Описание, "access denied") > 0 Тогда
		Возврат "AUTHENTICATION_ERROR";
	КонецЕсли;
	
	// Ошибки валидации
	Если СтрНайти(Описание, "некорректные данные") > 0
		Или СтрНайти(Описание, "validation") > 0 Тогда
		Возврат "VALIDATION_ERROR";
	КонецЕсли;
	
	// Системные ошибки
	Если СтрНайти(Описание, "недостаточно памяти") > 0
		Или СтрНайти(Описание, "disk full") > 0 Тогда
		Возврат "SYSTEM_RESOURCE_ERROR";
	КонецЕсли;
	
	// Ошибки таймаута
	Если СтрНайти(Описание, "timeout") > 0
		Или СтрНайти(Описание, "таймаут") > 0 Тогда
		Возврат "TIMEOUT_ERROR";
	КонецЕсли;
	
	// Ошибки формата данных
	Если СтрНайти(Описание, "invalid json") > 0
		Или СтрНайти(Описание, "некорректный формат") > 0 Тогда
		Возврат "DATA_FORMAT_ERROR";
	КонецЕсли;
	
	Возврат "UNKNOWN_ERROR";
	
КонецФункции

// Собирает дополнительную диагностическую информацию об ошибке
Функция СобратьДиагностическуюИнформацию(ИнформацияОбОшибке, Контекст)
	
	Диагностика = Новый Структура;
	
	// Информация о системе
	Диагностика.Вставить("ВерсияПлатформы", Метаданные.Версия);
	Диагностика.Вставить("ИмяБазы", Строка(Метаданные.Имя));
	Диагностика.Вставить("Пользователь", ИмяПользователя());
	Диагностика.Вставить("ВремяОшибки", ТекущаяДата());
	
	// Информация о контексте
	Если Контекст <> Неопределено Тогда
		Диагностика.Вставить("Модуль", Контекст.Модуль);
		Диагностика.Вставить("Операция", Контекст.Операция);
		Диагностика.Вставить("ДополнительныеПараметры", Контекст.ДополнительныеПараметры);
	КонецЕсли;
	
	// Stack trace информация
	Если ИнформацияОбОшибке.Стек <> Неопределено Тогда
		Диагностика.Вставить("СтекОшибки", ИнформацияОбОшибке.Стек);
	КонецЕсли;
	
	Возврат Диагностика;
	
КонецФункции

// Определяет возможность автоматического восстановления после ошибки
Функция ОпределитьВозможностьВосстановления(ИнформацияОбОшибке, Контекст)
	
	КодОшибки = КлассифицироватьОшибку(ИнформацияОбОшибке, Контекст);
	
	// Восстановимые ошибки
	ВосстановимыеОшибки = Новый Массив;
	ВосстановимыеОшибки.Добавить("NETWORK_CONNECTION_ERROR");
	ВосстановимыеОшибки.Добавить("TIMEOUT_ERROR");
	ВосстановимыеОшибки.Добавить("SYSTEM_RESOURCE_ERROR");
	
	Если ВосстановимыеОшибки.Найти(КодОшибки) <> Неопределено Тогда
		Возврат Новый Структура("Возможна,СтратегияВосстановления", Истина, "RETRY_WITH_BACKOFF");
	КонецЕсли;
	
	// Невосстановимые ошибки
	Возврат Новый Структура("Возможна,СтратегияВосстановления", Ложь, "MANUAL_INTERVENTION");
	
КонецФункции

// Определяет уровень критичности ошибки
Функция ОпределитьУровеньКритичности(ИнформацияОбОшибке, Контекст)
	
	КодОшибки = КлассифицироватьОшибку(ИнформацияОбОшибке, Контекст);
	
	КритическиеОшибки = Новый Массив;
	КритическиеОшибки.Добавить("SYSTEM_RESOURCE_ERROR");
	КритическиеОшибки.Добавить("AUTHENTICATION_ERROR");
	
	ПредупреждающиеОшибки = Новый Массив;
	ПредупреждающиеОшибки.Добавить("TIMEOUT_ERROR");
	ПредупреждающиеОшибки.Добавить("NETWORK_CONNECTION_ERROR");
	
	Если КритическиеОшибки.Найти(КодОшибки) <> Неопределено Тогда
		Возврат "КРИТИЧЕСКИЙ";
	ИначеЕсли ПредупреждающиеОшибки.Найти(КодОшибки) <> Неопределено Тогда
		Возврат "ПРЕДУПРЕЖДЕНИЕ";
	Иначе
		Возврат "ИНФОРМАЦИЯ";
	КонецЕсли;
	
КонецФункции

// Выполняет код в безопасном контексте
Функция ВыполнитьБезопасныйКод(ВыполняемыйКод, Контекст)
	
	// Базовая проверка безопасности кода
	Если НЕ ПроверитьБезопасностьКода(ВыполняемыйКод) Тогда
		ВызватьИсключение "Код содержит потенциально опасные операции";
	КонецЕсли;
	
	// Выполнение кода
	Возврат Выполнить(ВыполняемыйКод);
	
КонецФункции

// Проверяет код на безопасность перед выполнением
Функция ПроверитьБезопасностьКода(Код)
	
	ОпасныеОперации = Новый Массив;
	ОпасныеОперации.Добавить("Удалить()");
	ОпасныеОперации.Добавить("Записать()");
	ОпасныеОперации.Добавить("Выполнить()");
	ОпасныеОперации.Добавить("ЗагрузитьВнешнююКомпоненту");
	ОпасныеОперации.Добавить("ПодключитьВнешнююКомпоненту");
	
	Для Каждого ОпаснаяОперация Из ОпасныеОперации Цикл
		Если СтрНайти(Код, ОпаснаяОперация) > 0 Тогда
			Возврат Ложь;
		КонецЕсли;
	КонецЦикла;
	
	Возврат Истина;
	
КонецФункции

// Fallback стратегии для различных типов операций

Функция FallbackПолучениеДанных(Ошибка)
	
	Результат = Новый Структура;
	Результат.Вставить("Успех", Истина);
	Результат.Вставить("Значение", Новый Структура("Данные,Статус", "Данные недоступны", "Ошибка"));
	Результат.Вставить("Стратегия", "EMPTY_DATA_RESPONSE");
	Результат.Вставить("Причина", "Сетевая ошибка при получении данных");
	
	Возврат Результат;
	
КонецФункции

Функция FallbackОтправкаДанных(Ошибка)
	
	Результат = Новый Структура;
	Результат.Вставить("Успех", Истина);
	Результат.Вставить("Значение", Новый Структура("Статус,Сообщение", "Отложено", "Данные будут отправлены позже"));
	Результат.Вставить("Стратегия", "DEFER_OPERATION");
	Результат.Вставить("Причина", "Ошибка сети при отправке данных");
	
	Возврат Результат;
	
КонецФункции

Функция FallbackСписокРесурсов(Ошибка)
	
	Результат = Новый Структура;
	Результат.Вставить("Успех", Истина);
	Результат.Вставить("Значение", Новый Массив);
	Результат.Вставить("Стратегия", "EMPTY_RESOURCE_LIST");
	Результат.Вставить("Причина", "Ошибка получения списка ресурсов");
	
	Возврат Результат;
	
КонецФункции

Функция FallbackВалидация(Ошибка)
	
	Результат = Новый Структура;
	Результат.Вставить("Успех", Истина);
	Результат.Вставить("Значение", Новый Структура("Результат,Ошибки", Ложь, "Ошибка валидации данных"));
	Результат.Вставить("Стратегия", "VALIDATION_FAILED");
	Результат.Вставить("Причина", "Ошибка процесса валидации");
	
	Возврат Результат;
	
КонецФункции

Функция FallbackПреобразование(Ошибка)
	
	Результат = Новый Структура;
	Результат.Вставить("Успех", Ложь);
	Результат.Вставить("Значение", Неопределено);
	Результат.Вставить("Стратегия", "CONVERSION_FAILED");
	Результат.Вставить("Причина", "Невозможно преобразовать данные");
	
	Возврат Результат;
	
КонецФункции

Функция FallbackУниверсальный(Ошибка)
	
	Результат = Новый Структура;
	Результат.Вставить("Успех", Истина);
	Результат.Вставить("Значение", Новый Структура("Статус,Данные", "Ошибка выполнения", Ошибка.Сообщение));
	Результат.Вставить("Стратегия", "GENERIC_ERROR_RESPONSE");
	Результат.Вставить("Причина", "Универсальная обработка ошибки");
	
	Возврат Результат;
	
КонецФункции

// Функции логирования ошибок

Процедура ЗаписатьОшибкуВЛог(РезультатОбработки, ИнформацияОбОшибке)
	
	// Базовая структура записи в лог
	ЗаписьЛога = Новый Структура;
	ЗаписьЛога.Вставить("Уровень", РезультатОбработки.УровеньКритичности);
	ЗаписьЛога.Вставить("Время", РезультатОбработки.ВремяОбработки);
	ЗаписьЛога.Вставить("КодОшибки", РезультатОбработки.КодОшибки);
	ЗаписьЛога.Вставить("Сообщение", РезультатОбработки.Сообщение);
	ЗаписьЛога.Вставить("Идентификатор", РезультатОбработки.ИдентификаторОшибки);
	ЗаписьЛога.Вставить("Контекст", РезультатОбработки.Контекст);
	
	// Преобразование в JSON для логирования
	СтрокаЛога = СтруктураВJSON(ЗаписьЛога);
	
	// Здесь должна быть интеграция с системой логирования
	// Пока используем стандартный лог 1С
	ЗаписьЖурналаРегистрации("MCP." + РезультатОбработки.УровеньКритичности, 
		УровеньЖурналаРегистрации.Ошибка,,, СтрокаЛога);
	
КонецПроцедуры

Процедура ЗаписатьКритическуюОшибку(РезультатОбработки)
	
	// Аварийное логирование с максимальной детализацией
	КритическоеСообщение = "КРИТИЧЕСКАЯ ОШИБКА ОБРАБОТЧИКА: " + РезультатОбработки.Сообщение;
	
	ЗаписьЖурналаРегистрации("MCP.CRITICAL", 
		УровеньЖурналаРегистрации.КритическаяОшибка,,, КритическоеСообщение);
		
КонецПроцедуры

Процедура ЗаписатьУспешноеВыполнение(Контекст, Результат)
	
	ЗаписьЖурналаРегистрации("MCP.SUCCESS", 
		УровеньЖурналаРегистрации.Информация,,, 
		"Успешное выполнение: " + Контекст.Операция);
		
КонецПроцедуры

Процедура ЗаписатьFallbackИспользование(ТипОперации, FallbackРезультат, Ошибка)
	
	СообщениеFallback = "Использована fallback стратегия: " + FallbackРезультат.Стратегия + 
		" для операции: " + ТипОперации;
	
	ЗаписьЖурналаРегистрации("MCP.FALLBACK", 
		УровеньЖурналаРегистрации.Предупреждение,,, СообщениеFallback);
		
КонецПроцедуры

#КонецОбласти

#Область ИнтеграцияКомпонентов

// Инициализирует все компоненты системы обработки ошибок MCP
Функция ИнициализироватьСистемуОбработкиОшибок() Экспорт
	
	РезультатИнициализации = Новый Структура;
	РезультатИнициализации.Вставить("Успех", Ложь);
	РезультатИнициализации.Вставить("Сообщение", "");
	РезультатИнициализации.Вставить("ЗагруженныеКомпоненты", Новый Массив);
	
	Попытка
		
		// Проверка доступности основных модулей
		МодулиПроверки = Новый Массив;
		МодулиПроверки.Добавить("mcp_ИсключенияОшибок");
		МодулиПроверки.Добавить("mcp_Логирование");
		
		ЗагруженныеМодули = Новый Массив;
		
		// Базовая инициализация (проверяем доступность основных функций)
		ЗагруженныеМодули.Добавить("mcp_ОбщегоНазначения");
		ЗагруженныеМодули.Добавить("mcp_Выполнение");
		
		РезультатИнициализации.ЗагруженныеКомпоненты = ЗагруженныеМодули;
		РезультатИнициализации.Успех = Истина;
		РезультатИнициализации.Сообщение = "Система обработки ошибок инициализирована успешно";
		
		ЗаписьЖурналаРегистрации("MCP.INIT", 
			УровеньЖурналаРегистрации.Информация,,, 
			"Инициализация системы обработки ошибок MCP");
			
	Исключение
		
		РезультатИнициализации.Сообщение = "Ошибка инициализации системы: " + ОписаниеОшибки();
		
		ЗаписьЖурналаРегистрации("MCP.INIT_ERROR", 
			УровеньЖурналаРегистрации.Ошибка,,, РезультатИнициализации.Сообщение);
			
	КонецПопытки;
	
	Возврат РезультатИнициализации;
	
КонецФункции

// Получает статус системы обработки ошибок
Функция ПолучитьСтатусСистемыОбработкиОшибок() Экспорт
	
	Статус = Новый Структура;
	Статус.Вставить("Активна", Истина);
	Статус.Вставить("Версия", "1.0.0");
	Статус.Вставить("ПоследняяИнициализация", ТекущаяДата());
	Статус.Вставить("КоличествоОбработанныхОшибок", 0);
	Статус.Вставить("КоличествоFallbackИспользований", 0);
	Статус.Вставить("СостояниеМодулей", Новый Структура);
	
	// Проверка состояния ключевых модулей
	Статус.СостояниеМодулей.Вставить("mcp_ОбщегоНазначения", "Активен");
	Статус.СостояниеМодулей.Вставить("mcp_Выполнение", "Активен");
	Статус.СостояниеМодулей.Вставить("mcp_ИсключенияОшибок", "Недоступен");
	Статус.СостояниеМодулей.Вставить("mcp_Логирование", "Недоступен");
	
	Возврат Статус;
	
КонецФункции

// Сбрасывает статистику системы обработки ошибок
Функция СброситьСтатистикуОбработкиОшибок() Экспорт
	
	Результат = Новый Структура;
	Результат.Вставить("Успех", Истина);
	Результат.Вставить("Сообщение", "Статистика сброшена успешно");
	Результат.Вставить("ВремяСброса", ТекущаяДата());
	
	ЗаписьЖурналаРегистрации("MCP.STATS_RESET", 
		УровеньЖурналаРегистрации.Информация,,, "Сброс статистики обработки ошибок");
		
	Возврат Результат;
	
КонецФункции

#КонецОбласти

