Deno.serve(async (req) => {
    const corsHeaders = {
        'Access-Control-Allow-Origin': '*',
        'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
        'Access-Control-Allow-Methods': 'POST, GET, OPTIONS',
        'Access-Control-Max-Age': '86400',
        'Access-Control-Allow-Credentials': 'false'
    };

    if (req.method === 'OPTIONS') {
        return new Response(null, { status: 200, headers: corsHeaders });
    }

    try {
        const { demoType, userQuery } = await req.json();

        const steps = [];
        let finalResult = {};

        if (demoType === 'custom') {
            // Пользовательский запрос
            steps.push({ progress: 10, message: 'Анализ вашего запроса...' });
            await new Promise(r => setTimeout(r, 500));
            
            steps.push({ progress: 30, message: 'Подготовка кода...' });
            await new Promise(r => setTimeout(r, 800));
            
            steps.push({ progress: 60, message: 'Генерация решения...' });
            await new Promise(r => setTimeout(r, 1000));
            
            steps.push({ progress: 90, message: 'Оптимизация и форматирование...' });
            await new Promise(r => setTimeout(r, 700));
            
            const queryLower = (userQuery || '').toLowerCase();
            let customCode = '';
            let customMessage = '';
            
            // Расширенный анализ запроса с множественными паттернами 1С разработки
            if (queryLower.includes('справочник') || queryLower.includes('catalog')) {
                customCode = `// Модуль справочника товаров
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
    // Инициализация справочника
    УстановитьПривилегированныйРежим(Истина);
    
    // Заполнение реквизитов по умолчанию
    Если Объект.Ссылка.Пустая() Тогда
        Объект.Артикул = ПолучитьНовыйАртикул();
        Объект.ДатаСоздания = ТекущаяДата();
        Объект.Ответственный = ПараметрыСеанса.ТекущийПользователь;
    КонецЕсли;
    
    // Настройка видимости и доступности элементов
    УстановитьВидимость();
    УстановитьДоступность();
    
    УстановитьПривилегированныйРежим(Ложь);
КонецПроцедуры

Процедура ПередЗаписьюНаСервере(Отказ, ТекущийОбъект, ПараметрыЗаписи)
    // Валидация данных
    Если Не ЗначениеЗаполнено(ТекущийОбъект.Наименование) Тогда
        Сообщить("Необходимо заполнить наименование товара");
        Отказ = Истина;
        Возврат;
    КонецЕсли;
    
    // Проверка уникальности артикула
    Если ЗначениеЗаполнено(ТекущийОбъект.Артикул) Тогда
        Запрос = Новый Запрос;
        Запрос.Текст = 
        "ВЫБРАТЬ
        |    Ссылка
        |ИЗ
        |    Справочник.Товары
        |ГДЕ
        |    Артикул = &Артикул
        |    И Ссылка <> &ТекущаяСсылка";
        
        Запрос.УстановитьПараметр("Артикул", ТекущийОбъект.Артикул);
        Запрос.УстановитьПараметр("ТекущаяСсылка", Объект.Ссылка);
        
        Если Не Запрос.Выполнить().Пустой() Тогда
            Сообщить("Товар с таким артикулом уже существует");
            Отказ = Истина;
            Возврат;
        КонецЕсли;
    КонецЕсли;
    
    // Автогенерация артикула
    Если Не ЗначениеЗаполнено(ТекущийОбъект.Артикул) Тогда
        ТекущийОбъект.Артикул = ПолучитьНовыйАртикул();
    КонецЕсли;
КонецПроцедуры

Функция ПолучитьНовыйАртикул()
    Запрос = Новый Запрос;
    Запрос.Текст = 
    "ВЫБРАТЬ
    |    МАКСИМУМ(Товары.Код) КАК МаксКод
    |ИЗ
    |    Справочник.Товары КАК Товары";
    
    Результат = Запрос.Выполнить();
    Выборка = Результат.Выбрать();
    
    Если Выборка.Следующий() И ЗначениеЗаполнено(Выборка.МаксКод) Тогда
        Возврат Формат(Выборка.МаксКод + 1, "ЧЦ=7; ЧВН=");
    Иначе
        Возврат "0000001";
    КонецЕсли;
КонецФункции`;
                customMessage = `Анализ запроса: "${userQuery}"

Сгенерирован модуль справочника товаров:
• Автоматическая генерация уникальных артикулов
• Инициализация при создании объекта
• Заполнение ответственного и даты создания
• Валидация данных при записи
• Проверка уникальности артикула
• Настройка видимости и доступности элементов
• Использование привилегированного режима для безопасности`;
            } else if (queryLower.includes('документ') || queryLower.includes('document')) {
                customCode = `// Модуль документа "Приходная накладная"
Процедура ОбработкаПроведения(Отказ, Режим)
    // Инициализация документа
    Движения.ОстаткиТоваров.Записывать = Истина;
    
    // Очистка движений
    Движения.ОстаткиТоваров.Очистить();
    
    // Проверка заполнения табличной части
    Если Объект.Товары.Количество() = 0 Тогда
        Сообщить("Не заполнена табличная часть ""Товары""");
        Отказ = Истина;
        Возврат;
    КонецЕсли;
    
    // Проверка остатков на складе
    ПроверитьОстаткиНаСкладе(Отказ);
    Если Отказ Тогда
        Возврат;
    КонецЕсли;
    
    // Создание движений
    Для Каждого Строка Из Объект.Товары Цикл
        // Движение прихода
        Движение = Движения.ОстаткиТоваров.Добавить();
        Движение.ВидДвижения = ВидДвиженияНакопления.Приход;
        Движение.Период = Объект.Дата;
        Движение.Товар = Строка.Товар;
        Движение.Склад = Объект.Склад;
        Движение.Количество = Строка.Количество;
        Движение.Сумма = Строка.Сумма;
    КонецЦикла;
    
    // Проверка корректности сумм
    ПересчитатьСуммыВДокументе();
КонецПроцедуры

Процедура ПроверитьОстаткиНаСкладе(Отказ)
    Запрос = Новый Запрос;
    Запрос.Текст =
    "ВЫБРАТЬ
    |    Товары.Товар,
    |    Товары.Количество,
    |    ЕСТЬNULL(Остатки.КоличествоОстаток, 0) КАК Остаток
    |ПОМЕСТИТЬ ВтТовары
    |ИЗ
    |    Документ.ПриходнаяНакладная.Товары КАК Товары
    |        ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ОстаткиТоваров.Остатки(
    |            &МоментВремени,
    |            Склад = &Склад) КАК Остатки
    |        ПО Товары.Товар = Остатки.Товар
    |ГДЕ
    |    Товары.Ссылка = &Ссылка";
    
    Запрос.УстановитьПараметр("Ссылка", Объект.Ссылка);
    Запрос.УстановитьПараметр("МоментВремени", МоментВремени());
    Запрос.УстановитьПараметр("Склад", Объект.Склад);
    
    Результат = Запрос.Выполнить();
    Выборка = Результат.Выбрать();
    
    Пока Выборка.Следующий() Цикл
        Если Выборка.Остаток < Выборка.Количество Тогда
            Сообщить("Недостаточно товара """ + Выборка.Товар + 
                    """: требуется " + Выборка.Количество + 
                    ", на складе " + Выборка.Остаток);
            Отказ = Истина;
        КонецЕсли;
    КонецЦикла;
КонецПроцедуры`;
                customMessage = `Анализ запроса: "${userQuery}"

Сгенерирован модуль документа "Приходная накладная":
• Обработка проведения с созданием движений
• Проверка заполнения табличной части
• Контроль остатков на складе
• Создание движений по регистру накопления
• Пересчет сумм в документе
• Использование временных таблиц для оптимизации`;
            } else if (queryLower.includes('регистр') && (queryLower.includes('накоплен') || queryLower.includes('остаток'))) {
                customCode = `// Регистр накопления "Остатки товаров"
Функция ПолучитьОстаткиТоваров(Склад, Товар = Неопределено, ДатаНа = Неопределено)
    Если ДатаНа = Неопределено Тогда
        ДатаНа = ТекущаяДата();
    КонецЕсли;
    
    Запрос = Новый Запрос;
    Запрос.Текст =
    "ВЫБРАТЬ
    |    ОстаткиТоваровОстатки.Товар,
    |    ОстаткиТоваровОстатки.Склад,
    |    ОстаткиТоваровОстатки.КоличествоОстаток КАК Количество,
    |    ОстаткиТоваровОстатки.СуммаОстаток КАК Сумма
    |ИЗ
    |    РегистрНакопления.ОстаткиТоваров.Остатки(&ДатаНа, 
    |        Склад = &Склад
    |        И Товар В (&СписокТоваров)) КАК ОстаткиТоваровОстатки
    |ГДЕ
    |    ОстаткиТоваровОстатки.КоличествоОстаток > 0
    |УПОРЯДОЧИТЬ ПО
    |    Товар.Наименование";
    
    Запрос.УстановитьПараметр("Склад", Склад);
    
    Если Товар = Неопределено Тогда
        СписокТоваров = Новый Массив;
        СписокТоваров.Добавить(Справочники.Товары.ПустаяСсылка());
        Запрос.УстановитьПараметр("СписокТоваров", СписокТоваров);
    Иначе
        Запрос.УстановитьПараметр("СписокТоваров", Товар);
    КонецЕсли;
    
    Запрос.УстановитьПараметр("ДатаНа", ДатаНа);
    
    Возврат Запрос.Выполнить().Выгрузить();
КонецФункции

Процедура ОприходоватьТовары(Товар, Количество, Сумма, Склад, ДокументОснование = Неопределено)
    Движение = РегистрыНакопления.ОстаткиТоваров.СоздатьДвижение();
    Движение.ВидДвижения = ВидДвиженияНакопления.Приход;
    Движение.Период = ТекущаяДата();
    Движение.Товар = Товар;
    Движение.Склад = Склад;
    Движение.Количество = Количество;
    Движение.Сумма = Сумма;
    Движение.Регистратор = ДокументОснование;
    Движение.Записать();
КонецПроцедуры`;
                customMessage = `Анализ запроса: "${userQuery}"

Сгенерирован модуль регистра накопления "Остатки товаров":
• Функция получения остатков с параметрами
• Использование виртуальных таблиц регистров
• Фильтрация по складу и товарам
• Создание движений прихода
• Параметризованные запросы для оптимизации
• Работа с моментом времени`;
            } else if (queryLower.includes('регистр') && queryLower.includes('сведен')) {
                customCode = `// Регистр сведений "Цены номенклатуры"
Процедура ЗаписатьЦену(Товар, Цена, ТипЦены, Период = Неопределено, Источник = "")
    Если Период = Неопределено Тогда
        Период = ТекущаяДата();
    КонецЕсли;
    
    НаборЗаписей = РегистрыСведений.ЦеныНоменклатуры.СоздатьНаборЗаписей();
    
    // Установка отбора
    НаборЗаписей.Отбор.Период.Установить(Период);
    НаборЗаписей.Отбор.Товар.Установить(Товар);
    НаборЗаписей.Отбор.ТипЦены.Установить(ТипЦены);
    
    // Создание записи
    Запись = НаборЗаписей.Добавить();
    Запись.Период = Период;
    Запись.Товар = Товар;
    Запись.ТипЦены = ТипЦены;
    Запись.Цена = Цена;
    Запись.Источник = Источник;
    Запись.Пользователь = ПараметрыСеанса.ТекущийПользователь;
    
    // Запись с проверкой прав
    УстановитьПривилегированныйРежим(Истина);
    Попытка
        НаборЗаписей.Записать();
        Сообщить("Цена для """ + Товар + """ успешно установлена");
    Исключение
        Сообщить("Ошибка записи цены: " + ОписаниеОшибки());
    КонецПопытки;
    УстановитьПривилегированныйРежим(Ложь);
КонецПроцедуры

Функция ПолучитьЦену(Товар, ТипЦены, ДатаАктуальности = Неопределено)
    Если ДатаАктуальности = Неопределено Тогда
        ДатаАктуальности = ТекущаяДата();
    КонецЕсли;
    
    Запрос = Новый Запрос;
    Запрос.Текст =
    "ВЫБРАТЬ ПЕРВЫЕ 1
    |    ЦеныНоменклатурыСрезПоследних.Цена КАК Цена
    |ИЗ
    |    РегистрСведений.ЦеныНоменклатуры.СрезПоследних(&Дата, 
    |        Товар = &Товар
    |        И ТипЦены = &ТипЦены) КАК ЦеныНоменклатурыСрезПоследних";
    
    Запрос.УстановитьПараметр("Дата", ДатаАктуальности);
    Запрос.УстановитьПараметр("Товар", Товар);
    Запрос.УстановитьПараметр("ТипЦены", ТипЦены);
    
    Результат = Запрос.Выполнить();
    Если Результат.Пустой() Тогда
        Возврат 0;
    КонецЕсли;
    
    Выборка = Результат.Выбрать();
    Выборка.Следующий();
    
    Возврат Выборка.Цена;
КонецФункции`;
                customMessage = `Анализ запроса: "${userQuery}"

Сгенерирован модуль регистра сведений "Цены номенклатуры":
• Запись цен с использованием наборов записей
• Установка отборов по периоду и измерениям
• Функция получения актуальной цены через срез последних
• Логирование источника изменения цен
• Контроль прав доступа через привилегированный режим
• Обработка ошибок при записи`;
            } else if (queryLower.includes('отчет') || queryLower.includes('report')) {
                customCode = `// Отчет по остаткам товаров
Процедура СформироватьОтчет()
    ТабличныйДокумент = Новый ТабличныйДокумент;
    Макет = ПолучитьМакет("Основной");
    
    // Заголовок отчета
    ОбластьЗаголовка = Макет.ПолучитьОбласть("Заголовок");
    ОбластьЗаголовка.Параметры.НазваниеОтчета = "Отчет по остаткам товаров";
    ОбластьЗаголовка.Параметры.ДатаОтчета = ФорматДаты(ТекущаяДата());
    ОбластьЗаголовка.Параметры.Пользователь = ПараметрыСеанса.ТекущийПользователь;
    ТабличныйДокумент.Вывести(ОбластьЗаголовка);
    
    // Заголовки колонок
    ОбластьЗаголовковКолонок = Макет.ПолучитьОбласть("ЗаголовкиКолонок");
    ТабличныйДокумент.Вывести(ОбластьЗаголовковКолонок);
    
    // Получение данных
    ДанныеОтчета = ПолучитьДанныеОтчета();
    
    // Детальные записи
    ОбластьСтроки = Макет.ПолучитьОбласть("Строка");
    Для Каждого СтрокаДанных Из ДанныеОтчета Цикл
        ОбластьСтроки.Параметры.Заполнить(СтрокаДанных);
        ОбластьСтроки.Параметры.НомерСтроки = ДанныеОтчета.Индекс(СтрокаДанных) + 1;
        ТабличныйДокумент.Вывести(ОбластьСтроки);
    КонецЦикла;
    
    // Итоги
    Если ДанныеОтчета.Количество() > 0 Тогда
        ОбластьИтогов = Макет.ПолучитьОбласть("Итоги");
        ОбластьИтогов.Параметры.ИтогоКоличество = ДанныеОтчета.Итог("Количество");
        ОбластьИтогов.Параметры.ИтогоСумма = ДанныеОтчета.Итог("Сумма");
        ТабличныйДокумент.Вывести(ОбластьИтогов);
    КонецЕсли;
    
    // Подвал
    ОбластьПодвала = Макет.ПолучитьОбласть("Подвал");
    ОбластьПодвала.Параметры.КоличествоСтрок = ДанныеОтчета.Количество();
    ТабличныйДокумент.Вывести(ОбластьПодвала);
    
    Возврат ТабличныйДокумент;
КонецПроцедуры

Функция ПолучитьДанныеОтчета()
    Запрос = Новый Запрос;
    Запрос.Текст =
    "ВЫБРАТЬ
    |    Товары.Код КАК Артикул,
    |    Товары.Наименование КАК Товар,
    |    ОстаткиТоваровОстатки.КоличествоОстаток КАК Количество,
    |    ОстаткиТоваровОстатки.СуммаОстаток КАК Сумма,
    |    ОстаткиТоваровОстатки.Склад.Наименование КАК Склад
    |ИЗ
    |    РегистрНакопления.ОстаткиТоваров.Остатки КАК ОстаткиТоваровОстатки
    |        ЛЕВОЕ СОЕДИНЕНИЕ Справочник.Товары КАК Товары
    |        ПО ОстаткиТоваровОстатки.Товар = Товары.Ссылка
    |ГДЕ
    |    ОстаткиТоваровОстатки.КоличествоОстаток > 0
    |УПОРЯДОЧИТЬ ПО
    |    Товары.Наименование";
    
    Возврат Запрос.Выполнить().Выгрузить();
КонецФункции`;
                customMessage = `Анализ запроса: "${userQuery}"

Сгенерирован модуль отчета по остаткам товаров:
• Создание табличного документа с использованием макета
• Формирование заголовка, колонок, детальных записей и итогов
• Получение данных через запрос к регистру накопления
• Соединение с данными справочника товаров
• Подсчет итогов по количеству и сумме
• Нумерация строк для удобства просмотра
• Вывод информации о пользователе и дате формирования`;
            } else if (queryLower.includes('обработк') || queryLower.includes('processing')) {
                customCode = `// Обработка массового изменения цен
Процедура ВыполнитьОбработку(Параметры) Экспорт
    НачатьТранзакцию();
    Попытка
        // Проверка прав доступа
        Если Не ПравоДоступа("Изменение", Метаданные.РегистрыСведений.ЦеныНоменклатуры) Тогда
            ВызватьИсключение "Недостаточно прав для изменения цен";
        КонецЕсли;
        
        // Получение данных для обработки
        Запрос = Новый Запрос;
        Запрос.Текст =
        "ВЫБРАТЬ
        |    Товары.Ссылка КАК Товар
        |ИЗ
        |    Справочник.Товары КАК Товары
        |ГДЕ
        |    Товары.ПометкаУдаления = Ложь
        |    И Товары.ЭтоГруппа = Ложь";
        
        Если Параметры.Свойство("Товары") И ЗначениеЗаполнено(Параметры.Товары) Тогда
            Запрос.Текст = Запрос.Текст + "
            |    И Товары.Ссылка В (&Товары)";
            Запрос.УстановитьПараметр("Товары", Параметры.Товары);
        КонецЕсли;
        
        Выборка = Запрос.Выполнить().Выбрать();
        Счетчик = 0;
        
        // Обработка каждого товара
        Пока Выборка.Следующий() Цикл
            ОбновитьЦенуТовара(Выборка.Товар, Параметры);
            Счетчик = Счетчик + 1;
            
            // Прогресс-бар
            Если Счетчик % 100 = 0 Тогда
                Сообщить("Обработано " + Счетчик + " товаров...");
            КонецЕсли;
        КонецЦикла;
        
        ЗафиксироватьТранзакцию();
        Сообщить("Обработка завершена. Обновлено " + Счетчик + " товаров.");
        
    Исключение
        ОтменитьТранзакцию();
        Сообщить("Ошибка обработки: " + ОписаниеОшибки());
        ВызватьИсключение;
    КонецПопытки;
КонецПроцедуры

Процедура ОбновитьЦенуТовара(Товар, Параметры)
    // Получение текущей цены
    ТекущаяЦена = РегистрыСведений.ЦеныНоменклатуры.ПолучитьПоследнее(
        ТекущаяДата(), 
        Новый Структура("Товар, ТипЦены", Товар, Параметры.ТипЦены)
    );
    
    // Расчет новой цены
    НоваяЦена = РассчитатьНовуюЦену(ТекущаяЦена.Цена, Параметры);
    
    // Запись новой цены
    ЗаписатьЦену(Товар, НоваяЦена, Параметры.ТипЦены, , "Массовое изменение");
КонецПроцедуры`;
                customMessage = `Анализ запроса: "${userQuery}"

Создана обработка массового изменения цен:
• Транзакционная обработка данных с контролем ошибок
• Проверка прав доступа к регистру сведений
• Параметризованный запрос с фильтрацией по товарам
• Обновление цен с использованием регистра сведений
• Расчет новых цен по заданным правилам
• Прогресс-бар для отслеживания выполнения
• Логирование изменений с указанием источника`;
            } else if (queryLower.includes('запрос') || queryLower.includes('sql') || queryLower.includes('query')) {
                customCode = `// Оптимизированный запрос для анализа продаж
Функция ПолучитьАнализПродаж(ПериодНачала, ПериодКонца, Склад = Неопределено)
    Запрос = Новый Запрос;
    Запрос.Текст =
    "ВЫБРАТЬ
    |    ПродажиОбороты.Товар КАК Товар,
    |    ПродажиОбороты.Товар.Артикул КАК Артикул,
    |    ПродажиОбороты.Товар.ЕдиницаИзмерения КАК ЕдиницаИзмерения,
    |    СУММА(ПродажиОбороты.КоличествоОборот) КАК Количество,
    |    СУММА(ПродажиОбороты.СуммаОборот) КАК Сумма,
    |    СРЕДНЕЕ(ПродажиОбороты.Цена) КАК СредняяЦена
    |ПОМЕСТИТЬ ВтПродажи
    |ИЗ
    |    РегистрНакопления.Продажи.Обороты(&ПериодНачала, &ПериодКонца, 
    |        Регистратор, 
    |        Склад = &Склад) КАК ПродажиОбороты
    |СГРУППИРОВАТЬ ПО
    |    ПродажиОбороты.Товар
    |;
    
    |ВЫБРАТЬ
    |    ВтПродажи.Товар,
    |    ВтПродажи.Артикул,
    |    ВтПродажи.ЕдиницаИзмерения,
    |    ВтПродажи.Количество,
    |    ВтПродажи.Сумма,
    |    ВтПродажи.СредняяЦена,
    |    ЕСТЬNULL(Остатки.КоличествоОстаток, 0) КАК Остаток,
    |    ВЫБОР 
    |        КОГДА ЕСТЬNULL(Остатки.КоличествоОстаток, 0) = 0 ТОГДА 0
    |        ИНАЧЕ ВтПродажи.Количество / ЕСТЬNULL(Остатки.КоличествоОстаток, 1)
    |    КОНЕЦ КАК Оборачиваемость
    |ИЗ
    |    ВтПродажи КАК ВтПродажи
    |        ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ОстаткиТоваров.Остатки(&ПериодКонца) КАК Остатки
    |        ПО ВтПродажи.Товар = Остатки.Товар
    |УПОРЯДОЧИТЬ ПО
    |    ВтПродажи.Сумма УБЫВ";
    
    Запрос.УстановитьПараметр("ПериодНачала", ПериодНачала);
    Запрос.УстановитьПараметр("ПериодКонца", ПериодКонца);
    Запрос.УстановитьПараметр("Склад", Склад);
    
    Возврат Запрос.Выполнить().Выгрузить();
КонецФункции

// Использование итогов для ускорения запросов
Процедура ИспользоватьИтогиРегистра()
    РегистрыНакопления.Продажи.УстановитьИспользованиеИтогов(Истина);
    РегистрыНакопления.Продажи.ПересчитатьИтоги();
КонецПроцедуры`;
                customMessage = `Анализ запроса: "${userQuery}"

Создан оптимизированный запрос для анализа продаж:
• Использование виртуальных таблиц Обороты для получения агрегированных данных
• Временная таблица для промежуточных результатов
• Расчет оборачиваемости товаров на основе продаж и остатков
• Соединение с регистром остатков для получения текущих остатков
• Сортировка по сумме продаж для выявления лидеров
• Использование итогов регистров для ускорения запросов
• Параметризация запросов для безопасности`;
            } else if (queryLower.includes('печатн') && queryLower.includes('форм')) {
                customCode = `// Печатная форма "Расходная накладная"
Функция Печать(МассивОбъектов, ПараметрыПечати = Неопределено, КоллекцияПечатныхФорм = Неопределено) Экспорт
    УстановитьПривилегированныйРежим(Истина);
    
    ТабличныйДокумент = Новый ТабличныйДокумент;
    Макет = ПолучитьОбщийМакет("ПФ_MXL_РасходнаяНакладная");
    
    // Формирование печатной формы для каждого документа
    Для Каждого СсылкаНаДокумент Из МассивОбъектов Цикл
        ДокументОбъект = СсылкаНаДокумент.ПолучитьОбъект();
        
        // Заполнение шапки документа
        ЗаполнитьШапкуДокумента(ТабличныйДокумент, Макет, ДокументОбъект);
        
        // Заполнение табличной части
        ЗаполнитьТабличнуюЧасть(ТабличныйДокумент, Макет, ДокументОбъект);
        
        // Подвал документа
        ЗаполнитьПодвалДокумента(ТабличныйДокумент, Макет, ДокументОбъект);
        
        // Разделитель между документами
        Если МассивОбъектов.Найти(СсылкаНаДокумент) < МассивОбъектов.ВГраница() Тогда
            ТабличныйДокумент.ВывестиГоризонтальныйРазделительСтраниц();
        КонецЕсли;
    КонецЦикла;
    
    УстановитьПривилегированныйРежим(Ложь);
    
    Возврат ТабличныйДокумент;
КонецФункции

Процедура ЗаполнитьШапкуДокумента(ТабличныйДокумент, Макет, ДокументОбъект)
    ОбластьШапки = Макет.ПолучитьОбласть("Шапка");
    
    // Заполнение параметров шапки
    ОбластьШапки.Параметры.Заполнить(ДокументОбъект);
    ОбластьШапки.Параметры.ОрганизацияПредставление = ДокументОбъект.Организация.НаименованиеПолное;
    ОбластьШапки.Параметры.КонтрагентПредставление = ДокументОбъект.Контрагент.НаименованиеПолное;
    ОбластьШапки.Параметры.НомерДокумента = ПрефиксацияОбъектовКлиентСервер.ПолучитьНомерНаПечать(ДокументОбъект);
    
    ТабличныйДокумент.Вывести(ОбластьШапки);
КонецПроцедуры

Процедура ЗаполнитьТабличнуюЧасть(ТабличныйДокумент, Макет, ДокументОбъект)
    ОбластьЗаголовков = Макет.ПолучитьОбласть("ЗаголовокТаблицы");
    ТабличныйДокумент.Вывести(ОбластьЗаголовков);
    
    ОбластьСтроки = Макет.ПолучитьОбласть("СтрокаТаблицы");
    
    НомерСтроки = 0;
    ИтогоКоличество = 0;
    ИтогоСумма = 0;
    
    Для Каждого СтрокаТЧ Из ДокументОбъект.Товары Цикл
        НомерСтроки = НомерСтроки + 1;
        
        ОбластьСтроки.Параметры.Заполнить(СтрокаТЧ);
        ОбластьСтроки.Параметры.НомерСтроки = НомерСтроки;
        ОбластьСтроки.Параметры.ТоварПредставление = СтрокаТЧ.Товар.НаименованиеПолное;
        ОбластьСтроки.Параметры.ЕдиницаИзмеренияПредставление = СтрокаТЧ.ЕдиницаИзмерения.Наименование;
        
        ТабличныйДокумент.Вывести(ОбластьСтроки);
        
        ИтогоКоличество = ИтогоКоличество + СтрокаТЧ.Количество;
        ИтогоСумма = ИтогоСумма + СтрокаТЧ.Сумма;
    КонецЦикла;
    
    // Итоги
    ОбластьИтогов = Макет.ПолучитьОбласть("ИтогоТаблицы");
    ОбластьИтогов.Параметры.ИтогоКоличество = ИтогоКоличество;
    ОбластьИтогов.Параметры.ИтогоСумма = ИтогоСумма;
    ТабличныйДокумент.Вывести(ОбластьИтогов);
КонецПроцедуры`;
                customMessage = `Анализ запроса: "${userQuery}"

Сгенерирован модуль печатной формы "Расходная накладная":
• Создание табличного документа с использованием макета
• Формирование шапки, табличной части и подвала документа
• Получение и заполнение данных из объекта документа
• Нумерация строк и подсчет итогов
• Разделитель страниц между документами
• Формирование представлений для справочных данных
• Контроль доступа через привилегированный режим`;
            } else if (queryLower.includes('веб-сервис') || queryLower.includes('webservice') || queryLower.includes('soap')) {
                customCode = `// Веб-сервис для интеграции с внешними системами
Функция ПолучитьТовары(Параметры) Экспорт
    СтруктураОтвета = Новый Структура;
    
    Попытка
        // Проверка авторизации
        Если Не ПроверитьАвторизацию(Параметры.Токен) Тогда
            СтруктураОтвета.Вставить("Ошибка", "Неверный токен авторизации");
            Возврат ПреобразоватьВJSON(СтруктураОтвета);
        КонецЕсли;
        
        // Получение товаров
        Запрос = Новый Запрос;
        Запрос.Текст =
        "ВЫБРАТЬ
        |    Товары.Ссылка,
        |    Товары.Артикул,
        |    Товары.Наименование,
        |    Товары.ЕдиницаИзмерения.Наименование КАК ЕдиницаИзмерения,
        |    ЕСТЬNULL(Цены.Цена, 0) КАК Цена
        |ИЗ
        |    Справочник.Товары КАК Товары
        |        ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЦеныНоменклатуры.СрезПоследних(&Дата) КАК Цены
        |        ПО Товары.Ссылка = Цены.Товар
        |ГДЕ
        |    Товары.ПометкаУдаления = Ложь
        |    И Товары.ЭтоГруппа = Ложь
        |УПОРЯДОЧИТЬ ПО
        |    Товары.Наименование";
        
        Запрос.УстановитьПараметр("Дата", ТекущаяДата());
        
        РезультатЗапроса = Запрос.Выполнить();
        ТаблицаТоваров = РезультатЗапроса.Выгрузить();
        
        // Преобразование в JSON-совместимую структуру
        МассивТоваров = Новый Массив;
        Для Каждого СтрокаТовара Из ТаблицаТоваров Цикл
            СтруктураТовара = Новый Структура;
            СтруктураТовара.Вставить("Ссылка", СтрокаТовара.Ссылка.УникальныйИдентификатор());
            СтруктураТовара.Вставить("Артикул", СтрокаТовара.Артикул);
            СтруктураТовара.Вставить("Наименование", СтрокаТовара.Наименование);
            СтруктураТовара.Вставить("ЕдиницаИзмерения", СтрокаТовара.ЕдиницаИзмерения);
            СтруктураТовара.Вставить("Цена", СтрокаТовара.Цена);
            МассивТоваров.Добавить(СтруктураТовара);
        КонецЦикла;
        
        СтруктураОтвета.Вставить("Товары", МассивТоваров);
        СтруктураОтвета.Вставить("Количество", МассивТоваров.Количество());
        СтруктураОтвета.Вставить("Статус", "Успешно");
        
        // Логирование запроса
        ЗаписатьЛогЗапроса("ПолучитьТовары", Параметры.Токен, Истина);
        
    Исключение
        СтруктураОтвета.Вставить("Ошибка", ОписаниеОшибки());
        СтруктураОтвета.Вставить("Статус", "Ошибка");
        
        // Логирование ошибки
        ЗаписатьЛогЗапроса("ПолучитьТовары", Параметры.Токен, Ложь, ОписаниеОшибки());
    КонецПопытки;
    
    Возврат ПреобразоватьВJSON(СтруктураОтвета);
КонецФункции

Функция СоздатьЗаказ(Параметры) Экспорт
    Попытка
        // Проверка авторизации и валидация параметров
        Если Не ПроверитьАвторизацию(Параметры.Токен) Тогда
            Возврат СформироватьОтветОшибки("Неверный токен");
        КонецЕсли;
        
        // Создание документа заказа
        ДокументЗаказ = Документы.ЗаказПокупателя.СоздатьДокумент();
        ДокументЗаказ.Дата = ТекущаяДата();
        ДокументЗаказ.Контрагент = НайтиКонтрагентаПоИНН(Параметры.ИННКонтрагента);
        
        // Заполнение табличной части
        Для Каждого ТоварЗаказа Из Параметры.Товары Цикл
            СтрокаТЧ = ДокументЗаказ.Товары.Добавить();
            СтрокаТЧ.Товар = НайтиТоварПоАртикулу(ТоварЗаказа.Артикул);
            СтрокаТЧ.Количество = ТоварЗаказа.Количество;
            СтрокаТЧ.Цена = ПолучитьЦенуТовара(СтрокаТЧ.Товар, ДокументЗаказ.Контрагент);
            СтрокаТЧ.Сумма = СтрокаТЧ.Количество * СтрокаТЧ.Цена;
        КонецЦикла;
        
        ДокументЗаказ.Записать(РежимЗаписиДокумента.Проведение);
        
        Возврат ПреобразоватьВJSON(Новый Структура(
            "Статус, НомерЗаказа", 
            "Успешно", 
            ПрефиксацияОбъектовКлиентСервер.ПолучитьНомерНаПечать(ДокументЗаказ)
        ));
        
    Исключение
        Возврат СформироватьОтветОшибки(ОписаниеОшибки());
    КонецПопытки;
КонецФункции`;
                customMessage = `Анализ запроса: "${userQuery}"

Сгенерирован веб-сервис для интеграции с внешними системами:
• Функции для получения товаров и создания заказов
• Проверка авторизации через токены
• Преобразование данных в JSON формат
• Валидация входных параметров
• Создание и проведение документов
• Получение актуальных цен из регистра сведений
• Логирование всех запросов для аудита
• Обработка ошибок с детальными сообщениями`;
            } else if (queryLower.includes('обмен') || queryLower.includes('синхрониз') || queryLower.includes('интеграц')) {
                customCode = `// Обработка обмена данными с внешней системой
Процедура ВыполнитьОбмен() Экспорт
    Попытка
        // Инициализация подключения к внешней системе
        HTTPСоединение = Новый HTTPСоединение("api.external-system.com", 443);
        HTTPСоединение.Таймаут = 30;
        
        // Получение данных для выгрузки
        ДанныеКВыгрузке = ПодготовитьДанныеКВыгрузке();
        
        // Отправка данных
        ОтветСервера = ОтправитьДанные(HTTPСоединение, ДанныеКВыгрузке);
        
        // Обработка ответа
        ОбработатьОтвет(ОтветСервера);
        
        // Получение данных для загрузки
        ПолучитьИЗагрузитьДанные(HTTPСоединение);
        
        Сообщить("Обмен данными завершен успешно");
        
    Исключение
        Сообщить("Ошибка обмена данными: " + ОписаниеОшибки());
        ЗаписатьЛогОшибки(ОписаниеОшибки());
    КонецПопытки;
КонецПроцедуры

Функция ПодготовитьДанныеКВыгрузке()
    Запрос = Новый Запрос;
    Запрос.Текст =
    "ВЫБРАТЬ
    |    Товары.Ссылка.УникальныйИдентификатор() КАК GUID,
    |    Товары.Артикул,
    |    Товары.Наименование,
    |    Товары.ЕдиницаИзмерения.Наименование КАК ЕдиницаИзмерения,
    |    ЕСТЬNULL(Цены.Цена, 0) КАК Цена,
    |    Товары.ДатаИзменения
    |ИЗ
    |    Справочник.Товары КАК Товары
    |        ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЦеныНоменклатуры.СрезПоследних(&Дата) КАК Цены
    |        ПО Товары.Ссылка = Цены.Товар
    |ГДЕ
    |    Товары.ПометкаУдаления = Ложь
    |    И Товары.ДатаИзменения >= &ДатаПоследнегоОбмена";
    
    Запрос.УстановитьПараметр("Дата", ТекущаяДата());
    Запрос.УстановитьПараметр("ДатаПоследнегоОбмена", ПолучитьДатуПоследнегоОбмена());
    
    Возврат Запрос.Выполнить().Выгрузить();
КонецФункции

Функция ОтправитьДанные(HTTPСоединение, Данные)
    HTTPЗапрос = Новый HTTPЗапрос("/api/sync/products");
    HTTPЗапрос.Заголовки.Вставить("Content-Type", "application/json");
    HTTPЗапрос.Заголовки.Вставить("Authorization", "Bearer " + ПолучитьТокенАвторизации());
    HTTPЗапрос.УстановитьТелоИзСтроки(СериализоватьДанные(Данные));
    
    Возврат HTTPСоединение.ВызватьHTTPМетод("POST", HTTPЗапрос);
КонецФункции

Процедура ОбработатьОтвет(Ответ)
    Если Ответ.КодСостояния = 200 Тогда
        // Обновление даты последнего обмена
        УстановитьДатуПоследнегоОбмена(ТекущаяДата());
        
        // Парсинг ответа и обработка результатов
        Результат = РазобратьОтветJSON(Ответ.ПолучитьТелоКакСтроку());
        ОбработатьРезультатОбмена(Результат);
    Иначе
        ВызватьИсключение "Ошибка отправки данных: " + Ответ.ПолучитьТелоКакСтроку();
    КонецЕсли;
КонецПроцедуры`;
                customMessage = `Анализ запроса: "${userQuery}"

Создана обработка обмена данными с внешними системами:
• Инициализация HTTP-соединения с настройкой таймаутов
• Подготовка данных к выгрузке с фильтрацией по дате изменения
• Отправка данных через POST-запрос в JSON формате
• Авторизация через Bearer токен
• Обработка ответов сервера и обновление даты обмена
• Получение данных от внешней системы для загрузки
• Логирование всех операций для аудита
• Сериализация и десериализация данных`;
            } else if (queryLower.includes('загруз') && queryLower.includes('данн')) {
                customCode = `// Обработка загрузки данных из Excel
Процедура ЗагрузитьДанныеИзExcel(ИмяФайла, ЛистExcel = 1) Экспорт
    Попытка
        // Создание COM-объекта для работы с Excel
        Excel = Новый COMОбъект("Excel.Application");
        Excel.Visible = Ложь;
        
        // Открытие файла
        Книга = Excel.Workbooks.Open(ИмяФайла);
        Лист = Книга.WorkSheets(ЛистExcel);
        
        // Определение диапазона данных
        ПоследняяСтрока = Лист.Cells(Лист.Rows.Count, 1).End(-4162).Row;
        
        Если ПоследняяСтрока < 2 Тогда
            ВызватьИсключение "В файле отсутствуют данные для загрузки";
        КонецЕсли;
        
        // Создание таблицы значений для временного хранения данных
        ТаблицаДанных = Новый ТаблицаЗначений;
        ТаблицаДанных.Колонки.Добавить("Артикул");
        ТаблицаДанных.Колонки.Добавить("Наименование");
        ТаблицаДанных.Колонки.Добавить("Цена");
        ТаблицаДанных.Колонки.Добавить("Количество");
        ТаблицаДанных.Колонки.Добавить("ЕдиницаИзмерения");
        
        // Чтение данных из Excel
        Для НомерСтроки = 2 По ПоследняяСтрока Цикл
            СтрокаТЗ = ТаблицаДанных.Добавить();
            СтрокаТЗ.Артикул = СокрЛП(Лист.Cells(НомерСтроки, 1).Value);
            СтрокаТЗ.Наименование = СокрЛП(Лист.Cells(НомерСтроки, 2).Value);
            СтрокаТЗ.Цена = Лист.Cells(НомерСтроки, 3).Value;
            СтрокаТЗ.Количество = Лист.Cells(НомерСтроки, 4).Value;
            СтрокаТЗ.ЕдиницаИзмерения = СокрЛП(Лист.Cells(НомерСтроки, 5).Value);
            
            // Валидация данных
            Если Не ЗначениеЗаполнено(СтрокаТЗ.Артикул) ИЛИ Не ЗначениеЗаполнено(СтрокаТЗ.Наименование) Тогда
                Сообщить("Строка " + НомерСтроки + ": не заполнены обязательные поля");
                Продолжить;
            КонецЕсли;
        КонецЦикла;
        
        // Обработка загруженных данных
        ОбработатьЗагруженныеДанные(ТаблицаДанных);
        
        // Закрытие Excel
        Книга.Close();
        Excel.Quit();
        
        Сообщить("Загрузка данных завершена. Обработано " + ТаблицаДанных.Количество() + " строк");
        
    Исключение
        // Закрытие Excel в случае ошибки
        Попытка
            Книга.Close();
            Excel.Quit();
        Исключение
        КонецПопытки;
        
        Сообщить("Ошибка загрузки данных: " + ОписаниеОшибки());
        ВызватьИсключение;
    КонецПопытки;
КонецПроцедуры

Процедура ОбработатьЗагруженныеДанные(ТаблицаДанных)
    НачатьТранзакцию();
    Попытка
        Для Каждого СтрокаДанных Из ТаблицаДанных Цикл
            // Поиск существующего товара по артикулу
            Товар = НайтиТоварПоАртикулу(СтрокаДанных.Артикул);
            
            Если Товар = Неопределено Тогда
                // Создание нового товара
                ТоварОбъект = Справочники.Товары.СоздатьЭлемент();
                ТоварОбъект.Артикул = СтрокаДанных.Артикул;
            Иначе
                ТоварОбъект = Товар.ПолучитьОбъект();
            КонецЕсли;
            
            // Заполнение реквизитов
            ТоварОбъект.Наименование = СтрокаДанных.Наименование;
            ТоварОбъект.ЕдиницаИзмерения = НайтиЕдиницуИзмерения(СтрокаДанных.ЕдиницаИзмерения);
            
            // Запись товара
            ТоварОбъект.Записать();
            
            // Обновление цены
            Если СтрокаДанных.Цена > 0 Тогда
                ОбновитьЦенуТовара(ТоварОбъект.Ссылка, СтрокаДанных.Цена);
            КонецЕсли;
        КонецЦикла;
        
        ЗафиксироватьТранзакцию();
        
    Исключение
        ОтменитьТранзакцию();
        ВызватьИсключение;
    КонецПопытки;
КонецПроцедуры`;
                customMessage = `Анализ запроса: "${userQuery}"

Создана обработка загрузки данных из Excel:
• Использование COM-объекта для работы с Excel файлами
• Автоматическое определение диапазона данных
• Валидация обязательных полей при загрузке
• Создание таблицы значений для временного хранения данных
• Транзакционная обработка с возможностью отката
• Создание новых товаров и обновление существующих
• Обновление цен через регистр сведений
• Корректное закрытие Excel при возникновении ошибок`;
            } else if (queryLower.includes('внешн') && queryLower.includes('компонент')) {
                customCode = `// Работа с внешней компонентой для печати штрихкодов
Перем ВнешняяКомпонента条码;
Перем ПодключенаКомпонента;

// Подключение внешней компоненты
Процедура ПодключитьКомпоненту() Экспорт
    Попытка
        Если ПодключенаКомпонента = Истина Тогда
            Возврат;
        КонецЕсли;
        
        УстановитьВнешнююКомпоненту("Плагин.Barcode");
        ПодключитьВнешнююКомпоненту("Плагин.Barcode", "ВнешняяКомпонента条码");
        
        ВнешняяКомпонента条码 = Новый("AddIn.Плагин.Barcode.Barcodes");
        ПодключенаКомпонента = Истина;
        
        Сообщить("Внешняя компонента успешно подключена");
        
    Исключение
        Сообщить("Ошибка подключения внешней компоненты: " + ОписаниеОшибки());
        ПодключенаКомпонента = Ложь;
    КонецПопытки;
КонецПроцедуры

// Генерация штрихкода
Функция СгенерироватьШтрихкод(Знач ТекстКода, ТипШтрихкода = "CODE128") Экспорт
    Если ПодключенаКомпонента = Ложь Тогда
        ПодключитьКомпоненту();
    КонецЕсли;
    
    Попытка
        // Настройка параметров генерации
        ВнешняяКомпонента条码.TypeBar = ПолучитьТипШтрихкода(ТипШтрихкода);
        ВнешняяКомпонента条码.Content = ТекстКода;
        ВнешняяКомпонента条码.Module = 2; // Размер модуля
        ВнешняяКомпонента条码.Height = 50; // Высота в пикселях
        ВнешняяКомпонента条码.ShowText = Истина; // Показывать текст под штрихкодом
        
        // Генерация изображения штрихкода
        ДвоичныеДанныеИзображения = ВнешняяКомпонента条码.GenerateBarCode();
        
        // Сохранение во временный файл
        ИмяВременногоФайла = ПолучитьИмяВременногоФайла("png");
        ДвоичныеДанныеИзображения.Записать(ИмяВременногоФайла);
        
        Возврат ИмяВременногоФайла;
        
    Исключение
        Сообщить("Ошибка генерации штрихкода: " + ОписаниеОшибки());
        Возврат "";
    КонецПопытки;
КонецФункции

// Печать штрихкодов для товаров
Процедура НапечататьШтрихкодыТоваров(МассивТоваров) Экспорт
    ПодключитьКомпоненту();
    
    ТабличныйДокумент = Новый ТабличныйДокумент;
    Макет = ПолучитьМакет("ЭтикеткаШтрихкода");
    
    Для Каждого Товар Из МассивТоваров Цикл
        // Генерация штрихкода
        ИмяФайлаШтрихкода = СгенерироватьШтрихкод(Товар.Артикул);
        
        Если ЗначениеЗаполнено(ИмяФайлаШтрихкода) Тогда
            // Заполнение макета этикетки
            ОбластьЭтикетки = Макет.ПолучитьОбласть("Этикетка");
            
            КартинкаШтрихкода = Новый Картинка(ИмяФайлаШтрихкода, Ложь);
            ОбластьЭтикетки.Рисунки.Добавить(КартинкаШтрихкода);
            ОбластьЭтикетки.Рисунки.Штрихкод.Картинка = КартинкаШтрихкода;
            
            ОбластьЭтикетки.Параметры.НаименованиеТовара = Товар.Наименование;
            ОбластьЭтикетки.Параметры.Артикул = Товар.Артикул;
            
            ТабличныйДокумент.Вывести(ОбластьЭтикетки);
            
            // Удаление временного файла
            Попытка
                УдалитьФайлы(ИмяФайлаШтрихкода);
            Исключение
            КонецПопытки;
        КонецЕсли;
    КонецЦикла;
    
    ТабличныйДокумент.Показать("Печать штрихкодов");
КонецПроцедуры`;
                customMessage = `Анализ запроса: "${userQuery}"

Создана работа с внешней компонентой для печати штрихкодов:
• Подключение и инициализация внешней компоненты Barcode
• Генерация штрихкодов различных типов (CODE128, EAN13 и др.)
• Настройка параметров генерации (размер, высота, отображение текста)
• Сохранение изображений штрихкодов во временные файлы
• Формирование печатных этикеток с использованием макетов
• Печать этикеток для множества товаров
• Автоматическая очистка временных файлов
• Обработка ошибок подключения и генерации`;
            } else {
                customCode = `// Базовая функция обработки
Функция ОбработатьДанные(Параметры)
    Результат = Новый Структура;
    Результат.Вставить("Успешно", Истина);
    Результат.Вставить("Сообщение", "Обработка завершена");
    Результат.Вставить("Данные", Новый Массив);
    
    Попытка
        // Основная логика обработки
        Если Параметры.Свойство("ВыполнитьЗапрос") Тогда
            Результат.Данные = ВыполнитьЗапрос(Параметры.Запрос);
        КонецЕсли;
        
        Если Параметры.Свойство("ПроверитьДанные") Тогда
            Результат.Вставить("РезультатПроверки", ПроверитьДанные(Параметры.Данные));
        КонецЕсли;
        
        // Логирование операции
        ЗаписатьЛогОперации("Обработка данных", Параметры);
        
    Исключение
        Результат.Успешно = Ложь;
        Результат.Сообщение = ОписаниеОшибки();
        
        // Логирование ошибки
        ЗаписатьЛогОшибки(ОписаниеОшибки());
    КонецПопытки;
    
    Возврат Результат;
КонецФункции

// Вспомогательные функции
Функция ВыполнитьЗапрос(ТекстЗапроса)
    Запрос = Новый Запрос(ТекстЗапроса);
    Возврат Запрос.Выполнить().Выгрузить();
КонецФункции

Функция ПроверитьДанные(Данные)
    Возврат Новый Структура("Корректно, Ошибки", Истина, "");
КонецФункции`;
                customMessage = `Анализ запроса: "${userQuery}"

Сгенерирован базовый шаблон обработки:
• Структура результата с флагом успешности и данными
• Блок обработки исключений Try-Catch
• Детальное логирование операций и ошибок
• Универсальный паттерн для расширения функционала
• Вспомогательные функции для выполнения запросов и проверки данных
• Возможность передачи параметров в обработку
• Возврат структурированного результата`;
            }
            
            finalResult = {
                message: customMessage,
                code: customCode,
                language: '1C',
                userQuery: userQuery
            };
            
            steps.push({ 
                progress: 100, 
                message: 'Код успешно сгенерирован!',
                result: finalResult
            });
            
        } else if (demoType === 'generate') {
            steps.push({ progress: 10, message: 'Запуск генерации кода...' });
            await new Promise(r => setTimeout(r, 500));
            
            steps.push({ progress: 25, message: 'Анализ требований к справочнику товаров...' });
            await new Promise(r => setTimeout(r, 1000));
            
            steps.push({ progress: 50, message: 'Генерация структуры модуля...' });
            await new Promise(r => setTimeout(r, 1200));
            
            const generatedCode = `// Справочник "Товары"
&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
    // Инициализация
    УстановитьВидимость();
    УстановитьДоступность();
    ЗаполнитьСписокВыбораЕдиницИзмерения();
КонецПроцедуры

&НаСервере
Процедура ПередЗаписьюНаСервере(Отказ, ТекущийОбъект, ПараметрыЗаписи)
    // Валидация
    Если Не ЗначениеЗаполнено(ТекущийОбъект.Наименование) Тогда
        Сообщить("Необходимо заполнить наименование товара");
        Отказ = Истина;
        Возврат;
    КонецЕсли;
    
    Если ТекущийОбъект.Цена < 0 Тогда
        Сообщить("Цена не может быть отрицательной");
        Отказ = Истина;
        Возврат;
    КонецЕсли;
    
    // Установка артикула, если не заполнен
    Если Не ЗначениеЗаполнено(ТекущийОбъект.Артикул) Тогда
        ТекущийОбъект.Артикул = ПолучитьНовыйАртикул();
    КонецЕсли;
КонецПроцедуры

&НаСервереБезКонтекста
Функция ПолучитьНовыйАртикул()
    Префикс = "TOV";
    Номер = Формат(Справочники.Товары.ПолучитьПоследнийНомер() + 1, "ЧЦ=6; ЧВН=");
    Возврат Префикс + Номер;
КонецФункции`;
            
            steps.push({ progress: 75, message: 'Создание обработчиков событий...' });
            await new Promise(r => setTimeout(r, 800));
            
            steps.push({ progress: 90, message: 'Добавление валидации и проверок...' });
            await new Promise(r => setTimeout(r, 600));
            
            finalResult = {
                code: generatedCode,
                linesOfCode: 245,
                functions: 8,
                testCoverage: '87%',
                complexity: 'Low'
            };
            
            steps.push({ 
                progress: 100, 
                message: '✅ Код сгенерирован: 245 строк, 8 функций, покрытие тестами 87%',
                result: finalResult
            });
            
        } else if (demoType === 'optimize') {
            steps.push({ progress: 10, message: 'Запуск оптимизации...' });
            await new Promise(r => setTimeout(r, 500));
            
            steps.push({ progress: 30, message: 'Анализ SQL запроса...' });
            await new Promise(r => setTimeout(r, 800));
            
            const originalQuery = `SELECT 
    Товары.Наименование,
    Товары.Артикул,
    ОстаткиТоваров.Количество
FROM Товары
LEFT JOIN ОстаткиТоваров ON Товары.Ссылка = ОстаткиТоваров.Товар
WHERE ОстаткиТоваров.Склад = &Склад
ORDER BY Товары.Наименование`;

            const optimizedQuery = `SELECT 
    Товары.Наименование,
    Товары.Артикул,
    ОстаткиТоваров.Количество
FROM Товары
INNER JOIN ОстаткиТоваров WITH(INDEX(IX_ОстаткиТоваров_Склад_Товар))
    ON Товары.Ссылка = ОстаткиТоваров.Товар
WHERE ОстаткиТоваров.Склад = &Склад
    AND ОстаткиТоваров.Количество > 0
ORDER BY Товары.Наименование`;
            
            steps.push({ 
                progress: 60, 
                message: 'Выявление узких мест: отсутствие индексов, N+1 запросы' 
            });
            await new Promise(r => setTimeout(r, 1000));
            
            steps.push({ progress: 85, message: 'Применение оптимизаций...' });
            await new Promise(r => setTimeout(r, 800));
            
            finalResult = {
                originalQuery,
                optimizedQuery,
                improvements: [
                    'Добавлен hint для использования индекса',
                    'INNER JOIN вместо LEFT JOIN (исключены NULL значения)',
                    'Добавлен фильтр Количество > 0',
                    'Оптимизирован порядок условий'
                ],
                performanceBefore: '3.2s',
                performanceAfter: '0.4s',
                speedup: '8x'
            };
            
            steps.push({ 
                progress: 100, 
                message: '✅ Производительность улучшена: с 3.2с до 0.4с (8x быстрее)',
                result: finalResult
            });
            
        } else if (demoType === 'api') {
            steps.push({ progress: 10, message: 'Запуск создания API интеграции...' });
            await new Promise(r => setTimeout(r, 500));
            
            steps.push({ progress: 25, message: 'Анализ спецификации API...' });
            await new Promise(r => setTimeout(r, 800));
            
            steps.push({ progress: 50, message: 'Генерация методов интеграции...' });
            await new Promise(r => setTimeout(r, 1000));
            
            const apiCode = `// HTTP-сервис для интеграции с внешней системой
&НаСервере
Функция ОтправитьЗапросВнешнейСистеме(Метод, Параметры)
    Попытка
        HTTPСоединение = Новый HTTPСоединение(
            "api.external-system.com",
            443,
            ПолучитьЛогин(),
            ПолучитьПароль(),
            ,
            30, // Таймаут
            Новый ЗащищенноеСоединениеOpenSSL()
        );
        
        HTTPЗапрос = Новый HTTPЗапрос("/" + Метод);
        HTTPЗапрос.Заголовки.Вставить("Content-Type", "application/json");
        HTTPЗапрос.УстановитьТелоИзСтроки(ПараметрыВJSON(Параметры));
        
        HTTPОтвет = HTTPСоединение.ВызватьHTTPМетод("POST", HTTPЗапрос);
        
        Если HTTPОтвет.КодСостояния = 200 Тогда
            Возврат РазобратьОтветJSON(HTTPОтвет.ПолучитьТелоКакСтроку());
        Иначе
            ВызватьИсключение СтрШаблон(
                "Ошибка запроса: %1 - %2",
                HTTPОтвет.КодСостояния,
                HTTPОтвет.ПолучитьТелоКакСтроку()
            );
        КонецЕсли;
        
    Исключение
        ЗаписатьЛогОшибки(ОписаниеОшибки());
        ВызватьИсключение;
    КонецПопытки;
КонецФункции`;
            
            steps.push({ progress: 75, message: 'Добавление обработки ошибок...' });
            await new Promise(r => setTimeout(r, 800));
            
            finalResult = {
                code: apiCode,
                endpoints: 12,
                features: ['Retry логика', 'Логирование', 'Таймауты', 'SSL/TLS'],
                testCases: 24
            };
            
            steps.push({ 
                progress: 100, 
                message: '✅ API интеграция готова: 12 endpoint, retry логика, логирование',
                result: finalResult
            });
        }

        return new Response(JSON.stringify({
            data: {
                steps,
                finalResult
            }
        }), {
            headers: { ...corsHeaders, 'Content-Type': 'application/json' }
        });

    } catch (error) {
        console.error('Developer demo error:', error);

        return new Response(JSON.stringify({
            error: {
                code: 'DEVELOPER_DEMO_ERROR',
                message: error.message
            }
        }), {
            status: 500,
            headers: { ...corsHeaders, 'Content-Type': 'application/json' }
        });
    }
});