Deno.serve(async (req) => {
    const corsHeaders = {
        'Access-Control-Allow-Origin': '*',
        'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
        'Access-Control-Allow-Methods': 'POST, GET, OPTIONS',
        'Access-Control-Max-Age': '86400',
        'Access-Control-Allow-Credentials': 'false'
    };

    if (req.method === 'OPTIONS') {
        return new Response(null, { status: 200, headers: corsHeaders });
    }

    try {
        const { demoType, userQuery } = await req.json();

        const steps = [];
        let finalResult = {};

        if (demoType === 'custom') {
            // Пользовательский запрос
            steps.push({ progress: 10, message: 'Анализ вашего запроса...' });
            await new Promise(r => setTimeout(r, 500));
            
            steps.push({ progress: 30, message: 'Подготовка кода...' });
            await new Promise(r => setTimeout(r, 800));
            
            steps.push({ progress: 60, message: 'Генерация решения...' });
            await new Promise(r => setTimeout(r, 1000));
            
            steps.push({ progress: 90, message: 'Оптимизация и форматирование...' });
            await new Promise(r => setTimeout(r, 700));
            
            const queryLower = (userQuery || '').toLowerCase();
            let customCode = '';
            let customMessage = '';
            
            // Расширенный анализ запроса с множественными паттернами 1С разработки
            if (queryLower.includes('справочник') || queryLower.includes('catalog')) {
                customCode = `// Модуль справочника товаров\nПроцедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)\n    // Инициализация справочника\n    УстановитьПривилегированныйРежим(Истина);\n    \n    // Заполнение реквизитов по умолчанию\n    Если Объект.Ссылка.Пустая() Тогда\n        Объект.Артикул = ПолучитьНовыйАртикул();\n        Объект.ДатаСоздания = ТекущаяДата();\n    КонецЕсли;\n    \n    УстановитьПривилегированныйРежим(Ложь);\nКонецПроцедуры\n\nФункция ПолучитьНовыйАртикул()\n    Запрос = Новый Запрос;\n    Запрос.Текст = \n    \"ВЫБРАТЬ\n    |    МАКСИМУМ(Справочники.Товары.Код) КАК МаксКод\n    |ИЗ\n    |    Справочник.Товары\";\n    \n    Результат = Запрос.Выполнить();\n    Выборка = Результат.Выбрать();\n    \n    Если Выборка.Следующий() Тогда\n        Возврат Формат(Выборка.МаксКод + 1, \"ЧЦ=7; ЧВН=\");\n    Иначе\n        Возврат \"0000001\";\n    КонецЕсли;\nКонецФункции`;
                customMessage = `Анализ запроса: "${userQuery}"

Сгенерирован модуль справочника товаров:
• Автоматическая генерация артикулов с префиксом
• Инициализация при создании объекта
• Заполнение даты создания по умолчанию
• Использование привилегированного режима для безопасности`;
            } else if (queryLower.includes('запрос') || queryLower.includes('sql') || queryLower.includes('query')) {
                customCode = `// Оптимизированный запрос\nФункция ПолучитьОстаткиТоваров(Склад, ДатаНа = Неопределено)\n    Если ДатаНа = Неопределено Тогда\n        ДатаНа = ТекущаяДата();\n    КонецЕсли;\n    \n    Запрос = Новый Запрос;\n    Запрос.Текст = \n    \"ВЫБРАТЬ\n    |    ОстаткиТоваровОстатки.Товар,\n    |    ОстаткиТоваровОстатки.Склад,\n    |    ОстаткиТоваровОстатки.КоличествоОстаток КАК Количество\n    |ИЗ\n    |    РегистрНакопления.ОстаткиТоваров.Остатки(&ДатаНа, Склад = &Склад) КАК ОстаткиТоваровОстатки\n    |ГДЕ\n    |    ОстаткиТоваровОстатки.КоличествоОстаток > 0\n    |\n    |УПОРЯДОЧИТЬ ПО\n    |    Товар.Наименование\";\n    \n    Запрос.УстановитьПараметр(\"Склад\", Склад);\n    Запрос.УстановитьПараметр(\"ДатаНа\", ДатаНа);\n    \n    Возврат Запрос.Выполнить().Выгрузить();\nКонецФункции`;
                customMessage = `Анализ запроса: "${userQuery}"

Создан оптимизированный запрос для остатков товаров:
• Использование регистра накопления для точности данных
• Фильтрация по складу и дате
• Исключение нулевых остатков
• Сортировка по наименованию для удобства`;
            } else if (queryLower.includes('отчет') || queryLower.includes('report')) {
                customCode = `// Отчет по остаткам товаров\nПроцедура СформироватьОтчет()\n    ТабличныйДокумент = Новый ТабличныйДокумент;\n    Макет = ПолучитьМакет(\"Основной\");\n    \n    ОбластьЗаголовка = Макет.ПолучитьОбласть(\"Заголовок\");\n    ОбластьЗаголовка.Параметры.ДатаОтчета = ТекущаяДата();\n    ТабличныйДокумент.Вывести(ОбластьЗаголовка);\n    \n    Запрос = Новый Запрос;\n    Запрос.Текст = \"ВЫБРАТЬ Товары.Наименование, СУММА(Количество) КАК Количество...\";\n    Выборка = Запрос.Выполнить().Выбрать();\n    \n    ОбластьСтроки = Макет.ПолучитьОбласть(\"Строка\");\n    Пока Выборка.Следующий() Цикл\n        ОбластьСтроки.Параметры.Заполнить(Выборка);\n        ТабличныйДокумент.Вывести(ОбластьСтроки);\n    КонецЦикла;\nКонецПроцедуры`;
                customMessage = `Анализ запроса: "${userQuery}"

Сгенерирован модуль отчета:
• Использование табличного документа и макетов
• Запрос с группировкой данных
• Динамическое формирование строк
• Заполнение параметров из выборки`;
            } else if (queryLower.includes('обработк') || queryLower.includes('processing')) {
                customCode = `// Обработка массового изменения\nПроцедура ВыполнитьОбработку(Параметры)\n    НачатьТранзакцию();\n    Попытка\n        Запрос = Новый Запрос;\n        Запрос.Текст = \"ВЫБРАТЬ Ссылка ИЗ Справочник.Товары...\";\n        Выборка = Запрос.Выполнить().Выбрать();\n        \n        Пока Выборка.Следующий() Цикл\n            Объект = Выборка.Ссылка.ПолучитьОбъект();\n            // Изменение данных\n            Объект.Записать();\n        КонецЦикла;\n        \n        ЗафиксироватьТранзакцию();\n    Исключение\n        ОтменитьТранзакцию();\n        Сообщить(\"Ошибка: \" + ОписаниеОшибки());\n    КонецПопытки;\nКонецПроцедуры`;
                customMessage = `Анализ запроса: "${userQuery}"

Создана обработка массового изменения:
• Транзакционная обработка данных
• Массовое изменение объектов
• Обработка ошибок с откатом
• Автоматический учет изменений`;
            } else {
                customCode = `// Базовая функция обработки\nФункция ОбработатьДанные(Параметры)\n    Результат = Новый Структура;\n    Результат.Вставить(\"Успешно\", Истина);\n    Результат.Вставить(\"Сообщение\", \"Обработка завершена\");\n    \n    Попытка\n        // Основная логика\n        ВыполнитьОбработку(Параметры);\n    Исключение\n        Результат.Успешно = Ложь;\n        Результат.Сообщение = ОписаниеОшибки();\n    КонецПопытки;\n    \n    Возврат Результат;\nКонецФункции`;
                customMessage = `Анализ запроса: "${userQuery}"

Сгенерирован базовый шаблон функции:
• Структура результата с флагом успешности
• Блок обработки исключений Try-Catch
• Детальное логирование ошибок
• Универсальный паттерн для расширения функционала`;
            }
            
            finalResult = {
                message: customMessage,
                code: customCode,
                language: '1C',
                userQuery: userQuery
            };
            
            steps.push({ 
                progress: 100, 
                message: 'Код успешно сгенерирован!',
                result: finalResult
            });
            
        } else if (demoType === 'generate') {
            steps.push({ progress: 10, message: 'Запуск генерации кода...' });
            await new Promise(r => setTimeout(r, 500));
            
            steps.push({ progress: 25, message: 'Анализ требований к справочнику товаров...' });
            await new Promise(r => setTimeout(r, 1000));
            
            steps.push({ progress: 50, message: 'Генерация структуры модуля...' });
            await new Promise(r => setTimeout(r, 1200));
            
            const generatedCode = `// Справочник "Товары"
&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
    // Инициализация
    УстановитьВидимость();
    УстановитьДоступность();
    ЗаполнитьСписокВыбораЕдиницИзмерения();
КонецПроцедуры

&НаСервере
Процедура ПередЗаписьюНаСервере(Отказ, ТекущийОбъект, ПараметрыЗаписи)
    // Валидация
    Если Не ЗначениеЗаполнено(ТекущийОбъект.Наименование) Тогда
        Сообщить("Необходимо заполнить наименование товара");
        Отказ = Истина;
        Возврат;
    КонецЕсли;
    
    Если ТекущийОбъект.Цена < 0 Тогда
        Сообщить("Цена не может быть отрицательной");
        Отказ = Истина;
        Возврат;
    КонецЕсли;
    
    // Установка артикула, если не заполнен
    Если Не ЗначениеЗаполнено(ТекущийОбъект.Артикул) Тогда
        ТекущийОбъект.Артикул = ПолучитьНовыйАртикул();
    КонецЕсли;
КонецПроцедуры

&НаСервереБезКонтекста
Функция ПолучитьНовыйАртикул()
    Префикс = "TOV";
    Номер = Формат(Справочники.Товары.ПолучитьПоследнийНомер() + 1, "ЧЦ=6; ЧВН=");
    Возврат Префикс + Номер;
КонецФункции`;
            
            steps.push({ progress: 75, message: 'Создание обработчиков событий...' });
            await new Promise(r => setTimeout(r, 800));
            
            steps.push({ progress: 90, message: 'Добавление валидации и проверок...' });
            await new Promise(r => setTimeout(r, 600));
            
            finalResult = {
                code: generatedCode,
                linesOfCode: 245,
                functions: 8,
                testCoverage: '87%',
                complexity: 'Low'
            };
            
            steps.push({ 
                progress: 100, 
                message: '✅ Код сгенерирован: 245 строк, 8 функций, покрытие тестами 87%',
                result: finalResult
            });
            
        } else if (demoType === 'optimize') {
            steps.push({ progress: 10, message: 'Запуск оптимизации...' });
            await new Promise(r => setTimeout(r, 500));
            
            steps.push({ progress: 30, message: 'Анализ SQL запроса...' });
            await new Promise(r => setTimeout(r, 800));
            
            const originalQuery = `SELECT 
    Товары.Наименование,
    Товары.Артикул,
    ОстаткиТоваров.Количество
FROM Товары
LEFT JOIN ОстаткиТоваров ON Товары.Ссылка = ОстаткиТоваров.Товар
WHERE ОстаткиТоваров.Склад = &Склад
ORDER BY Товары.Наименование`;

            const optimizedQuery = `SELECT 
    Товары.Наименование,
    Товары.Артикул,
    ОстаткиТоваров.Количество
FROM Товары
INNER JOIN ОстаткиТоваров WITH(INDEX(IX_ОстаткиТоваров_Склад_Товар))
    ON Товары.Ссылка = ОстаткиТоваров.Товар
WHERE ОстаткиТоваров.Склад = &Склад
    AND ОстаткиТоваров.Количество > 0
ORDER BY Товары.Наименование`;
            
            steps.push({ 
                progress: 60, 
                message: 'Выявление узких мест: отсутствие индексов, N+1 запросы' 
            });
            await new Promise(r => setTimeout(r, 1000));
            
            steps.push({ progress: 85, message: 'Применение оптимизаций...' });
            await new Promise(r => setTimeout(r, 800));
            
            finalResult = {
                originalQuery,
                optimizedQuery,
                improvements: [
                    'Добавлен hint для использования индекса',
                    'INNER JOIN вместо LEFT JOIN (исключены NULL значения)',
                    'Добавлен фильтр Количество > 0',
                    'Оптимизирован порядок условий'
                ],
                performanceBefore: '3.2s',
                performanceAfter: '0.4s',
                speedup: '8x'
            };
            
            steps.push({ 
                progress: 100, 
                message: '✅ Производительность улучшена: с 3.2с до 0.4с (8x быстрее)',
                result: finalResult
            });
            
        } else if (demoType === 'api') {
            steps.push({ progress: 10, message: 'Запуск создания API интеграции...' });
            await new Promise(r => setTimeout(r, 500));
            
            steps.push({ progress: 25, message: 'Анализ спецификации API...' });
            await new Promise(r => setTimeout(r, 800));
            
            steps.push({ progress: 50, message: 'Генерация методов интеграции...' });
            await new Promise(r => setTimeout(r, 1000));
            
            const apiCode = `// HTTP-сервис для интеграции с внешней системой
&НаСервере
Функция ОтправитьЗапросВнешнейСистеме(Метод, Параметры)
    Попытка
        HTTPСоединение = Новый HTTPСоединение(
            "api.external-system.com",
            443,
            ПолучитьЛогин(),
            ПолучитьПароль(),
            ,
            30, // Таймаут
            Новый ЗащищенноеСоединениеOpenSSL()
        );
        
        HTTPЗапрос = Новый HTTPЗапрос("/" + Метод);
        HTTPЗапрос.Заголовки.Вставить("Content-Type", "application/json");
        HTTPЗапрос.УстановитьТелоИзСтроки(ПараметрыВJSON(Параметры));
        
        HTTPОтвет = HTTPСоединение.ВызватьHTTPМетод("POST", HTTPЗапрос);
        
        Если HTTPОтвет.КодСостояния = 200 Тогда
            Возврат РазобратьОтветJSON(HTTPОтвет.ПолучитьТелоКакСтроку());
        Иначе
            ВызватьИсключение СтрШаблон(
                "Ошибка запроса: %1 - %2",
                HTTPОтвет.КодСостояния,
                HTTPОтвет.ПолучитьТелоКакСтроку()
            );
        КонецЕсли;
        
    Исключение
        ЗаписатьЛогОшибки(ОписаниеОшибки());
        ВызватьИсключение;
    КонецПопытки;
КонецФункции`;
            
            steps.push({ progress: 75, message: 'Добавление обработки ошибок...' });
            await new Promise(r => setTimeout(r, 800));
            
            finalResult = {
                code: apiCode,
                endpoints: 12,
                features: ['Retry логика', 'Логирование', 'Таймауты', 'SSL/TLS'],
                testCases: 24
            };
            
            steps.push({ 
                progress: 100, 
                message: '✅ API интеграция готова: 12 endpoint, retry логика, логирование',
                result: finalResult
            });
        }

        return new Response(JSON.stringify({
            data: {
                steps,
                finalResult
            }
        }), {
            headers: { ...corsHeaders, 'Content-Type': 'application/json' }
        });

    } catch (error) {
        console.error('Developer demo error:', error);

        return new Response(JSON.stringify({
            error: {
                code: 'DEVELOPER_DEMO_ERROR',
                message: error.message
            }
        }), {
            status: 500,
            headers: { ...corsHeaders, 'Content-Type': 'application/json' }
        });
    }
});
