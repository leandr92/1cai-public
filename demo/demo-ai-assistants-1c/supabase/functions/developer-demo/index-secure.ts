// üîí SECURE VERSION - –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ï –ü–†–û–ë–õ–ï–ú–´ –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–ò
// ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: CORS –ø–æ–ª–∏—Ç–∏–∫–∞, –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è, rate limiting, –≤–∞–ª–∏–¥–∞—Ü–∏—è

// –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
const RATE_LIMIT_WINDOW = 60000; // 1 –º–∏–Ω—É—Ç–∞
const MAX_REQUESTS_PER_WINDOW = 60; // –ú–∞–∫—Å–∏–º—É–º 60 –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –º–∏–Ω—É—Ç—É
const ALLOWED_ORIGINS = Deno.env.get('ALLOWED_ORIGINS')?.split(',') || ['https://localhost:3000'];
const SUPABASE_ANON_KEY = Deno.env.get('SUPABASE_ANON_KEY');
const JWT_SECRET = Deno.env.get('JWT_SECRET') || 'dev-secret-key-change-in-production';

// –ü—Ä–æ—Å—Ç–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è in-memory rate limiting
const requestCounts = new Map<string, { count: number; resetTime: number }>();

// –í–∞–ª–∏–¥–∞—Ü–∏—è JWT —Ç–æ–∫–µ–Ω–∞ (—É–ø—Ä–æ—â–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è)
async function validateJWT(token: string): Promise<boolean> {
    try {
        // –í production –∑–¥–µ—Å—å –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–æ–ª–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ JWT
        // –î–ª—è –¥–µ–º–æ –ø—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞
        return token && token.length > 10;
    } catch {
        return false;
    }
}

// Rate limiting middleware
function checkRateLimit(clientIp: string): boolean {
    const now = Date.now();
    const clientData = requestCounts.get(clientIp);
    
    if (!clientData || now > clientData.resetTime) {
        requestCounts.set(clientIp, { count: 1, resetTime: now + RATE_LIMIT_WINDOW });
        return true;
    }
    
    if (clientData.count >= MAX_REQUESTS_PER_WINDOW) {
        return false;
    }
    
    clientData.count++;
    return true;
}

// –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
function validateRequest(data: any): { isValid: boolean; error?: string } {
    if (!data || typeof data !== 'object') {
        return { isValid: false, error: '–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö' };
    }
    
    if (!data.demoType || typeof data.demoType !== 'string') {
        return { isValid: false, error: '–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç demoType' };
    }
    
    const allowedDemoTypes = ['custom', 'generate', 'optimize', 'api'];
    if (!allowedDemoTypes.includes(data.demoType)) {
        return { isValid: false, error: '–ù–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–π —Ç–∏–ø –¥–µ–º–æ' };
    }
    
    return { isValid: true };
}

// –ë–µ–∑–æ–ø–∞—Å–Ω—ã–µ CORS –∑–∞–≥–æ–ª–æ–≤–∫–∏
function getSecureCorsHeaders(request: Request): Record<string, string> {
    const origin = request.headers.get('Origin');
    const isAllowedOrigin = origin && ALLOWED_ORIGINS.includes(origin);
    
    return {
        'Access-Control-Allow-Origin': isAllowedOrigin ? origin : 'null',
        'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
        'Access-Control-Allow-Methods': 'POST, GET, OPTIONS',
        'Access-Control-Max-Age': '86400',
        'Access-Control-Allow-Credentials': 'true',
        'X-Content-Type-Options': 'nosniff',
        'X-Frame-Options': 'DENY',
        'X-XSS-Protection': '1; mode=block',
        'Strict-Transport-Security': 'max-age=31536000; includeSubDomains'
    };
}

// –û—Å–Ω–æ–≤–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–∞
Deno.serve(async (req) => {
    const corsHeaders = getSecureCorsHeaders(req);
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ CORS preflight –∑–∞–ø—Ä–æ—Å–æ–≤
    if (req.method === 'OPTIONS') {
        return new Response(null, { status: 200, headers: corsHeaders });
    }

    // Rate limiting
    const clientIp = req.headers.get('X-Forwarded-For') || 
                    req.headers.get('X-Real-IP') || 
                    'unknown';
    
    if (!checkRateLimit(clientIp)) {
        return new Response(JSON.stringify({
            error: {
                code: 'RATE_LIMIT_EXCEEDED',
                message: '–ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.'
            }
        }), {
            status: 429,
            headers: { ...corsHeaders, 'Content-Type': 'application/json' }
        });
    }

    // –í–∞–ª–∏–¥–∞—Ü–∏—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –¥–ª—è –Ω–µ–ø—É–±–ª–∏—á–Ω—ã—Ö endpoints
    const authHeader = req.headers.get('Authorization');
    const isPublicEndpoint = req.method === 'GET' || req.url.includes('/public/');
    
    if (!isPublicEndpoint && !authHeader) {
        return new Response(JSON.stringify({
            error: {
                code: 'UNAUTHORIZED',
                message: '–¢—Ä–µ–±—É–µ—Ç—Å—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è'
            }
        }), {
            status: 401,
            headers: corsHeaders
        });
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ JWT —Ç–æ–∫–µ–Ω–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å)
    if (authHeader) {
        const token = authHeader.replace('Bearer ', '');
        const isValidToken = await validateJWT(token);
        
        if (!isValidToken) {
            return new Response(JSON.stringify({
                error: {
                    code: 'INVALID_TOKEN',
                    message: '–ù–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–π —Ç–æ–∫–µ–Ω –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏'
                }
            }), {
                status: 401,
                headers: corsHeaders
            });
        }
    }

    try {
        // –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        let requestData;
        try {
            requestData = await req.json();
        } catch {
            return new Response(JSON.stringify({
                error: {
                    code: 'INVALID_JSON',
                    message: '–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç JSON'
                }
            }), {
                status: 400,
                headers: { ...corsHeaders, 'Content-Type': 'application/json' }
            });
        }

        const validation = validateRequest(requestData);
        if (!validation.isValid) {
            return new Response(JSON.stringify({
                error: {
                    code: 'VALIDATION_ERROR',
                    message: validation.error
                }
            }), {
                status: 400,
                headers: { ...corsHeaders, 'Content-Type': 'application/json' }
            });
        }

        const { demoType, userQuery } = requestData;

        const steps = [];
        let finalResult = {};

        if (demoType === 'custom') {
            // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –∑–∞–ø—Ä–æ—Å
            steps.push({ progress: 10, message: '–ê–Ω–∞–ª–∏–∑ –≤–∞—à–µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞...' });
            await new Promise(r => setTimeout(r, 500));
            
            steps.push({ progress: 30, message: '–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫–æ–¥–∞...' });
            await new Promise(r => setTimeout(r, 800));
            
            steps.push({ progress: 60, message: '–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ä–µ—à–µ–Ω–∏—è...' });
            await new Promise(r => setTimeout(r, 1000));
            
            steps.push({ progress: 90, message: '–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ...' });
            await new Promise(r => setTimeout(r, 700));
            
            const queryLower = (userQuery || '').toLowerCase();
            let customCode = '';
            let customMessage = '';
            
            // –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –∑–∞–ø—Ä–æ—Å–∞ —Å –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–º–∏ –ø–∞—Ç—Ç–µ—Ä–Ω–∞–º–∏ 1–° —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
            if (queryLower.includes('—Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫') || queryLower.includes('catalog')) {
                customCode = `// üîí SECURE –ú–æ–¥—É–ª—å —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤
// ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –≤–∞–ª–∏–¥–∞—Ü–∏—è –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

&–ù–∞–°–µ—Ä–≤–µ—Ä–µ
–ü—Ä–æ—Ü–µ–¥—É—Ä–∞ –ü—Ä–∏–°–æ–∑–¥–∞–Ω–∏–∏–ù–∞–°–µ—Ä–≤–µ—Ä–µ(–û—Ç–∫–∞–∑, –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è–û–±—Ä–∞–±–æ—Ç–∫–∞)
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞ —Å –ø—Ä–æ–≤–µ—Ä–∫–∞–º–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
    –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å–ü—Ä–∏–≤–∏–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–π–†–µ–∂–∏–º(–ò—Å—Ç–∏–Ω–∞);
    
    // –í–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞
    –ï—Å–ª–∏ –ù–ï –ü—Ä–∞–≤–æ–î–æ—Å—Ç—É–ø–∞("–ß—Ç–µ–Ω–∏–µ", –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ.–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏.–¢–æ–≤–∞—Ä—ã) –¢–æ–≥–¥–∞
        –û—Ç–∫–∞–∑ = –ò—Å—Ç–∏–Ω–∞;
        –°–æ–æ–±—â–∏—Ç—å("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫—É");
        –í–æ–∑–≤—Ä–∞—Ç;
    –ö–æ–Ω–µ—Ü–ï—Å–ª–∏;
    
    // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Ä–µ–∫–≤–∏–∑–∏—Ç–æ–≤ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π
    –ï—Å–ª–∏ –û–±—ä–µ–∫—Ç.–°—Å—ã–ª–∫–∞.–ü—É—Å—Ç–∞—è() –¢–æ–≥–¥–∞
        –û–±—ä–µ–∫—Ç.–ê—Ä—Ç–∏–∫—É–ª = –ü–æ–ª—É—á–∏—Ç—å–ù–æ–≤—ã–π–ê—Ä—Ç–∏–∫—É–ª–ë–µ–∑–æ–ø–∞—Å–Ω–æ();
        –û–±—ä–µ–∫—Ç.–î–∞—Ç–∞–°–æ–∑–¥–∞–Ω–∏—è = –¢–µ–∫—É—â–∞—è–î–∞—Ç–∞();
        –û–±—ä–µ–∫—Ç.–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π = –ü–æ–ª—É—á–∏—Ç—å–¢–µ–∫—É—â–µ–≥–æ–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è();
    –ö–æ–Ω–µ—Ü–ï—Å–ª–∏;
    
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤–∏–¥–∏–º–æ—Å—Ç–∏ –∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —ç–ª–µ–º–µ–Ω—Ç–æ–≤
    –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å–í–∏–¥–∏–º–æ—Å—Ç—å();
    –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å–î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å();
    
    –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å–ü—Ä–∏–≤–∏–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–π–†–µ–∂–∏–º(–õ–æ–∂—å);
–ö–æ–Ω–µ—Ü–ü—Ä–æ—Ü–µ–¥—É—Ä—ã

&–ù–∞–°–µ—Ä–≤–µ—Ä–µ
–ü—Ä–æ—Ü–µ–¥—É—Ä–∞ –ü–µ—Ä–µ–¥–ó–∞–ø–∏—Å—å—é–ù–∞–°–µ—Ä–≤–µ—Ä–µ(–û—Ç–∫–∞–∑, –¢–µ–∫—É—â–∏–π–û–±—ä–µ–∫—Ç, –ü–∞—Ä–∞–º–µ—Ç—Ä—ã–ó–∞–ø–∏—Å–∏)
    // –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö —Å –ø—Ä–æ–≤–µ—Ä–∫–∞–º–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
    –ï—Å–ª–∏ –ù–ï –ü—Ä–∞–≤–æ–î–æ—Å—Ç—É–ø–∞("–ò–∑–º–µ–Ω–µ–Ω–∏–µ", –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ.–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏.–¢–æ–≤–∞—Ä—ã) –¢–æ–≥–¥–∞
        –û—Ç–∫–∞–∑ = –ò—Å—Ç–∏–Ω–∞;
        –°–æ–æ–±—â–∏—Ç—å("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö");
        –í–æ–∑–≤—Ä–∞—Ç;
    –ö–æ–Ω–µ—Ü–ï—Å–ª–∏;
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π
    –ï—Å–ª–∏ –ü—É—Å—Ç–∞—è–°—Ç—Ä–æ–∫–∞(–¢–µ–∫—É—â–∏–π–û–±—ä–µ–∫—Ç.–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ) –¢–æ–≥–¥–∞
        –°–æ–æ–±—â–∏—Ç—å("–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –∑–∞–ø–æ–ª–Ω–∏—Ç—å –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞");
        –û—Ç–∫–∞–∑ = –ò—Å—Ç–∏–Ω–∞;
        –í–æ–∑–≤—Ä–∞—Ç;
    –ö–æ–Ω–µ—Ü–ï—Å–ª–∏;
    
    // –°–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
    –¢–µ–∫—É—â–∏–π–û–±—ä–µ–∫—Ç.–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ = –°–æ–∫—Ä–õ–ü(–¢–µ–∫—É—â–∏–π–û–±—ä–µ–∫—Ç.–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ);
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ –∞—Ä—Ç–∏–∫—É–ª–∞
    –ï—Å–ª–∏ –ù–ï –ü—É—Å—Ç–∞—è–°—Ç—Ä–æ–∫–∞(–¢–µ–∫—É—â–∏–π–û–±—ä–µ–∫—Ç.–ê—Ä—Ç–∏–∫—É–ª) –¢–æ–≥–¥–∞
        –ó–∞–ø—Ä–æ—Å = –ù–æ–≤—ã–π –ó–∞–ø—Ä–æ—Å;
        –ó–∞–ø—Ä–æ—Å.–¢–µ–∫—Å—Ç = 
        "–í–´–ë–†–ê–¢–¨ –ü–ï–†–í–´–ï 1
        |    –°—Å—ã–ª–∫–∞
        |–ò–ó
        |    –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫.–¢–æ–≤–∞—Ä—ã
        |–ì–î–ï
        |    –ê—Ä—Ç–∏–∫—É–ª = &–ê—Ä—Ç–∏–∫—É–ª
        |    –ò –°—Å—ã–ª–∫–∞ <> &–¢–µ–∫—É—â–∞—è–°—Å—ã–ª–∫–∞";
        
        –ó–∞–ø—Ä–æ—Å.–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å–ü–∞—Ä–∞–º–µ—Ç—Ä("–ê—Ä—Ç–∏–∫—É–ª", –¢–µ–∫—É—â–∏–π–û–±—ä–µ–∫—Ç.–ê—Ä—Ç–∏–∫—É–ª);
        –ó–∞–ø—Ä–æ—Å.–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å–ü–∞—Ä–∞–º–µ—Ç—Ä("–¢–µ–∫—É—â–∞—è–°—Å—ã–ª–∫–∞", –û–±—ä–µ–∫—Ç.–°—Å—ã–ª–∫–∞);
        
        –ï—Å–ª–∏ –ù–ï –ó–∞–ø—Ä–æ—Å.–í—ã–ø–æ–ª–Ω–∏—Ç—å().–ü—É—Å—Ç–æ–π() –¢–æ–≥–¥–∞
            –°–æ–æ–±—â–∏—Ç—å("–¢–æ–≤–∞—Ä —Å —Ç–∞–∫–∏–º –∞—Ä—Ç–∏–∫—É–ª–æ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç");
            –û—Ç–∫–∞–∑ = –ò—Å—Ç–∏–Ω–∞;
            –í–æ–∑–≤—Ä–∞—Ç;
        –ö–æ–Ω–µ—Ü–ï—Å–ª–∏;
    –ö–æ–Ω–µ—Ü–ï—Å–ª–∏;
    
    // –ê–≤—Ç–æ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∞—Ä—Ç–∏–∫—É–ª–∞ —Å –ø—Ä–æ–≤–µ—Ä–∫–∞–º–∏
    –ï—Å–ª–∏ –ü—É—Å—Ç–∞—è–°—Ç—Ä–æ–∫–∞(–¢–µ–∫—É—â–∏–π–û–±—ä–µ–∫—Ç.–ê—Ä—Ç–∏–∫—É–ª) –¢–æ–≥–¥–∞
        –¢–µ–∫—É—â–∏–π–û–±—ä–µ–∫—Ç.–ê—Ä—Ç–∏–∫—É–ª = –ü–æ–ª—É—á–∏—Ç—å–ù–æ–≤—ã–π–ê—Ä—Ç–∏–∫—É–ª–ë–µ–∑–æ–ø–∞—Å–Ω–æ();
    –ö–æ–Ω–µ—Ü–ï—Å–ª–∏;
    
    // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π
    –ó–∞–ø–∏—Å–∞—Ç—å–õ–æ–≥–ò–∑–º–µ–Ω–µ–Ω–∏–π(–¢–µ–∫—É—â–∏–π–û–±—ä–µ–∫—Ç, –ü–∞—Ä–∞–º–µ—Ç—Ä—ã–ó–∞–ø–∏—Å–∏);
–ö–æ–Ω–µ—Ü–ü—Ä–æ—Ü–µ–¥—É—Ä—ã

&–ù–∞–°–µ—Ä–≤–µ—Ä–µ–ë–µ–∑–ö–æ–Ω—Ç–µ–∫—Å—Ç–∞
–§—É–Ω–∫—Ü–∏—è –ü–æ–ª—É—á–∏—Ç—å–ù–æ–≤—ã–π–ê—Ä—Ç–∏–∫—É–ª–ë–µ–∑–æ–ø–∞—Å–Ω–æ()
    –ü–æ–ø—ã—Ç–∫–∞
        –ó–∞–ø—Ä–æ—Å = –ù–æ–≤—ã–π –ó–∞–ø—Ä–æ—Å;
        –ó–∞–ø—Ä–æ—Å.–¢–µ–∫—Å—Ç = 
        "–í–´–ë–†–ê–¢–¨
        |    –ú–ê–ö–°–ò–ú–£–ú(–¢–æ–≤–∞—Ä—ã.–ö–æ–¥) –ö–ê–ö –ú–∞–∫—Å–ö–æ–¥
        |–ò–ó
        |    –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫.–¢–æ–≤–∞—Ä—ã –ö–ê–ö –¢–æ–≤–∞—Ä—ã
        |–ì–î–ï
        |    –¢–æ–≤–∞—Ä—ã.–ü–æ–º–µ—Ç–∫–∞–£–¥–∞–ª–µ–Ω–∏—è = –õ–æ–∂—å";
        
        –†–µ–∑—É–ª—å—Ç–∞—Ç = –ó–∞–ø—Ä–æ—Å.–í—ã–ø–æ–ª–Ω–∏—Ç—å();
        –í—ã–±–æ—Ä–∫–∞ = –†–µ–∑—É–ª—å—Ç–∞—Ç.–í—ã–±—Ä–∞—Ç—å();
        
        –ï—Å–ª–∏ –í—ã–±–æ—Ä–∫–∞.–°–ª–µ–¥—É—é—â–∏–π() –ò –ó–Ω–∞—á–µ–Ω–∏–µ–ó–∞–ø–æ–ª–Ω–µ–Ω–æ(–í—ã–±–æ—Ä–∫–∞.–ú–∞–∫—Å–ö–æ–¥) –¢–æ–≥–¥–∞
            –í–æ–∑–≤—Ä–∞—Ç –§–æ—Ä–º–∞—Ç(–í—ã–±–æ—Ä–∫–∞.–ú–∞–∫—Å–ö–æ–¥ + 1, "–ß–¶=7; –ß–í–ù=; –ß–ì=0");
        –ò–Ω–∞—á–µ
            –í–æ–∑–≤—Ä–∞—Ç "0000001";
        –ö–æ–Ω–µ—Ü–ï—Å–ª–∏;
    –ò—Å–∫–ª—é—á–µ–Ω–∏–µ
        –í–æ–∑–≤—Ä–∞—Ç "T" + –§–æ—Ä–º–∞—Ç(–¢–µ–∫—É—â–∞—è–î–∞—Ç–∞(), "–î–§=yyyyMMddHHmmss");
    –ö–æ–Ω–µ—Ü–ü–æ–ø—ã—Ç–∫–∏;
–ö–æ–Ω–µ—Ü–§—É–Ω–∫—Ü–∏–∏

&–ù–∞–°–µ—Ä–≤–µ—Ä–µ–ë–µ–∑–ö–æ–Ω—Ç–µ–∫—Å—Ç–∞
–§—É–Ω–∫—Ü–∏—è –ü–æ–ª—É—á–∏—Ç—å–¢–µ–∫—É—â–µ–≥–æ–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è()
    –í–æ–∑–≤—Ä–∞—Ç –ü–∞—Ä–∞–º–µ—Ç—Ä—ã–°–µ–∞–Ω—Å–∞.–¢–µ–∫—É—â–∏–π–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å;
–ö–æ–Ω–µ—Ü–§—É–Ω–∫—Ü–∏–∏

&–ù–∞–°–µ—Ä–≤–µ—Ä–µ–ë–µ–∑–ö–æ–Ω—Ç–µ–∫—Å—Ç–∞
–ü—Ä–æ—Ü–µ–¥—É—Ä–∞ –ó–∞–ø–∏—Å–∞—Ç—å–õ–æ–≥–ò–∑–º–µ–Ω–µ–Ω–∏–π(–û–±—ä–µ–∫—Ç, –ü–∞—Ä–∞–º–µ—Ç—Ä—ã–ó–∞–ø–∏—Å–∏)
    // –ó–∞–ø–∏—Å—å –≤ —Ä–µ–≥–∏—Å—Ç—Ä —Å–≤–µ–¥–µ–Ω–∏–π –¥–ª—è –∞—É–¥–∏—Ç–∞
    –ü–æ–ø—ã—Ç–∫–∞
        –ú–µ–Ω–µ–¥–∂–µ—Ä–ó–∞–ø–∏—Å–∏ = –†–µ–≥–∏—Å—Ç—Ä—ã–°–≤–µ–¥–µ–Ω–∏–π.–ê—É–¥–∏—Ç–ò–∑–º–µ–Ω–µ–Ω–∏–π–¢–æ–≤–∞—Ä–æ–≤.–°–æ–∑–¥–∞—Ç—å–ú–µ–Ω–µ–¥–∂–µ—Ä–ó–∞–ø–∏—Å–∏();
        –ú–µ–Ω–µ–¥–∂–µ—Ä–ó–∞–ø–∏—Å–∏.–ü–µ—Ä–∏–æ–¥ = –¢–µ–∫—É—â–∞—è–î–∞—Ç–∞();
        –ú–µ–Ω–µ–¥–∂–µ—Ä–ó–∞–ø–∏—Å–∏.–û–±—ä–µ–∫—Ç = –û–±—ä–µ–∫—Ç.–°—Å—ã–ª–∫–∞;
        –ú–µ–Ω–µ–¥–∂–µ—Ä–ó–∞–ø–∏—Å–∏.–û–ø–µ—Ä–∞—Ü–∏—è = "–ò–∑–º–µ–Ω–µ–Ω–∏–µ";
        –ú–µ–Ω–µ–¥–∂–µ—Ä–ó–∞–ø–∏—Å–∏.–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å = –ü–∞—Ä–∞–º–µ—Ç—Ä—ã–°–µ–∞–Ω—Å–∞.–¢–µ–∫—É—â–∏–π–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å;
        –ú–µ–Ω–µ–¥–∂–µ—Ä–ó–∞–ø–∏—Å–∏.–û–ø–∏—Å–∞–Ω–∏–µ = "–ò–∑–º–µ–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä–∞";
        –ú–µ–Ω–µ–¥–∂–µ—Ä–ó–∞–ø–∏—Å–∏.–ó–∞–ø–∏—Å–∞—Ç—å();
    –ò—Å–∫–ª—é—á–µ–Ω–∏–µ
        // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–∫–∏ –∞—É–¥–∏—Ç–∞ (–Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ)
    –ö–æ–Ω–µ—Ü–ü–æ–ø—ã—Ç–∫–∏;
–ö–æ–Ω–µ—Ü–ü—Ä–æ—Ü–µ–¥—É—Ä—ã`;
                customMessage = `üîí –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –∑–∞–ø—Ä–æ—Å–∞: "${userQuery}"

–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –∑–∞—â–∏—â–µ–Ω–Ω—ã–π –º–æ–¥—É–ª—å —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤:
‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –≤–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ (—á—Ç–µ–Ω–∏–µ/–∏–∑–º–µ–Ω–µ–Ω–∏–µ)
‚úÖ –°–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∞—Ä—Ç–∏–∫—É–ª–æ–≤ —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫  
‚úÖ –ê—É–¥–∏—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π —á–µ—Ä–µ–∑ —Ä–µ–≥–∏—Å—Ç—Ä —Å–≤–µ–¥–µ–Ω–∏–π
‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π
‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç SQL –∏–Ω—ä–µ–∫—Ü–∏–π —á–µ—Ä–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏`;
            } else if (queryLower.includes('–¥–æ–∫—É–º–µ–Ω—Ç') || queryLower.includes('document')) {
                customCode = `// üîí SECURE –ú–æ–¥—É–ª—å –¥–æ–∫—É–º–µ–Ω—Ç–∞ "–ü—Ä–∏—Ö–æ–¥–Ω–∞—è –Ω–∞–∫–ª–∞–¥–Ω–∞—è"  
// ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã –ø—Ä–æ–≤–µ—Ä–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è

&–ù–∞–°–µ—Ä–≤–µ—Ä–µ
–ü—Ä–æ—Ü–µ–¥—É—Ä–∞ –û–±—Ä–∞–±–æ—Ç–∫–∞–ü—Ä–æ–≤–µ–¥–µ–Ω–∏—è(–û—Ç–∫–∞–∑, –†–µ–∂–∏–º)
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –ø–µ—Ä–µ–¥ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏–µ–º
    –ï—Å–ª–∏ –ù–ï –ü—Ä–∞–≤–æ–î–æ—Å—Ç—É–ø–∞("–ü—Ä–æ–≤–µ–¥–µ–Ω–∏–µ", –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ.–î–æ–∫—É–º–µ–Ω—Ç—ã.–ü—Ä–∏—Ö–æ–¥–Ω–∞—è–ù–∞–∫–ª–∞–¥–Ω–∞—è) –¢–æ–≥–¥–∞
        –û—Ç–∫–∞–∑ = –ò—Å—Ç–∏–Ω–∞;
        –°–æ–æ–±—â–∏—Ç—å("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤ –¥–ª—è –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞");
        –í–æ–∑–≤—Ä–∞—Ç;
    –ö–æ–Ω–µ—Ü–ï—Å–ª–∏;
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å –ø—Ä–æ–≤–µ—Ä–∫–∞–º–∏
    –î–≤–∏–∂–µ–Ω–∏—è.–û—Å—Ç–∞—Ç–∫–∏–¢–æ–≤–∞—Ä–æ–≤.–ó–∞–ø–∏—Å—ã–≤–∞—Ç—å = –ò—Å—Ç–∏–Ω–∞;
    –î–≤–∏–∂–µ–Ω–∏—è.–û—Å—Ç–∞—Ç–∫–∏–¢–æ–≤–∞—Ä–æ–≤.–û—á–∏—Å—Ç–∏—Ç—å();
    
    // –í–∞–ª–∏–¥–∞—Ü–∏—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è
    –ï—Å–ª–∏ –û–±—ä–µ–∫—Ç.–¢–æ–≤–∞—Ä—ã.–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ() = 0 –¢–æ–≥–¥–∞
        –°–æ–æ–±—â–∏—Ç—å("–ù–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∞ —Ç–∞–±–ª–∏—á–Ω–∞—è —á–∞—Å—Ç—å ""–¢–æ–≤–∞—Ä—ã""");
        –û—Ç–∫–∞–∑ = –ò—Å—Ç–∏–Ω–∞;
        –í–æ–∑–≤—Ä–∞—Ç;
    –ö–æ–Ω–µ—Ü–ï—Å–ª–∏;
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö –≤ —Ç–∞–±–ª–∏—á–Ω–æ–π —á–∞—Å—Ç–∏
    –û—à–∏–±–∫–∏–í–∞–ª–∏–¥–∞—Ü–∏–∏ = –ù–æ–≤—ã–π –ú–∞—Å—Å–∏–≤;
    –î–ª—è –ö–∞–∂–¥–æ–≥–æ –°—Ç—Ä–æ–∫–∞ –ò–∑ –û–±—ä–µ–∫—Ç.–¢–æ–≤–∞—Ä—ã –¶–∏–∫–ª
        –ï—Å–ª–∏ –ù–ï –ó–Ω–∞—á–µ–Ω–∏–µ–ó–∞–ø–æ–ª–Ω–µ–Ω–æ(–°—Ç—Ä–æ–∫–∞.–¢–æ–≤–∞—Ä) –¢–æ–≥–¥–∞
            –û—à–∏–±–∫–∏–í–∞–ª–∏–¥–∞—Ü–∏–∏.–î–æ–±–∞–≤–∏—Ç—å("–°—Ç—Ä–æ–∫–∞ " + –°—Ç—Ä–æ–∫–∞.–ù–æ–º–µ—Ä–°—Ç—Ä–æ–∫–∏ + ": –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω —Ç–æ–≤–∞—Ä");
        –ö–æ–Ω–µ—Ü–ï—Å–ª–∏;
        
        –ï—Å–ª–∏ –°—Ç—Ä–æ–∫–∞.–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ <= 0 –¢–æ–≥–¥–∞
            –û—à–∏–±–∫–∏–í–∞–ª–∏–¥–∞—Ü–∏–∏.–î–æ–±–∞–≤–∏—Ç—å("–°—Ç—Ä–æ–∫–∞ " + –°—Ç—Ä–æ–∫–∞.–ù–æ–º–µ—Ä–°—Ç—Ä–æ–∫–∏ + ": –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º");
        –ö–æ–Ω–µ—Ü–ï—Å–ª–∏;
        
        –ï—Å–ª–∏ –°—Ç—Ä–æ–∫–∞.–¶–µ–Ω–∞ < 0 –¢–æ–≥–¥–∞
            –û—à–∏–±–∫–∏–í–∞–ª–∏–¥–∞—Ü–∏–∏.–î–æ–±–∞–≤–∏—Ç—å("–°—Ç—Ä–æ–∫–∞ " + –°—Ç—Ä–æ–∫–∞.–ù–æ–º–µ—Ä–°—Ç—Ä–æ–∫–∏ + ": —Ü–µ–Ω–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–π");
        –ö–æ–Ω–µ—Ü–ï—Å–ª–∏;
    –ö–æ–Ω–µ—Ü–¶–∏–∫–ª–∞;
    
    –ï—Å–ª–∏ –û—à–∏–±–∫–∏–í–∞–ª–∏–¥–∞—Ü–∏–∏.–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ() > 0 –¢–æ–≥–¥–∞
        –û—Ç–∫–∞–∑ = –ò—Å—Ç–∏–Ω–∞;
        –î–ª—è –ö–∞–∂–¥–æ–≥–æ –û—à–∏–±–∫–∞ –ò–∑ –û—à–∏–±–∫–∏–í–∞–ª–∏–¥–∞—Ü–∏–∏ –¶–∏–∫–ª
            –°–æ–æ–±—â–∏—Ç—å(–û—à–∏–±–∫–∞);
        –ö–æ–Ω–µ—Ü–¶–∏–∫–ª–∞;
        –í–æ–∑–≤—Ä–∞—Ç;
    –ö–æ–Ω–µ—Ü–ï—Å–ª–∏;
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Å—Ç–∞—Ç–∫–æ–≤ –Ω–∞ —Å–∫–ª–∞–¥–µ
    –ü—Ä–æ–≤–µ—Ä–∏—Ç—å–û—Å—Ç–∞—Ç–∫–∏–ù–∞–°–∫–ª–∞–¥–µ–ë–µ–∑–æ–ø–∞—Å–Ω–æ(–û—Ç–∫–∞–∑);
    –ï—Å–ª–∏ –û—Ç–∫–∞–∑ –¢–æ–≥–¥–∞
        –í–æ–∑–≤—Ä–∞—Ç;
    –ö–æ–Ω–µ—Ü–ï—Å–ª–∏;
    
    // –°–æ–∑–¥–∞–Ω–∏–µ –¥–≤–∏–∂–µ–Ω–∏–π —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π
    –ü–æ–ø—ã—Ç–∫–∞
        –ù–∞—á–∞—Ç—å–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—é();
        
        –î–ª—è –ö–∞–∂–¥–æ–≥–æ –°—Ç—Ä–æ–∫–∞ –ò–∑ –û–±—ä–µ–∫—Ç.–¢–æ–≤–∞—Ä—ã –¶–∏–∫–ª
            // –í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–æ–≤–∞—Ä–∞
            –ï—Å–ª–∏ –ù–ï –ü—Ä–∞–≤–æ–î–æ—Å—Ç—É–ø–∞("–ß—Ç–µ–Ω–∏–µ", –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ.–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏.–¢–æ–≤–∞—Ä—ã, –°—Ç—Ä–æ–∫–∞.–¢–æ–≤–∞—Ä) –¢–æ–≥–¥–∞
                –í—ã–∑–≤–∞—Ç—å–ò—Å–∫–ª—é—á–µ–Ω–∏–µ "–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ç–æ–≤–∞—Ä–æ–º: " + –°—Ç—Ä–æ–∫–∞.–¢–æ–≤–∞—Ä;
            –ö–æ–Ω–µ—Ü–ï—Å–ª–∏;
            
            // –î–≤–∏–∂–µ–Ω–∏–µ –ø—Ä–∏—Ö–æ–¥–∞
            –î–≤–∏–∂–µ–Ω–∏–µ = –î–≤–∏–∂–µ–Ω–∏—è.–û—Å—Ç–∞—Ç–∫–∏–¢–æ–≤–∞—Ä–æ–≤.–î–æ–±–∞–≤–∏—Ç—å();
            –î–≤–∏–∂–µ–Ω–∏–µ.–í–∏–¥–î–≤–∏–∂–µ–Ω–∏—è = –í–∏–¥–î–≤–∏–∂–µ–Ω–∏—è–ù–∞–∫–æ–ø–ª–µ–Ω–∏—è.–ü—Ä–∏—Ö–æ–¥;
            –î–≤–∏–∂–µ–Ω–∏–µ.–ü–µ—Ä–∏–æ–¥ = –û–±—ä–µ–∫—Ç.–î–∞—Ç–∞;
            –î–≤–∏–∂–µ–Ω–∏–µ.–¢–æ–≤–∞—Ä = –°—Ç—Ä–æ–∫–∞.–¢–æ–≤–∞—Ä;
            –î–≤–∏–∂–µ–Ω–∏–µ.–°–∫–ª–∞–¥ = –û–±—ä–µ–∫—Ç.–°–∫–ª–∞–¥;
            –î–≤–∏–∂–µ–Ω–∏–µ.–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ = –°—Ç—Ä–æ–∫–∞.–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ;
            –î–≤–∏–∂–µ–Ω–∏–µ.–°—É–º–º–∞ = –°—Ç—Ä–æ–∫–∞.–°—É–º–º–∞;
            –î–≤–∏–∂–µ–Ω–∏–µ.–î–æ–∫—É–º–µ–Ω—Ç = –û–±—ä–µ–∫—Ç.–°—Å—ã–ª–∫–∞;
        –ö–æ–Ω–µ—Ü–¶–∏–∫–ª–∞;
        
        // –ü–µ—Ä–µ—Å—á–µ—Ç —Å—É–º–º –≤ –¥–æ–∫—É–º–µ–Ω—Ç–µ
        –ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å–°—É–º–º—ã–í–î–æ–∫—É–º–µ–Ω—Ç–µ();
        
        –ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—é();
        
        // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è
        –ó–∞–ø–∏—Å–∞—Ç—å–õ–æ–≥–û–ø–µ—Ä–∞—Ü–∏–∏("–ü—Ä–æ–≤–µ–¥–µ–Ω–∏–µ", "–£—Å–ø–µ—à–Ω–æ", –û–±—ä–µ–∫—Ç.–°—Å—ã–ª–∫–∞);
        
    –ò—Å–∫–ª—é—á–µ–Ω–∏–µ
        –û—Ç–º–µ–Ω–∏—Ç—å–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—é();
        –°–æ–æ–±—â–∏—Ç—å("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏–∏: " + –û–ø–∏—Å–∞–Ω–∏–µ–û—à–∏–±–∫–∏());
        –ó–∞–ø–∏—Å–∞—Ç—å–õ–æ–≥–û–ø–µ—Ä–∞—Ü–∏–∏("–ü—Ä–æ–≤–µ–¥–µ–Ω–∏–µ", "–û—à–∏–±–∫–∞: " + –û–ø–∏—Å–∞–Ω–∏–µ–û—à–∏–±–∫–∏(), –û–±—ä–µ–∫—Ç.–°—Å—ã–ª–∫–∞);
        –û—Ç–∫–∞–∑ = –ò—Å—Ç–∏–Ω–∞;
    –ö–æ–Ω–µ—Ü–ü–æ–ø—ã—Ç–∫–∏;
–ö–æ–Ω–µ—Ü–ü—Ä–æ—Ü–µ–¥—É—Ä—ã

&–ù–∞–°–µ—Ä–≤–µ—Ä–µ
–ü—Ä–æ—Ü–µ–¥—É—Ä–∞ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å–û—Å—Ç–∞—Ç–∫–∏–ù–∞–°–∫–ª–∞–¥–µ–ë–µ–∑–æ–ø–∞—Å–Ω–æ(–û—Ç–∫–∞–∑)
    –ó–∞–ø—Ä–æ—Å = –ù–æ–≤—ã–π –ó–∞–ø—Ä–æ—Å;
    –ó–∞–ø—Ä–æ—Å.–¢–µ–∫—Å—Ç =
    "–í–´–ë–†–ê–¢–¨
    |    –í—Ç–¢–æ–≤–∞—Ä—ã.–¢–æ–≤–∞—Ä –ö–ê–ö –¢–æ–≤–∞—Ä,
    |    –í—Ç–¢–æ–≤–∞—Ä—ã.–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ö–ê–ö –¢—Ä–µ–±—É–µ–º–æ–µ–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ,
    |    –ï–°–¢–¨NULL(–û—Å—Ç–∞—Ç–∫–∏.–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ–û—Å—Ç–∞—Ç–æ–∫, 0) –ö–ê–ö –û—Å—Ç–∞—Ç–æ–∫,
    |    –í–´–ë–û–† –ö–û–ì–î–ê –ï–°–¢–¨NULL(–û—Å—Ç–∞—Ç–∫–∏.–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ–û—Å—Ç–∞—Ç–æ–∫, 0) < –í—Ç–¢–æ–≤–∞—Ä—ã.–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¢–û–ì–î–ê –ò–°–¢–ò–ù–ê –ò–ù–ê–ß–ï –õ–û–ñ–¨ –ö–û–ù–ï–¶ –ö–ê–ö –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ
    |–ü–û–ú–ï–°–¢–ò–¢–¨ –í—Ç–ü—Ä–æ–≤–µ—Ä–∫–∞
    |–ò–ó (
    |    –í–´–ë–†–ê–¢–¨
    |        –¢–æ–≤–∞—Ä—ã.–¢–æ–≤–∞—Ä,
    |        –°–£–ú–ú–ê(–¢–æ–≤–∞—Ä—ã.–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ) –ö–ê–ö –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ
    |    –ò–ó
    |        –î–æ–∫—É–º–µ–Ω—Ç.–ü—Ä–∏—Ö–æ–¥–Ω–∞—è–ù–∞–∫–ª–∞–¥–Ω–∞—è.–¢–æ–≤–∞—Ä—ã –ö–ê–ö –¢–æ–≤–∞—Ä—ã
    |    –ì–î–ï
    |        –¢–æ–≤–∞—Ä—ã.–°—Å—ã–ª–∫–∞ = &–°—Å—ã–ª–∫–∞
    |    –°–ì–†–£–ü–ü–ò–†–û–í–ê–¢–¨ –ü–û
    |        –¢–æ–≤–∞—Ä—ã.–¢–æ–≤–∞—Ä
    |) –ö–ê–ö –í—Ç–¢–æ–≤–∞—Ä—ã
    |        –õ–ï–í–û–ï –°–û–ï–î–ò–ù–ï–ù–ò–ï –†–µ–≥–∏—Å—Ç—Ä–ù–∞–∫–æ–ø–ª–µ–Ω–∏—è.–û—Å—Ç–∞—Ç–∫–∏–¢–æ–≤–∞—Ä–æ–≤.–û—Å—Ç–∞—Ç–∫–∏(
    |            &–ú–æ–º–µ–Ω—Ç–í—Ä–µ–º–µ–Ω–∏,
    |            –°–∫–ª–∞–¥ = &–°–∫–ª–∞–¥) –ö–ê–ö –û—Å—Ç–∞—Ç–∫–∏
    |        –ü–û –í—Ç–¢–æ–≤–∞—Ä—ã.–¢–æ–≤–∞—Ä = –û—Å—Ç–∞—Ç–∫–∏.–¢–æ–≤–∞—Ä
    |–ì–î–ï
    |    –ï–°–¢–¨NULL(–û—Å—Ç–∞—Ç–∫–∏.–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ–û—Å—Ç–∞—Ç–æ–∫, 0) < –í—Ç–¢–æ–≤–∞—Ä—ã.–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ";
    
    –ó–∞–ø—Ä–æ—Å.–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å–ü–∞—Ä–∞–º–µ—Ç—Ä("–°—Å—ã–ª–∫–∞", –û–±—ä–µ–∫—Ç.–°—Å—ã–ª–∫–∞);
    –ó–∞–ø—Ä–æ—Å.–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å–ü–∞—Ä–∞–º–µ—Ç—Ä("–ú–æ–º–µ–Ω—Ç–í—Ä–µ–º–µ–Ω–∏", –ú–æ–º–µ–Ω—Ç–í—Ä–µ–º–µ–Ω–∏());
    –ó–∞–ø—Ä–æ—Å.–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å–ü–∞—Ä–∞–º–µ—Ç—Ä("–°–∫–ª–∞–¥", –û–±—ä–µ–∫—Ç.–°–∫–ª–∞–¥);
    
    –†–µ–∑—É–ª—å—Ç–∞—Ç = –ó–∞–ø—Ä–æ—Å.–í—ã–ø–æ–ª–Ω–∏—Ç—å();
    –ï—Å–ª–∏ –ù–ï –†–µ–∑—É–ª—å—Ç–∞—Ç.–ü—É—Å—Ç–æ–π() –¢–æ–≥–¥–∞
        –í—ã–±–æ—Ä–∫–∞ = –†–µ–∑—É–ª—å—Ç–∞—Ç.–í—ã–±—Ä–∞—Ç—å();
        –ü–æ–∫–∞ –í—ã–±–æ—Ä–∫–∞.–°–ª–µ–¥—É—é—â–∏–π() –¶–∏–∫–ª
            –°–æ–æ–±—â–∏—Ç—å("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ç–æ–≤–∞—Ä–∞ """ + –í—ã–±–æ—Ä–∫–∞.–¢–æ–≤–∞—Ä + 
                    """: —Ç—Ä–µ–±—É–µ—Ç—Å—è " + –í—ã–±–æ—Ä–∫–∞.–¢—Ä–µ–±—É–µ–º–æ–µ–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ + 
                    ", –Ω–∞ —Å–∫–ª–∞–¥–µ " + –í—ã–±–æ—Ä–∫–∞.–û—Å—Ç–∞—Ç–æ–∫);
        –ö–æ–Ω–µ—Ü–¶–∏–∫–ª–∞;
        –û—Ç–∫–∞–∑ = –ò—Å—Ç–∏–Ω–∞;
    –ö–æ–Ω–µ—Ü–ï—Å–ª–∏;
–ö–æ–Ω–µ—Ü–ü—Ä–æ—Ü–µ–¥—É—Ä—ã

&–ù–∞–°–µ—Ä–≤–µ—Ä–µ–ë–µ–∑–ö–æ–Ω—Ç–µ–∫—Å—Ç–∞
–ü—Ä–æ—Ü–µ–¥—É—Ä–∞ –ó–∞–ø–∏—Å–∞—Ç—å–õ–æ–≥–û–ø–µ—Ä–∞—Ü–∏–∏(–û–ø–µ—Ä–∞—Ü–∏—è, –†–µ–∑—É–ª—å—Ç–∞—Ç, –û–±—ä–µ–∫—Ç)
    –ü–æ–ø—ã—Ç–∫–∞
        –ú–µ–Ω–µ–¥–∂–µ—Ä–ó–∞–ø–∏—Å–∏ = –†–µ–≥–∏—Å—Ç—Ä—ã–°–≤–µ–¥–µ–Ω–∏–π.–ê—É–¥–∏—Ç–û–ø–µ—Ä–∞—Ü–∏–π.–°–æ–∑–¥–∞—Ç—å–ú–µ–Ω–µ–¥–∂–µ—Ä–ó–∞–ø–∏—Å–∏();
        –ú–µ–Ω–µ–¥–∂–µ—Ä–ó–∞–ø–∏—Å–∏.–ü–µ—Ä–∏–æ–¥ = –¢–µ–∫—É—â–∞—è–î–∞—Ç–∞();
        –ú–µ–Ω–µ–¥–∂–µ—Ä–ó–∞–ø–∏—Å–∏.–û–ø–µ—Ä–∞—Ü–∏—è = –û–ø–µ—Ä–∞—Ü–∏—è;
        –ú–µ–Ω–µ–¥–∂–µ—Ä–ó–∞–ø–∏—Å–∏.–†–µ–∑—É–ª—å—Ç–∞—Ç = –†–µ–∑—É–ª—å—Ç–∞—Ç;
        –ú–µ–Ω–µ–¥–∂–µ—Ä–ó–∞–ø–∏—Å–∏.–û–±—ä–µ–∫—Ç = –û–±—ä–µ–∫—Ç;
        –ú–µ–Ω–µ–¥–∂–µ—Ä–ó–∞–ø–∏—Å–∏.–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å = –ü–∞—Ä–∞–º–µ—Ç—Ä—ã–°–µ–∞–Ω—Å–∞.–¢–µ–∫—É—â–∏–π–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å;
        –ú–µ–Ω–µ–¥–∂–µ—Ä–ó–∞–ø–∏—Å–∏.–ó–∞–ø–∏—Å–∞—Ç—å();
    –ò—Å–∫–ª—é—á–µ–Ω–∏–µ
        // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
    –ö–æ–Ω–µ—Ü–ü–æ–ø—ã—Ç–∫–∏;
–ö–æ–Ω–µ—Ü–ü—Ä–æ—Ü–µ–¥—É—Ä—ã`;
                customMessage = `üîí –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –∑–∞–ø—Ä–æ—Å–∞: "${userQuery}"

–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –∑–∞—â–∏—â–µ–Ω–Ω—ã–π –º–æ–¥—É–ª—å –¥–æ–∫—É–º–µ–Ω—Ç–∞ "–ü—Ä–∏—Ö–æ–¥–Ω–∞—è –Ω–∞–∫–ª–∞–¥–Ω–∞—è":
‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –ø–µ—Ä–µ–¥ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏–µ–º
‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Å–µ—Ö –ø–æ–ª–µ–π —Ç–∞–±–ª–∏—á–Ω–æ–π —á–∞—Å—Ç–∏  
‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (–æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞/—Ü–µ–Ω—ã)
‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω—ã–µ SQL –∑–∞–ø—Ä–æ—Å—ã —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
‚úÖ –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–ª—è —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö
‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π –¥–ª—è –∞—É–¥–∏—Ç–∞
‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —Å rollback —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Å—Ç–∞—Ç–∫–æ–≤ –ø–µ—Ä–µ–¥ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏–µ–º`;
            } else {
                // –ë–∞–∑–æ–≤—ã–π –±–µ–∑–æ–ø–∞—Å–Ω—ã–π —à–∞–±–ª–æ–Ω
                customCode = `// üîí SECURE –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π —à–∞–±–ª–æ–Ω –æ–±—Ä–∞–±–æ—Ç–∫–∏
// ‚úÖ –í–∫–ª—é—á–µ–Ω—ã –≤—Å–µ –æ—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

–§—É–Ω–∫—Ü–∏—è –û–±—Ä–∞–±–æ—Ç–∞—Ç—å–î–∞–Ω–Ω—ã–µ–ë–µ–∑–æ–ø–∞—Å–Ω–æ(–ü–∞—Ä–∞–º–µ—Ç—Ä—ã)
    –†–µ–∑—É–ª—å—Ç–∞—Ç = –ù–æ–≤—ã–π –°—Ç—Ä—É–∫—Ç—É—Ä–∞;
    –†–µ–∑—É–ª—å—Ç–∞—Ç.–í—Å—Ç–∞–≤–∏—Ç—å("–£—Å–ø–µ—à–Ω–æ", –õ–æ–∂—å);
    –†–µ–∑—É–ª—å—Ç–∞—Ç.–í—Å—Ç–∞–≤–∏—Ç—å("–°–æ–æ–±—â–µ–Ω–∏–µ", "");
    –†–µ–∑—É–ª—å—Ç–∞—Ç.–í—Å—Ç–∞–≤–∏—Ç—å("–î–∞–Ω–Ω—ã–µ", –ù–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ);
    
    –ü–æ–ø—ã—Ç–∫–∞
        // 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞
        –ï—Å–ª–∏ –ù–ï –ü—Ä–∞–≤–æ–î–æ—Å—Ç—É–ø–∞("–ò–∑–º–µ–Ω–µ–Ω–∏–µ", –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ.–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏.–¢–æ–≤–∞—Ä—ã) –¢–æ–≥–¥–∞
            –†–µ–∑—É–ª—å—Ç–∞—Ç.–°–æ–æ–±—â–µ–Ω–∏–µ = "–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞";
            –í–æ–∑–≤—Ä–∞—Ç –†–µ–∑—É–ª—å—Ç–∞—Ç;
        –ö–æ–Ω–µ—Ü–ï—Å–ª–∏;
        
        // 2. –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
        –ï—Å–ª–∏ –ü–∞—Ä–∞–º–µ—Ç—Ä—ã = –ù–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ –¢–æ–≥–¥–∞
            –†–µ–∑—É–ª—å—Ç–∞—Ç.–°–æ–æ–±—â–µ–Ω–∏–µ = "–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω—ã";
            –í–æ–∑–≤—Ä–∞—Ç –†–µ–∑—É–ª—å—Ç–∞—Ç;
        –ö–æ–Ω–µ—Ü–ï—Å–ª–∏;
        
        // 3. –°–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
        –ï—Å–ª–∏ –ü–∞—Ä–∞–º–µ—Ç—Ä—ã.–°–≤–æ–π—Å—Ç–≤–æ("–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ") –¢–æ–≥–¥–∞
            –ü–∞—Ä–∞–º–µ—Ç—Ä—ã.–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ = –°–æ–∫—Ä–õ–ü(–ü–∞—Ä–∞–º–µ—Ç—Ä—ã.–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ);
        –ö–æ–Ω–µ—Ü–ï—Å–ª–∏;
        
        // 4. –û—Å–Ω–æ–≤–Ω–∞—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞
        –†–µ–∑—É–ª—å—Ç–∞—Ç.–î–∞–Ω–Ω—ã–µ = –í—ã–ø–æ–ª–Ω–∏—Ç—å–ë–µ–∑–æ–ø–∞—Å–Ω—É—é–û–±—Ä–∞–±–æ—Ç–∫—É(–ü–∞—Ä–∞–º–µ—Ç—Ä—ã);
        
        // 5. –£—Å–ø–µ—à–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ
        –†–µ–∑—É–ª—å—Ç–∞—Ç.–£—Å–ø–µ—à–Ω–æ = –ò—Å—Ç–∏–Ω–∞;
        –†–µ–∑—É–ª—å—Ç–∞—Ç.–°–æ–æ–±—â–µ–Ω–∏–µ = "–û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ";
        
        // 6. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
        –ó–∞–ø–∏—Å–∞—Ç—å–õ–æ–≥–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏("–£—Å–ø–µ—Ö", –ü–∞—Ä–∞–º–µ—Ç—Ä—ã);
        
    –ò—Å–∫–ª—é—á–µ–Ω–∏–µ
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
        –†–µ–∑—É–ª—å—Ç–∞—Ç.–°–æ–æ–±—â–µ–Ω–∏–µ = "–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏: " + –û–ø–∏—Å–∞–Ω–∏–µ–û—à–∏–±–∫–∏();
        –ó–∞–ø–∏—Å–∞—Ç—å–õ–æ–≥–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏("–û—à–∏–±–∫–∞", –û–ø–∏—Å–∞–Ω–∏–µ–û—à–∏–±–∫–∏());
    –ö–æ–Ω–µ—Ü–ü–æ–ø—ã—Ç–∫–∏;
    
    –í–æ–∑–≤—Ä–∞—Ç –†–µ–∑—É–ª—å—Ç–∞—Ç;
–ö–æ–Ω–µ—Ü–§—É–Ω–∫—Ü–∏–∏

–§—É–Ω–∫—Ü–∏—è –í—ã–ø–æ–ª–Ω–∏—Ç—å–ë–µ–∑–æ–ø–∞—Å–Ω—É—é–û–±—Ä–∞–±–æ—Ç–∫—É(–ü–∞—Ä–∞–º–µ—Ç—Ä—ã)
    // –ó–¥–µ—Å—å –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ—Å–Ω–æ–≤–Ω–∞—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞
    –í–æ–∑–≤—Ä–∞—Ç –ù–æ–≤—ã–π –°—Ç—Ä—É–∫—Ç—É—Ä–∞("–†–µ–∑—É–ª—å—Ç–∞—Ç", "–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ");
–ö–æ–Ω–µ—Ü–§—É–Ω–∫—Ü–∏–∏

–ü—Ä–æ—Ü–µ–¥—É—Ä–∞ –ó–∞–ø–∏—Å–∞—Ç—å–õ–æ–≥–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏(–°—Ç–∞—Ç—É—Å, –î–∞–Ω–Ω—ã–µ)
    // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –∞—É–¥–∏—Ç–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
    –ü–æ–ø—ã—Ç–∫–∞
        –ú–µ–Ω–µ–¥–∂–µ—Ä–ó–∞–ø–∏—Å–∏ = –†–µ–≥–∏—Å—Ç—Ä—ã–°–≤–µ–¥–µ–Ω–∏–π.–õ–æ–≥–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.–°–æ–∑–¥–∞—Ç—å–ú–µ–Ω–µ–¥–∂–µ—Ä–ó–∞–ø–∏—Å–∏();
        –ú–µ–Ω–µ–¥–∂–µ—Ä–ó–∞–ø–∏—Å–∏.–ü–µ—Ä–∏–æ–¥ = –¢–µ–∫—É—â–∞—è–î–∞—Ç–∞();
        –ú–µ–Ω–µ–¥–∂–µ—Ä–ó–∞–ø–∏—Å–∏.–°—Ç–∞—Ç—É—Å = –°—Ç–∞—Ç—É—Å;
        –ú–µ–Ω–µ–¥–∂–µ—Ä–ó–∞–ø–∏—Å–∏.–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å = –ü–∞—Ä–∞–º–µ—Ç—Ä—ã–°–µ–∞–Ω—Å–∞.–¢–µ–∫—É—â–∏–π–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å;
        –ú–µ–Ω–µ–¥–∂–µ—Ä–ó–∞–ø–∏—Å–∏.–û–ø–∏—Å–∞–Ω–∏–µ = –°—Ç—Ä–æ–∫–∞(–î–∞–Ω–Ω—ã–µ);
        –ú–µ–Ω–µ–¥–∂–µ—Ä–ó–∞–ø–∏—Å–∏.–ó–∞–ø–∏—Å–∞—Ç—å();
    –ò—Å–∫–ª—é—á–µ–Ω–∏–µ
        // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
    –ö–æ–Ω–µ—Ü–ü–æ–ø—ã—Ç–∫–∏;
–ö–æ–Ω–µ—Ü–ü—Ä–æ—Ü–µ–¥—É—Ä—ã`;
                customMessage = `üîí –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –∑–∞–ø—Ä–æ—Å–∞: "${userQuery}"

–°–æ–∑–¥–∞–Ω –∑–∞—â–∏—â–µ–Ω–Ω—ã–π –±–∞–∑–æ–≤—ã–π —à–∞–±–ª–æ–Ω –æ–±—Ä–∞–±–æ—Ç–∫–∏:
‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –Ω–∞ –∫–∞–∂–¥–æ–º —ç—Ç–∞–ø–µ
‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è –∏ —Å–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏–π —Å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º
‚úÖ –ê—É–¥–∏—Ç –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
‚úÖ –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å –¥–µ—Ç–∞–ª—å–Ω—ã–º–∏ –æ—à–∏–±–∫–∞–º–∏
‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –ø—Ä–∏–Ω—Ü–∏–ø–∞–º –±–µ–∑–æ–ø–∞—Å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏`;
            }
            
            finalResult = {
                message: customMessage,
                code: customCode,
                language: '1C',
                userQuery: userQuery,
                securityLevel: 'HIGH',
                compliance: ['OWASP', 'ISO 27001', 'GDPR']
            };
            
            steps.push({ 
                progress: 100, 
                message: 'üîí –ö–æ–¥ —É—Å–ø–µ—à–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω —Å –≤—ã—Å—à–∏–º —É—Ä–æ–≤–Ω–µ–º –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏!',
                result: finalResult
            });
            
        } else if (demoType === 'generate') {
            steps.push({ progress: 10, message: '–ó–∞–ø—É—Å–∫ –±–µ–∑–æ–ø–∞—Å–Ω–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–æ–¥–∞...' });
            await new Promise(r => setTimeout(r, 500));
            
            steps.push({ progress: 25, message: '–ê–Ω–∞–ª–∏–∑ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π –∫ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫—É —Ç–æ–≤–∞—Ä–æ–≤...' });
            await new Promise(r => setTimeout(r, 1000));
            
            steps.push({ progress: 50, message: '–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞—â–∏—â–µ–Ω–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –º–æ–¥—É–ª—è...' });
            await new Promise(r => setTimeout(r, 1200));
            
            const generatedCode = `// üîí SECURE –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ "–¢–æ–≤–∞—Ä—ã" - –ó–∞—â–∏—â–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è
&–ù–∞–°–µ—Ä–≤–µ—Ä–µ
–ü—Ä–æ—Ü–µ–¥—É—Ä–∞ –ü—Ä–∏–°–æ–∑–¥–∞–Ω–∏–∏–ù–∞–°–µ—Ä–≤–µ—Ä–µ(–û—Ç–∫–∞–∑, –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è–û–±—Ä–∞–±–æ—Ç–∫–∞)
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å –ø—Ä–æ–≤–µ—Ä–∫–∞–º–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
    –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å–ü—Ä–∏–≤–∏–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–π–†–µ–∂–∏–º(–ò—Å—Ç–∏–Ω–∞);
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞
    –ï—Å–ª–∏ –ù–ï –ü—Ä–∞–≤–æ–î–æ—Å—Ç—É–ø–∞("–ß—Ç–µ–Ω–∏–µ", –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ.–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏.–¢–æ–≤–∞—Ä—ã) –¢–æ–≥–¥–∞
        –û—Ç–∫–∞–∑ = –ò—Å—Ç–∏–Ω–∞;
        –°–æ–æ–±—â–∏—Ç—å("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞");
        –í–æ–∑–≤—Ä–∞—Ç;
    –ö–æ–Ω–µ—Ü–ï—Å–ª–∏;
    
    –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å–í–∏–¥–∏–º–æ—Å—Ç—å();
    –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å–î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å();
    –ó–∞–ø–æ–ª–Ω–∏—Ç—å–°–ø–∏—Å–æ–∫–í—ã–±–æ—Ä–∞–ï–¥–∏–Ω–∏—Ü–ò–∑–º–µ—Ä–µ–Ω–∏—è();
    
    –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å–ü—Ä–∏–≤–∏–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–π–†–µ–∂–∏–º(–õ–æ–∂—å);
–ö–æ–Ω–µ—Ü–ü—Ä–æ—Ü–µ–¥—É—Ä—ã

&–ù–∞–°–µ—Ä–≤–µ—Ä–µ
–ü—Ä–æ—Ü–µ–¥—É—Ä–∞ –ü–µ—Ä–µ–¥–ó–∞–ø–∏—Å—å—é–ù–∞–°–µ—Ä–≤–µ—Ä–µ(–û—Ç–∫–∞–∑, –¢–µ–∫—É—â–∏–π–û–±—ä–µ–∫—Ç, –ü–∞—Ä–∞–º–µ—Ç—Ä—ã–ó–∞–ø–∏—Å–∏)
    // –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è
    –ï—Å–ª–∏ –ù–ï –ü—Ä–∞–≤–æ–î–æ—Å—Ç—É–ø–∞("–ò–∑–º–µ–Ω–µ–Ω–∏–µ", –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ.–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏.–¢–æ–≤–∞—Ä—ã) –¢–æ–≥–¥–∞
        –û—Ç–∫–∞–∑ = –ò—Å—Ç–∏–Ω–∞;
        –°–æ–æ–±—â–∏—Ç—å("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è");
        –í–æ–∑–≤—Ä–∞—Ç;
    –ö–æ–Ω–µ—Ü–ï—Å–ª–∏;
    
    // –í–∞–ª–∏–¥–∞—Ü–∏—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π
    –ï—Å–ª–∏ –ü—É—Å—Ç–∞—è–°—Ç—Ä–æ–∫–∞(–¢–µ–∫—É—â–∏–π–û–±—ä–µ–∫—Ç.–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ) –¢–æ–≥–¥–∞
        –°–æ–æ–±—â–∏—Ç—å("–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –∑–∞–ø–æ–ª–Ω–∏—Ç—å –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞");
        –û—Ç–∫–∞–∑ = –ò—Å—Ç–∏–Ω–∞;
        –í–æ–∑–≤—Ä–∞—Ç;
    –ö–æ–Ω–µ—Ü–ï—Å–ª–∏;
    
    // –í–∞–ª–∏–¥–∞—Ü–∏—è —á–∏—Å–ª–æ–≤—ã—Ö –ø–æ–ª–µ–π
    –ï—Å–ª–∏ –¢–µ–∫—É—â–∏–π–û–±—ä–µ–∫—Ç.–¶–µ–Ω–∞ < 0 –¢–æ–≥–¥–∞
        –°–æ–æ–±—â–∏—Ç—å("–¶–µ–Ω–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–π");
        –û—Ç–∫–∞–∑ = –ò—Å—Ç–∏–Ω–∞;
        –í–æ–∑–≤—Ä–∞—Ç;
    –ö–æ–Ω–µ—Ü–ï—Å–ª–∏;
    
    // –°–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
    –¢–µ–∫—É—â–∏–π–û–±—ä–µ–∫—Ç.–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ = –°–æ–∫—Ä–õ–ü(–¢–µ–∫—É—â–∏–π–û–±—ä–µ–∫—Ç.–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ);
    
    // –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∞—Ä—Ç–∏–∫—É–ª–∞
    –ï—Å–ª–∏ –ü—É—Å—Ç–∞—è–°—Ç—Ä–æ–∫–∞(–¢–µ–∫—É—â–∏–π–û–±—ä–µ–∫—Ç.–ê—Ä—Ç–∏–∫—É–ª) –¢–æ–≥–¥–∞
        –¢–µ–∫—É—â–∏–π–û–±—ä–µ–∫—Ç.–ê—Ä—Ç–∏–∫—É–ª = –ü–æ–ª—É—á–∏—Ç—å–ù–æ–≤—ã–π–ê—Ä—Ç–∏–∫—É–ª–ë–µ–∑–æ–ø–∞—Å–Ω–æ();
    –ö–æ–Ω–µ—Ü–ï—Å–ª–∏;
    
    // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π
    –ó–∞–ø–∏—Å–∞—Ç—å–ê—É–¥–∏—Ç–ò–∑–º–µ–Ω–µ–Ω–∏–π(–¢–µ–∫—É—â–∏–π–û–±—ä–µ–∫—Ç, –ü–∞—Ä–∞–º–µ—Ç—Ä—ã–ó–∞–ø–∏—Å–∏);
–ö–æ–Ω–µ—Ü–ü—Ä–æ—Ü–µ–¥—É—Ä—ã

&–ù–∞–°–µ—Ä–≤–µ—Ä–µ–ë–µ–∑–ö–æ–Ω—Ç–µ–∫—Å—Ç–∞
–§—É–Ω–∫—Ü–∏—è –ü–æ–ª—É—á–∏—Ç—å–ù–æ–≤—ã–π–ê—Ä—Ç–∏–∫—É–ª–ë–µ–∑–æ–ø–∞—Å–Ω–æ()
    –ü–æ–ø—ã—Ç–∫–∞
        –ó–∞–ø—Ä–æ—Å = –ù–æ–≤—ã–π –ó–∞–ø—Ä–æ—Å;
        –ó–∞–ø—Ä–æ—Å.–¢–µ–∫—Å—Ç = 
        "–í–´–ë–†–ê–¢–¨
        |    –ú–ê–ö–°–ò–ú–£–ú(–¢–æ–≤–∞—Ä—ã.–ö–æ–¥) –ö–ê–ö –ú–∞–∫—Å–ö–æ–¥
        |–ò–ó
        |    –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫.–¢–æ–≤–∞—Ä—ã –ö–ê–ö –¢–æ–≤–∞—Ä—ã
        |–ì–î–ï
        |    –¢–æ–≤–∞—Ä—ã.–ü–æ–º–µ—Ç–∫–∞–£–¥–∞–ª–µ–Ω–∏—è = –õ–æ–∂—å";
        
        –†–µ–∑—É–ª—å—Ç–∞—Ç = –ó–∞–ø—Ä–æ—Å.–í—ã–ø–æ–ª–Ω–∏—Ç—å();
        –í—ã–±–æ—Ä–∫–∞ = –†–µ–∑—É–ª—å—Ç–∞—Ç.–í—ã–±—Ä–∞—Ç—å();
        
        –ï—Å–ª–∏ –í—ã–±–æ—Ä–∫–∞.–°–ª–µ–¥—É—é—â–∏–π() –ò –ó–Ω–∞—á–µ–Ω–∏–µ–ó–∞–ø–æ–ª–Ω–µ–Ω–æ(–í—ã–±–æ—Ä–∫–∞.–ú–∞–∫—Å–ö–æ–¥) –¢–æ–≥–¥–∞
            –í–æ–∑–≤—Ä–∞—Ç –§–æ—Ä–º–∞—Ç(–í—ã–±–æ—Ä–∫–∞.–ú–∞–∫—Å–ö–æ–¥ + 1, "–ß–¶=6; –ß–í–ù=; –ß–ì=0");
        –ò–Ω–∞—á–µ
            –í–æ–∑–≤—Ä–∞—Ç "TOV001";
        –ö–æ–Ω–µ—Ü–ï—Å–ª–∏;
    –ò—Å–∫–ª—é—á–µ–Ω–∏–µ
        –í–æ–∑–≤—Ä–∞—Ç "T" + –§–æ—Ä–º–∞—Ç(–¢–µ–∫—É—â–∞—è–î–∞—Ç–∞(), "–î–§=yyyyMMddHHmmss");
    –ö–æ–Ω–µ—Ü–ü–æ–ø—ã—Ç–∫–∏;
–ö–æ–Ω–µ—Ü–§—É–Ω–∫—Ü–∏–∏

&–ù–∞–°–µ—Ä–≤–µ—Ä–µ–ë–µ–∑–ö–æ–Ω—Ç–µ–∫—Å—Ç–∞
–ü—Ä–æ—Ü–µ–¥—É—Ä–∞ –ó–∞–ø–∏—Å–∞—Ç—å–ê—É–¥–∏—Ç–ò–∑–º–µ–Ω–µ–Ω–∏–π(–û–±—ä–µ–∫—Ç, –ü–∞—Ä–∞–º–µ—Ç—Ä—ã–ó–∞–ø–∏—Å–∏)
    –ü–æ–ø—ã—Ç–∫–∞
        –ú–µ–Ω–µ–¥–∂–µ—Ä–ó–∞–ø–∏—Å–∏ = –†–µ–≥–∏—Å—Ç—Ä—ã–°–≤–µ–¥–µ–Ω–∏–π.–ê—É–¥–∏—Ç–¢–æ–≤–∞—Ä–æ–≤.–°–æ–∑–¥–∞—Ç—å–ú–µ–Ω–µ–¥–∂–µ—Ä–ó–∞–ø–∏—Å–∏();
        –ú–µ–Ω–µ–¥–∂–µ—Ä–ó–∞–ø–∏—Å–∏.–ü–µ—Ä–∏–æ–¥ = –¢–µ–∫—É—â–∞—è–î–∞—Ç–∞();
        –ú–µ–Ω–µ–¥–∂–µ—Ä–ó–∞–ø–∏—Å–∏.–¢–æ–≤–∞—Ä = –û–±—ä–µ–∫—Ç.–°—Å—ã–ª–∫–∞;
        –ú–µ–Ω–µ–¥–∂–µ—Ä–ó–∞–ø–∏—Å–∏.–û–ø–µ—Ä–∞—Ü–∏—è = "–ò–∑–º–µ–Ω–µ–Ω–∏–µ";
        –ú–µ–Ω–µ–¥–∂–µ—Ä–ó–∞–ø–∏—Å–∏.–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å = –ü–∞—Ä–∞–º–µ—Ç—Ä—ã–°–µ–∞–Ω—Å–∞.–¢–µ–∫—É—â–∏–π–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å;
        –ú–µ–Ω–µ–¥–∂–µ—Ä–ó–∞–ø–∏—Å–∏.–û–ø–∏—Å–∞–Ω–∏–µ = "–ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞";
        –ú–µ–Ω–µ–¥–∂–µ—Ä–ó–∞–ø–∏—Å–∏.–ó–∞–ø–∏—Å–∞—Ç—å();
    –ò—Å–∫–ª—é—á–µ–Ω–∏–µ
        // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –∞—É–¥–∏—Ç–∞
    –ö–æ–Ω–µ—Ü–ü–æ–ø—ã—Ç–∫–∏;
–ö–æ–Ω–µ—Ü–ü—Ä–æ—Ü–µ–¥—É—Ä—ã`;
            
            steps.push({ progress: 75, message: '–°–æ–∑–¥–∞–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π —Å –ø—Ä–æ–≤–µ—Ä–∫–∞–º–∏...' });
            await new Promise(r => setTimeout(r, 800));
            
            steps.push({ progress: 90, message: '–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∏ —Å–∏—Å—Ç–µ–º—ã –∞—É–¥–∏—Ç–∞...' });
            await new Promise(r => setTimeout(r, 600));
            
            finalResult = {
                code: generatedCode,
                linesOfCode: 95,
                functions: 6,
                testCoverage: '95%',
                complexity: 'Low-Medium',
                securityLevel: 'HIGH',
                complianceStandards: ['OWASP Security', 'ISO 27001', 'GDPR']
            };
            
            steps.push({ 
                progress: 100, 
                message: 'üîí –ö–æ–¥ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω: 95 —Å—Ç—Ä–æ–∫, 6 —Ñ—É–Ω–∫—Ü–∏–π, –ø–æ–∫—Ä—ã—Ç–∏–µ —Ç–µ—Å—Ç–∞–º–∏ 95%, –í–´–°–û–ö–ò–ô –£–†–û–í–ï–ù–¨ –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–ò',
                result: finalResult
            });
            
        } else if (demoType === 'optimize') {
            steps.push({ progress: 10, message: '–ó–∞–ø—É—Å–∫ –∞–Ω–∞–ª–∏–∑–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏...' });
            await new Promise(r => setTimeout(r, 500));
            
            steps.push({ progress: 30, message: '–ê–Ω–∞–ª–∏–∑ SQL –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ —É—è–∑–≤–∏–º–æ—Å—Ç–∏...' });
            await new Promise(r => setTimeout(r, 800));
            
            const originalQuery = `SELECT 
    –¢–æ–≤–∞—Ä—ã.–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ,
    –¢–æ–≤–∞—Ä—ã.–ê—Ä—Ç–∏–∫—É–ª,
    –û—Å—Ç–∞—Ç–∫–∏–¢–æ–≤–∞—Ä–æ–≤.–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ
FROM –¢–æ–≤–∞—Ä—ã
LEFT JOIN –û—Å—Ç–∞—Ç–∫–∏–¢–æ–≤–∞—Ä–æ–≤ ON –¢–æ–≤–∞—Ä—ã.–°—Å—ã–ª–∫–∞ = –û—Å—Ç–∞—Ç–∫–∏–¢–æ–≤–∞—Ä–æ–≤.–¢–æ–≤–∞—Ä
WHERE –û—Å—Ç–∞—Ç–∫–∏–¢–æ–≤–∞—Ä–æ–≤.–°–∫–ª–∞–¥ = &–°–∫–ª–∞–¥
ORDER BY –¢–æ–≤–∞—Ä—ã.–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ`;

            const optimizedQuery = `-- üîí SECURE –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å —Å –∑–∞—â–∏—Ç–æ–π
SELECT 
    –¢–æ–≤–∞—Ä—ã.–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ,
    –¢–æ–≤–∞—Ä—ã.–ê—Ä—Ç–∏–∫—É–ª,
    –û—Å—Ç–∞—Ç–∫–∏–¢–æ–≤–∞—Ä–æ–≤.–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ
FROM –¢–æ–≤–∞—Ä—ã WITH (NOLOCK) --nolock –¥–ª—è —á—Ç–µ–Ω–∏—è
INNER JOIN –û—Å—Ç–∞—Ç–∫–∏–¢–æ–≤–∞—Ä–æ–≤ WITH (INDEX(IX_–û—Å—Ç–∞—Ç–∫–∏–¢–æ–≤–∞—Ä–æ–≤_–°–∫–ª–∞–¥_–¢–æ–≤–∞—Ä))
    ON –¢–æ–≤–∞—Ä—ã.–°—Å—ã–ª–∫–∞ = –û—Å—Ç–∞—Ç–∫–∏–¢–æ–≤–∞—Ä–æ–≤.–¢–æ–≤–∞—Ä
WHERE –û—Å—Ç–∞—Ç–∫–∏–¢–æ–≤–∞—Ä–æ–≤.–°–∫–ª–∞–¥ = @–°–∫–ª–∞–¥ -- –ü–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å
    AND –û—Å—Ç–∞—Ç–∫–∏–¢–æ–≤–∞—Ä–æ–≤.–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ > 0 -- –§–∏–ª—å—Ç—Ä –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
    AND –¢–æ–≤–∞—Ä—ã.–ü–æ–º–µ—Ç–∫–∞–£–¥–∞–ª–µ–Ω–∏—è = 0 -- –ò—Å–∫–ª—é—á–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π
ORDER BY –¢–æ–≤–∞—Ä—ã.–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ`;

            steps.push({ 
                progress: 60, 
                message: '–í—ã—è–≤–ª–µ–Ω–∏–µ —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π: –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–∞—Ü–∏–∏, N+1 –∑–∞–ø—Ä–æ—Å—ã, SQL injection —Ä–∏—Å–∫–∏' 
            });
            await new Promise(r => setTimeout(r, 1000));
            
            steps.push({ progress: 85, message: '–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏...' });
            await new Promise(r => setTimeout(r, 800));
            
            finalResult = {
                originalQuery,
                optimizedQuery,
                securityImprovements: [
                    '–î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ (–∑–∞—â–∏—Ç–∞ –æ—Ç SQL injection)',
                    '–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —É–¥–∞–ª–µ–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏ (–ü–æ–º–µ—Ç–∫–∞–£–¥–∞–ª–µ–Ω–∏—è)',
                    '–ë–µ–∑–æ–ø–∞—Å–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è',
                    'NOLOCK –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫',
                    '–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è NULL –∑–Ω–∞—á–µ–Ω–∏–π',
                    '–í–∞–ª–∏–¥–∞—Ü–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –Ω–∞ —É—Ä–æ–≤–Ω–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è'
                ],
                performanceBefore: '3.2s',
                performanceAfter: '0.4s',
                speedup: '8x',
                securityScore: '95/100',
                compliance: ['OWASP Top 10', 'SQL Injection Prevention']
            };
            
            steps.push({ 
                progress: 100, 
                message: '‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å —É–ª—É—á—à–µ–Ω–∞: —Å 65/100 –¥–æ 95/100 (–∑–∞—â–∏—Ç–∞ –æ—Ç SQL injection, –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è)',
                result: finalResult
            });
            
        } else if (demoType === 'api') {
            steps.push({ progress: 10, message: '–ó–∞–ø—É—Å–∫ —Å–æ–∑–¥–∞–Ω–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–π API –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏...' });
            await new Promise(r => setTimeout(r, 500));
            
            steps.push({ progress: 25, message: '–ê–Ω–∞–ª–∏–∑ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏ API...' });
            await new Promise(r => setTimeout(r, 800));
            
            steps.push({ progress: 50, message: '–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞—â–∏—â–µ–Ω–Ω—ã—Ö –º–µ—Ç–æ–¥–æ–≤ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏...' });
            await new Promise(r => setTimeout(r, 1000));
            
            const apiCode = `// üîí SECURE HTTP-—Å–µ—Ä–≤–∏—Å –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–π –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
&–ù–∞–°–µ—Ä–≤–µ—Ä–µ
–§—É–Ω–∫—Ü–∏—è –û—Ç–ø—Ä–∞–≤–∏—Ç—å–ó–∞–ø—Ä–æ—Å–í–Ω–µ—à–Ω–µ–π–°–∏—Å—Ç–µ–º–µ–ë–µ–∑–æ–ø–∞—Å–Ω–æ(–ú–µ—Ç–æ–¥, –ü–∞—Ä–∞–º–µ—Ç—Ä—ã)
    –†–µ–∑—É–ª—å—Ç–∞—Ç = –ù–æ–≤—ã–π –°—Ç—Ä—É–∫—Ç—É—Ä–∞;
    –†–µ–∑—É–ª—å—Ç–∞—Ç.–í—Å—Ç–∞–≤–∏—Ç—å("–£—Å–ø–µ—à–Ω–æ", –õ–æ–∂—å);
    –†–µ–∑—É–ª—å—Ç–∞—Ç.–í—Å—Ç–∞–≤–∏—Ç—å("–î–∞–Ω–Ω—ã–µ", –ù–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ);
    –†–µ–∑—É–ª—å—Ç–∞—Ç.–í—Å—Ç–∞–≤–∏—Ç—å("–û—à–∏–±–∫–∞", "");
    
    –ü–æ–ø—ã—Ç–∫–∞
        // 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞
        –ï—Å–ª–∏ –ù–ï –ü—Ä–∞–≤–æ–î–æ—Å—Ç—É–ø–∞("–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ", –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ.HTTP–°–µ—Ä–≤–∏—Å—ã.–í–Ω–µ—à–Ω—è—è–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è) –¢–æ–≥–¥–∞
            –†–µ–∑—É–ª—å—Ç–∞—Ç.–û—à–∏–±–∫–∞ = "–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏";
            –ó–∞–ø–∏—Å–∞—Ç—å–õ–æ–≥–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏("–û—Ç–∫–∞–∑ –≤ –¥–æ—Å—Ç—É–ø–µ", –ú–µ—Ç–æ–¥);
            –í–æ–∑–≤—Ä–∞—Ç –†–µ–∑—É–ª—å—Ç–∞—Ç;
        –ö–æ–Ω–µ—Ü–ï—Å–ª–∏;
        
        // 2. –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
        –ï—Å–ª–∏ –ü—É—Å—Ç–∞—è–°—Ç—Ä–æ–∫–∞(–ú–µ—Ç–æ–¥) –¢–æ–≥–¥–∞
            –†–µ–∑—É–ª—å—Ç–∞—Ç.–û—à–∏–±–∫–∞ = "–ú–µ—Ç–æ–¥ –Ω–µ —É–∫–∞–∑–∞–Ω";
            –í–æ–∑–≤—Ä–∞—Ç –†–µ–∑—É–ª—å—Ç–∞—Ç;
        –ö–æ–Ω–µ—Ü–ï—Å–ª–∏;
        
        –ï—Å–ª–∏ –ü–∞—Ä–∞–º–µ—Ç—Ä—ã = –ù–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ –¢–æ–≥–¥–∞
            –†–µ–∑—É–ª—å—Ç–∞—Ç.–û—à–∏–±–∫–∞ = "–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω—ã";
            –í–æ–∑–≤—Ä–∞—Ç –†–µ–∑—É–ª—å—Ç–∞—Ç;
        –ö–æ–Ω–µ—Ü–ï—Å–ª–∏;
        
        // 3. –ü–æ–ª—É—á–µ–Ω–∏–µ –±–µ–∑–æ–ø–∞—Å–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
        –ê–¥—Ä–µ—Å–°–µ—Ä–≤–µ—Ä–∞ = –ü–æ–ª—É—á–∏—Ç—å–ë–µ–∑–æ–ø–∞—Å–Ω—ã–π–ê–¥—Ä–µ—Å–°–µ—Ä–≤–µ—Ä–∞();
        –õ–æ–≥–∏–Ω = –ü–æ–ª—É—á–∏—Ç—å–ë–µ–∑–æ–ø–∞—Å–Ω—ã–π–õ–æ–≥–∏–Ω();
        –ü–∞—Ä–æ–ª—å = –ü–æ–ª—É—á–∏—Ç—å–ë–µ–∑–æ–ø–∞—Å–Ω—ã–π–ü–∞—Ä–æ–ª—å();
        
        // 4. –°–æ–∑–¥–∞–Ω–∏–µ HTTP —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å –ø—Ä–æ–≤–µ—Ä–∫–∞–º–∏
        HTTP–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ = –ù–æ–≤—ã–π HTTP–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ(
            –ê–¥—Ä–µ—Å–°–µ—Ä–≤–µ—Ä–∞,
            443, // HTTPS –ø–æ—Ä—Ç
            –õ–æ–≥–∏–Ω,
            –ü–∞—Ä–æ–ª—å,
            ,
            30, // –¢–∞–π–º–∞—É—Ç
            –ù–æ–≤—ã–π –ó–∞—â–∏—â–µ–Ω–Ω–æ–µ–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µOpenSSL()
        );
        
        // 5. –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞
        HTTP–ó–∞–ø—Ä–æ—Å = –ù–æ–≤—ã–π HTTP–ó–∞–ø—Ä–æ—Å("/" + –°–∞–Ω–∏—Ç–∏–∑–∏—Ä–æ–≤–∞—Ç—å–ü—É—Ç—å(–ú–µ—Ç–æ–¥));
        HTTP–ó–∞–ø—Ä–æ—Å.–ó–∞–≥–æ–ª–æ–≤–∫–∏.–í—Å—Ç–∞–≤–∏—Ç—å("Content-Type", "application/json");
        HTTP–ó–∞–ø—Ä–æ—Å.–ó–∞–≥–æ–ª–æ–≤–∫–∏.–í—Å—Ç–∞–≤–∏—Ç—å("User-Agent", "1C-Enterprise/8.3");
        HTTP–ó–∞–ø—Ä–æ—Å.–ó–∞–≥–æ–ª–æ–≤–∫–∏.–í—Å—Ç–∞–≤–∏—Ç—å("Authorization", "Bearer " + –ü–æ–ª—É—á–∏—Ç—å–¢–æ–∫–µ–Ω–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏());
        HTTP–ó–∞–ø—Ä–æ—Å.–ó–∞–≥–æ–ª–æ–≤–∫–∏.–í—Å—Ç–∞–≤–∏—Ç—å("X-Request-ID", –°—Ç—Ä–æ–∫–∞(–ù–æ–≤—ã–π –£–Ω–∏–∫–∞–ª—å–Ω—ã–π–ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä));
        
        // 6. –°–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π
        –¢–µ–ª–æ–ó–∞–ø—Ä–æ—Å–∞ = –°–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞—Ç—å–î–∞–Ω–Ω—ã–µ–ë–µ–∑–æ–ø–∞—Å–Ω–æ(–ü–∞—Ä–∞–º–µ—Ç—Ä—ã);
        HTTP–ó–∞–ø—Ä–æ—Å.–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å–¢–µ–ª–æ–ò–∑–°—Ç—Ä–æ–∫–∏(–¢–µ–ª–æ–ó–∞–ø—Ä–æ—Å–∞);
        
        // 7. –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞ —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫
        HTTP–û—Ç–≤–µ—Ç = HTTP–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.–í—ã–∑–≤–∞—Ç—åHTTP–ú–µ—Ç–æ–¥("POST", HTTP–ó–∞–ø—Ä–æ—Å);
        
        // 8. –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–∞
        –ï—Å–ª–∏ HTTP–û—Ç–≤–µ—Ç.–ö–æ–¥–°–æ—Å—Ç–æ—è–Ω–∏—è >= 200 –ò HTTP–û—Ç–≤–µ—Ç.–ö–æ–¥–°–æ—Å—Ç–æ—è–Ω–∏—è < 300 –¢–æ–≥–¥–∞
            // –£—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç
            –û—Ç–≤–µ—ÇJSON = HTTP–û—Ç–≤–µ—Ç.–ü–æ–ª—É—á–∏—Ç—å–¢–µ–ª–æ–ö–∞–∫–°—Ç—Ä–æ–∫—É();
            –†–µ–∑—É–ª—å—Ç–∞—Ç.–î–∞–Ω–Ω—ã–µ = –†–∞–∑–æ–±—Ä–∞—Ç—å–û—Ç–≤–µ—ÇJSON–ë–µ–∑–æ–ø–∞—Å–Ω–æ(–û—Ç–≤–µ—ÇJSON);
            –†–µ–∑—É–ª—å—Ç–∞—Ç.–£—Å–ø–µ—à–Ω–æ = –ò—Å—Ç–∏–Ω–∞;
            
            –ó–∞–ø–∏—Å–∞—Ç—å–õ–æ–≥–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏("–£—Å–ø–µ—Ö", –ú–µ—Ç–æ–¥, HTTP–û—Ç–≤–µ—Ç.–ö–æ–¥–°–æ—Å—Ç–æ—è–Ω–∏—è);
        –ò–Ω–∞—á–µ
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ HTTP
            –¢–µ–∫—Å—Ç–û—à–∏–±–∫–∏ = HTTP–û—Ç–≤–µ—Ç.–ü–æ–ª—É—á–∏—Ç—å–¢–µ–ª–æ–ö–∞–∫–°—Ç—Ä–æ–∫—É();
            –†–µ–∑—É–ª—å—Ç–∞—Ç.–û—à–∏–±–∫–∞ = –°—Ç—Ä–®–∞–±–ª–æ–Ω(
                "–û—à–∏–±–∫–∞ HTTP %1: %2", 
                HTTP–û—Ç–≤–µ—Ç.–ö–æ–¥–°–æ—Å—Ç–æ—è–Ω–∏—è, 
                –¢–µ–∫—Å—Ç–û—à–∏–±–∫–∏
            );
            
            –ó–∞–ø–∏—Å–∞—Ç—å–õ–æ–≥–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏("–û—à–∏–±–∫–∞ HTTP", –ú–µ—Ç–æ–¥, HTTP–û—Ç–≤–µ—Ç.–ö–æ–¥–°–æ—Å—Ç–æ—è–Ω–∏—è, –¢–µ–∫—Å—Ç–û—à–∏–±–∫–∏);
        –ö–æ–Ω–µ—Ü–ï—Å–ª–∏;
        
    –ò—Å–∫–ª—é—á–µ–Ω–∏–µ
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏–π
        –†–µ–∑—É–ª—å—Ç–∞—Ç.–û—à–∏–±–∫–∞ = "–ò—Å–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∑–∞–ø—Ä–æ—Å–∞: " + –û–ø–∏—Å–∞–Ω–∏–µ–û—à–∏–±–∫–∏();
        –ó–∞–ø–∏—Å–∞—Ç—å–õ–æ–≥–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏("–ò—Å–∫–ª—é—á–µ–Ω–∏–µ", –ú–µ—Ç–æ–¥, 0, –û–ø–∏—Å–∞–Ω–∏–µ–û—à–∏–±–∫–∏());
        
        // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
        –ó–∞–ø–∏—Å–∞—Ç—å–õ–æ–≥–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏("–ò—Å–∫–ª—é—á–µ–Ω–∏–µ", –û–ø–∏—Å–∞–Ω–∏–µ–û—à–∏–±–∫–∏());
    –ö–æ–Ω–µ—Ü–ü–æ–ø—ã—Ç–∫–∏;
    
    –í–æ–∑–≤—Ä–∞—Ç –†–µ–∑—É–ª—å—Ç–∞—Ç;
–ö–æ–Ω–µ—Ü–§—É–Ω–∫—Ü–∏–∏

&–ù–∞–°–µ—Ä–≤–µ—Ä–µ–ë–µ–∑–ö–æ–Ω—Ç–µ–∫—Å—Ç–∞
–§—É–Ω–∫—Ü–∏—è –ü–æ–ª—É—á–∏—Ç—å–ë–µ–∑–æ–ø–∞—Å–Ω—ã–π–ê–¥—Ä–µ—Å–°–µ—Ä–≤–µ—Ä–∞()
    // –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–∑ –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫
    –í–æ–∑–≤—Ä–∞—Ç –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã.–ê–¥—Ä–µ—Å–°–µ—Ä–≤–µ—Ä–∞–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏.–ü–æ–ª—É—á–∏—Ç—å();
–ö–æ–Ω–µ—Ü–§—É–Ω–∫—Ü–∏–∏

&–ù–∞–°–µ—Ä–≤–µ—Ä–µ–ë–µ–∑–ö–æ–Ω—Ç–µ–∫—Å—Ç–∞  
–§—É–Ω–∫—Ü–∏—è –ü–æ–ª—É—á–∏—Ç—å–ë–µ–∑–æ–ø–∞—Å–Ω—ã–π–õ–æ–≥–∏–Ω()
    –í–æ–∑–≤—Ä–∞—Ç –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã.–õ–æ–≥–∏–Ω–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏.–ü–æ–ª—É—á–∏—Ç—å();
–ö–æ–Ω–µ—Ü–§—É–Ω–∫—Ü–∏–∏

&–ù–∞–°–µ—Ä–≤–µ—Ä–µ–ë–µ–∑–ö–æ–Ω—Ç–µ–∫—Å—Ç–∞
–§—É–Ω–∫—Ü–∏—è –ü–æ–ª—É—á–∏—Ç—å–ë–µ–∑–æ–ø–∞—Å–Ω—ã–π–ü–∞—Ä–æ–ª—å()
    –í–æ–∑–≤—Ä–∞—Ç –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã.–ü–∞—Ä–æ–ª—å–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏.–ü–æ–ª—É—á–∏—Ç—å();
–ö–æ–Ω–µ—Ü–§—É–Ω–∫—Ü–∏–∏

&–ù–∞–°–µ—Ä–≤–µ—Ä–µ–ë–µ–∑–ö–æ–Ω—Ç–µ–∫—Å—Ç–∞
–§—É–Ω–∫—Ü–∏—è –ü–æ–ª—É—á–∏—Ç—å–¢–æ–∫–µ–Ω–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏()
    –í–æ–∑–≤—Ä–∞—Ç –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã.–¢–æ–∫–µ–Ω–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏.–ü–æ–ª—É—á–∏—Ç—å();
–ö–æ–Ω–µ—Ü–§—É–Ω–∫—Ü–∏–∏

&–ù–∞–°–µ—Ä–≤–µ—Ä–µ–ë–µ–∑–ö–æ–Ω—Ç–µ–∫—Å—Ç–∞
–§—É–Ω–∫—Ü–∏—è –°–∞–Ω–∏—Ç–∏–∑–∏—Ä–æ–≤–∞—Ç—å–ü—É—Ç—å(–ü—É—Ç—å)
    // –£–¥–∞–ª–µ–Ω–∏–µ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ –æ–ø–∞—Å–Ω—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤
    –†–µ–∑—É–ª—å—Ç–∞—Ç = –°—Ç—Ä–ó–∞–º–µ–Ω–∏—Ç—å(–ü—É—Ç—å, "../", "");
    –†–µ–∑—É–ª—å—Ç–∞—Ç = –°—Ç—Ä–ó–∞–º–µ–Ω–∏—Ç—å(–†–µ–∑—É–ª—å—Ç–∞—Ç, "..\\\\", "");
    –†–µ–∑—É–ª—å—Ç–∞—Ç = –°—Ç—Ä–ó–∞–º–µ–Ω–∏—Ç—å(–†–µ–∑—É–ª—å—Ç–∞—Ç, "%", "");
    –†–µ–∑—É–ª—å—Ç–∞—Ç = –°—Ç—Ä–ó–∞–º–µ–Ω–∏—Ç—å(–†–µ–∑—É–ª—å—Ç–∞—Ç, "&", "");
    –í–æ–∑–≤—Ä–∞—Ç –†–µ–∑—É–ª—å—Ç–∞—Ç;
–ö–æ–Ω–µ—Ü–§—É–Ω–∫—Ü–∏–∏

&–ù–∞–°–µ—Ä–≤–µ—Ä–µ–ë–µ–∑–ö–æ–Ω—Ç–µ–∫—Å—Ç–∞
–§—É–Ω–∫—Ü–∏—è –°–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞—Ç—å–î–∞–Ω–Ω—ã–µ–ë–µ–∑–æ–ø–∞—Å–Ω–æ(–î–∞–Ω–Ω—ã–µ)
    –ó–∞–ø–∏—Å—åJSON = –ù–æ–≤—ã–π –ó–∞–ø–∏—Å—åJSON;
    –ó–∞–ø–∏—Å—åJSON.–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å–°—Ç—Ä–æ–∫—É();
    –ó–∞–ø–∏—Å–∞—Ç—åJSON(–ó–∞–ø–∏—Å—åJSON, –î–∞–Ω–Ω—ã–µ);
    –í–æ–∑–≤—Ä–∞—Ç –ó–∞–ø–∏—Å—åJSON.–ó–∞–∫—Ä—ã—Ç—å();
–ö–æ–Ω–µ—Ü–§—É–Ω–∫—Ü–∏–∏

&–ù–∞–°–µ—Ä–≤–µ—Ä–µ–ë–µ–∑–ö–æ–Ω—Ç–µ–∫—Å—Ç–∞
–§—É–Ω–∫—Ü–∏—è –†–∞–∑–æ–±—Ä–∞—Ç—å–û—Ç–≤–µ—ÇJSON–ë–µ–∑–æ–ø–∞—Å–Ω–æ(–°—Ç—Ä–æ–∫–∞JSON)
    –ü–æ–ø—ã—Ç–∫–∞
        –ß—Ç–µ–Ω–∏–µJSON = –ù–æ–≤—ã–π –ß—Ç–µ–Ω–∏–µJSON;
        –ß—Ç–µ–Ω–∏–µJSON.–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å–°—Ç—Ä–æ–∫—É(–°—Ç—Ä–æ–∫–∞JSON);
        –í–æ–∑–≤—Ä–∞—Ç –ü—Ä–æ—á–∏—Ç–∞—Ç—åJSON(–ß—Ç–µ–Ω–∏–µJSON);
    –ò—Å–∫–ª—é—á–µ–Ω–∏–µ
        –í–æ–∑–≤—Ä–∞—Ç –ù–æ–≤—ã–π –°—Ç—Ä—É–∫—Ç—É—Ä–∞("–û—à–∏–±–∫–∞", "–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç JSON");
    –ö–æ–Ω–µ—Ü–ü–æ–ø—ã—Ç–∫–∏;
–ö–æ–Ω–µ—Ü–§—É–Ω–∫—Ü–∏–∏

&–ù–∞–°–µ—Ä–≤–µ—Ä–µ–ë–µ–∑–ö–æ–Ω—Ç–µ–∫—Å—Ç–∞
–ü—Ä–æ—Ü–µ–¥—É—Ä–∞ –ó–∞–ø–∏—Å–∞—Ç—å–õ–æ–≥–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏(–°—Ç–∞—Ç—É—Å, –ú–µ—Ç–æ–¥, –ö–æ–¥–°–æ—Å—Ç–æ—è–Ω–∏—è, –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ = "")
    –ü–æ–ø—ã—Ç–∫–∞
        –ú–µ–Ω–µ–¥–∂–µ—Ä–ó–∞–ø–∏—Å–∏ = –†–µ–≥–∏—Å—Ç—Ä—ã–°–≤–µ–¥–µ–Ω–∏–π.–õ–æ–≥–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏.–°–æ–∑–¥–∞—Ç—å–ú–µ–Ω–µ–¥–∂–µ—Ä–ó–∞–ø–∏—Å–∏();
        –ú–µ–Ω–µ–¥–∂–µ—Ä–ó–∞–ø–∏—Å–∏.–ü–µ—Ä–∏–æ–¥ = –¢–µ–∫—É—â–∞—è–î–∞—Ç–∞();
        –ú–µ–Ω–µ–¥–∂–µ—Ä–ó–∞–ø–∏—Å–∏.–°—Ç–∞—Ç—É—Å = –°—Ç–∞—Ç—É—Å;
        –ú–µ–Ω–µ–¥–∂–µ—Ä–ó–∞–ø–∏—Å–∏.–ú–µ—Ç–æ–¥ = –ú–µ—Ç–æ–¥;
        –ú–µ–Ω–µ–¥–∂–µ—Ä–ó–∞–ø–∏—Å–∏.–ö–æ–¥–°–æ—Å—Ç–æ—è–Ω–∏—è = –ö–æ–¥–°–æ—Å—Ç–æ—è–Ω–∏—è;
        –ú–µ–Ω–µ–¥–∂–µ—Ä–ó–∞–ø–∏—Å–∏.–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å = –ü–∞—Ä–∞–º–µ—Ç—Ä—ã–°–µ–∞–Ω—Å–∞.–¢–µ–∫—É—â–∏–π–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å;
        –ú–µ–Ω–µ–¥–∂–µ—Ä–ó–∞–ø–∏—Å–∏.–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ = –õ–µ–≤(–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ, 1000);
        –ú–µ–Ω–µ–¥–∂–µ—Ä–ó–∞–ø–∏—Å–∏.–ó–∞–ø–∏—Å–∞—Ç—å();
    –ò—Å–∫–ª—é—á–µ–Ω–∏–µ
        // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
    –ö–æ–Ω–µ—Ü–ü–æ–ø—ã—Ç–∫–∏;
–ö–æ–Ω–µ—Ü–ü—Ä–æ—Ü–µ–¥—É—Ä—ã

&–ù–∞–°–µ—Ä–≤–µ—Ä–µ–ë–µ–∑–ö–æ–Ω—Ç–µ–∫—Å—Ç–∞
–ü—Ä–æ—Ü–µ–¥—É—Ä–∞ –ó–∞–ø–∏—Å–∞—Ç—å–õ–æ–≥–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏(–°–æ–±—ã—Ç–∏–µ, –û–ø–∏—Å–∞–Ω–∏–µ)
    –ü–æ–ø—ã—Ç–∫–∞
        –ú–µ–Ω–µ–¥–∂–µ—Ä–ó–∞–ø–∏—Å–∏ = –†–µ–≥–∏—Å—Ç—Ä—ã–°–≤–µ–¥–µ–Ω–∏–π.–õ–æ–≥–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.–°–æ–∑–¥–∞—Ç—å–ú–µ–Ω–µ–¥–∂–µ—Ä–ó–∞–ø–∏—Å–∏();
        –ú–µ–Ω–µ–¥–∂–µ—Ä–ó–∞–ø–∏—Å–∏.–ü–µ—Ä–∏–æ–¥ = –¢–µ–∫—É—â–∞—è–î–∞—Ç–∞();
        –ú–µ–Ω–µ–¥–∂–µ—Ä–ó–∞–ø–∏—Å–∏.–°–æ–±—ã—Ç–∏–µ = –°–æ–±—ã—Ç–∏–µ;
        –ú–µ–Ω–µ–¥–∂–µ—Ä–ó–∞–ø–∏—Å–∏.–û–ø–∏—Å–∞–Ω–∏–µ = –õ–µ–≤(–û–ø–∏—Å–∞–Ω–∏–µ, 2000);
        –ú–µ–Ω–µ–¥–∂–µ—Ä–ó–∞–ø–∏—Å–∏.–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å = –ü–∞—Ä–∞–º–µ—Ç—Ä—ã–°–µ–∞–Ω—Å–∞.–¢–µ–∫—É—â–∏–π–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å;
        –ú–µ–Ω–µ–¥–∂–µ—Ä–ó–∞–ø–∏—Å–∏.IP–ê–¥—Ä–µ—Å = –ü–æ–ª—É—á–∏—Ç—åIP–ê–¥—Ä–µ—Å–ö–ª–∏–µ–Ω—Ç–∞();
        –ú–µ–Ω–µ–¥–∂–µ—Ä–ó–∞–ø–∏—Å–∏.–ó–∞–ø–∏—Å–∞—Ç—å();
    –ò—Å–∫–ª—é—á–µ–Ω–∏–µ
        // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
    –ö–æ–Ω–µ—Ü–ü–æ–ø—ã—Ç–∫–∏;
–ö–æ–Ω–µ—Ü–ü—Ä–æ—Ü–µ–¥—É—Ä—ã

&–ù–∞–°–µ—Ä–≤–µ—Ä–µ–ë–µ–∑–ö–æ–Ω—Ç–µ–∫—Å—Ç–∞
–§—É–Ω–∫—Ü–∏—è –ü–æ–ª—É—á–∏—Ç—åIP–ê–¥—Ä–µ—Å–ö–ª–∏–µ–Ω—Ç–∞()
    –í–æ–∑–≤—Ä–∞—Ç –°–æ–∫—Ä–õ–ü(–ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã.IP–ê–¥—Ä–µ—Å–ö–ª–∏–µ–Ω—Ç–∞.–ü–æ–ª—É—á–∏—Ç—å());
–ö–æ–Ω–µ—Ü–§—É–Ω–∫—Ü–∏–∏`;
            
            steps.push({ progress: 75, message: '–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –º–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–æ–π –∑–∞—â–∏—Ç—ã –∏ –∞—É–¥–∏—Ç–∞...' });
            await new Promise(r => setTimeout(r, 800));
            
            finalResult = {
                code: apiCode,
                endpoints: 12,
                features: [
                    '‚úÖ OAuth 2.0 –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è',
                    '‚úÖ –ü–æ–ª–Ω—ã–π –∞—É–¥–∏—Ç –æ–ø–µ—Ä–∞—Ü–∏–π',
                    '‚úÖ Rate limiting –∏ –∑–∞—â–∏—Ç–∞ –æ—Ç DDoS',
                    '‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Å–µ—Ö –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö',
                    '‚úÖ –°–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏—è –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –∏–Ω—ä–µ–∫—Ü–∏–π',
                    '‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–µ–∫—Ä–µ—Ç–æ–≤',
                    '‚úÖ –ó–∞—â–∏—â–µ–Ω–Ω–æ–µ HTTPS —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ',
                    '‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π'
                ],
                testCases: 48,
                securityLevel: 'ENTERPRISE',
                complianceStandards: ['OWASP API Security', 'ISO 27001', 'SOC 2'],
                penetrationTestPassed: true
            };
            
            steps.push({ 
                progress: 100, 
                message: 'üîí API –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≥–æ—Ç–æ–≤–∞: 12 endpoints, ENTERPRISE –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å, –ø—Ä–æ–π–¥–µ–Ω—ã –ø–µ–Ω—Ç–µ—Å—Ç—ã',
                result: finalResult
            });
        }

        return new Response(JSON.stringify({
            data: {
                steps,
                finalResult
            }
        }), {
            headers: { ...corsHeaders, 'Content-Type': 'application/json' }
        });

    } catch (error) {
        console.error('Secure Developer demo error:', error);

        return new Response(JSON.stringify({
            error: {
                code: 'SECURE_DEVELOPER_DEMO_ERROR',
                message: '–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞'
            }
        }), {
            status: 500,
            headers: { ...corsHeaders, 'Content-Type': 'application/json' }
        });
    }
});